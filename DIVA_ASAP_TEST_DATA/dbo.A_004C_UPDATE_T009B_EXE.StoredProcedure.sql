USE [DIVA_ASAP_TEST_DATA]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[A_004C_UPDATE_T009B_EXE] 


WITH EXEC AS CALLER

AS

/* Initialize parameters from globals table */

     DECLARE 	 
			 @CURRENCY NVARCHAR(MAX)			= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'currency')
			,@DATE1 NVARCHAR(MAX)				= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'date1')
			,@DATE2 NVARCHAR(MAX)				= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'date2')
			,@DOWNLOADDATE NVARCHAR(MAX)		= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'downloaddate')
			,@DATEFORMAT VARCHAR(3)             = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'dateformat')
			,@EXCHANGERATETYPE NVARCHAR(MAX)	= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'exchangeratetype')
			,@LANGUAGE1 NVARCHAR(MAX)			= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'language1')
			,@LANGUAGE2 NVARCHAR(MAX)			= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'language2')
			,@YEAR NVARCHAR(MAX)				= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'year')
			,@ID NVARCHAR(MAX)					= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'id')
			,@LIMIT_RECORDS INT		            = CAST((SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'LIMIT_RECORDS') AS INT)


/*Test mode*/

SET ROWCOUNT @LIMIT_RECORDS


/*
  Title		    :	Updates table T009B
  Description	:  

  --------------------------------------------------------------
  Update history
  --------------------------------------------------------------
  Date		    | Who |	Description
  15-02-2016  FT  Initial version
 
  
*/


/* Initiate the log */  
--Create database log table if it does not exist
IF OBJECT_ID('LOG_SP_EXECUTION', 'U') IS NULL BEGIN CREATE TABLE [DBO].[LOG_SP_EXECUTION] ([DATABASE] NVARCHAR(MAX) NULL,[OBJECT] NVARCHAR(MAX) NULL,[OBJECT_TYPE] NVARCHAR(MAX) NULL,[USER] NVARCHAR(MAX) NULL,[DATE] DATE NULL,[TIME] TIME NULL,[DESCRIPTION] NVARCHAR(MAX) NULL,[TABLE] NVARCHAR(MAX),[ROWS] INT) END

--Log start of procedure
INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(DATE,GETDATE()),CONVERT(TIME,GETDATE()),'Procedure started',NULL,NULL



EXEC sp_droptable '#TEMP_T009B'
EXEC sp_droptable '#T009B_COMPLETE'

--include K4 period for OTC mapping
INSERT INTO A_T009B
SELECT T009B_MANDT, 'K4', '', RIGHT(T009B_POPER, 2), T009B_BUTAG, T009B_POPER, '0' FROM A_T009B WHERE T009B_PERIV='V3'

SELECT DISTINCT A_T009B.* 
INTO #TEMP_T009B
FROM A_T009B 
INNER JOIN A_T001
ON A_T009B.T009B_PERIV=A_T001.T001_PERIV
INNER JOIN AM_SCOPE SC
ON A_T001.T001_BUKRS=SC.SCOPE_CMPNY_CODE

UPDATE #TEMP_T009B SET T009B_BDATJ=@year WHERE T009B_POPER LIKE '00%' AND T009B_PERIV='V3'

UPDATE #TEMP_T009B SET T009B_BDATJ=@year+1 WHERE T009B_POPER LIKE '01%' AND T009B_PERIV='V3'


;WITH TEMP_T009B_FULL AS (
SELECT * FROM A_T009B
UNION ALL
SELECT * FROM #TEMP_T009B)

SELECT *
INTO #T009B_COMPLETE
 FROM TEMP_T009B_FULL

EXEC sp_droptable 'A_T009B'

SELECT * INTO A_T009B FROM #T009B_COMPLETE 

-- De-duplicate table incase procedure has been run more than once
DECLARE	@return_value int
EXEC	@return_value = [dbo].[A_002B_REMOVE_DUPLICATES]
		@tbl = N'T009B'
   


/* log end of procedure*/


INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(date,GETDATE()),CONVERT(time,GETDATE()),'Procedure finished',NULL,NULL












GO
