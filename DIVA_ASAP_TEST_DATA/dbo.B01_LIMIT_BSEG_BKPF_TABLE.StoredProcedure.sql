USE [DIVA_ASAP_TEST_DATA]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE      PROCEDURE [dbo].[B01_LIMIT_BSEG_BKPF_TABLE]
WITH EXECUTE AS CALLER
AS

select *
FROM AM_GLOBALS


-- FEB


-- Step 1 . Get all JE from BSAK, BSIK tables.

-- 

DROP TABLE IF EXISTS A_BSAK_BSIK_COMBINE

SELECT 
	DISTINCT 
		BSAK_BELNR, BSAK_GJAHR, BSAK_BUKRS
INTO A_BSAK_BSIK_COMBINE
FROM A_BSAK
UNION 
SELECT DISTINCT
	BSIK_BELNR, BSIK_GJAHR, BSIK_BUKRS
FROM A_BSIK


-- Step 2. From BSEG filter all JE exists in BSAK/BSIK

DROP TABLE IF EXISTS A_BSEG

SELECT  *
INTO A_BSEG
FROM A_BSEG_BK
WHERE EXISTS 
(

	SELECT TOP 1 1 
	FROM A_BSAK_BSIK_COMBINE
	WHERE A_BSAK_BSIK_COMBINE.BSAK_BELNR = A_BSEG_BK.BSEG_BELNR
	AND A_BSAK_BSIK_COMBINE.BSAK_GJAHR = A_BSEG_BK.BSEG_GJAHR
	AND A_BSAK_BSIK_COMBINE.BSAK_BUKRS = A_BSEG_BK.BSEG_BUKRS 

)
-- Step 3. From BKPF filter all JE exists in BSAK/BSIK

DROP TABLE IF EXISTS A_BKPF

SELECT  *
INTO A_BKPF
FROM A_BKPF_BK
WHERE EXISTS 
(

	SELECT TOP 1 1 
	FROM A_BSAK_BSIK_COMBINE
	WHERE A_BSAK_BSIK_COMBINE.BSAK_BELNR = A_BKPF_BK.BKPF_BELNR
	AND A_BSAK_BSIK_COMBINE.BSAK_GJAHR = A_BKPF_BK.BKPF_GJAHR
	AND A_BSAK_BSIK_COMBINE.BSAK_BUKRS = A_BKPF_BK.BKPF_BUKRS 

)

-- Step 4 / Check ALL AM mapping we need to run PTP.
-- AM_GL_HIERARCHY, AM_TANGO, AM_IRGR_MATERIAL_GROUP_HIERARCHY, AM_SPEND_CATEGORY, AM_COPA_MAPPING, AM_VAT_CLF

-- 296216 296216
-- 7836 7836
-- 80620 80620
-- 145744 145744

-- NEED TO LIMIT THE DATA.



EXEC [A_004A_UPDATE_MANDANT_VALUE_EXE]

EXEC [A_004B_UPDATE_DATE_FIELDS_EXE]

EXEC [A_004C_UPDATE_T009B_EXE]


EXEC [A_004D_APPLY_CUT_OFF_EXE] '20250331'

SELECT *
FROM A_BSIK WHERE BSIK_BUDAT > '20250331'

-- BSEG / BIKPF MAX 03-2025
-- BSEG : RUN PTP LIMIT BSIK TABLE



-- (SELECT COUNT(*) FROM A_BSIK WHERE BSIK_BUDAT > @cut_off_date)



SELECT *
FROM DIVA_SEV_FY2023..AM_VENDOR_EXCEPTION_LIST


SELECT
	*
FROM A_EKKO WHERE EKKO_BEDAT > '20250331'

-- 7836


select COUNT(*)
FROM A_BSIK


SELECT *

FROM AM_SPEND_CATEGORY


EXEC [A_004D_APPLY_CUT_OFF_EXE] 'date2'

EXEC [A_005A_CREATE_AM_SCOPE]

EXEC [A_005H_IMPORT_COUNTRY_MAPPING]


EXEC A_005D_CREATE_PROCUREMENT_CATEGORY_STRUCTURE_EXE


SELECT *
FROM AM_TANGO


SELECT *
FROM DIVA_SEV_FY2023..AM_IRGR_GINI_ARDR_MAPPING


EXEC [A_009_CREATE/UPDATE_AM_COPA_MAPPING_TABLE]

EXEC [A_010_CREATE/UPDATE_AM_VAT_CLF]

EXEC [A_012_CREATE/UPDATE_AM_COMPANY_CODE]

EXEC [A_013_CREATE/UPDATE_AM_VENDOR_EXCEPTION_LIST]

EXEC [A_014_CREATE/UPDATE_AM_T077X_T077Y]



--- GINI (Goods Issued Not Invoiced)


--- IRGR (Invoice Receipt / Goods Receipt)
--- ARDR Accrued Revenue / Deferred Revenue
select *
FROM AM_TANGO
WHERE TANGO_GL_ACCT = 'A013010'



--SELECT 
--	DISTINCT [(Z_Spend category level 1)], [(Z_Spend category level 2)], [(Z_Spend category level 3)]

--FROM AM_GPW_MAPPING_LEVEL
--WHERE [(APA-lines#Material group)] IN
--(
--	SELECT DISTINCT T023T_MATKL
--	FROM AM_IRGR_MATERIAL_GROUP_HIERARCHY


--)
--GROUP BY [(APA-lines#Material group)]
--HAVING COUNT(*) > 1



EXEC [A_015_CREATE/UPDATE_AM_FSMC]

EXEC [A_016_CREATE/UPDATE_AM_COPA_FILTER_MAPPING]

EXEC SP_WHERE_USED 'AM_PROC_CAT'




GO
