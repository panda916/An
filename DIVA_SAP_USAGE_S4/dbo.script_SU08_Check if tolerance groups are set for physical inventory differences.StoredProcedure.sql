USE [DIVA_SAP_USAGE_S4]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[script_SU08_Check if tolerance groups are set for physical inventory differences]
AS
--DYNAMIC_SCRIPT_START

--Step 1: Identify users that have been assigned tolerance groups for physical inventory differences
EXEC SP_REMOVE_TABLES 'SU08_%'


EXEC SP_DROPTABLE SU08_01_RT_T043;
SELECT DISTINCT *
INTO SU08_01_RT_T043
FROM A_T043;

---Step 2: Using T043I to see which tolerance limits are linked to which company codes. 

EXEC SP_DROPTABLE SU08_02_RT_T043I;
SELECT DISTINCT A_T043I.*,
       T001_BUTXT,
	   T001_WAERS
INTO SU08_02_RT_T043I
FROM A_T043I
LEFT JOIN A_T001
ON T043I_BUKRS =T001_BUKRS;

---Step 3: Identify company codes that are not assigned to have tolerance limits set diff

EXEC SP_DROPTABLE SU08_03_XT_T001_BURKS_NOT_IN_T043;
SELECT
	T001_BUKRS,
	T001_BUTXT,
	T001_ORT01,
	T001_LAND1,
	T001_WAERS
INTO SU08_03_XT_T001_BURKS_NOT_IN_T043
FROM A_T001
WHERE T001_BUKRS NOT IN 
				(
				SELECT T043I_BUKRS
				FROM SU08_02_RT_T043I
				WHERE T043I_INVPR <> ' ' OR LEN(TRIM(T043I_INVPR)) > 0
				);
-- Phase 2 show a summary of the volume/ value of movements per accounting scheme for materials, assuming that 
---these are those that have a materials GL account on either debit or credit (BSEG_KOART = M). 


---Step 4 Table journal entry table
--Filter on movements that are not automatic 
--and where the transaction code starts with MI (MKPF_TCODE2)
--Only get the GR where company codes do not have tolerance limit set
EXEC SP_DROPTABLE SU08_04_XT_JE_RELATE_MSEG_FILTERED
		
SELECT DISTINCT B04_08_IT_FIN_GL.*
INTO SU08_04_XT_JE_RELATE_MSEG_FILTERED
FROM   B04_08_IT_FIN_GL
INNER JOIN BP03_01_IT_GR
ON B04_GL_ZF_ACDOCA_AWKEY_DOC_NUM=BP03_01_MKPF_MBLNR AND
   B04_GL_ZF_ACDOCA_AWKEY_YEAR=BP03_01_MKPF_MJAHR AND B04_GL_ACDOCA_AWTYP='MKPF'
WHERE BP03_01_MKPF_TCODE2 LIKE 'MI%' AND 
	LEN(TRIM(BP03_01_MSEG_XAUTO)) = 0 AND 
	B04_GL_ACDOCA_RBUKRS IN (SELECT DISTINCT T001_BUKRS FROM SU08_03_XT_T001_BURKS_NOT_IN_T043);


---Step 5
--Get the Accouting sheme and related MSEG-MKPF
--For MSEG-MKPF, filter on movements that are not automatic and where the transaction code starts with MI (MKPF_TCODE2)

EXEC SP_DROPTABLE SU08_05_XT_MKPF_MSEG_ACCT_SCHEME
SELECT DISTINCT 
	B04_09_ZF_DEBIT_ACCOUNT_TYPES,
	B04_09_ZF_CREDIT_ACCOUNT_TYPES,
	B04_09_ACDOCA_GJAHR,B04_09_ACDOCA_BELNR,B04_09_ACDOCA_RBUKRS
	,BP03_01_IT_GR.*
INTO SU08_05_XT_MKPF_MSEG_ACCT_SCHEME
FROM B04_09_IT_ACDOCA_BKPF_ACC_SCH
--Inner join with JE cube, to limit down the accouting schme and get the AWKEY from JE cube
--Then joinF back to MSEG-MKPF to get ther related MSEG_MKPF
INNER JOIN SU08_04_XT_JE_RELATE_MSEG_FILTERED 
ON B04_GL_ACDOCA_GJAHR = B04_09_ACDOCA_GJAHR AND	
	B04_GL_ACDOCA_BELNR = B04_09_ACDOCA_BELNR AND	
	B04_GL_ACDOCA_RBUKRS = B04_09_ACDOCA_RBUKRS
--Get the GR related, filter MKPF_TCODE2 and MSEG_XAUTO
LEFT JOIN  BP03_01_IT_GR
 ON B04_GL_ZF_ACDOCA_AWKEY_DOC_NUM= BP03_01_MKPF_MBLNR AND
    B04_GL_ZF_ACDOCA_AWKEY_YEAR= BP03_01_MKPF_MJAHR AND
	B04_GL_ACDOCA_AWTYP='MKPF' AND  
--Filter MKPF_TCODE2 and MSEG_XAUTO
	(
		 BP03_01_MKPF_TCODE2 LIKE 'MI%' AND 
		 LEN(TRIM( BP03_01_MSEG_XAUTO)) = 0 AND 
		 BP03_01_MSEG_BUKRS IN (SELECT DISTINCT T001_BUKRS FROM SU08_03_XT_T001_BURKS_NOT_IN_T043)
	)

--Rename all the fields
EXEC SP_RENAME_FIELD 'SU08_01_','SU08_01_RT_T043';
EXEC SP_RENAME_FIELD 'SU08_02_','SU08_02_RT_T043I';
EXEC SP_RENAME_FIELD 'SU08_03_','SU08_03_XT_T001_BURKS_NOT_IN_T043';
EXEC SP_UNNAME_FIELD 'B04_GL_','SU08_04_XT_JE_RELATE_MSEG_FILTERED'
EXEC SP_RENAME_FIELD 'SU08_04_','SU08_04_XT_JE_RELATE_MSEG_FILTERED';
EXEC SP_UNNAME_FIELD 'BP03_01_','SU08_05_XT_MKPF_MSEG_ACCT_SCHEME'
EXEC SP_UNNAME_FIELD 'B04_09_','SU08_05_XT_MKPF_MSEG_ACCT_SCHEME'
EXEC SP_RENAME_FIELD 'SU08_05_','SU08_05_XT_MKPF_MSEG_ACCT_SCHEME';

GO
