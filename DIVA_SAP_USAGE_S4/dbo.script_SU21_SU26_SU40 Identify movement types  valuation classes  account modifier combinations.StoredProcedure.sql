USE [DIVA_SAP_USAGE_S4]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[script_SU21_SU26_SU40 Identify movement types/ valuation classes/ account modifier combinations]
AS
--DYNAMIC_SCRIPT_START

---Objective: Identify movement types/ valuation classes/ account modifier combinations that are not assigned accounts in standard account assignment table
---Step 1: Load T030 table with full description



EXEC SP_DROPTABLE 'SU26_01_RT_T030_ADD_DESC';
SELECT DISTINCT * 
INTO SU26_01_RT_T030_ADD_DESC
FROM BC21_02_IT_T030_ADD_DESC

---Step 2: Load table BC21_01_IT_T156X_T156W_T156T 
---Then check field T156X_KOMOK to see the transaction key contains Account Modification or not 


EXEC SP_DROPTABLE 'SU26_02_XT_T156W_VORSL_BUSTW_CNT02_KOMOK';
SELECT DISTINCT *,
      --Add a flag to check if T156X_BWART+T156X_BUSTR+T156X_CNT02 that are not found in T156W
      IIF(
	     T156X_BUSTW IN (SELECT DISTINCT T156W_BUSTW FROM A_T156W WHERE LEN(TRIM(T156W_BUSTW)) > 0) 
	     AND T156X_CNT02 IN (SELECT DISTINCT T156W_CNT02 FROM A_T156W WHERE LEN(TRIM(T156W_CNT02))> 0),'Yes','No'
		 ) AS ZF_T156X_BUSTW_CNT02_CHECK_IN_T156W,	  
	  --Add a flag to check if T156W_VORSL+T156X_KOMOK that are not found in T030_KTOSL+T030_KOMOK	  
	  IIF(
	      T156W_VORSL IN (SELECT DISTINCT T030_KTOSL FROM A_T030 WHERE LEN(TRIM(T030_KTOSL)) > 0) 
	  AND T156X_KOMOK IN (SELECT DISTINCT T030_KOMOK FROM A_T030 WHERE LEN(TRIM(T030_KOMOK)) > 0), 'Yes','No'
	     ) AS ZF_T156W_VORSL_KOMOK_CHECK_IN_T030
INTO SU26_02_XT_T156W_VORSL_BUSTW_CNT02_KOMOK
FROM BC21_01_IT_T156X_T156W_T156T;

---Step 3:  Retrieve the material valuation class then add the flag to check if valuation class in MBEW also exists in A_T030


EXEC SP_DROPTABLE SU26_03_RT_MBEW_MARA_MAKT_T025_FLAG_T030_BKLAS;
SELECT DISTINCT MBEW_BKLAS,  
				MARA_MTART,
				MARA_MATNR,
				MAKT_MAKTX,
				T025T_BKBEZ,
				T134T_MTBEZ, 
				IIF(MBEW_BKLAS IN (SELECT DISTINCT T030_BKLAS FROM A_T030), 'Yes','No') AS ZF_MBEW_BKLAS_IN_T030_BKLAS_CHECK
INTO SU26_03_RT_MBEW_MARA_MAKT_T025_FLAG_T030_BKLAS
FROM A_MBEW
INNER JOIN A_MARA
ON MBEW_MATNR = MARA_MATNR 
LEFT JOIN A_MAKT
ON MBEW_MATNR = MAKT_MATNR
LEFT JOIN A_T025T
ON MBEW_BKLAS = T025T_BKLAS
LEFT JOIN A_T134T
ON T134T_MTART = MARA_MTART;

EXEC SP_RENAME_FIELD 'SU26_01_','SU26_01_RT_T030_ADD_DESC';
EXEC SP_RENAME_FIELD 'SU26_02_','SU26_02_XT_T156W_VORSL_BUSTW_CNT02_KOMOK';
EXEC SP_RENAME_FIELD 'SU26_03_','SU26_03_RT_MBEW_MARA_MAKT_T025_FLAG_T030_BKLAS';


--Step 4 Get the list of movement types from MSEG, which is not found in T156X_BWART

EXEC SP_DROPTABLE SU26_04_XT_MSEG_BWART_NOT_IN_T156X
SELECT B26_01_IT_MATERIAL_MOVEMENT.* 
INTO SU26_04_XT_MSEG_BWART_NOT_IN_T156X
FROM B26_01_IT_MATERIAL_MOVEMENT
WHERE B26_01_MSEG_BWART NOT IN 
(
	SELECT DISTINCT T156X_BWART
	FROM A_T156X
);

EXEC SP_UNNAME_FIELD 'B26_01_','SU26_04_XT_MSEG_BWART_NOT_IN_T156X';
EXEC SP_RENAME_FIELD 'SU26_04_','SU26_04_XT_MSEG_BWART_NOT_IN_T156X';


--Step 5 Create a list of all combinations of movement type (MSEG_BWART) and valuation class (MBEW_BKLAS)
-- Get only the one which is not found in T030

EXEC SP_DROPTABLE SU26_05_XT_MSEG_BWART_NOT_IN_T030

SELECT DISTINCT B26_01_IT_MATERIAL_MOVEMENT.* 
INTO SU26_05_XT_MSEG_BWART_NOT_IN_T030
FROM B26_01_IT_MATERIAL_MOVEMENT
LEFT JOIN A_MBEW
ON 
MBEW_MATNR=B26_01_MSEG_MATNR AND MBEW_BWKEY=B26_01_MSEG_WERKS AND MBEW_BWTAR=B26_01_MSEG_BWTAR
LEFT JOIN 
BC21_01_IT_T156X_T156W_T156T
ON B26_01_MSEG_BWART=T156X_BWART
WHERE T156W_VORSL NOT IN (SELECT DISTINCT T030_KTOSL FROM A_T030) AND
	  MBEW_BKLAS NOT IN (SELECT DISTINCT T030_BKLAS FROM A_T030)
	  
EXEC SP_UNNAME_FIELD 'B26_01_','SU26_05_XT_MSEG_BWART_NOT_IN_T030';
EXEC SP_RENAME_FIELD 'SU26_05_','SU26_05_XT_MSEG_BWART_NOT_IN_T030';
GO
