USE [DIVA_SAP_USAGE_S4]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[script_SU36_Check if tolerance limits are set for clearing]
AS
--DYNAMIC_SCRIPT_START

--Script objective: Check if tolerance limits are set for clearing

--Step 1 Get the information tolerance limits for group of GL account
--Add a flag for company codes where tolerance limits are not set.
EXEC SP_DROPTABLE SU36_01_RT_T043S_TOGRU_LIMIT_SETTING

SELECT A.*,
		IIF((ZF_COUNT_T043S_BUKRS=1 AND LEN(BC17_01_T043S_TOGRU)=0) 
		OR  BC17_01_T043S_TOGRU IS NULL,'X','') AS ZF_T043S_TOGRU_NOT_SET
INTO SU36_01_RT_T043S_TOGRU_LIMIT_SETTING
FROM BC17_01_IT_T043S_T001 AS A
LEFT JOIN
(
	SELECT T043S_BUKRS,
			COUNT( T043S_BUKRS) AS ZF_COUNT_T043S_BUKRS
	FROM A_T043S
	GROUP BY T043S_BUKRS
) AS B
ON  A.BC17_01_T043S_BUKRS=B.T043S_BUKRS

--Step 2 get the list of tolerance group for vendor/customer
EXEC SP_DROPTABLE SU36_02_RT_T043G_TOGRU_LIMIT_SETTING
SELECT A.*,
IIF((ZF_COUNT_T043G_BUKRS=1 AND LEN(BC33_01_T043G_TOGRU)=0) OR BC33_01_T043G_TOGRU IS NULL,'X','') AS ZF_T043G_TOGRU_NOT_SET
INTO SU36_02_RT_T043G_TOGRU_LIMIT_SETTING
FROM BC33_01_IT_T043G_T001 AS A
LEFT JOIN
(
	SELECT T043G_BUKRS,
			COUNT( T043G_BUKRS) AS ZF_COUNT_T043G_BUKRS
	FROM A_T043G
	GROUP BY T043G_BUKRS
) AS B
ON  A.BC33_01_T043G_BUKRS=B.T043G_BUKRS

--Step 3 Get the list of customers
--Only get the case where Tolerance group is not set

EXEC SP_DROPTABLE SU36_03_XT_KNA1_KNB1_NO_TOLERANCE_GR

SELECT DISTINCT 
		BO01_01_KNB1_KUNNR,
		BO01_01_KNB1_BUKRS, 
		BO01_01_T001_BUTXT,
		BO01_01_KNB1_TOGRU, 
		BO01_01_KNA1_NAME1,
		BO01_01_KNA1_ERNAM,
		V_USERNAME_NAME_TEXT
		INTO SU36_03_XT_KNA1_KNB1_NO_TOLERANCE_GR
FROM BO01_01_IT_CUSTOMER
LEFT JOIN A_V_USERNAME
		ON BO01_01_KNA1_ERNAM=V_USERNAME_BNAME
WHERE LEN(TRIM(BO01_01_KNB1_TOGRU))=0

--STep 4 Get the list of suppliers 
--Only get the case where Tolerance group is not set
EXEC SP_DROPTABLE SU36_04_XT_LFA1_LFB1_NO_TOLERANCE_GR

SELECT 
		BP01_01_LFB1_LIFNR,
		BP01_01_LFB1_BUKRS,
		BP01_01_T001_BUTXT,
		BP01_01_LFB1_TOGRU,
		BP01_01_LFA1_NAME1,
		BP01_01_LFA1_ERNAM,
		V_USERNAME_NAME_TEXT
INTO SU36_04_XT_LFA1_LFB1_NO_TOLERANCE_GR
FROM BP01_01_IT_SUPP
LEFT JOIN A_V_USERNAME
		ON BP01_01_LFA1_NAME1=V_USERNAME_BNAME
WHERE LEN(TRIM(BP01_01_LFB1_TOGRU))=0


--Rename the fields
EXEC SP_UNNAME_FIELD 'BC17_01_','SU36_01_RT_T043S_TOGRU_LIMIT_SETTING'
EXEC SP_RENAME_FIELD 'SU36_01_','SU36_01_RT_T043S_TOGRU_LIMIT_SETTING'

EXEC SP_UNNAME_FIELD 'BC33_01_','SU36_02_RT_T043G_TOGRU_LIMIT_SETTING'
EXEC SP_RENAME_FIELD 'SU36_02_','SU36_02_RT_T043G_TOGRU_LIMIT_SETTING'

EXEC SP_UNNAME_FIELD 'BO01_01_','SU36_03_XT_KNA1_KNB1_NO_TOLERANCE_GR'
EXEC SP_RENAME_FIELD 'SU36_03_','SU36_03_XT_KNA1_KNB1_NO_TOLERANCE_GR'

EXEC SP_UNNAME_FIELD 'BP01_01_','SU36_04_XT_LFA1_LFB1_NO_TOLERANCE_GR'
EXEC SP_RENAME_FIELD 'SU36_04_','SU36_04_XT_LFA1_LFB1_NO_TOLERANCE_GR'




GO
