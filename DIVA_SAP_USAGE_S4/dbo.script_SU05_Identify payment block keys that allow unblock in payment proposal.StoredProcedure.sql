USE [DIVA_SAP_USAGE_S4]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[script_SU05_Identify payment block keys that allow unblock in payment proposal]
AS
--DYNAMIC_SCRIPT_START

--Script objective: Identify the blocking keys are permitted to change in payment proposal

--Step 1 Get the list of blocking reason
--Add a flag where Change in Payment Proposal Permitted?

EXEC SP_DROPTABLE SU05_01_RT_T008_CHAR1_EQ_X_FLAG

SELECT 
		*,
		'' AS ZF_T008_ZAHLS_IN_RBKK_BSAK,
		IIF(BC01_01_T008_CHAR1='X','Yes','') AS ZF_T008_CHAR1_FLAG
INTO SU05_01_RT_T008_CHAR1_EQ_X_FLAG
FROM BC01_01_IT_T008_T008T

--STep 2 Rename fields
EXEC SP_UNNAME_FIELD 'BC01_01_', 'SU05_01_RT_T008_CHAR1_EQ_X_FLAG'
EXEC SP_RENAME_FIELD 'SU05_01_', 'SU05_01_RT_T008_CHAR1_EQ_X_FLAG'


--Step 3 Get the Block change
EXEC SP_DROPTABLE SU05_02_TT_CDHDR_CDPOS_PAYMENT_BLOCK

SELECT
*
INTO SU05_02_TT_CDHDR_CDPOS_PAYMENT_BLOCK
FROM BC44_01_IT_CDHDR_CDPOS_PAYMENT_BLOCK
WHERE ZF_BLOCK_UNBLOCK_DESC='Block'

--Step 4 Get the Unblock change

EXEC SP_DROPTABLE SU05_03_TT_CDHDR_CDPOS_PAYMENT_UNBLOCK

SELECT
*
INTO SU05_03_TT_CDHDR_CDPOS_PAYMENT_UNBLOCK
FROM BC44_01_IT_CDHDR_CDPOS_PAYMENT_BLOCK
WHERE ZF_BLOCK_UNBLOCK_DESC='Unblock'

--Step 5 Full outer join between block and unblock

EXEC SP_DROPTABLE SU05_04_TT_CDHDR_CDPOS_PAYMENT_UNBLOCK_BLOCK

SELECT DISTINCT
--Block
	   A.CDHDR_OBJECTID AS ZF_CDHDR_OBJECTID_BLOCK,
	   A.CDHDR_OBJECTCLAS AS ZF_CDHDR_OBJECTCLAS_BLOCK,
	   A.CDHDR_CHANGENR AS ZF_CDHDR_CHANGENR_BLOCK,
	   A.CDHDR_UDATE AS ZF_CDHDR_UDATE_BLOCK,
	   A.CDHDR_UTIME AS ZF_CDHDR_UTIME_BLOCK,
	   A.CDPOS_VALUE_OLD AS ZF_CDPOS_VALUE_OLD_BLOCK,
	   A.CDPOS_VALUE_NEW AS ZF_CDPOS_VALUE_NEW_BLOCK,
--Unblock
	   B.CDHDR_OBJECTID AS ZF_CDHDR_OBJECTID_UNBLOCK,
	   B.CDHDR_OBJECTCLAS AS ZF_CDHDR_OBJECTCLAS_UNBLOCK,
	   B.CDHDR_CHANGENR AS ZF_CDHDR_CHANGENR_UNBLOCK,
	   B.CDHDR_UDATE AS ZF_CDHDR_UDATE_UNBLOCK,
	   B.CDHDR_UTIME AS ZF_CDHDR_UTIME_UNBLOCK,
	   B.CDPOS_VALUE_OLD AS ZF_CDPOS_VALUE_OLD_UNBLOCK,
	   B.CDPOS_VALUE_NEW AS ZF_CDPOS_VALUE_NEW_UNBLOCK
INTO SU05_04_TT_CDHDR_CDPOS_PAYMENT_UNBLOCK_BLOCK
FROM 
SU05_02_TT_CDHDR_CDPOS_PAYMENT_BLOCK AS A
FULL OUTER JOIN
SU05_03_TT_CDHDR_CDPOS_PAYMENT_UNBLOCK AS B
ON A.CDHDR_OBJECTID=B.CDHDR_OBJECTID AND A.CDHDR_OBJECTCLAS=B.CDHDR_OBJECTCLAS

--Step 6/ For the blank date fields, 
--If it is block, change the blank field to 19000101 
--If it is unblock, change the blank field to 99990101 
UPDATE SU05_04_TT_CDHDR_CDPOS_PAYMENT_UNBLOCK_BLOCK
SET ZF_CDHDR_UDATE_BLOCK='19000101'  
WHERE ZF_CDHDR_UDATE_BLOCK IS NULL 

UPDATE SU05_04_TT_CDHDR_CDPOS_PAYMENT_UNBLOCK_BLOCK
SET ZF_CDHDR_UDATE_UNBLOCK='99990101'  
WHERE ZF_CDHDR_UDATE_UNBLOCK IS NULL 

--Step 7 Since we do full outer join , for 1 block there will be many unblocks date

--For example

-- OBJECTDID_BLOCK | CHANGENR_BLOCK	|	UDATE_BLOCK |  CHANGENR_BLOCK  |  UDATE_UNBLOCK
--		ABC				001					1-JAN			004				 3-JAN
--		ABC				001					1-JAN			005				 7-JAN
--		ABC				002					4-JAN			004				 3-JAN
--		ABC				002					4-JAN			005				 7-JAN

--Get only the case
--If UDATE_BLOCK < UDATE_UNBLOCK, get the first line only
--If UDATE_BLOCK > UDATE_UNBLOCK, ignore

--Step 7.1 FIlter out the the case where UDATE_BLOCK < UDATE_UNBLOCK
EXEC SP_DROPTABLE SU05_05_TT_CDHDR_CDPOS_UDATE_BLOCK_BEFORE_UDATE_UNBLOCK

SELECT * 
INTO SU05_05_TT_CDHDR_CDPOS_UDATE_BLOCK_BEFORE_UDATE_UNBLOCK
FROM SU05_04_TT_CDHDR_CDPOS_PAYMENT_UNBLOCK_BLOCK
WHERE ZF_CDHDR_UDATE_BLOCK<ZF_CDHDR_UDATE_UNBLOCK

--Step 7.2 Add the row-number for each line, base on OBJECTDID_BLOCK,UDATE_BLOCK,UDATE_UNBLOCK

--For example
-- OBJECTDID_BLOCK | CHANGENR_BLOCK	|	UDATE_BLOCK |  CHANGENR_UNBLOCK  |  UDATE_UNBLOCK | ROW_NUMBER
--		ABC				001					1-JAN			004				 3-JAN				1
--		ABC				001					1-JAN			005				 7-JAN				2
--		ABC				002					4-JAN			005				 7-JAN				1

EXEC SP_DROPTABLE SU05_06_TT_CDHDR_CDPOS_ADD_ROWNUMBER

SELECT
*,
ROW_NUMBER() OVER ( PARTITION BY ZF_CDHDR_OBJECTCLAS_BLOCK,ZF_CDHDR_OBJECTID_BLOCK,ZF_CDHDR_UDATE_BLOCK 
							ORDER BY ZF_CDHDR_OBJECTCLAS_BLOCK,ZF_CDHDR_OBJECTID_BLOCK,ZF_CDHDR_UDATE_BLOCK,ZF_CDHDR_UDATE_UNBLOCK )
AS ZF_ROW_NUMBER
INTO SU05_06_TT_CDHDR_CDPOS_ADD_ROWNUMBER
FROM SU05_05_TT_CDHDR_CDPOS_UDATE_BLOCK_BEFORE_UDATE_UNBLOCK

--Step 7.3 Get the only the row number is 1, which is the first line

EXEC SP_DROPTABLE SU05_07_XT_CDHDR_CDPOS_UDATE_BLOCK_UNBLOCK

SELECT *
INTO SU05_07_XT_CDHDR_CDPOS_UDATE_BLOCK_UNBLOCK
FROM SU05_06_TT_CDHDR_CDPOS_ADD_ROWNUMBER
WHERE ZF_ROW_NUMBER=1

--STep 8 Add back to the invoice transaction, so we can see the block-unblock date
EXEC SP_DROPTABLE SU05_08_XT_INVOICE_BETWEEN_BLOCK_UNBLOCK

SELECT 
	B11_06_IT_PTP_INV.*,
	ZF_CDHDR_UDATE_BLOCK,
	ZF_CDHDR_UDATE_UNBLOCK,
	IIF( B11C_ACDOCA_AUGDT BETWEEN ZF_CDHDR_UDATE_BLOCK AND ZF_CDHDR_UDATE_UNBLOCK,'X',''  ) AS ZF_ACDOCA_AUGDT_DURING_BLOCK
INTO SU05_08_XT_INVOICE_BETWEEN_BLOCK_UNBLOCK
FROM B11_06_IT_PTP_INV
INNER JOIN SU05_07_XT_CDHDR_CDPOS_UDATE_BLOCK_UNBLOCK
	ON ZF_CDHDR_OBJECTID_BLOCK =B11C_ACDOCA_RCLNT+B11C_ACDOCA_RBUKRS+B11C_ACDOCA_BELNR+B11C_ACDOCA_GJAHR

--Step 9 Get the payment details relate to the invoices

EXEC SP_DROPTABLE SU05_09_XT_PAYMENT_RELATE_INV_PAYMENT_BLOCK

SELECT 
	B11_08_IT_PTP_PAY.*,ZF_ACDOCA_AUGDT_DURING_BLOCK
INTO SU05_09_XT_PAYMENT_RELATE_INV_PAYMENT_BLOCK
FROM
	B11_08_IT_PTP_PAY
INNER JOIN 
	SU05_08_XT_INVOICE_BETWEEN_BLOCK_UNBLOCK ON 
	B11C_ACDOCA_AUGDT=B11E_ACDOCA_AUGDT AND  
	B11C_ACDOCA_AUGBL=B11E_ACDOCA_AUGBL AND 
	B11C_ACDOCA_RBUKRS=B11E_ACDOCA_RBUKRS

--Step 10 Get the detail list of payment block 

EXEC SP_DROPTABLE SU05_10_RT_PAYMENT_BLOCK_CHANGE_DETAIL

SELECT * 
INTO SU05_10_RT_PAYMENT_BLOCK_CHANGE_DETAIL
FROM BC44_01_IT_CDHDR_CDPOS_PAYMENT_BLOCK

EXEC SP_RENAME_FIELD 'SU05_10_',SU05_10_RT_PAYMENT_BLOCK_CHANGE_DETAIL 
--Step 10 Remove all the temporary table
EXEC SP_DROPTABLE SU05_03_TT_CDHDR_CDPOS_PAYMENT_UNBLOCK
EXEC SP_DROPTABLE SU05_02_TT_CDHDR_CDPOS_PAYMENT_BLOCK
EXEC SP_DROPTABLE SU05_04_TT_CDHDR_CDPOS_PAYMENT_UNBLOCK_BLOCK
EXEC SP_DROPTABLE SU05_05_TT_CDHDR_CDPOS_UDATE_BLOCK_BEFORE_UDATE_UNBLOCK
EXEC SP_DROPTABLE SU05_06_TT_CDHDR_CDPOS_ADD_ROWNUMBER
--Rename the fields

EXEC SP_RENAME_FIELD 'SU05_07_',SU05_07_XT_CDHDR_CDPOS_UDATE_BLOCK_UNBLOCK 
EXEC SP_UNNAME_FIELD 'B11C_',SU05_08_XT_INVOICE_BETWEEN_BLOCK_UNBLOCK
EXEC SP_UNNAME_FIELD 'B11E_',SU05_09_XT_PAYMENT_RELATE_INV_PAYMENT_BLOCK
EXEC SP_RENAME_FIELD 'SU05_08_',SU05_08_XT_INVOICE_BETWEEN_BLOCK_UNBLOCK
EXEC SP_RENAME_FIELD 'SU05_09_',SU05_09_XT_PAYMENT_RELATE_INV_PAYMENT_BLOCK


GO
