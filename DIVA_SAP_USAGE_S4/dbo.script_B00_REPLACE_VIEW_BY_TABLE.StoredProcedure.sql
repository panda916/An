USE [DIVA_SAP_USAGE_S4]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/****** Object:  StoredProcedure [dbo].[script_B00_REPLACE_VIEW_BY_TABLE]    Script Date: 3/28/2023 10:08:56 AM ******/
CREATE PROCEDURE [dbo].[script_B00_REPLACE_VIEW_BY_TABLE]
AS 
--DYNAMIC_SCRIPT_START
/*  Change history comments
	Update history 
	-------------------------------------------------------
	Date            | Who   |  Description 
	24-03-2022	    | Thuan	|  Remove MANDT field in join
	22-06-2022		| Khoa	|  Replace A_ACDOCA to B00_ACDOCA
*/

	/* Initialize parameters from globals table */
    DECLARE  
				@CURRENCY NVARCHAR(3)                 = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'currency')
				,@DATE1 NVARCHAR(MAX)                           = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'date1')
				,@DATE2 NVARCHAR(MAX)                           = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'date2')
				,@DOWNLOADDATE NVARCHAR(MAX)             = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'downloaddate')
				,@DATEFORMAT VARCHAR(3)             = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'dateformat')
				,@EXCHANGERATETYPE NVARCHAR(MAX)  = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'exchangeratetype')
				,@LANGUAGE1 NVARCHAR(3)                = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'language1')
				,@LANGUAGE2 NVARCHAR(3)                = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'language2')
				,@LIMIT_RECORDS INT                    = CAST((SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'LIMIT_RECORDS') AS INT)
				,@FISCAL_YEAR_FROM NVARCHAR(MAX)					= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'FISCAL_YEAR_FROM')
				,@FISCAL_YEAR_TO NVARCHAR(MAX)					= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'FISCAL_YEAR_TO')
                 SET DATEFORMAT @DATEFORMAT;
			

/*Test mode*/

SET ROWCOUNT @LIMIT_RECORDS


EXEC SP_REMOVE_TABLES 'B00_SKAT'
SELECT A_SKAT.SKAT_MANDT, A_SKAT.SKAT_KTOPL, A_SKAT.SKAT_SAKNR, ISNULL(SKAT_1.SKAT_TXT20, SKAT_2.SKAT_TXT20) AS SKAT_TXT20, ISNULL(SKAT_1.SKAT_TXT50, SKAT_2.SKAT_TXT50) AS SKAT_TXT50, 
                  ISNULL(SKAT_1.SKAT_MCOD1, SKAT_2.SKAT_MCOD1) AS SKAT_MCOD1, ISNULL(SKAT_1.SKAT_SPRAS, SKAT_2.SKAT_SPRAS) AS SKAT_SPRAS
INTO B00_SKAT
FROM     (SELECT DISTINCT SKAT_MANDT, SKAT_KTOPL, SKAT_SAKNR
                  FROM      dbo.A_SKAT) AS A_SKAT LEFT OUTER JOIN
                      (SELECT SKAT_MANDT, SKAT_KTOPL, SKAT_SAKNR, SKAT_SPRAS, MAX(SKAT_TXT20) AS SKAT_TXT20, MAX(SKAT_TXT50) AS SKAT_TXT50, MAX(SKAT_MCOD1) AS SKAT_MCOD1
                       FROM      dbo.A_SKAT
                       WHERE   (SKAT_SPRAS = dbo.GET_PARAM('language1'))
                       GROUP BY SKAT_MANDT, SKAT_KTOPL, SKAT_SAKNR, SKAT_SPRAS) AS SKAT_1 ON  A_SKAT.SKAT_KTOPL = SKAT_1.SKAT_KTOPL AND 
                  A_SKAT.SKAT_SAKNR = SKAT_1.SKAT_SAKNR LEFT OUTER JOIN
                      (SELECT SKAT_MANDT, SKAT_KTOPL, SKAT_SAKNR, SKAT_SPRAS, MAX(SKAT_TXT20) AS SKAT_TXT20, MAX(SKAT_TXT50) AS SKAT_TXT50, MAX(SKAT_MCOD1) AS SKAT_MCOD1
                       FROM      dbo.A_SKAT
                       WHERE   (SKAT_SPRAS = dbo.GET_PARAM('language2'))
                       GROUP BY SKAT_MANDT, SKAT_KTOPL, SKAT_SAKNR, SKAT_SPRAS) AS SKAT_2 ON  A_SKAT.SKAT_KTOPL = SKAT_2.SKAT_KTOPL AND 
                  A_SKAT.SKAT_SAKNR = SKAT_2.SKAT_SAKNR

EXEC SP_CREATE_INDEX 'SKAT_MANDT, SKAT_SAKNR, SKAT_KTOPL', 'B00_SKAT'


EXEC SP_REMOVE_TABLES 'B00_TSTCT'

SELECT A_TSTCT.TSTCT_TCODE, ISNULL(TSTCT_language1.TSTCT_SPRSL, TSTCT_language2.TSTCT_SPRSL) AS TSTCT_SPRSL, ISNULL(TSTCT_language1.TSTCT_TTEXT, TSTCT_language2.TSTCT_TTEXT) 
                  AS TSTCT_TTEXT
INTO B00_TSTCT
FROM     (SELECT DISTINCT TSTCT_TCODE
                  FROM      dbo.A_TSTCT AS TSTCT_3) AS A_TSTCT LEFT OUTER JOIN
                      (SELECT TSTCT_TCODE, TSTCT_SPRSL, MAX(TSTCT_TTEXT) AS TSTCT_TTEXT
                       FROM      dbo.A_TSTCT AS TSTCT_2
                       WHERE   (TSTCT_SPRSL = dbo.GET_PARAM('language1'))
                       GROUP BY TSTCT_TCODE, TSTCT_SPRSL) AS TSTCT_language1 ON A_TSTCT.TSTCT_TCODE = TSTCT_language1.TSTCT_TCODE LEFT OUTER JOIN
                      (SELECT TSTCT_TCODE, TSTCT_SPRSL, MAX(TSTCT_TTEXT) AS TSTCT_TTEXT
                       FROM      dbo.A_TSTCT AS TSTCT_1
                       WHERE   (TSTCT_SPRSL = dbo.GET_PARAM('language2'))
                       GROUP BY TSTCT_TCODE, TSTCT_SPRSL) AS TSTCT_language2 ON A_TSTCT.TSTCT_TCODE = TSTCT_language2.TSTCT_TCODE

EXEC SP_CREATE_INDEX 'TSTCT_TCODE', 'B00_TSTCT'

EXEC SP_REMOVE_TABLES 'B00_T009B'
SELECT DISTINCT 
	T009B_PERIV,
	T009B_BDATJ,
	CAST(T009B_BUMON AS INT) T009B_BUMON,
	CAST(T009B_BUTAG AS INT) T009B_BUTAG,
	CAST(T009B_POPER AS INT) T009B_POPER,
	CAST(T009B_RELJR AS INT) T009B_RELJR
INTO B00_T009B
FROM A_T009B


EXEC SP_DROPTABLE 'B00_T023T'

SELECT A_T023T.T023T_MANDT, A_T023T.T023T_MATKL, ISNULL(T023T_language1.T023T_SPRAS, T023T_language2.T023T_SPRAS) AS T023T_SPRAS, ISNULL(T023T_language1.T023T_WGBEZ, T023T_language2.T023T_WGBEZ) 
                  AS T023T_WGBEZ
INTO B00_T023T
FROM     (SELECT DISTINCT T023T_MANDT, T023T_MATKL
                  FROM      dbo.A_T023T AS T023T_3) AS A_T023T LEFT OUTER JOIN
                      (SELECT T023T_MANDT, T023T_MATKL, T023T_SPRAS, MAX(T023T_WGBEZ) AS T023T_WGBEZ
                       FROM      dbo.A_T023T AS T023T_2
                       WHERE   (T023T_SPRAS = dbo.GET_PARAM('language1'))
                       GROUP BY T023T_MANDT, T023T_MATKL, T023T_SPRAS) AS T023T_language1 ON A_T023T.T023T_MATKL = T023T_language1.T023T_MATKL LEFT OUTER JOIN
                      (SELECT T023T_MANDT, T023T_MATKL, T023T_SPRAS, MAX(T023T_WGBEZ) AS T023T_WGBEZ
                       FROM      dbo.A_T023T AS T023T_1
                       WHERE   (T023T_SPRAS = dbo.GET_PARAM('language2'))
                       GROUP BY T023T_MANDT, T023T_MATKL, T023T_SPRAS) AS T023T_language2 ON  A_T023T.T023T_MATKL = T023T_language2.T023T_MATKL

EXEC SP_CREATE_INDEX 'T023T_MANDT, T023T_MATKL', 'B00_T023T'



EXEC SP_DROPTABLE 'B00_T003T'
SELECT A_T003T.T003T_MANDT, A_T003T.T003T_BLART, ISNULL(T003T_language1.T003T_SPRAS, T003T_language2.T003T_SPRAS) AS T003T_SPRAS, ISNULL(T003T_language1.T003T_LTEXT, T003T_language2.T003T_LTEXT) 
                  AS T003T_LTEXT
INTO B00_T003T
FROM     (SELECT DISTINCT T003T_MANDT, T003T_BLART
                  FROM      dbo.A_T003T) AS A_T003T LEFT OUTER JOIN
                      (SELECT T003T_MANDT, T003T_BLART, T003T_SPRAS, MAX(T003T_LTEXT) AS T003T_LTEXT
                       FROM      dbo.A_T003T
                       WHERE   (T003T_SPRAS = dbo.GET_PARAM('language1'))
                       GROUP BY T003T_MANDT, T003T_BLART, T003T_SPRAS) AS T003T_language1 ON A_T003T.T003T_BLART = T003T_language1.T003T_BLART LEFT OUTER JOIN
                      (SELECT T003T_MANDT, T003T_BLART, T003T_SPRAS, MAX(T003T_LTEXT) AS T003T_LTEXT
                       FROM      dbo.A_T003T
                       WHERE   (T003T_SPRAS = dbo.GET_PARAM('language2'))
                       GROUP BY T003T_MANDT, T003T_BLART, T003T_SPRAS) AS T003T_language2 ON  A_T003T.T003T_BLART = T003T_language2.T003T_BLART

EXEC SP_CREATE_INDEX 'T003T_MANDT, T003T_BLART', 'B00_T003T'


EXEC SP_DROPTABLE 'B00_T077X'

SELECT A_T077X.T077X_MANDT, A_T077X.T077X_KTOKD, ISNULL(T077X_language1.T077X_SPRAS, T077X_language2.T077X_SPRAS) AS T077X_SPRAS, ISNULL(T077X_language1.T077X_TXT30, T077X_language2.T077X_TXT30) 
                  AS T077X_TXT30
INTO B00_T077X
FROM     (SELECT DISTINCT T077X_MANDT, T077X_KTOKD, T077X_TXT30
                  FROM      dbo.A_T077X) AS A_T077X LEFT OUTER JOIN
                      (SELECT T077X_MANDT, T077X_KTOKD, T077X_SPRAS, MAX(T077X_TXT30) AS T077X_TXT30
                       FROM      dbo.A_T077X
                       WHERE   (T077X_SPRAS = dbo.GET_PARAM('language1'))
                       GROUP BY T077X_MANDT, T077X_KTOKD, T077X_SPRAS) AS T077X_language1 ON A_T077X.T077X_KTOKD = T077X_language1.T077X_KTOKD  LEFT OUTER JOIN
                      (SELECT T077X_MANDT, T077X_KTOKD, T077X_SPRAS, MAX(T077X_TXT30) AS T077X_TXT30
                       FROM      dbo.A_T077X
                       WHERE   (T077X_SPRAS = dbo.GET_PARAM('language2'))
                       GROUP BY T077X_MANDT, T077X_KTOKD, T077X_SPRAS) AS T077X_language2 ON A_T077X.T077X_KTOKD = T077X_language2.T077X_KTOKD 

EXEC SP_CREATE_INDEX 'T077X_MANDT, T077X_KTOKD', 'B00_T077X'


EXEC SP_DROPTABLE 'B00_T077Y'

SELECT A_T077Y.T077Y_MANDT, A_T077Y.T077Y_KTOKK, ISNULL(T077Y_language1.T077Y_SPRAS, T077Y_language2.T077Y_SPRAS) AS T077Y_SPRAS, ISNULL(T077Y_language1.T077Y_TXT30, T077Y_language2.T077Y_TXT30) 
                  AS T077Y_TXT30
INTO B00_T077Y
FROM     (SELECT DISTINCT T077Y_MANDT, T077Y_KTOKK
                  FROM      dbo.A_T077Y) AS A_T077Y LEFT OUTER JOIN
                      (SELECT T077Y_MANDT, T077Y_KTOKK, T077Y_SPRAS, MAX(T077Y_TXT30) AS T077Y_TXT30
                       FROM      dbo.A_T077Y
                       WHERE   (T077Y_SPRAS = dbo.GET_PARAM('language1'))
                       GROUP BY T077Y_MANDT, T077Y_KTOKK, T077Y_SPRAS) AS T077Y_language1 ON A_T077Y.T077Y_KTOKK = T077Y_language1.T077Y_KTOKK  LEFT OUTER JOIN
                      (SELECT T077Y_MANDT, T077Y_KTOKK, T077Y_SPRAS, MAX(T077Y_TXT30) AS T077Y_TXT30
                       FROM      dbo.A_T077Y
                       WHERE   (T077Y_SPRAS = dbo.GET_PARAM('language2'))
                       GROUP BY T077Y_MANDT, T077Y_KTOKK, T077Y_SPRAS) AS T077Y_language2 ON  A_T077Y.T077Y_KTOKK = T077Y_language2.T077Y_KTOKK

EXEC SP_CREATE_INDEX 'T077Y_MANDT, T077Y_KTOKK', 'B00_T077Y'



EXEC SP_DROPTABLE 'B00_TBSLT'

SELECT A_TBSLT.TBSLT_MANDT, A_TBSLT.TBSLT_BSCHL, A_TBSLT.TBSLT_UMSKZ, ISNULL(TBSLT_1.TBSLT_SPRAS, TBSLT_2.TBSLT_SPRAS) AS TBSLT_SPRAS, ISNULL(TBSLT_1.TBSLT_LTEXT, TBSLT_2.TBSLT_LTEXT) 
                  AS TBSLT_LTEXT
INTO B00_TBSLT
FROM     (SELECT TBSLT_MANDT, TBSLT_BSCHL, ISNULL(TBSLT_UMSKZ, '') AS TBSLT_UMSKZ
                  FROM      dbo.A_TBSLT
                  GROUP BY TBSLT_MANDT, TBSLT_BSCHL, TBSLT_UMSKZ) AS A_TBSLT LEFT OUTER JOIN
                      (SELECT TBSLT_MANDT, TBSLT_BSCHL, ISNULL(TBSLT_UMSKZ, '') AS TBSLT_UMSKZ, TBSLT_SPRAS, MAX(TBSLT_LTEXT) AS TBSLT_LTEXT
                       FROM      dbo.A_TBSLT
                       WHERE   (TBSLT_SPRAS = dbo.GET_PARAM('language1'))
                       GROUP BY TBSLT_MANDT, TBSLT_BSCHL, TBSLT_UMSKZ, TBSLT_SPRAS) AS TBSLT_1 ON A_TBSLT.TBSLT_UMSKZ = TBSLT_1.TBSLT_UMSKZ AND A_TBSLT.TBSLT_BSCHL = TBSLT_1.TBSLT_BSCHL  LEFT OUTER JOIN
                      (SELECT TBSLT_MANDT, TBSLT_BSCHL, ISNULL(TBSLT_UMSKZ, '') AS TBSLT_UMSKZ, TBSLT_SPRAS, MAX(TBSLT_LTEXT) AS TBSLT_LTEXT
                       FROM      dbo.A_TBSLT
                       WHERE   (TBSLT_SPRAS = dbo.GET_PARAM('language2'))
                       GROUP BY TBSLT_MANDT, TBSLT_BSCHL, TBSLT_UMSKZ, TBSLT_SPRAS) AS TBSLT_2 ON A_TBSLT.TBSLT_UMSKZ = TBSLT_2.TBSLT_UMSKZ AND A_TBSLT.TBSLT_BSCHL = TBSLT_2.TBSLT_BSCHL 

EXEC SP_CREATE_INDEX 'TBSLT_MANDT, TBSLT_UMSKZ, TBSLT_BSCHL', 'B00_TBSLT'


EXEC SP_DROPTABLE 'B00_USR02'

SELECT USR02_MANDT, USR02_BNAME, USR02_BCODE, USR02_GLTGV, USR02_GLTGB, USR02_USTYP, USR02_CLASS, USR02_LOCNT, USR02_UFLAG, USR02_ACCNT, USR02_ANAME, USR02_ERDAT, USR02_TRDAT, USR02_LTIME, 
                  USR02_CODVN, USR02_TZONE, USR02_PASSCODE, USR02_PWDCHGDATE
INTO B00_USR02
FROM     dbo.A_USR02

EXEC SP_CREATE_INDEX  'USR02_BNAME', 'B00_USR02'



EXEC SP_DROPTABLE 'B00_CEPCT'

SELECT 
	DISTINCT A.*
INTO B00_CEPCT
FROM A_CEPCT A
INNER JOIN 
	(
		SELECT CEPCT_MANDT, CEPCT_KOKRS, CEPCT_PRCTR, MAX(CEPCT_DATBI) AS ZF_CEPCT_DATBI_MAX
		FROM A_CEPCT
		WHERE CEPCT_SPRAS IN 
			(
				SELECT dbo.GET_PARAM('language1')
				UNION 
				SELECT dbo.GET_PARAM('language2')
			)
		GROUP BY CEPCT_MANDT, CEPCT_KOKRS, CEPCT_PRCTR
	) B
ON  A.CEPCT_KOKRS = B.CEPCT_KOKRS
AND A.CEPCT_PRCTR = B.CEPCT_PRCTR
AND A.CEPCT_DATBI = B.ZF_CEPCT_DATBI_MAX
WHERE A.CEPCT_SPRAS IN 
			(
				SELECT dbo.GET_PARAM('language1')
				UNION 
				SELECT dbo.GET_PARAM('language2')
			)

EXEC SP_CREATE_INDEX  'CEPCT_KOKRS, CEPCT_PRCTR', 'B00_CEPCT'


EXEC SP_DROPTABLE 'B00_TVKOT'

SELECT A_TVKOT.TVKOT_MANDT, A_TVKOT.TVKOT_VKORG, ISNULL(TVKOT_language1.TVKOT_SPRAS, TVKOT_language2.TVKOT_SPRAS) AS TVKOT_SPRAS, ISNULL(TVKOT_language1.TVKOT_VTEXT, TVKOT_language2.TVKOT_VTEXT) 
                  AS TVKOT_VTEXT
INTO B00_TVKOT
FROM     (SELECT DISTINCT TVKOT_MANDT, TVKOT_VKORG
                  FROM      dbo.A_TVKOT) AS A_TVKOT LEFT OUTER JOIN
                      (SELECT TVKOT_MANDT, TVKOT_VKORG, TVKOT_SPRAS, MAX(TVKOT_VTEXT) AS TVKOT_VTEXT
                       FROM      dbo.A_TVKOT
                       WHERE   (TVKOT_SPRAS =
                                             (SELECT GLOBALS_VALUE
                                              FROM      dbo.AM_GLOBALS
                                              WHERE   (GLOBALS_PARAMETER = 'language1')))
                       GROUP BY TVKOT_MANDT, TVKOT_VKORG, TVKOT_SPRAS) AS TVKOT_language1 ON A_TVKOT.TVKOT_VKORG = TVKOT_language1.TVKOT_VKORG LEFT OUTER JOIN
                      (SELECT TVKOT_MANDT, TVKOT_VKORG, TVKOT_SPRAS, MAX(TVKOT_VTEXT) AS TVKOT_VTEXT
                       FROM      dbo.A_TVKOT
                       WHERE   (TVKOT_SPRAS =
                                             (SELECT GLOBALS_VALUE
                                              FROM      dbo.AM_GLOBALS
                                              WHERE   (GLOBALS_PARAMETER = 'language2')))
                       GROUP BY TVKOT_MANDT, TVKOT_VKORG, TVKOT_SPRAS) AS TVKOT_language2 ON  A_TVKOT.TVKOT_VKORG = TVKOT_language2.TVKOT_VKORG

EXEC SP_CREATE_INDEX 'TVKOT_MANDT, TVKOT_VKORG', 'B00_TVKOT'


EXEC SP_DROPTABLE 'B00_MAKT'

SELECT 
	A_MAKT.MAKT_MANDT,
	A_MAKT.MAKT_MATNR,
	ISNULL(MAKT_1.MAKT_SPRAS, MAKT_2.MAKT_SPRAS) AS MAKT_SPRAS,
	ISNULL(MAKT_1.MAKT_MAKTX, MAKT_2.MAKT_MAKTX) AS MAKT_MAKTX
INTO B00_MAKT
FROM     (SELECT MAKT_MANDT, MAKT_MATNR
                  FROM      dbo.A_MAKT AS MAKT_5
                  GROUP BY MAKT_MANDT, MAKT_MATNR) AS A_MAKT LEFT OUTER JOIN
                      (SELECT MAKT_MANDT, MAKT_MATNR, MAKT_SPRAS, MAX(MAKT_MAKTX) AS MAKT_MAKTX
                       FROM      dbo.A_MAKT AS MAKT_4
                       WHERE   (MAKT_SPRAS = dbo.GET_PARAM('language1'))
                       GROUP BY MAKT_MANDT, MAKT_MATNR, MAKT_SPRAS) AS MAKT_1 ON A_MAKT.MAKT_MATNR = MAKT_1.MAKT_MATNR  LEFT OUTER JOIN
                      (SELECT MAKT_MANDT, MAKT_MATNR, MAKT_SPRAS, MAX(MAKT_MAKTX) AS MAKT_MAKTX
                       FROM      dbo.A_MAKT AS MAKT_3
                       WHERE   (MAKT_SPRAS = dbo.GET_PARAM('language2'))
                       GROUP BY MAKT_MANDT, MAKT_MATNR, MAKT_SPRAS) AS MAKT_2 ON A_MAKT.MAKT_MATNR = MAKT_2.MAKT_MATNR

EXEC SP_CREATE_INDEX 'MAKT_MANDT, MAKT_MATNR', 'B00_MAKT'


EXEC SP_DROPTABLE 'B00_TCURX'

SELECT TCURX_CURRKEY, POWER(CAST(10 AS real), 2 - TCURX_CURRDEC) AS TCURX_FACTOR
INTO B00_TCURX
FROM     dbo.A_TCURX

EXEC SP_CREATE_INDEX 'TCURX_CURRKEY', 'B00_TCURX'
GO
