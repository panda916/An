USE [DIVA_SAP_USAGE_S4]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[script_BC35_T053E_T053R_T001]
AS
--DYNAMIC_SCRIPT_START

--STep 1 Get the data about reason code and Classification of Payment Differences 
--Add the text description and other infomration to the cube
EXEC SP_DROPTABLE BC35_01_IT_T053E_T053R

SELECT DISTINCT 
	A_T053R.*,
	A_T053E.*, 
	T001_BUTXT,
	T001_KTOPL,
	T001_BUKRS,
	IIF(T053R_BUKRS IS NULL OR LEN(TRIM(T053R_BUKRS))=0,'X','') AS ZF_T053R_BUKRS_BLANK, -- Check if T001 company code found in T053F
	IIF(T030_KOMOK IS NULL OR LEN(TRIM(T030_KOMOK))=0,'X','') AS ZF_T030_KOMOK_BLANK,-- Check if T053R_RGSTR found in T0303
	IIF(T053E_BUKRS IS NULL OR LEN(TRIM(T053E_BUKRS))=0,'X','') AS ZF_T053E_BUKRS_BLANK,-- Check If T053R reason code found in T053E
--	T053S_TXT20,
	T048T_LTEXT
INTO BC35_01_IT_T053E_T053R
FROM A_T053R 
LEFT JOIN A_T053E ON T053E_BUKRS=T053R_BUKRS AND T053E_RSTGR=T053R_RSTGR
--Add company code details
RIGHT JOIN A_T001 ON T053R_BUKRS=T001_BUKRS
--Add Reason code description 
--LEFT JOIN A_T053S ON T053S_RSTGR=T053R_RSTGR AND T053R_BUKRS=T053S_BUKRS AND T053S_SPRAS='EN'
--Add a flag if account is found in T030
LEFT JOIN A_T030 ON T030_KOMOK=T053R_RSTGR AND T001_KTOPL=T030_KTOPL
--Add description for Correspondence 
LEFT JOIN A_T048T ON T048T_EVENT=T053R_KMRST AND T048T_SPRAS='EN'
GO
