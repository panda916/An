USE [DIVA_SAP_USAGE_S4]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE     PROC [dbo].[SP_RENAME_FIELD](@PREFIX AS NVARCHAR(MAX), @TABLE_NAME AS VARCHAR(MAX))
as

SET ANSI_WARNINGS OFF;  

-- RENAME OUTPUT TABLE FOR QLIK DASHBOARD CONNECTION
DECLARE @STR_SQL NVARCHAR(MAX)
DECLARE @ZV_FIELD_NAME NVARCHAR(MAX), @ZV_OLD_NAME NVARCHAR(MAX), @ZV_NEW_NAME NVARCHAR(MAX)
DECLARE @CURRENT_DB NVARCHAR(MAX) = (SELECT DB_NAME())
DECLARE FIELDLIST_CURSOR CURSOR SCROLL
	FOR SELECT name FROM sys.columns WHERE object_id = OBJECT_ID('dbo.' + @TABLE_NAME) 

OPEN FIELDLIST_CURSOR
	FETCH NEXT FROM FIELDLIST_CURSOR
		INTO @ZV_FIELD_NAME
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @ZV_OLD_NAME = '[' + @TABLE_NAME + '].[' + @ZV_FIELD_NAME + ']'
		SET @ZV_NEW_NAME = @PREFIX + @ZV_FIELD_NAME
		EXEC sp_rename  @ZV_OLD_NAME, @ZV_NEW_NAME, 'COLUMN'
	FETCH NEXT FROM FIELDLIST_CURSOR
			INTO @ZV_FIELD_NAME
	END
CLOSE FIELDLIST_CURSOR
DEALLOCATE FIELDLIST_CURSOR


GO
