USE [DIVA_SAP_USAGE_S4]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[script_BO06_DELIVERY_DOC]
WITH EXECUTE AS CALLER
AS
--DYNAMIC_SCRIPT_START

EXEC SP_REMOVE_TABLES 'BO06_01_IT_LIKP_DELIVERY_DOCS'
SELECT
	LIKP_MANDT,
	LIKP_VBELN,
	LIPS_POSNR,
	LIKP_ERNAM,
	LIKP_ERDAT,
	LIKP_BLDAT,
	LIKP_VKORG,
	TVKOT_VTEXT,
	LIKP_BZIRK,
	T171T_BZTXT,
	LIKP_LFART,
	TVLKT_VTEXT,
	LIKP_KODAT,
	LIKP_LFDAT,
	LIKP_KDGRP,
	T151T_KTEXT,
	LIKP_KUNNR,
	A_KNA1_SHIP_TO.KNA1_NAME1 AS ZF_KNA1_NAME1_SHIP_TO,
	A_KNA1_SOLD_TO.KNA1_NAME1 AS ZF_KNA1_NAME1_SOLD_TO,
	LIKP_WAERK,
	LIKP_VSART,
	T173T_BEZEI,
	LIPS_ERNAM,
	LIPS_ERDAT,
	LIPS_PSTYV,
	LIPS_MATNR,
	LIPS_ARKTX,
	LIPS_MATKL,
	T023T_WGBEZ,
	LIPS_LFIMG,
	LIPS_VGBEL,
	LIPS_VGPOS,
	LIKP_VBTYP,
	LIPS_VGTYP,
	A_KNA1_SHIP_TO.KNA1_ERDAT AS ZF_KNA1_ERDAT_SHIP_TO,
	A_KNA1_SHIP_TO.KNA1_ERNAM AS ZF_KNA1_ERNAM_SHIP_TO,
	A_KNA1_SOLD_TO.KNA1_ERDAT AS ZF_KNA1_ERDAT_SOLD_TO,
	A_KNA1_SOLD_TO.KNA1_ERNAM AS ZF_KNA1_ERNAM_SOLD_TO,
	CONCAT(LIKP_MANDT,'|',LIKP_VBELN,'|',CAST(LIPS_POSNR AS INT)) ZF_SALE_DELIVERY_DOC_KEY,
	--sales order is required as basis for delivery (test 19)
	A_TVLK.TVLK_AUFER,
	A_V_USERNAME.V_USERNAME_NAME_TEXT,
	MAKT_MAKTX

INTO BO06_01_IT_LIKP_DELIVERY_DOCS
FROM A_LIKP
INNER JOIN A_LIPS
ON LIKP_VBELN = LIPS_VBELN

--Only keep all sale organization relate to company code in the BKPF/BSEG cube
INNER JOIN B00_TVKO
ON LIKP_VKORG = TVKO_VKORG

--Get customer information
LEFT JOIN A_KNA1 AS A_KNA1_SHIP_TO
ON LIKP_KUNNR = A_KNA1_SHIP_TO.KNA1_KUNNR

LEFT JOIN A_KNA1 AS A_KNA1_SOLD_TO
ON LIKP_KUNAG = A_KNA1_SOLD_TO.KNA1_KUNNR

LEFT JOIN A_TVKOT
ON TVKOT_SPRAS IN ('E', 'EN')
AND LIKP_VKORG = TVKOT_VKORG

LEFT JOIN A_T171T
ON T171T_SPRAS IN ('E', 'EN')
AND T171T_BZIRK = LIKP_BZIRK

LEFT JOIN A_TVLKT
ON TVLKT_SPRAS IN ('E', 'EN')
AND TVLKT_LFART = LIKP_LFART														

LEFT JOIN A_T151T
ON T151T_SPRAS IN ('E', 'EN')
AND LIKP_KDGRP = T151T_KDGRP
		
LEFT JOIN A_T173T
ON T173T_SPRAS IN ('E', 'EN')
AND T173T_VSART = LIKP_VSART

LEFT JOIN A_T023T
ON T023T_SPRAS IN ('E', 'EN')
AND T023T_MATKL = LIPS_MATKL

-- Get sales order is required as basis for delivery description
LEFT JOIN A_TVLK
ON LIKP_LFART = TVLK_LFART

-- Get username 
LEFT JOIN A_V_USERNAME 
ON  LIKP_ERNAM = A_V_USERNAME.V_USERNAME_BNAME
-- Get material description
LEFT JOIN BC12_01_IT_MARA_VS_MAKT_ADD_MAKT_MAKTX
ON LIPS_MATNR = MARA_MATNR


GO
