USE [DIVA_SAP_USAGE_S4]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[script_BC21_T156X_T156W_T156T_&_T030_ADD_DESC]
AS
--DYNAMIC_SCRIPT_START
---Objective: Create the movement types table to identify which transaction keys are set for 
---automatic postings


--Step 1:
---Firstly, we will join table A_T156X vs A_T156W vs T156T 
--Khoi update, should get T156HT instead of T156T, 
--since we don't have enough key field,which will lead to duplicate

EXEC SP_DROPTABLE BC21_01_IT_T156X_T156W_T156T
SELECT  A_T156X.*,
        T148T_SOTXT,
        A_T156W.*,T156HT_BTEXT,
		T156_BWART,
	    T156_XWSBR,
		T156_XNEBE,
		T156_SHKZG,
		IIF(T156_SHKZG='H','Credit','Debit') AS ZF_T156_SHKZG_DESC,
		T156X_BWART+'-'+T156HT_BTEXT AS ZF_T156X_BWART_DESC,
		T156W_VORSL+'-'+T030W_LTEXT AS ZF_156W_VORSL_DESC,
CASE 
	WHEN T156X_KZBEW IS NULL OR LEN(TRIM(T156X_KZBEW))=0 THEN '-Goods movement w/o reference'	
	WHEN T156X_KZBEW='B' THEN 'B-Goods movement for purchase order'	
	WHEN T156X_KZBEW='F'THEN  'F-Goods movement for production order'
	WHEN T156X_KZBEW='L'THEN  'L-Goods movement for delivery note'
	WHEN T156X_KZBEW='K'THEN  'K-Goods movement for kanban requirement (WM - internal only)'
	WHEN T156X_KZBEW='O'	THEN '0-Subsequent adjustment of "material-provided" consumption'
	WHEN T156X_KZBEW='W'THEN'W-Subsequent adjustment of proportion/product unit material'
ELSE 'Not found' END AS ZF_T156X_KZBEW_DESC,
CASE 
WHEN T156X_KZVBR IS NULL OR LEN(TRIM(T156X_KZVBR))=0 THEN '-No consumption'	
WHEN T156X_KZVBR ='V'	THEN 'V-Consumption'
WHEN T156X_KZVBR ='A'	THEN 'A-Asset'
WHEN T156X_KZVBR ='E'	THEN 'E-Sales order'
WHEN T156X_KZVBR ='P'	THEN 'P-Project'
ELSE '' END AS ZF_T156X_KZVBR_DESC,

--Change description for T156W_XMFRW 

   IIF(T156W_XMFRW ='X', 'Yes','No') AS ZF_T156W_XMFRW_DESC 
INTO BC21_01_IT_T156X_T156W_T156T													
FROM  A_T156X
LEFT JOIN A_T156W
ON T156X_BUSTW=T156W_BUSTW AND 
   T156X_CNT02=T156W_CNT02
LEFT JOIN A_T156HT 
ON T156HT_BWART = T156X_BWART 
LEFT JOIN A_T030W
ON T156W_VORSL = T030W_KTOSL AND T030W_SPRAS='EN'
LEFT JOIN A_T148T
ON T148T_SOBKZ = T156X_SOBKZ AND T148T_SPRAS='EN'
LEFT JOIN A_T156
ON T156_BWART = T156X_BWART 

--Step 2: Create B phrase cube for T030 to add description 

EXEC SP_DROPTABLE BC21_02_IT_T030_ADD_DESC
SELECT DISTINCT T030_KTOPL,
				T030_KTOSL,
				T030W_LTEXT,
				T030_KTOSL+'-'+T030W_LTEXT AS ZF_T030_KTOSL_DESC,
				T030_BWMOD,
				T030_KOMOK,
				T030_KONTH,
				T030_KONTS,
				T025T_BKBEZ,
				T030_BKLAS,
				A.SKAT_TXT20 AS ZF_T030_KONTH_SKAT_TXT20,
				B.SKAT_TXT20 AS ZF_T030_KONTS_SKAT_TXT20,
				ISNULL(T030_BKLAS+'-'+T025T_BKBEZ,' ') AS ZF_T030_BKLAS_DESC,
				T030_KONTH+'-'+A.SKAT_TXT20 AS ZF_T030_KONTH_DESC,
				T030_KONTS+'-'+B.SKAT_TXT20 AS ZF_T030_KONTS_DESC,   
				T001_BUKRS, T001_BUTXT,
				IIF(LEN(TRIM(T030_KOMOK)) > 0,'Yes','No') AS ZF_T030_KOMOK_DESC,
				T004T_KTPLT
INTO BC21_02_IT_T030_ADD_DESC
FROM A_T030
	LEFT JOIN A_T030W
		ON T030_KTOSL = T030W_KTOSL AND T030W_SPRAS='EN'
	LEFT JOIN A_T025T
		ON T025T_BKLAS = T030_BKLAS
	LEFT JOIN A_SKAT AS A
		ON A.SKAT_SAKNR = T030_KONTH AND A.SKAT_KTOPL=T030_KTOPL
	LEFT JOIN A_SKAT AS B
		ON B.SKAT_SAKNR = T030_KONTS AND B.SKAT_KTOPL=T030_KTOPL
	LEFT JOIN A_T001
		ON T001_KTOPL= T030_KTOPL
	LEFT JOIN A_T004T ON T004T_KTOPL=T030_KTOPL AND T004T_SPRAS='EN'

GO
