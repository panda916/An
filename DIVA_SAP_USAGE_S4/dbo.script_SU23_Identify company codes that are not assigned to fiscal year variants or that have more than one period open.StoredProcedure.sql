USE [DIVA_SAP_USAGE_S4]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[script_SU23_Identify company codes that are not assigned to fiscal year variants or that have more than one period open]
AS
--DYNAMIC_SCRIPT_START

--Script objective : Identify the company codes have multiple posting period 


--Step 1 Get the detail of company code where they have fiscal year variants
EXEC SP_DROPTABLE SU23_01_RT_T001_T009_T001B_MUL_POST_PERIOD

SELECT DISTINCT 
	BC07_01_T001_BUKRS,
	BC07_01_T001_BUTXT,
	BC07_01_T001_ORT01,
	BC07_01_T001_LAND1,
	BC07_01_T001_WAERS,
	BC07_01_T001_SPRAS,
	BC07_01_T001_KTOPL,
	BC07_01_T001_PERIV,
	BC07_01_T001_OPVAR,
	BC07_01_T009_XKALE,
	BC07_01_T009_XJABH,
	BC07_01_T009_ANZBP,
	BC07_01_T009_ANZSP,
	BC07_01_ZF_T009_PERIV_NULL_FLAG,
	BC07_01_ZF_T001B_BUKRS_NULL_FLAG,
	BC07_01_T001B_RRCTY,
	BC07_01_T001B_BKONT,
	BC07_01_T001B_VKONT,
	BC07_01_T001B_FRYE1,
	BC07_01_T001B_FRPE1,
	BC07_01_T001B_TOYE1,
	BC07_01_T001B_TOPE1,
	BC07_01_T001B_FRYE2,
	BC07_01_T001B_FRPE2,
	BC07_01_T001B_TOYE2,
	BC07_01_T001B_TOPE2,
	BC07_01_T001B_BRGRU,
	BC07_01_T001B_FRYE3,
	BC07_01_T001B_FRPE3,
	BC07_01_T001B_TOYE3, 
	BC07_01_T001B_TOPE3,
	BC07_01_ZF_DIFF_T001B_FRPE1_TOPE1,
	BC07_01_ZF_DIFF_T001B_FRPE2_TOPE2,
	BC07_01_ZF_DIFF_T001B_FRPE3_TOPE3,
	BC07_01_ZF_T001B_RRCTY_DESC,
	BC07_01_T001B_MKOAR,
	BC07_01_ZF_T001B_MKOAR_DESC,
	CASE
		WHEN LEN(BC07_01_ZF_DIFF_T001B_FRPE1_TOPE1) <> 0 OR LEN(BC07_01_ZF_DIFF_T001B_FRPE2_TOPE2) <> 0 OR LEN(BC07_01_ZF_DIFF_T001B_FRPE3_TOPE3) <> 0  
		THEN 'Yes' ELSE 'No' END AS ZF_T001B_PERI_OPEN_FLAG
INTO  SU23_01_RT_T001_T009_T001B_MUL_POST_PERIOD
FROM BC07_01_IT_T001_T009_T001B_T000

--Rename the fields
EXEC SP_UNNAME_FIELD 'BC07_01_','SU23_01_RT_T001_T009_T001B_MUL_POST_PERIOD'
EXEC SP_RENAME_FIELD 'SU23_01_','SU23_01_RT_T001_T009_T001B_MUL_POST_PERIOD'
GO
