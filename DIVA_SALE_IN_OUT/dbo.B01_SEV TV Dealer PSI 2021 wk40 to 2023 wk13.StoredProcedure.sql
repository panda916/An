USE [DIVA_SALE_IN_OUT]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE     PROCEDURE [dbo].[B01_SEV TV Dealer PSI 2021 wk40 to 2023 wk13]
AS

-----------------------------------------------------------------------------HANDLE SALES IN SALE OUT-----------------------------------------------------

---------------------------------------------------- HANLDE SELL IN SELL OUT DATA------------------------------------------------------------------
-- Step 1 / Pivot table 
-- INSERT VALUE FOR SEV_TV_DEALER_FY2123 TABLE
/*
INSERT INTO SEV_TV_DEALER_FY2123
SELECT *
FROM SEV_TV_DEALER_FY23


DROP TABLE IF EXISTS B00_TT_SELL_IN_OUT_PIVOT_FY21_FY22

SELECT [Account Group Name], [MKT Kataban], ZF_SALE_FLAG, Year_Week,  Value_ 
INTO B00_TT_SELL_IN_OUT_PIVOT_FY21_FY22
FROM   
   (SELECT [Account Group Name],[MKT Kataban], ZF_SALE_FLAG, [2021-40],	[2021-41],	[2021-42],	[2021-43],	[2021-44],	[2021-45],	[2021-46],	[2021-47],	[2021-48],	[2021-49],	[2021-50],	[2021-51],	[2021-52],	[2022-01],	[2022-02],	[2022-03],	[2022-04],	[2022-05],	[2022-06],	[2022-07],	[2022-08],	[2022-09],	[2022-10],	[2022-11],	[2022-12],	[2022-13],	[2022-14],	[2022-15],	[2022-16],	[2022-17],	[2022-18],	[2022-19],	[2022-20],	[2022-21],	[2022-22],	[2022-23],	[2022-24],	[2022-25],	[2022-26],	[2022-27],	[2022-28],	[2022-29],	[2022-30],	[2022-31],	[2022-32],	[2022-33],	[2022-34],	[2022-35],	[2022-36],	[2022-37],	[2022-38],	[2022-39],	[2022-40],	[2022-41],	[2022-42],	[2022-43],	[2022-44],	[2022-45],	[2022-46],	[2022-47],	[2022-48],	[2022-49],	[2022-50],	[2022-51],	[2022-52],	[2023-01],	[2023-02],	[2023-03],	[2023-04],	[2023-05],	[2023-06],	[2023-07],	[2023-08],	[2023-09],	[2023-10],	[2023-11],	[2023-12],	[2023-13]
 
   FROM SEV_TV_DEALER_FY2123) p  
UNPIVOT  
   (Value_ FOR Year_Week IN   
      ( [2021-40],	[2021-41],	[2021-42],	[2021-43],	[2021-44],	[2021-45],	[2021-46],	[2021-47],	[2021-48],	[2021-49],	[2021-50],	[2021-51],	[2021-52],	[2022-01],	[2022-02],	[2022-03],	[2022-04],	[2022-05],	[2022-06],	[2022-07],	[2022-08],	[2022-09],	[2022-10],	[2022-11],	[2022-12],	[2022-13],	[2022-14],	[2022-15],	[2022-16],	[2022-17],	[2022-18],	[2022-19],	[2022-20],	[2022-21],	[2022-22],	[2022-23],	[2022-24],	[2022-25],	[2022-26],	[2022-27],	[2022-28],	[2022-29],	[2022-30],	[2022-31],	[2022-32],	[2022-33],	[2022-34],	[2022-35],	[2022-36],	[2022-37],	[2022-38],	[2022-39],	[2022-40],	[2022-41],	[2022-42],	[2022-43],	[2022-44],	[2022-45],	[2022-46],	[2022-47],	[2022-48],	[2022-49],	[2022-50],	[2022-51],	[2022-52],	[2023-01],	[2023-02],	[2023-03],	[2023-04],	[2023-05],	[2023-06],	[2023-07],	[2023-08],	[2023-09],	[2023-10],	[2023-11],	[2023-12],	[2023-13]
 )  
)AS unpvt

-- Create fy23 table 
select * from SEV_TV_DEALER_FY23

select * from sev

DROP TABLE IF EXISTS B00_TT_SELL_IN_OUT_PIVOT_FY23

SELECT [Account Group Name], [MKT Kataban], ZF_SALE_FLAG, Year_Week,  Value_ 
INTO B00_TT_SELL_IN_OUT_PIVOT_FY23
FROM   
   (SELECT [Account Group Name],[MKT Kataban],  ZF_SALE_FLAG, 
		[2023-14] , [2023-15] , [2023-16] , [2023-17] , [2023-18] , [2023-19] , [2023-20] , [2023-21] , [2023-22] , [2023-23] , [2023-24] , [2023-25] , [2023-26] , [2023-27] , [2023-28] , [2023-29] , [2023-30] , [2023-31] , [2023-32] , [2023-33] , [2023-34] , [2023-35] , [2023-36] , [2023-37] , [2023-38] , [2023-39] 

 
   FROM SEV_TV_DEALER_FY23) p  
UNPIVOT  
   (Value_ FOR Year_Week IN   
      ( [2023-14] , [2023-15] , [2023-16] , [2023-17] , [2023-18] , [2023-19] , [2023-20] , [2023-21] , [2023-22] , [2023-23] , [2023-24] , [2023-25] , [2023-26] , [2023-27] , [2023-28] , [2023-29] , [2023-30] , [2023-31] , [2023-32] , [2023-33] , [2023-34] , [2023-35] , [2023-36] , [2023-37] , [2023-38] , [2023-39] )
)AS unpvt

-- Append data fy21,fy22 and fy23

SELECT *
INTO B00_TT_SELL_IN_OUT_PIVOT
FROM B00_TT_SELL_IN_OUT_PIVOT_FY21_FY22
UNION 
SELECT * FROM B00_TT_SELL_IN_OUT_PIVOT_FY23

-- DELETE THE RECORD with total line 

DELETE FROM AM_MONTH_YEAR_SALE
WHERE ZF_SALE_FLAG IS NULL


SELECT * FROM AM_MONTH_YEAR_SALE

-- Step 2 /  Add field year month , month week and year into 

ALTER TABLE B00_TT_SELL_IN_OUT_PIVOT ADD  ZF_YEAR_MONTH NVARCHAR(20);
ALTER TABLE B00_TT_SELL_IN_OUT_PIVOT ADD  ZF_YEAR_MONTH_WEEK NVARCHAR(40);
ALTER TABLE B00_TT_SELL_IN_OUT_PIVOT ADD  ZF_YEAR NVARCHAR(10);

-- UPDATE VALUE

UPDATE B00_TT_SELL_IN_OUT_PIVOT
SET ZF_YEAR_MONTH = B.ZF_YEAR_MONTH,
	ZF_YEAR_MONTH_WEEK = B.ZF_YEAR_MONTH_WEEK,
	ZF_YEAR = B.ZF_YEAR
FROM B00_TT_SELL_IN_OUT_PIVOT A 
INNER JOIN AM_MONTH_YEAR_SALE B ON A.Year_Week = B.ZF_YEAR_WEEK_ORI


-- Step 3 / Need to combine sale in/ sale out, Calculated on hand stock and Dealer SOH
--- Step 1 / Calulated Calculated on hand stock

DROP TABLE IF EXISTS B01_TT_CALUATED_ON_HAND_STOCK
SELECT * ,	SUM (
		CASE WHEN Year_Week = '2021-40' AND ZF_NUMBERICAL_ORDER = 1 THEN [Dealer SOH]
		
			 ELSE  Value_ - [Dealer Net Sell Out Qty]
		END 
		) OVER (PARTITION BY [Account Group Name],[MKT Kataban]  ORDER BY ZF_NUMBERICAL_ORDER) as 'Calculated on hand stock' ,
	
	CASE  WHEN SUM (
		CASE WHEN Year_Week = '2021-40' AND ZF_NUMBERICAL_ORDER = 1 THEN [Dealer SOH]
		
			 ELSE  Value_ - [Dealer Net Sell Out Qty]
		END 
		) OVER (PARTITION BY [Account Group Name],[MKT Kataban]  ORDER BY ZF_NUMBERICAL_ORDER) <> [Dealer SOH] THEN 'Yes' ELSE 'No' END AS ZF_DIFF_SOH_CAL
INTO B01_TT_CALUATED_ON_HAND_STOCK
FROM 
(
	SELECT 
		SALE_IN.*, SALE_OUT.VALUE_ AS 'Dealer Net Sell Out Qty', SALE_SOH.Value_ AS 'Dealer SOH',
		ROW_NUMBER () OVER(PARTITION BY SALE_IN.[Account Group Name], SALE_IN.[MKT Kataban] ORDER BY  SALE_IN.Year_Week) AS ZF_NUMBERICAL_ORDER

	FROM
	(
		SELECT 
			DISTINCT 
				[Account Group Name],
				[MKT Kataban],
				ZF_SALE_FLAG,
				Year_Week,
				Value_,
				ZF_YEAR_MONTH,
				ZF_YEAR_MONTH_WEEK,
				ZF_YEAR
		FROM B00_TT_SELL_IN_OUT_PIVOT
		WHERE ZF_SALE_FLAG = 'Dealer Net Sell In Qty'
	)  AS SALE_IN 
	INNER JOIN 
	(
		SELECT 
		DISTINCT 
			[Account Group Name],
			[MKT Kataban],
			Year_Week,
			Value_
		FROM B00_TT_SELL_IN_OUT_PIVOT
		WHERE ZF_SALE_FLAG = 'Dealer Net Sell Out Qty'

	) AS SALE_OUT ON SALE_IN.[Account Group Name] = SALE_OUT.[Account Group Name]
				 AND SALE_IN.[MKT Kataban] = SALE_OUT.[MKT Kataban]
				 AND SALE_IN.Year_Week = SALE_OUT.Year_Week
	INNER JOIN 
	(
		SELECT 
		DISTINCT 
			[Account Group Name],
			[MKT Kataban],
			Year_Week,
			Value_
		FROM B00_TT_SELL_IN_OUT_PIVOT
		WHERE ZF_SALE_FLAG = 'Dealer SOH'

	) AS SALE_SOH ON SALE_IN.[Account Group Name] = SALE_SOH.[Account Group Name]
				 AND SALE_IN.[MKT Kataban] = SALE_SOH.[MKT Kataban]
				 AND SALE_IN.Year_Week = SALE_SOH.Year_Week
)AS A

-- Step 3 / Append flag each other

DROP TABLE IF EXISTS B02_TT_SALE_COMBINE_TEMP

-- Dealer Net Sell in Qty
SELECT DISTINCT 
				[Account Group Name],
				[MKT Kataban],
				ZF_SALE_FLAG,
				Year_Week,
				Value_,
				ZF_YEAR_MONTH,
				ZF_YEAR_MONTH_WEEK,
				ZF_YEAR,
				ZF_DIFF_SOH_CAL,
				0 AS ZF_NUMBERICAL_ORDER
INTO B02_TT_SALE_COMBINE_TEMP
FROM B01_TT_CALUATED_ON_HAND_STOCK
UNION
SELECT DISTINCT 
				[Account Group Name],
				[MKT Kataban],
				'Dealer Net Sell Out Qty' AS ZF_SALE_FLAG,
				Year_Week,
				[Dealer Net Sell Out Qty],
				ZF_YEAR_MONTH,
				ZF_YEAR_MONTH_WEEK,
				ZF_YEAR,
				ZF_DIFF_SOH_CAL,
				ROW_NUMBER () OVER(PARTITION BY ZF_YEAR_MONTH,[Account Group Name], [MKT Kataban]  ORDER BY  ZF_YEAR_MONTH_WEEK)
FROM B01_TT_CALUATED_ON_HAND_STOCK
UNION
SELECT DISTINCT 
				[Account Group Name],
				[MKT Kataban],
				'Dealer SOH' AS ZF_SALE_FLAG,
				Year_Week,
				[Dealer SOH],
				ZF_YEAR_MONTH,
				ZF_YEAR_MONTH_WEEK,
				ZF_YEAR,
				ZF_DIFF_SOH_CAL,
				0
FROM B01_TT_CALUATED_ON_HAND_STOCK
UNION
SELECT DISTINCT 
				[Account Group Name],
				[MKT Kataban],
				'Calculated on hand stock' AS ZF_SALE_FLAG,
				Year_Week,
				[Calculated on hand stock],
				ZF_YEAR_MONTH,
				ZF_YEAR_MONTH_WEEK,
				ZF_YEAR,
				ZF_DIFF_SOH_CAL,
				0
FROM B01_TT_CALUATED_ON_HAND_STOCK

-- 3263832
-- 3275930
-- OK

-- STEP 4 / add credit note qty 



--------------------------------------------------------------------HANLDE COPA CUBE -----------------------------------------------------------------------------------

SELECT TOP 1 * FROM COPA_TABLE



-- Step 5 / Create field for copa table 

-- B02_TT_SALE_COMBINE_TEMP

DROP TABLE IF EXISTS B03_TT_SALE_COPA_TEMP

SELECT *
INTO B03_TT_SALE_COPA_TEMP
FROM DIVA_SEV_FY2023_Q2..B18_04_IT_COPA_ACCOUNT_BASED

-- 588844
-- 2764409
USE DIVA_SEV_FY21_FY22
SELECT count(*) FROM B18_04_IT_COPA_ACCOUNT_BASED

ALTER TABLE B03_TT_SALE_COPA_TEMP ADD ZF_ACDOCA_KUNWE_LEADER_NAME NVARCHAR(1000)
ALTER TABLE B03_TT_SALE_COPA_TEMP ADD ZF_ACDOCA_MAKT_MAKTX NVARCHAR(1000)
ALTER TABLE B03_TT_SALE_COPA_TEMP ADD ZF_ACDOCA_YEAR_MONTH_WEEK NVARCHAR(100)
ALTER TABLE B03_TT_SALE_COPA_TEMP ADD ZF_ACDOCA_YEAR_WEEK NVARCHAR(50)


-- Step 7 / Need to update value for 4 fields above

DROP TABLE IF EXISTS AM_KUNWE_LEADER_NAME_MAPPING
SELECT 
	DISTINCT  (B18_ACDOCA_KUNWE), ZF_ACDOCA_KUNWE_LEADER_NAME
INTO AM_KUNWE_LEADER_NAME_MAPPING
FROM COPA_TABLE
WHERE 
	(B18_ACDOCA_RCLNT IS NOT NULL OR B18_ACDOCA_RCLNT = '' )

-- Update value for ZF_ACDOCA_KUNWE_LEADER_NAME

UPDATE B03_TT_SALE_COPA_TEMP
SET ZF_ACDOCA_KUNWE_LEADER_NAME  = B.ZF_ACDOCA_KUNWE_LEADER_NAME
FROM B03_TT_SALE_COPA_TEMP A
LEFT JOIN AM_KUNWE_LEADER_NAME_MAPPING B  ON A.B18_ACDOCA_KUNWE = B.B18_ACDOCA_KUNWE

-- Update ZF_ACDOCA_MAKT_MAKTX

UPDATE B03_TT_SALE_COPA_TEMP
SET ZF_ACDOCA_MAKT_MAKTX = 
CASE
	WHEN CHARINDEX(' ',MAKT_MAKTX ) = 0 THEN MAKT_MAKTX
	ELSE REPLACE(LEFT(MAKT_MAKTX, CHARINDEX(' ',MAKT_MAKTX )),' ','') END
FROM B03_TT_SALE_COPA_TEMP
INNER JOIN A_MAKT ON B18_ACDOCA_MATNR_COPA = MAKT_MATNR

select DISTINCT ZF_ACDOCA_MAKT_MAKTX, ZF_ACDOCA_KUNWE_LEADER_NAME

FROM B03_TT_SALE_COPA_TEMP



-- Update ZF_ACDOCA_YEAR_WEEK

UPDATE B03_TT_SALE_COPA_TEMP
SET ZF_ACDOCA_YEAR_WEEK = CONCAT(YEAR(B18_ACDOCA_BUDAT),'-',RIGHT('00' + CONVERT(VARCHAR(2), DATEPART(ISO_WEEK, B18_ACDOCA_BUDAT)), 2))

-- UPDATE ZF_ACDOCA_YEAR_WEEK with month = 1 and week in 51,52,53

UPDATE B03_TT_SALE_COPA_TEMP
SET ZF_ACDOCA_YEAR_WEEK = CONCAT(YEAR(B18_ACDOCA_BUDAT) - 1,'-',RIGHT('00' + CONVERT(VARCHAR(2), DATEPART(ISO_WEEK, B18_ACDOCA_BUDAT)), 2))
WHERE DATEPART(ISO_WEEK, B18_ACDOCA_BUDAT) IN (51,52,53)
AND MONTH(B18_ACDOCA_BUDAT) = 1

-- UPDATE ZF_ACDOCA_YEAR_MONTH_WEEK

UPDATE B03_TT_SALE_COPA_TEMP
SET ZF_ACDOCA_YEAR_MONTH_WEEK = 

 CONCAT(
		LEFT(ZF_ACDOCA_YEAR_WEEK,4) ,'-',
		RIGHT('00' + CONVERT(VARCHAR(2), DATEPART(MONTH, B18_ACDOCA_BUDAT)), 2),
		'-Week:',RIGHT(ZF_ACDOCA_YEAR_WEEK,2
	))


-------------------------------------------------------------------------ADD MORE VALUE FOR COPA CUBE------------------------------------------------------
-- Step 8 / List of customer and account group name exists in copa cube

DROP TABLE IF EXISTS B04_TT_KUNNR_LEADER_NAME_COPA_CUBE

SELECT 
DISTINCT  
	B18_ACDOCA_KUNNR,
	ZF_ACDOCA_KUNWE_LEADER_NAME
INTO 	B04_TT_KUNNR_LEADER_NAME_COPA_CUBE
FROM B03_TT_SALE_COPA_TEMP
WHERE ZF_ACDOCA_KUNWE_LEADER_NAME <> ''

-- Step 8.1/ Allow null  for some column in copa cube

ALTER TABLE B03_TT_SALE_COPA_TEMP ALTER COLUMN B18_ZF_BUDAT_YEAR_MNTH varchar(26) NULL;
ALTER TABLE B03_TT_SALE_COPA_TEMP ALTER COLUMN B18_ZF_BLDAT_YEAR_MNTH varchar(26) NULL;
ALTER TABLE B03_TT_SALE_COPA_TEMP ALTER COLUMN B18_COPA_LINE_FLAG varchar(1) NULL;
ALTER TABLE B03_TT_SALE_COPA_TEMP ALTER COLUMN B18_ACDOCA_ROCUR nvarchar(7) NULL;
ALTER TABLE B03_TT_SALE_COPA_TEMP ALTER COLUMN B18_ZF_NO_CUSTOMER_FLAG varchar(1) NULL;
ALTER TABLE B03_TT_SALE_COPA_TEMP ALTER COLUMN B18_ZF_NO_SALE_ORG_FLAG varchar(1) NULL;
ALTER TABLE B03_TT_SALE_COPA_TEMP ALTER COLUMN B18_ZF_NO_MATERIAL_FLAG varchar(1) NULL;
ALTER TABLE B03_TT_SALE_COPA_TEMP ALTER COLUMN B18_ZF_NULL_NUMBER varchar(1) NULL;
ALTER TABLE B03_TT_SALE_COPA_TEMP ALTER COLUMN B18_ZF_GJAHR_MONAT varchar(26) NULL;
ALTER TABLE B03_TT_SALE_COPA_TEMP ALTER COLUMN B18_ZF_GJAHR_POPER_FISCAL_YQ Nvarchar(7) NULL;

SELECT COUNT(*) FROM B03_TT_SALE_COPA_TEMP

--- Step 9 / List of in sev with Customer group and material and week not exists in copa cube
INSERT INTO B03_TT_SALE_COPA_TEMP
(
	B18_ACDOCA_RYEAR,
	B18_ZF_BUDAT_YEAR_MNTH,
	B18_ACDOCA_KUNNR,
	ZF_ACDOCA_KUNWE_LEADER_NAME,	
	ZF_ACDOCA_MAKT_MAKTX,	
	ZF_ACDOCA_YEAR_MONTH_WEEK,	
	ZF_ACDOCA_YEAR_WEEK
)

SELECT 
	DISTINCT 
		ZF_YEAR,
		ZF_YEAR_MONTH,
		B18_ACDOCA_KUNNR,
		[Account Group Name],
		[MKT Kataban],
		ZF_YEAR_MONTH_WEEK,
		Year_Week
FROM B02_TT_SALE_COMBINE_TEMP A 
	INNER JOIN B04_TT_KUNNR_LEADER_NAME_COPA_CUBE B ON A.[Account Group Name] = B.ZF_ACDOCA_KUNWE_LEADER_NAME
WHERE  EXISTS 
(
	SELECT TOP 1 1 FROM B03_TT_SALE_COPA_TEMP B
	WHERE A.[Account Group Name] = B.ZF_ACDOCA_KUNWE_LEADER_NAME
	AND A.Year_Week = B.ZF_ACDOCA_YEAR_WEEK
	AND A.[MKT Kataban] = B.ZF_ACDOCA_MAKT_MAKTX
)
AND NOT EXISTS
(

	SELECT TOP 1 1 FROM B03_TT_SALE_COPA_TEMP C
	WHERE A.[Account Group Name] = C.ZF_ACDOCA_KUNWE_LEADER_NAME
	AND A.Year_Week = C.ZF_ACDOCA_YEAR_WEEK
	AND A.[MKT Kataban] = C.ZF_ACDOCA_MAKT_MAKTX
	AND B.B18_ACDOCA_KUNNR = C.B18_ACDOCA_KUNNR
)



USE DIVA_SEV_FY2023_Q2

SELECT 
DISTINCT 
	ACDOCA_GJAHR
FROM A_ACDOCA




ZF_YEAR_MONTH_WEEK
2023-03-Week:11
-- 10000_DIRECT SALES	KD-43X7000G
B18_ACDOCA_RYEAR,
B18_ZF_BUDAT_YEAR_MNTH,
B18_ACDOCA_KUNNR,
ZF_ACDOCA_KUNWE_LEADER_NAME,	
ZF_ACDOCA_MAKT_MAKTX,	
ZF_ACDOCA_YEAR_MONTH_WEEK,	
ZF_ACDOCA_YEAR_WEEK




SELECT 
*
FROM COPA_TABLE
WHERE B18_ACDOCA_RCLNT IS NULL






select distinct ZF_ACDOCA_YEAR_WEEK
from (
SELECT * 
FROM COPA_TABLE
WHERE B18_ACDOCA_RCLNT IS NOT NULL
EXCEPT
SELECT *
FROM B03_TT_SALE_COPA_TEMP
) as a



SELECT DISTINCT *
FROM COPA_TABLE
WHERE 
 ZF_ACDOCA_KUNWE_LEADER_NAME = 'CTY NGUYEN KIM' 
and ZF_ACDOCA_MAKT_MAKTX = 'XR-75X90K'
AND ZF_ACDOCA_YEAR_MONTH_WEEK = '2023-03-Week:11'

SELECT 
		DISTINCT 
		ZF_YEAR,
		ZF_YEAR_MONTH,
		[Account Group Name],
		[MKT Kataban],
		ZF_YEAR_MONTH_WEEK,
		Year_Week
FROM B02_TT_SALE_COMBINE_TEMP
WHERE [Account Group Name] = 'CTY NGUYEN KIM' 
AND [MKT Kataban] = 'XR-75X90K'
AND ZF_YEAR_MONTH_WEEK = '2023-03-Week:11'


SELECT * FROM B04_TT_KUNNR_LEADER_NAME_COPA_CUBE
WHERE ZF_ACDOCA_KUNWE_LEADER_NAME = 'CTY NGUYEN KIM' 


SELECT *
FROM COPA_TABLE
WHERE 



SELECT DISTINCT B18_ACDOCA_KUNNR
FROM B03_TT_SALE_COPA_TEMP
WHERE 
 ZF_ACDOCA_KUNWE_LEADER_NAME = 'CTY NGUYEN KIM' 
and ZF_ACDOCA_MAKT_MAKTX = 'XR-75X90K'






SELECT DISTINCT B18_ACDOCA_KUNNR
FROM COPA_TABLE
WHERE 
 ZF_ACDOCA_KUNWE_LEADER_NAME = 'CTY NGUYEN KIM' 
 and ZF_ACDOCA_MAKT_MAKTX = 'XR-75X90K'




UPDATE COPA_TABLE
SET ZF_ACDOCA_KUNWE_LEADER_NAME = ''
WHERE ZF_ACDOCA_KUNWE_LEADER_NAME = '-'


UPDATE COPA_TABLE
SET ZF_ACDOCA_MAKT_MAKTX = ''
WHERE ZF_ACDOCA_MAKT_MAKTX = '-'



UPDATE B03_TT_SALE_COPA_TEMP
SET ZF_ACDOCA_KUNWE_LEADER_NAME = ''
WHERE ZF_ACDOCA_KUNWE_LEADER_NAME = '-'


UPDATE B03_TT_SALE_COPA_TEMP
SET ZF_ACDOCA_MAKT_MAKTX = ''
WHERE ZF_ACDOCA_MAKT_MAKTX = '-'

ALTER TABLE B03_TT_SALE_COPA_TEMP ADD ZF_ACDOCA_YEAR_MONTH_WEEK NVARCHAR(100)
ALTER TABLE B03_TT_SALE_COPA_TEMP ADD ZF_ACDOCA_YEAR_WEEK NVARCHAR(50)

ALTER TABLE B03_TT_SALE_COPA_TEMP DROP COLUMN ZF_ACDOCA_YEAR_WEEK, ZF_ACDOCA_YEAR_MONTH_WEEK


SELECT *
FROM COPA_TABLE
WHERE B18_ACDOCA_BELNR = '0736500005' AND B18_ACDOCA_BUZEI = '002'
UNION
select 
 *
FROM B03_TT_SALE_COPA_TEMP
WHERE B18_ACDOCA_BELNR = '0736500005' AND B18_ACDOCA_BUZEI = '002'


SELECT 
DISTINCT ZF_ACDOCA_YEAR_WEEK, ZF_ACDOCA_YEAR_MONTH_WEEK,
 CONCAT(
		LEFT(ZF_ACDOCA_YEAR_WEEK,4) ,'-',
		RIGHT('00' + CONVERT(VARCHAR(2), DATEPART(MONTH, B18_ACDOCA_BUDAT)), 2),
		'-Week:',RIGHT(ZF_ACDOCA_YEAR_MONTH_WEEK,2))


FROM COPA_TABLE



SELECT 
*
FROM (
SELECT DISTINCT 
	B18_ACDOCA_BUDAT, ZF_ACDOCA_YEAR_WEEK
FROM COPA_TABLE
WHERE 
	(B18_ACDOCA_RCLNT IS NOT NULL OR B18_ACDOCA_RCLNT = '' )
	) AS A 
INNER JOIN
	(

		SELECT DISTINCT 
		B18_ACDOCA_BUDAT, ZF_ACDOCA_YEAR_WEEK
		FROM B03_TT_SALE_COPA_TEMP
	) AS B 
ON A.B18_ACDOCA_BUDAT = B.B18_ACDOCA_BUDAT
AND A.ZF_ACDOCA_YEAR_WEEK <> B.ZF_ACDOCA_YEAR_WEEK
	 







-- 2764409
SELECT  COUNT(*)
FROM B18_04_IT_COPA_ACCOUNT_BASED

SELECT COUNT(*)
FROM COPA_TABLE
WHERE B18_ACDOCA_RCLNT IS NOT NULL OR B18_ACDOCA_RCLNT = ''

SELECT [Account Group Name],	[MKT Kataban],	[ZF_SALE_FLAG],	Year_Week,	Value_,	ZF_YEAR_MONTH,	ZF_YEAR_MONTH_WEEK,	ZF_YEAR	ZF_DIFF_SOH_CAL,	ZF_NUMBERICAL_ORDER
FROM B02_TT_SALE_COMBINE_TEMP
UNION
SELECT [Account Group Name],	[MKT Kataban],	[ZF_SALE_FLAG],	Year_Week,	Value_,	ZF_YEAR_MONTH,	ZF_YEAR_MONTH_WEEK,	ZF_YEAR	ZF_DIFF_SOH_CAL,	ZF_NUMBERICAL_ORDER
FROM DIVA_SEV_FY21_22_SUMMARY

[Account Group Name],	[MKT Kataban],	[ZF_SALE_FLAG],	Year_Week,	Value_,	ZF_YEAR_MONTH,	ZF_YEAR_MONTH_WEEK,	ZF_YEAR	ZF_DIFF_SOH_CAL,	ZF_NUMBERICAL_ORDER








SELECT 
	A.*, B.*
FROM B00_TT_SELL_IN_OUT_PIVOT A 
INNER JOIN AM_MONTH_YEAR_SALE  B ON A.Year_Week = B.ZF_YEAR_WEEK_ORI
WHERE [Account Group Name] = 'CTY THE GIOI DI DONG'
AND [MKT Kataban] = 'KD-32W830K'



SELECT 
*
FROM DIVA_SEV_FY21_22_SUMMARY
WHERE [Account Group Name] = 'CTY THE GIOI DI DONG'
AND [MKT Kataban] = 'KD-32W830K'



-- 2448108
-- 3263832

-- Calculated on hand stock

SELECT DISTINCT ZF_SALE_FLAG
FROM DIVA_SEV_FY21_22_SUMMARY


SELECT COUNT(*)
FROM DIVA_SEV_FY21_22_SUMMARY


SELECT * FROM AM_MONTH_YEAR_SALE



UPDATE DIVA_SEV_FY21_22_SUMMARY_OLD
SET DIVA_SEV_FY21_22_SUMMARY_OLD.ZF_YEAR_MONTH = AM_MONTH_YEAR_SALE.ZF_YEAR_MONTH
FROM DIVA_SEV_FY21_22_SUMMARY_OLD INNER JOIN AM_MONTH_YEAR_SALE ON Year_Week = ZF_YEAR_WEEK_ORI

UPDATE DIVA_SEV_FY21_22_SUMMARY_OLD
SET DIVA_SEV_FY21_22_SUMMARY_OLD.ZF_YEAR_MONTH_WEEK = AM_MONTH_YEAR_SALE.ZF_YEAR_MONTH_WEEK
FROM DIVA_SEV_FY21_22_SUMMARY_OLD INNER JOIN AM_MONTH_YEAR_SALE ON Year_Week = ZF_YEAR_WEEK_ORI

UPDATE DIVA_SEV_FY21_22_SUMMARY_OLD
SET DIVA_SEV_FY21_22_SUMMARY_OLD.ZF_YEAR = AM_MONTH_YEAR_SALE.ZF_YEAR
FROM DIVA_SEV_FY21_22_SUMMARY_OLD INNER JOIN AM_MONTH_YEAR_SALE ON Year_Week = ZF_YEAR_WEEK_ORI




USE DIVA_SEV_FY21_FY22
select *
FROM DIVA_SEV_FY21_22_SUMMARY A
INNER JOIN AM_MONTH_YEAR_SALE  B ON A.ZF_YEAR_MONTH_WEEK 

WHERE [Account Group Name] = 'CTY THE GIOI DI DONG'
AND [MKT Kataban] = 'KD-32W830K'


SELECT 
*
FROM DIVA_SEV_FY21_22_SUMMARY_OLD
WHERE [Account Group Name] = 'CTY THE GIOI DI DONG'
AND [MKT Kataban] = 'KD-32W830K'



SELECT *
FROM DIVA_SEV_FY21_22_SUMMARY





ZF_YEAR_MONTH
2022-06


DROP TABLE DIVA_SEV_FY21_22_SUMMARY_OLD
SELECT [Account Group Name], [MKT Kataban], ZF_SALE_FLAG, Year_Week,  Value_ 
INTO DIVA_SEV_FY21_22_SUMMARY_OLD
FROM   
   (SELECT [Account Group Name],[MKT Kataban], ZF_SALE_FLAG, [2021-40],	[2021-41],	[2021-42],	[2021-43],	[2021-44],	[2021-45],	[2021-46],	[2021-47],	[2021-48],	[2021-49],	[2021-50],	[2021-51],	[2021-52],	[2022-01],	[2022-02],	[2022-03],	[2022-04],	[2022-05],	[2022-06],	[2022-07],	[2022-08],	[2022-09],	[2022-10],	[2022-11],	[2022-12],	[2022-13],	[2022-14],	[2022-15],	[2022-16],	[2022-17],	[2022-18],	[2022-19],	[2022-20],	[2022-21],	[2022-22],	[2022-23],	[2022-24],	[2022-25],	[2022-26],	[2022-27],	[2022-28],	[2022-29],	[2022-30],	[2022-31],	[2022-32],	[2022-33],	[2022-34],	[2022-35],	[2022-36],	[2022-37],	[2022-38],	[2022-39],	[2022-40],	[2022-41],	[2022-42],	[2022-43],	[2022-44],	[2022-45],	[2022-46],	[2022-47],	[2022-48],	[2022-49],	[2022-50],	[2022-51],	[2022-52],	[2023-01],	[2023-02],	[2023-03],	[2023-04],	[2023-05],	[2023-06],	[2023-07],	[2023-08],	[2023-09],	[2023-10],	[2023-11],	[2023-12],	[2023-13]
 
   FROM SEV_TV_DEALER_FY2123) p  
UNPIVOT  
   (Value_ FOR Year_Week IN   
      ( [2021-40],	[2021-41],	[2021-42],	[2021-43],	[2021-44],	[2021-45],	[2021-46],	[2021-47],	[2021-48],	[2021-49],	[2021-50],	[2021-51],	[2021-52],	[2022-01],	[2022-02],	[2022-03],	[2022-04],	[2022-05],	[2022-06],	[2022-07],	[2022-08],	[2022-09],	[2022-10],	[2022-11],	[2022-12],	[2022-13],	[2022-14],	[2022-15],	[2022-16],	[2022-17],	[2022-18],	[2022-19],	[2022-20],	[2022-21],	[2022-22],	[2022-23],	[2022-24],	[2022-25],	[2022-26],	[2022-27],	[2022-28],	[2022-29],	[2022-30],	[2022-31],	[2022-32],	[2022-33],	[2022-34],	[2022-35],	[2022-36],	[2022-37],	[2022-38],	[2022-39],	[2022-40],	[2022-41],	[2022-42],	[2022-43],	[2022-44],	[2022-45],	[2022-46],	[2022-47],	[2022-48],	[2022-49],	[2022-50],	[2022-51],	[2022-52],	[2023-01],	[2023-02],	[2023-03],	[2023-04],	[2023-05],	[2023-06],	[2023-07],	[2023-08],	[2023-09],	[2023-10],	[2023-11],	[2023-12],	[2023-13]
 )  
)AS unpvt


SELECT *

FROM SEV_TV_DEALER_FY2123
WHERE [Account Group Name] = 'CTY THE GIOI DI DONG'
AND [MKT Kataban] = 'KD-32W830K'


-- Step 1 / Create table from iport table
DROP TABLE IF EXISTS TEMP1
SELECT 
 DISTINCT Z_KEY, [Sold-to Party], NoName1, Material, NoName, [Claim Date], Z_QTY
 INTO TEMP1
from [20231129 PASR FY22 H1]
UNION 
SELECT 
 DISTINCT Z_KEY, [Sold-to Party], NoName1, Material, NoName, [Claim Date], Z_QTY
from [20231129 PASR FY22 H2]
UNION 
SELECT 
 DISTINCT [KEY], [Sold-to Party], NoName1, Material, NoName, [Claim Date], [BW PASR Qty]
FROM [PASR FY23 Q1]
UNION 
SELECT 
 DISTINCT [KEY], [Sold-to Party], NoName1, Material, NoName, [Claim Date], [BW PASR Qty]
FROM [PASR FY23 Q2]
UNION 
SELECT 
 DISTINCT [KEY], [Sold-to Party], NoName1, Material, NoName, [Claim Date], [BW PASR Qty]
FROM [PASR FY23 Q2]



-- STEP 2 / GET RECORD IF [Sold-to Party]

DELETE FROM TEMP1
WHERE Z_QTY = 0 OR Z_QTY IS NULL

ALTER TABLE TEMP1 ADD ZF_SPWOC VARCHAR(10)

UPDATE TEMP1
SET ZF_SPWOC = CONCAT(RIGHT('00' + CONVERT(VARCHAR(2), DATEPART(ISO_WEEK, [Claim Date])), 2),'.', YEAR([Claim Date]))

SELECT DISTINCT [Claim Date] , ZF_SPWOC  FROM TEMP1
WHERE DATEPART(ISO_WEEK, [Claim Date]) IN (51,52,52)
AND MONTH([Claim Date]) = 1

UPDATE TEMP1
SET ZF_SPWOC = '52.2022'
WHERE ZF_SPWOC = '52.2023'

-- Step 3 / Create table to group by vaulue

DROP TABLE IF EXISTS TEMP2
SELECT [Sold-to Party],  DBO.REMOVE_LEADING_ZEROES(Material)  AS Material, ZF_SPWOC,  ROUND(SUM(Z_QTY),2) AS Z_QTY
INTO TEMP2
FROM TEMP1 
WHERE CONCAT([Sold-to Party], DBO.REMOVE_LEADING_ZEROES(Material))
IN
(
	SELECT DISTINCT CONCAT(B00_06_ZZSV_CMPTR, DBO.REMOVE_LEADING_ZEROES(B00_06_MATNR)) FROM B00_06_IT_SALE_IN_OUT_APPEND_COMPARE
	 
)
GROUP BY [Sold-to Party],  DBO.REMOVE_LEADING_ZEROES(Material)  , ZF_SPWOC



-----------------------------------------------INSERT VALUE----------------------------------------------------

DROP TABLE IF EXISTS TEMP3
SELECT DISTINCT *
INTO TEMP3
FROM B00_06_IT_SALE_IN_OUT_APPEND_COMPARE
WHERE B00_06_ZF_SALE_IN_OUT_FLAG <> 'BW PASR Qty'

-- insert value 

INSERT INTO TEMP3(B00_06_MATNR, B00_06_ZZSV_CMPTR,B00_06_SPWOC, B00_06_ZF_SALE_IN_OUT_FLAG, B00_06_ZF_SALE_IN_OUT_REPORT_VALUE) 
SELECT Material, [Sold-to Party], ZF_SPWOC, 'BW PASR Qty', Z_QTY
FROM TEMP2


----- UPDATE COLUMN

UPDATE  TEMP3  
SET 
		B00_06_ZF_CUSTOMER_MATER_COM_ROH_01_2019_ISNULL_0 = B.B00_06_ZF_CUSTOMER_MATER_COM_ROH_01_2019_ISNULL_0,  
		B00_06_ZF_CUSTOMER_MATER_CALC_NEGATIVE_VALUE = B.B00_06_ZF_CUSTOMER_MATER_CALC_NEGATIVE_VALUE,
		B00_06_NAME1 = B.B00_06_NAME1,
		B00_06_MATKL = B.B00_06_MATKL,
		B00_06_WGBEZ = B.B00_06_WGBEZ

FROM TEMP3  A  
	INNER JOIN   (   
	
			SELECT DISTINCT      B00_06_MATNR, B00_06_ZZSV_CMPTR,    B00_06_ZF_CUSTOMER_MATER_COM_ROH_01_2019_ISNULL_0,   
			B00_06_ZF_CUSTOMER_MATER_CALC_NEGATIVE_VALUE   ,B00_06_MATKL,B00_06_NAME1,B00_06_WGBEZ
			FROM TEMP3   
			where B00_06_ZF_SALE_IN_OUT_FLAG <> 'BW PASR Qty'   
			) AS B  
			ON A.B00_06_MATNR = B.B00_06_MATNR 
			AND A.B00_06_ZZSV_CMPTR = B.B00_06_ZZSV_CMPTR  
where B00_06_ZF_SALE_IN_OUT_FLAG = 'BW PASR Qty'


UPDATE  TEMP3  
SET 
		B00_06_ZF_ROW_NUMBER_SPWOC = B.B00_06_ZF_ROW_NUMBER_SPWOC

FROM TEMP3  A  
	INNER JOIN   (   
	
			SELECT DISTINCT      B00_06_MATNR, B00_06_ZZSV_CMPTR,    B00_06_ZF_CUSTOMER_MATER_COM_ROH_01_2019_ISNULL_0,   
			B00_06_ZF_CUSTOMER_MATER_CALC_NEGATIVE_VALUE   ,B00_06_MATKL,B00_06_NAME1,B00_06_WGBEZ, B00_06_SPWOC, B00_06_ZF_ROW_NUMBER_SPWOC
			FROM TEMP3   
			where B00_06_ZF_SALE_IN_OUT_FLAG <> 'BW PASR Qty'   
			) AS B  
			ON A.B00_06_MATNR = B.B00_06_MATNR 
			AND A.B00_06_ZZSV_CMPTR = B.B00_06_ZZSV_CMPTR  
			AND A.B00_06_SPWOC = B.B00_06_SPWOC
where B00_06_ZF_SALE_IN_OUT_FLAG = 'BW PASR Qty'


----------------------------------------

-- STEP 6 / UPDATE VALUE ASB FOR BW PASR Qty

update TEMP3
set B00_06_ZF_SALE_IN_OUT_REPORT_VALUE = abs(B00_06_ZF_SALE_IN_OUT_REPORT_VALUE)
WHERE B00_06_ZF_SALE_IN_OUT_FLAG = 'BW PASR Qty'


ZF_FLAG_CLAIM_PASR	ZF_FLAG_BW_GREATER_CLAIM
No	No

ALTER TABLE TEMP3 DROP COLUMN ZF_FLAG_CLAIM_PASR
ALTER TABLE TEMP3 DROP COLUMN ZF_FLAG_BW_GREATER_CLAIM

ALTER TABLE TEMP3 ADD  ZF_FLAG_CLAIM_PASR NVARCHAR(3)
ALTER TABLE TEMP3 ADD ZF_FLAG_BW_GREATER_CLAIM   NVARCHAR(3)

UPDATE TEMP3
SET ZF_FLAG_CLAIM_PASR = 'No',ZF_FLAG_BW_GREATER_CLAIM = 'No'
 

UPDATE TEMP3 
SET ZF_FLAG_CLAIM_PASR = 'Yes' 
FROM TEMP3 A   
INNER JOIN ( 
	select    A.*  FROM TEMP3 A 
	INNER JOIN 
	(   
	select    *   FROM TEMP3   
	WHERE B00_06_ZF_SALE_IN_OUT_FLAG = 'BW PASR Qty'  
	) as B  
	ON A.B00_06_ZZSV_CMPTR = B.B00_06_ZZSV_CMPTR  
	AND A.B00_06_MATNR = B.B00_06_MATNR  
	AND A.B00_06_SPWOC = B.B00_06_SPWOC 
	AND A.B00_06_ZF_SALE_IN_OUT_REPORT_VALUE =
	B.B00_06_ZF_SALE_IN_OUT_REPORT_VALUE 
	WHERE A.B00_06_ZF_SALE_IN_OUT_FLAG = 'Claim'  
	) AS B  
	ON A.B00_06_ZZSV_CMPTR = B.B00_06_ZZSV_CMPTR  
	AND A.B00_06_MATNR = B.B00_06_MATNR  
	AND A.B00_06_SPWOC = B.B00_06_SPWOC




UPDATE TEMP3 
SET ZF_FLAG_BW_GREATER_CLAIM = 'Yes' 
FROM TEMP3 A   
INNER JOIN ( 
	select    A.*  FROM TEMP3 A 
	INNER JOIN 
	(   
	select    *   FROM TEMP3   
	WHERE B00_06_ZF_SALE_IN_OUT_FLAG = 'BW PASR Qty'  
	) as B  
	ON A.B00_06_ZZSV_CMPTR = B.B00_06_ZZSV_CMPTR  
	AND A.B00_06_MATNR = B.B00_06_MATNR  
	AND A.B00_06_SPWOC = B.B00_06_SPWOC 
	AND A.B00_06_ZF_SALE_IN_OUT_REPORT_VALUE < 	B.B00_06_ZF_SALE_IN_OUT_REPORT_VALUE 
	WHERE A.B00_06_ZF_SALE_IN_OUT_FLAG = 'Claim'  
	) AS B  
	ON A.B00_06_ZZSV_CMPTR = B.B00_06_ZZSV_CMPTR  
	AND A.B00_06_MATNR = B.B00_06_MATNR  
	AND A.B00_06_SPWOC = B.B00_06_SPWOC

---------------------------------test
ZF_FLAG_CLAIM_PASR

-- 26506
-- 21798
SELECT COUNT(*)
FROM B00_06_IT_SALE_IN_OUT_APPEND_COMPARE
WHERE B00_06_ZF_SALE_IN_OUT_FLAG = 'BW PASR Qty'  

---------------------------------------------------------------------------------------------------------------------------
B00_06_SPWOC
08.2020

select distinct right(B00_06_SPWOC,4), B00_06_SPWOC from B00_06_IT_SALE_IN_OUT_APPEND_COMPARE
where B00_06_ZF_SALE_IN_OUT_FLAG = 'BW PASR Qty'  


select DISTINCT B00_06_SPWOC FROM TEMP3






SELECT  B00_06_MATNR
		,B00_06_ZZSV_CMPTR
		,B00_06_SPWOC
		,B00_06_ZF_SALE_IN_OUT_FLAG
		,B00_06_ZF_SALE_IN_OUT_REPORT_VALUE
		,B00_06_NAME1
		,B00_06_MATKL
		,B00_06_WGBEZ
		,B00_06_ZF_CUSTOMER_MATER_CALC_NEGATIVE_VALUE
		,B00_06_ZF_CUSTOMER_MATER_COM_ROH_01_2019_ISNULL_0
		,ZF_FLAG_CLAIM_PASR
		,ZF_FLAG_BW_GREATER_CLAIM


FROM B00_06_IT_SALE_IN_OUT_APPEND_COMPARE
EXCEPT
SELECT    B00_06_MATNR
		,B00_06_ZZSV_CMPTR
		,B00_06_SPWOC
		,B00_06_ZF_SALE_IN_OUT_FLAG
		,B00_06_ZF_SALE_IN_OUT_REPORT_VALUE
		,B00_06_NAME1
		,B00_06_MATKL
		,B00_06_WGBEZ
		,B00_06_ZF_CUSTOMER_MATER_CALC_NEGATIVE_VALUE
		,B00_06_ZF_CUSTOMER_MATER_COM_ROH_01_2019_ISNULL_0
		,ZF_FLAG_CLAIM_PASR
		,ZF_FLAG_BW_GREATER_CLAIM
FROM TEMP3


-- BDPBX370	1004414	24.2022	61

SELECT *
FROM B00_06_IT_SALE_IN_OUT_APPEND_COMPARE
WHERE B00_06_ZZSV_CMPTR = '1004414' AND B00_06_SPWOC = '24.2022'
AND B00_06_MATNR = 'BDPBX370'  and B00_06_ZF_SALE_IN_OUT_FLAG = 'Calculated on hand stock'
union

SELECT *
FROM TEMP3
WHERE B00_06_ZZSV_CMPTR = '1004414' AND B00_06_SPWOC = '24.2022'
AND B00_06_MATNR = 'BDPBX370'  and B00_06_ZF_SALE_IN_OUT_FLAG = 'Calculated on hand stock'


select    A.*  FROM TEMP3 A 
INNER JOIN 
(   
	select    *   FROM TEMP3   
	WHERE B00_06_ZF_SALE_IN_OUT_FLAG = 'BW PASR Qty'  
) as B  
	ON A.B00_06_ZZSV_CMPTR = B.B00_06_ZZSV_CMPTR  
	AND A.B00_06_MATNR = B.B00_06_MATNR  
	AND A.B00_06_SPWOC = B.B00_06_SPWOC 
	AND A.B00_06_ZF_SALE_IN_OUT_REPORT_VALUE =
	B.B00_06_ZF_SALE_IN_OUT_REPORT_VALUE 
	WHERE A.B00_06_ZF_SALE_IN_OUT_FLAG = 'Claim'  
and  A.B00_06_ZZSV_CMPTR = '1004434' AND A.B00_06_SPWOC = '25.2022'
AND A.B00_06_MATNR = 'ACCVC1'-- and B00_06_ZF_SALE_IN_OUT_FLAG = 'Calculated on hand stock'





-- 1004386	HTA3000

SELECT *
FROM SUMMARY_PASR
WHERE [Sold-to Party] = '1004386' AND Material = 'HTA3000'

SELECT *
FROM TEMP1
WHERE [Sold-to Party] = '1004386' AND Material = 'HTA3000'
AND Z_QTY = -698

SELECT *
FROM TEMP2
WHERE [Sold-to Party] = '1004386' AND Material = 'HTA3000'
AND Z_QTY = -698


SELECT * FROM SUMMARY_PASR
WHERE [Sold-to Party] = '1004434'
AND Material = 'ILCE7RM3A/B'


-- 1000019	FW55BZ30J	01.2023	-1


SELECT * FROM TEMP1 
WHERE [Sold-to Party] = '1000019' AND Material = 'FW55BZ30J'


where Z_QTY = 0

-- 21798
-- 21786

SELECT 


-- 14194

DROP TABLE IF EXISTS TEMP3
SELECT DISTINCT *
INTO TEMP3
FROM B00_06_IT_SALE_IN_OUT_APPEND_COMPARE
WHERE B00_06_ZF_SALE_IN_OUT_FLAG <> 'BW PASR Qty'




ZF_FLAG_CLAIM_PASR
No

SELECT DISTINCT B00_06_ZF_ROW_NUMBER_SPWOC FROM 
B00_06_IT_SALE_IN_OUT_APPEND_COMPARE
WHERE B00_06_ZF_SALE_IN_OUT_FLAG <> 'BW PASR Qty'

----------- them du lieu
INSERT INTO TEMP3(B00_06_MATNR, B00_06_ZZSV_CMPTR,B00_06_SPWOC, B00_06_ZF_SALE_IN_OUT_FLAG, B00_06_ZF_SALE_IN_OUT_REPORT_VALUE) 
SELECT Material, [Sold-to Party], ZF_SPWOC, 'BW PASR Qty', Z_QTY
FROM TEMP2

SELECT COUNT(*) FROM SUMMARY_PASR
SELECT COUNT(*) FROM B00_06_IT_SALE_IN_OUT_APPEND_COMPARE
-- 21798

-- 2667798
-- 2653604
select 2653604 + 21798
-- 2675402


SELECT *
FROM TEMP3

B00_06_MATNR,
B00_06_ZZSV_CMPTR,
B00_06_SPWOC,
B00_06_ZF_ROW_NUMBER_SPWOC,
B00_06_ZF_SALE_IN_OUT_FLAG,
B00_06_ZF_SALE_IN_OUT_REPORT_VALUE,
B00_06_NAME1,
B00_06_MATKL,
B00_06_WGBEZ,
B00_06_ZF_CUSTOMER_MATER_CALC_NEGATIVE_VALUE,
B00_06_ZF_CUSTOMER_MATER_COM_ROH_01_2019_ISNULL_0

UPDATE  B00_06_IT_SALE_IN_OUT_APPEND_COMPARE  
SET B00_06_ZF_CUSTOMER_MATER_COM_ROH_01_2019_ISNULL_0 = B.B00_06_ZF_CUSTOMER_MATER_COM_ROH_01_2019_ISNULL_0,  
B00_06_ZF_CUSTOMER_MATER_CALC_NEGATIVE_VALUE = B.B00_06_ZF_CUSTOMER_MATER_CALC_NEGATIVE_VALUE     
FROM B00_06_IT_SALE_IN_OUT_APPEND_COMPARE  A  
	INNER JOIN   (   
	
			SELECT DISTINCT      B00_06_MATNR, B00_06_ZZSV_CMPTR,    B00_06_ZF_CUSTOMER_MATER_COM_ROH_01_2019_ISNULL_0,   
			B00_06_ZF_CUSTOMER_MATER_CALC_NEGATIVE_VALUE   
			FROM B00_06_IT_SALE_IN_OUT_APPEND_COMPARE   
			where B00_06_ZF_SALE_IN_OUT_FLAG <> 'BW PASR Qty'   
			) AS B  
			ON A.B00_06_MATNR = B.B00_06_MATNR 
			AND A.B00_06_ZZSV_CMPTR = B.B00_06_ZZSV_CMPTR  
where B00_06_ZF_SALE_IN_OUT_FLAG = 'BW PASR Qty'








DELETE FROM TEMP1
WHERE NOT EXISTS 
(
	SELECT TOP 1 1 
	FROM B00_06_IT_SALE_IN_OUT_APPEND_COMPARE
	WHERE CONCAT()
)

SELECT * FROM TEMP2
WHERE CONCAT([Sold-to Party], DBO.REMOVE_LEADING_ZEROES(Material))
NOT IN 
(

SELECT DISTINCT CONCAT([Sold-to Party], DBO.REMOVE_LEADING_ZEROES(Material)) FROM SUMMARY_PASR

)

SELECT * FROM SUMMARY_PASR

*/
GO
