USE [DIVA_SALE_IN_OUT]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE      PROCEDURE [dbo].[B00_IMPORT_DATA]
WITH EXECUTE AS CALLER
AS

/*
-- Step 1 / Handle sale in data. Append 

EXEC SP_REMOVE_TABLES 'B00_01_IT_SALE_IN'

SELECT 
	*
INTO B00_01_IT_SALE_IN
FROM [19 20 sell in data]   -- Sale in data from FY19 and FY20
UNION ALL
SELECT 
	*
FROM [21 22 sell in data]   -- Sale in data from FY21 21




SELECT 
	DISTINCT PKUNAG, ZZSV_CMPTR
FROM B00_01_IT_SALE_IN
WHERE PKUNAG <> ZZSV_CMPTR

-- Step 2 / Handle sale out data

EXEC SP_REMOVE_TABLES 'B00_02_IT_SALE_OUT'

SELECT  * 
INTO B00_02_IT_SALE_OUT
FROM [19 sell out data]
UNION ALL
SELECT  * FROM [20 sell out]
UNION ALL
SELECT  * FROM [21 sell out]

-- Step 3 / Handle material group table.

EXEC SP_REMOVE_TABLES 'B00_03_IT_MATERIAL_GROUP'

SELECT 
	A.*,
	B.WGBEZ
INTO B00_03_IT_MATERIAL_GROUP
FROM [SNA material groups] A 
LEFT JOIN [SNA material group texts] B ON A.MATKL = B.MATKL
WHERE LEN(A.MATNR) <> 0 AND A.MATNR IS NOT NULL


-- Step 4 / Handle Customer table
EXEC SP_REMOVE_TABLES 'B00_04_IT_CUSTOMER'

SELECT 
DISTINCT 
	*
INTO B00_04_IT_CUSTOMER
FROM [SNA customer names]
WHERE KUNNR IS NOT NULL AND LEN(KUNNR) <> 0

-- We have 4 customer where ZZSV_CMPTR <> PKUNAG

-- 1504 PKUNAG found in B00_04_IT_CUSTOMER table.

SELECT 
	COUNT(DISTINCT PKUNAG)
FROM B00_01_IT_SALE_IN
WHERE EXISTS 
(	
	SELECT TOP 1 1 
	FROM B00_04_IT_CUSTOMER
	WHERE PKUNAG = KUNNR
)

-- 1507 ZZSV_CMPTR found in B00_04_IT_CUSTOMER table.

SELECT 
	COUNT(DISTINCT ZZSV_CMPTR)
FROM B00_01_IT_SALE_IN
WHERE EXISTS 
(	
	SELECT TOP 1 1 
	FROM B00_04_IT_CUSTOMER
	WHERE ZZSV_CMPTR = KUNNR
)

-- List of customer in sale in not in customer table
/*
1048
1070014
1080078
1102
1107807
1112370
1115854
1118
1160
129
1372
1373
1910
472
630001857
630001866
630001867
630005344
630005348
630005358
630005363
630005570
630005916
630006372
630006636
630007121
630007383
630007617
630007618
630007897
630008345
630008590
630009872
630009922
630009997
630011325
630012189
630012435
630013088
630013093
706
8
901
*/

SELECT 
	DISTINCT ZZSV_CMPTR
FROM B00_01_IT_SALE_IN
WHERE NOT EXISTS 
(	
	SELECT TOP 1 1 
	FROM B00_04_IT_CUSTOMER
	WHERE ZZSV_CMPTR = KUNNR
)


----- Special cases

/*
07.2019	2000	XBR55X900F
40.2020	2000	MCSSUBSCRIPT
40.2020	2000	MCSUSAGE

*/

-- 414022 : Number of records in full sale in data.

/*
07.2019	2000	XBR55X900F
40.2020	2000	MCSSUBSCRIPT
40.2020	2000	MCSUSAGE
*/
-- Sum only 1 line
-- 

SELECT distinct 
	SPWOC, ZZSV_CMPTR, MATNR
FROM B00_01_IT_SALE_IN
GROUP BY 
SPWOC, ZZSV_CMPTR, MATNR
HAVING COUNT(*) > 1


SELECT 
*
FROM B00_01_IT_SALE_IN
WHERE SPWOC = '07.2019' AND ZZSV_CMPTR = '2000' AND MATNR = 'XBR55X900F'

SELECT 
*
FROM B00_01_IT_SALE_IN
WHERE SPWOC = '40.2020' AND ZZSV_CMPTR = '2000' AND MATNR = 'MCSSUBSCRIPT'

SELECT 
*
FROM B00_01_IT_SALE_IN
WHERE SPWOC = '40.2020' AND ZZSV_CMPTR = '2000' AND MATNR = 'MCSUSAGE'



SELECT 
	SPWOC, ZZSV_CMPTR, MATNR
FROM B00_02_IT_SALE_OUT
GROUP BY SPWOC, ZZSV_CMPTR, MATNR
HAVING COUNT(*
) > 1




-----------------------------------------------------------------------CUBE------------------------------------------------------
-- Step 5 / For each SPWOC, MATNR, ZZSV_CMPTR need to sum quantity.

EXEC SP_REMOVE_TABLES 'B00_05_TT_SALE_IN_OUT_APPEND_TEMP'

-- Sale out data.
SELECT 
	SPWOC, 
	ZZSV_CMPTR, 
	MATNR,
	SUM(ZZSV_QTYTC) AS ZF_SALE_IN_OUT_REPORT_VALUE,
	'Sale out' AS ZF_SALE_IN_OUT_FLAG
INTO B00_05_TT_SALE_IN_OUT_APPEND_TEMP
FROM B00_02_IT_SALE_OUT
GROUP BY SPWOC, ZZSV_CMPTR, MATNR
UNION
-- Sale in data.
SELECT 
	SPWOC, 
	ZZSV_CMPTR, 
	MATNR,
	SUM(FKIMG) ,
	'Sale in' AS ZF_SALE_IN_OUT_REPORT_VALUE
FROM B00_01_IT_SALE_IN
GROUP BY SPWOC, ZZSV_CMPTR, MATNR
UNION
-- Reported on hand stock
SELECT 
	SPWOC, 
	ZZSV_CMPTR, 
	MATNR,
	SUM(ZZSV_CHINV),
	'Reported on hand stock' AS ZF_SALE_IN_OUT_FLAG
FROM B00_02_IT_SALE_OUT
GROUP BY SPWOC, ZZSV_CMPTR, MATNR


-- 1780945

-- Step 6 / Add material text + customer txt.

EXEC SP_REMOVE_TABLES 'B00_06_IT_SALE_IN_OUT_APPEND'
-- 1780945
SELECT 

	A.*,
	B.MATKL,
	B.WGBEZ,
	C.LAND1,
	C.NAME1,
	D.ZF_NUMBERICAL_ORDER,
	D.ZF_SPWOC_WEEK,
	D.ZF_SPWOC_YEAR,
	CAST('No' AS NVARCHAR(3)) AS ZF_ONLY_SALE_IN,
	CAST('No' AS NVARCHAR(3)) AS ZF_ONLY_SALE_OUT,
	CAST('No' AS NVARCHAR(3)) AS ZF_QUANTITY_EQUAL_0,
	IIF( A.SPWOC = E.ZF_SPWOC, 'Yes','No') AS ZF_MAX_SPWOC_EACH_MATNR_CMPTR
INTO B00_06_IT_SALE_IN_OUT_APPEND
FROM B00_05_TT_SALE_IN_OUT_APPEND_TEMP A 
LEFT JOIN B00_03_IT_MATERIAL_GROUP B ON A.MATNR = B.MATNR
LEFT JOIN B00_04_IT_CUSTOMER C ON A.ZZSV_CMPTR = C.KUNNR
LEFT JOIN 
(

	SELECT 
	*,
	ROW_NUMBER () OVER( ORDER BY ZF_SPWOC_YEAR, ZF_SPWOC_WEEK) AS ZF_NUMBERICAL_ORDER
	FROM (
	SELECT 
		DISTINCT 
			RIGHT(SPWOC,4) AS ZF_SPWOC_YEAR,
			LEFT(SPWOC,2 ) AS ZF_SPWOC_WEEK,
			SPWOC
	FROM B00_05_TT_SALE_IN_OUT_APPEND_TEMP
	) AS A
) AS D ON D.SPWOC = A.SPWOC
LEFT JOIN 
(
	SELECT 
		A.MATNR, A.ZZSV_CMPTR,  MAX(ZF_SPWOC_WEEK)+'.'+A.ZF_SPWOC_YEAR AS ZF_SPWOC
	FROM  (
	SELECT 
		DISTINCT 
				RIGHT(SPWOC,4) AS ZF_SPWOC_YEAR,
				LEFT(SPWOC,2 ) AS ZF_SPWOC_WEEK,
				MATNR,
				ZZSV_CMPTR
	FROM B00_05_TT_SALE_IN_OUT_APPEND_TEMP
	WHERE ZF_SALE_IN_OUT_FLAG = 'Reported on hand stock'
	) AS A
	GROUP BY A.MATNR, A.ZZSV_CMPTR, A.ZF_SPWOC_YEAR
) AS E ON A.MATNR = E.MATNR AND A.ZZSV_CMPTR = E.ZZSV_CMPTR AND A.SPWOC = E.ZF_SPWOC



UPDATE B00_06_IT_SALE_IN_OUT_APPEND
SET ZF_ONLY_SALE_IN = 'Yes'
FROM B00_06_IT_SALE_IN_OUT_APPEND A
WHERE ZF_SALE_IN_OUT_FLAG = 'Sale in'
AND ZF_SALE_IN_OUT_REPORT_VALUE <> 0
AND NOT EXISTS 
(
	SELECT DISTINCT ZZSV_CMPTR+ZZSV_CMPTR
	FROM B00_06_IT_SALE_IN_OUT_APPEND B 
	WHERE ZF_SALE_IN_OUT_FLAG <> 'Sale in' 
	AND ZF_SALE_IN_OUT_REPORT_VALUE <> 0
	AND A.ZZSV_CMPTR = B.ZZSV_CMPTR
	AND A.MATNR = B.MATNR
)


UPDATE B00_06_IT_SALE_IN_OUT_APPEND
SET ZF_ONLY_SALE_OUT = 'Yes'
FROM B00_06_IT_SALE_IN_OUT_APPEND A
WHERE ZF_SALE_IN_OUT_FLAG = 'Sale out'
AND ZF_SALE_IN_OUT_REPORT_VALUE <> 0
AND NOT EXISTS 
(
	SELECT DISTINCT ZZSV_CMPTR+ZZSV_CMPTR
	FROM B00_06_IT_SALE_IN_OUT_APPEND B 
	WHERE ZF_SALE_IN_OUT_FLAG = 'Sale in' 
	AND A.ZZSV_CMPTR = B.ZZSV_CMPTR
	AND A.MATNR = B.MATNR
	AND ZF_SALE_IN_OUT_REPORT_VALUE <> 0
)
AND NOT EXISTS
(
	SELECT DISTINCT ZZSV_CMPTR+ZZSV_CMPTR
	FROM B00_06_IT_SALE_IN_OUT_APPEND B 
	WHERE ZF_SALE_IN_OUT_FLAG = 'Reported on hand stock' 
	AND A.ZZSV_CMPTR = B.ZZSV_CMPTR
	AND A.MATNR = B.MATNR	
	AND ZF_SALE_IN_OUT_REPORT_VALUE <> 0
)


UPDATE B00_06_IT_SALE_IN_OUT_APPEND
SET ZF_QUANTITY_EQUAL_0 = 'Yes'
WHERE ZF_SALE_IN_OUT_REPORT_VALUE = 0



select 
*
FROM B00_06_IT_SALE_IN_OUT_APPEND
WHERE ZF_ONLY_SALE_OUT = 'Yes'

-- Rename field before load into Qliksense

EXEC SP_UNNAME_FIELD 'B00_01' , 'B00_01_IT_SALE_IN'

EXEC SP_UNNAME_FIELD 'B00_02' , 'B00_02_IT_SALE_OUT'

EXEC SP_UNNAME_FIELD 'B00_02' , 'B00_06_IT_SALE_IN_OUT_APPEND'


EXEC sp_RENAME_FIELD 'B00_01_', 'B00_01_IT_SALE_IN'

EXEC sp_RENAME_FIELD 'B00_02_', 'B00_02_IT_SALE_OUT'

EXEC sp_RENAME_FIELD 'B00_06_', 'B00_06_IT_SALE_IN_OUT_APPEND'


B00_06_ZF_SALE_IN_OUT_REPORT_VALUE
0
SELECT 
	TOP 10 *,
	CASE 
		WHEN B00_06_ZF_SALE_IN_OUT_REPORT_VALUE < 10 THEN 'A' 
		WHEN 
			CASE WHEN B00_06_ZF_SALE_IN_OUT_REPORT_VALUE > 0 THEN 'B'
			END 
	END
FROM B00_06_IT_SALE_IN_OUT_APPEND


SELECT 
	SPWOC, ZZSV_CMPTR, MATNR
FROM B00_01_IT_SALE_IN
GROUP BY SPWOC, ZZSV_CMPTR, MATNR
HAVING COUNT(*
) > 1


SELECT 
*
FROM B00_01_IT_SALE_IN
WHERE B00_01_SPWOC = '01.2019' AND B00_01_ZZSV_CMPTR = '1004434' AND B00_01_MATNR = 'ACCTRBX'
ORDER BY B00_01_SPWOC

SELECT 
*
FROM B00_02_IT_SALE_OUT
WHERE B00_02_SPWOC = '01.2019' AND B00_02_ZZSV_CMPTR = '1004434' AND B00_02_MATNR = 'ACCTRBX'
ORDER BY B00_02_SPWOC

SELECT 
	SPWOC, ZZSV_CMPTR, MATNR
FROM B00_01_IT_SALE_IN
GROUP BY SPWOC, ZZSV_CMPTR, MATNR
HAVING COUNT(DISTINCT FKIMG
) > 1



SELECT 
*
FROM B00_01_IT_SALE_IN
WHERE B00_01_ZZSV_CMPTR = '1004434' AND B00_01_MATNR = 'ACCTRBX'



SELECT 
*
FROM B00_02_IT_SALE_OUT
WHERE B00_02_ZZSV_CMPTR = '1004434' AND B00_02_MATNR = 'ACCTRBX






SELECT 
	*,


FROM B00_05_TT_SALE_IN_OUT_APPEND_TEMP AS A
LEFT JOIN 
	(

		SELECT DISTINCT SPWOC, ZZSV_CMPTR, MATNR, ZF_SALE_IN_OUT_REPORT_VALUE AS ZF_SALE_IN
		FROM B00_05_TT_SALE_IN_OUT_APPEND_TEMP
		WHERE  [ZF_SALE_IN_OUT_FLAG] = 'Sale in'

	) AS B
LEFT JOIN 
	(

		SELECT DISTINCT SPWOC, ZZSV_CMPTR, MATNR, ZF_SALE_IN_OUT_REPORT_VALUE AS ZF_SALE_OUT
		FROM B00_05_TT_SALE_IN_OUT_APPEND_TEMP
		WHERE  [ZF_SALE_IN_OUT_FLAG] = 'Sale out'

	) AS C
ON A.SPWOC = C.SPWOC AND A.MATNR = C.MATNR AND A.ZZSV_CMPTR = C.ZZSV_CMPTR
WHERE [ZF_SALE_IN_OUT_FLAG] = 'Reported on hand stock'





---- 
EXEC SP_REMOVE_TABLES 'B00_05_TT_SALE_IN_OUT_TEMP'

SELECT 
	ISNULL(	A.SPWOC, B.SPWOC) AS SPWOC,
	ISNULL(	A.MATNR, B.MATNR)  AS MATNR,
	ISNULL(	A.ZZSV_CMPTR, B.ZZSV_CMPTR)  AS ZZSV_CMPTR,
	ISNULL(A.FKIMG,0) AS ZF_SALE_IN,
	ISNULL(B.ZZSV_QTYTC,0) AS ZF_SALE_OUT  ,
	ISNULL(B.ZZSV_CHINV,0) AS ZF_ROH
INTO B00_05_TT_SALE_IN_OUT_TEMP
FROM B00_01_IT_SALE_IN A
FULL  JOIN B00_02_IT_SALE_OUT B ON A.SPWOC = B.SPWOC AND A.MATNR = B.MATNR AND A.ZZSV_CMPTR = B.ZZSV_CMPTR




-- Step 3 : For each 

EXEC SP_REMOVE_TABLES 'B00_06_TT_SALE_IN_OUT_DESC'

SELECT 

	A.*,
	ROW_NUMBER () OVER( PARTITION BY A.MATNR, A.ZZSV_CMPTR ORDER BY RIGHT( A.SPWOC,4), LEFT(A.SPWOC,2) ASC) AS ZF_ROW_NUMBER_SPWOC,
	ZF_ROW_NUMBER_MATNR_CMPTR,
	B.MATKL,
	B.WGBEZ,
	C.LAND1,
	C.NAME1,
	D.ZF_NUMBERICAL_ORDER,
	D.ZF_SPWOC_WEEK,
	D.ZF_SPWOC_YEAR
INTO B00_06_TT_SALE_IN_OUT_DESC
FROM B00_05_TT_SALE_IN_OUT_TEMP A 
LEFT JOIN B00_03_IT_MATERIAL_GROUP B ON A.MATNR = B.MATNR
LEFT JOIN B00_04_IT_CUSTOMER C ON A.ZZSV_CMPTR = C.KUNNR
LEFT JOIN 
(

	SELECT 
	*,
	ROW_NUMBER () OVER( ORDER BY ZF_SPWOC_YEAR, ZF_SPWOC_WEEK) AS ZF_NUMBERICAL_ORDER
	FROM (
	SELECT 
		DISTINCT 
			RIGHT(SPWOC,4) AS ZF_SPWOC_YEAR,
			LEFT(SPWOC,2 ) AS ZF_SPWOC_WEEK,
			SPWOC
	FROM B00_05_TT_SALE_IN_OUT_TEMP
	) AS A
) AS D ON D.SPWOC = A.SPWOC
LEFT JOIN
(
	SELECT 
		*,
	ROW_NUMBER () OVER( ORDER BY MATNR, ZZSV_CMPTR) AS ZF_ROW_NUMBER_MATNR_CMPTR
	FROM (
		SELECT DISTINCT 
			MATNR,
			ZZSV_CMPTR
		FROM B00_05_TT_SALE_IN_OUT_TEMP
	) AS A 
) AS E ON A.MATNR = E.MATNR AND A.ZZSV_CMPTR = E.ZZSV_CMPTR





-- Step 6 : Handle ROH update.

EXEC SP_REMOVE_TABLES 'B00_06_IT_SALE_IN_OUT_ROH_FULL'

SELECT 
	*,
	ZF_ROH AS ZF_ROH_UPDATE
INTO B00_06_IT_SALE_IN_OUT_ROH_FULL
FROM B00_06_TT_SALE_IN_OUT_DESC
WHERE CONCAT(ZF_SPWOC_YEAR,MATNR,ZZSV_CMPTR,ZF_ROW_NUMBER) IN (
SELECT 
	CONCAT(ZF_SPWOC_YEAR,MATNR,ZZSV_CMPTR,MIN(ZF_ROW_NUMBER))
FROM B00_06_TT_SALE_IN_OUT_DESC
GROUP BY ZF_SPWOC_YEAR, MATNR, ZZSV_CMPTR
)
UNION
(
	SELECT 
		A.*,
		(  B.ZF_SALE_IN - B.ZF_SALE_OUT )    AS 	ZF_ROH_UPDATE
	FROM B00_06_TT_SALE_IN_OUT_DESC A
	INNER JOIN B00_06_TT_SALE_IN_OUT_DESC B
		ON A.ZF_SPWOC_YEAR = B.ZF_SPWOC_YEAR AND A.MATNR = B.MATNR
		AND A.ZZSV_CMPTR = B.ZZSV_CMPTR AND A.ZF_ROW_NUMBER -1  = B.ZF_ROW_NUMBER 

)

SELECT 
	*
FROM B00_06_TT_SALE_IN_OUT_DESC
WHERE ZZSV_CMPTR = '1004434' AND MATNR = 'AXSAR1'

DROP TABLE TEMP2

SELECT TOP  0 ZF_ROW_NUMBER_MATNR_CMPTR as ZF_KEY, ZF_ROW_NUMBER_SPWOC ,  0 AS ZF_ROH_UPDATE INTO TEMP2 FROM B00_06_TT_SALE_IN_OUT_DESC



DROP TABLE TEMP1
SELECT 
	DISTINCT top 20
	ZF_ROW_NUMBER_MATNR_CMPTR
INTO TEMP1
FROM B00_06_TT_SALE_IN_OUT_DESC
WHERE ZZSV_CMPTR = '1004434' AND MATNR = 'AXSAR1'


SELECT *
FROM B00_06_TT_SALE_IN_OUT_DESC
WHERE ZF_SALE_IN = 0 AND 

DROP TABLE TEMP2

SELECT TOP  0 ZF_ROW_NUMBER_MATNR_CMPTR as ZF_KEY, ZF_ROW_NUMBER_SPWOC ,  0 AS ZF_ROH_UPDATE INTO TEMP2 FROM B00_06_TT_SALE_IN_OUT_DESC



DROP TABLE TEMP1
SELECT 
	DISTINCT top 20
	ZF_ROW_NUMBER_MATNR_CMPTR
INTO TEMP1
FROM B00_06_TT_SALE_IN_OUT_DESC


DECLARE @MATNR_CMPTR NVARCHAR(100) = '';
DECLARE @ROH INT = 0;
DECLARE @COUNT INT = 0

WHILE EXISTS(SELECT * FROM TEMP1) 

BEGIN

	SET @COUNT = 1
	SET @MATNR_CMPTR =  (SELECT TOP 1 ZF_ROW_NUMBER_MATNR_CMPTR FROM TEMP1)
	EXEC SP_REMOVE_TABLES 'TEMP3'
	SELECT DISTINCT ZF_ROW_NUMBER_MATNR_CMPTR AS ZF_KEY, ZF_SALE_IN, ZF_SALE_OUT, ZF_ROH, ZF_ROW_NUMBER_SPWOC
	INTO TEMP3 
	FROM  B00_06_TT_SALE_IN_OUT_DESC WHERE ZF_ROW_NUMBER_MATNR_CMPTR = @MATNR_CMPTR

	SET @ROH = ( SELECT TOP 1 ZF_ROH FROM TEMP3 WHERE ZF_ROW_NUMBER_SPWOC = 1)
	WHILE @COUNT <= (SELECT COUNT(*) FROM TEMP3) 
		BEGIN
			INSERT INTO TEMP2 
			SELECT 
				ZF_KEY,
				@COUNT,
				@ROH + ZF_SALE_IN - ZF_SALE_OUT
			FROM TEMP3
			WHERE @COUNT = ZF_ROW_NUMBER_SPWOC  

			SET @ROH = (SELECT ZF_ROH_UPDATE FROM TEMP2 WHERE ZF_ROW_NUMBER_SPWOC = @COUNT and ZF_KEY = @MATNR_CMPTR)
			SET @COUNT = @COUNT + 1
		END
	DELETE FROM TEMP1
	WHERE ZF_ROW_NUMBER_MATNR_CMPTR = @MATNR_CMPTR
END

EXEC SP_REMOVE_TABLES 'TEMP3';
EXEC SP_REMOVE_TABLES 'TEMP2';
DECLARE @TEMP1 TABLE (ZF_ROW_NUMBER_MATNR_CMPTR NVARCHAR(100));
DECLARE @TEMP3 TABLE (ZF_KEY NVARCHAR(100), ZF_SALE_IN INT, ZF_SALE_OUT INT, ZF_ROH INT, ZF_ROW_NUMBER_SPWOC INT);
DECLARE @TEMP2 TABLE (ZF_KEY NVARCHAR(100), ZF_ROW_NUMBER_SPWOC INT, ZF_ROH_UPDATE INT);

INSERT INTO @TEMP1
SELECT DISTINCT TOP 20 ZF_ROW_NUMBER_MATNR_CMPTR
FROM B00_06_TT_SALE_IN_OUT_DESC
WHERE ZZSV_CMPTR = '1004434' AND MATNR = 'AXSAR1';


INSERT INTO @TEMP2 (ZF_KEY, ZF_ROW_NUMBER_SPWOC, ZF_ROH_UPDATE)
SELECT ZF_ROW_NUMBER_MATNR_CMPTR, 0, 0
FROM B00_06_TT_SALE_IN_OUT_DESC
WHERE 1 = 0; -- create an empty table

WHILE EXISTS(SELECT * FROM @TEMP1) 
BEGIN
    DECLARE @MATNR_CMPTR NVARCHAR(100);
    DECLARE @ROH INT = 0;
    
    SELECT TOP 1 @MATNR_CMPTR = ZF_ROW_NUMBER_MATNR_CMPTR
    FROM @TEMP1;
   
    INSERT INTO @TEMP3 (ZF_KEY, ZF_SALE_IN, ZF_SALE_OUT, ZF_ROH, ZF_ROW_NUMBER_SPWOC)
    SELECT ZF_ROW_NUMBER_MATNR_CMPTR, ZF_SALE_IN, ZF_SALE_OUT, ZF_ROH, ZF_ROW_NUMBER_SPWOC
    FROM B00_06_TT_SALE_IN_OUT_DESC
    WHERE ZF_ROW_NUMBER_MATNR_CMPTR = @MATNR_CMPTR;
    
    SELECT @ROH = ZF_ROH
    FROM @TEMP3
    WHERE ZF_ROW_NUMBER_SPWOC = 1;
    
    WITH CTE_TEMP2 AS (
        SELECT 
            ZF_KEY,
            ROW_NUMBER() OVER (ORDER BY ZF_ROW_NUMBER_SPWOC) AS ZF_ROW_NUMBER_SPWOC,
            @ROH + ZF_SALE_IN - ZF_SALE_OUT AS ZF_ROH_UPDATE
        FROM @TEMP3
    )
    INSERT INTO @TEMP2 (ZF_KEY, ZF_ROW_NUMBER_SPWOC, ZF_ROH_UPDATE)
    SELECT ZF_KEY, ZF_ROW_NUMBER_SPWOC, ZF_ROH_UPDATE
    FROM CTE_TEMP2;
    
    DELETE FROM @TEMP1
    WHERE ZF_ROW_NUMBER_MATNR_CMPTR = @MATNR_CMPTR;
END

SELECT * INTO TEMP2
FROM @TEMP2;


SELECT 
*
FROM TEMP2





select 
ZF_ROW_NUMBER_MATNR_CMPTR
FROM B00_06_TT_SALE_IN_OUT_DESC
WHERE ZF_ROW_NUMBER_MATNR_CMPTR =   5834
GROUP BY ZF_ROW_NUMBER_MATNR_CMPTR
HAVING COUNT(DISTINCT ZF_ROW_NUMBER_SPWOC) > 1


select 
ZF_ROW_NUMBER_MATNR_CMPTR
FROM B00_06_TT_SALE_IN_OUT_DESC

GROUP BY ZF_ROW_NUMBER_MATNR_CMPTR, ZF_ROW_NUMBER_SPWOC
HAVING COUNT( *) > 1




ZF_KEY	ZF_ROW_NUMBER_SPWOC	ZF_ROH_UPDATE

truncate table temp2

SELECT * FROM TEMP2
ORDER	


WHERE ZZSV_CMPTR = '1004434' AND MATNR = 'AXSAR1' 

SELECT 

	*

FROM B00_06_TT_SALE_IN_OUT_DESC
WHERE ZZSV_CMPTR = '1004434' AND MATNR = 'AXSAR1' 
ORDER BY ZF_SPWOC_YEAR, ZF_SPWOC_WEEK



SET @MATNR_CMPTR =  (SELECT TOP 1 CONCAT( MATNR,ZZSV_CMPTR,ZF_SPWOC_YEAR) FROM TEMP1)

SET @COUNT_TABLE =  (SELECT TOP 1 ZF_ROW_NUMBER FROM B00_06_TT_SALE_IN_OUT_DESC WHERE CONCAT( MATNR,ZZSV_CMPTR,ZF_SPWOC_YEAR) = @MATNR_CMPTR ORDER BY ZF_ROW_NUMBER DESC)

PRINT @COUNT_TABLE



ORDER BY ZF_SPWOC_YEAR, ZF_SPWOC_WEEK


SELECT 
	SPWOC, MATNR, ZZSV_CMPTR
FROM B00_06_TT_SALE_IN_OUT_DESC
GROUP BY SPWOC, MATNR, ZZSV_CMPTR





-- 1629768

ZF_ROW_NUMBER
3

SELECT 
B.ZF_ROW_NUMBER,
	A.*
	
FROM B00_06_IT_SALE_IN_OUT_APPEND A
INNER JOIN B00_06_IT_SALE_IN_OUT_APPEND B
	ON RIGHT(A.SPWOC,4) = RIGHT(B.SPWOC,4) AND A.MATNR = B.MATNR
	AND A.ZZSV_CMPTR = B.ZZSV_CMPTR AND A.ZF_ROW_NUMBER = B.ZF_ROW_NUMBER - 1
WHERE A.ZZSV_CMPTR = '1028049' AND A.MATNR = '100CDQ80RS' 




EXEC SP_REMOVE_TABLES 'B00_05_TT_SALE_IN_OUT_TEMP'

SELECT 
	SPWOC,
	ZF_ROW_NUMBER_SPWOC,
	MATNR,
	ZZSV_CMPTR,
	ZF_SALE_IN as 'Sale in',
	ZF_SALE_OUT as 'Sale out',
	ZF_ROH as 'Reported on hand stock',
	SUM (ZF_CALCULATED_ON_HANDLE) OVER (PARTITION BY MATNR,ZZSV_CMPTR  ORDER BY ZF_ROW_NUMBER_SPWOC) as 'Calculated on hand stock'
INTO B00_05_TT_SALE_IN_OUT_TEMP
FROM 
	(

	SELECT *,
		CASE WHEN SPWOC = '01.2019' AND ZF_ROW_NUMBER_SPWOC = 1 THEN ZF_ROH
		
			 ELSE  ZF_SALE_IN - ZF_SALE_OUT
		END AS ZF_CALCULATED_ON_HANDLE
	FROM (

		SELECT 
			*,
			ROW_NUMBER () OVER( PARTITION BY A.MATNR, A.ZZSV_CMPTR ORDER BY RIGHT( A.SPWOC,4), LEFT(A.SPWOC,2) ASC) AS ZF_ROW_NUMBER_SPWOC
		FROM
		(
		SELECT 
			ISNULL(	A.SPWOC, B.SPWOC) AS SPWOC,
			ISNULL(	A.MATNR, B.MATNR)  AS MATNR,
			ISNULL(	A.ZZSV_CMPTR, B.ZZSV_CMPTR)  AS ZZSV_CMPTR,
			ISNULL(A.FKIMG,0) AS ZF_SALE_IN,
			ISNULL(B.ZZSV_QTYTC,0) AS ZF_SALE_OUT  ,
			ISNULL(B.ZZSV_CHINV,0) AS ZF_ROH

		FROM B00_01_IT_SALE_IN A
		FULL  JOIN B00_02_IT_SALE_OUT B ON A.SPWOC = B.SPWOC AND A.MATNR = B.MATNR AND A.ZZSV_CMPTR = B.ZZSV_CMPTR
		)AS A
	) AS A
) AS A

-- 



-- Unpivot the table.  
DROP TABLE B00_06_IT_SALE_IN_OUT_APPEND
SELECT  MATNR,ZZSV_CMPTR, SPWOC, ZF_ROW_NUMBER_SPWOC, ZF_SALE_IN_OUT_FLAG, ZF_SALE_IN_OUT_REPORT_VALUE
INTO B00_06_IT_SALE_IN_OUT_APPEND
FROM   
   (SELECT MATNR,ZZSV_CMPTR, SPWOC, ZF_ROW_NUMBER_SPWOC, [Sale in], [Sale out], [Reported on hand stock], [Calculated on hand stock]
   FROM B00_05_TT_SALE_IN_OUT_TEMP) p  
UNPIVOT  
   (ZF_SALE_IN_OUT_REPORT_VALUE FOR ZF_SALE_IN_OUT_FLAG IN   
      ( [Sale in], [Sale out], [Reported on hand stock], [Calculated on hand stock])  
)AS unpvt;  


ALTER TABLE B00_06_IT_SALE_IN_OUT_APPEND ADD ZF_CUSTOMER_MATER_COM_ROH_01_2019_ISNULL_0 NVARCHAR(3)


UPDATE B00_06_IT_SALE_IN_OUT_APPEND
SET ZF_CUSTOMER_MATER_COM_ROH_01_2019_ISNULL_0 = 'Yes'
WHERE B00_06_MATNR+B00_06_ZZSV_CMPTR IN (
select DISTINCT B00_06_MATNR+B00_06_ZZSV_CMPTR
from B00_06_IT_SALE_IN_OUT_APPEND
WHERE B00_06_SPWOC = '01.2019' AND B00_06_ZF_SALE_IN_OUT_FLAG
 = 'Reported on hand stock' AND ( B00_06_ZF_SALE_IN_OUT_REPORT_VALUE = 0 OR B00_06_ZF_SALE_IN_OUT_REPORT_VALUE IS NULL))


UPDATE B00_06_IT_SALE_IN_OUT_APPEND
SET ZF_CUSTOMER_MATER_COM_ROH_01_2019_ISNULL_0 = 'Yes'
WHERE B00_06_ZF_ROW_NUMBER_SPWOC = 1 AND B00_06_SPWOC <> '01.2019' 


*/
GO
