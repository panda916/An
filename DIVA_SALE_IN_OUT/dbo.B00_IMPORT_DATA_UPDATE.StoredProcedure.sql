USE [DIVA_SALE_IN_OUT]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE       PROCEDURE [dbo].[B00_IMPORT_DATA_UPDATE]
WITH EXECUTE AS CALLER
AS


/*

-- Store B00_06_IT_SALE_IN_OUT_APPEND table
-- 9327812
SELECT * INTO B00_06_IT_SALE_IN_OUT_APPEND_BK FROM B00_06_IT_SALE_IN_OUT_APPEND
-- Store B00_02_IT_SALE_OUT table
-- 2091283
SELECT * INTO B00_02_IT_SALE_OUT_BK FROM B00_02_IT_SALE_OUT
-- Store B00_01_IT_SALE_IN table
-- 481125
SELECT * INTO B00_01_IT_SALE_IN_BK FROM B00_01_IT_SALE_IN


-- Step 1 / Hanlde Sale in data

EXEC SP_REMOVE_TABLES 'B00_01_IT_SALE_IN'

SELECT 
	*
INTO B00_01_IT_SALE_IN
FROM [19 20 sell in data]   -- Sale in data from FY19 and FY20
UNION ALL
SELECT 
	*
FROM [21 22 sell in data]   -- Sale in data from FY21 21



-- Step 2 / Handle sale out data : 1815095

EXEC SP_REMOVE_TABLES 'B00_02_IT_SALE_OUT'

SELECT  * 
INTO B00_02_IT_SALE_OUT
FROM [19 sell out data]
UNION ALL
SELECT  * FROM [20 sell out]
UNION ALL
SELECT  * FROM [21 sell out]
UNION ALL
SELECT * FROM  [22 sell out data]



-----------------------------------------------------------------------CUBE------------------------------------------------------
-- Step 5 / For each SPWOC, MATNR, ZZSV_CMPTR need to sum quantity.

EXEC SP_REMOVE_TABLES 'B00_05_TT_SALE_IN_OUT_APPEND_TEMP'

-- Sale out data.
SELECT 
	SPWOC, 
	ZZSV_CMPTR, 
	MATNR,
	SUM(ZZSV_QTYTC) AS ZF_SALE_IN_OUT_REPORT_VALUE,
	'Sale out' AS ZF_SALE_IN_OUT_FLAG
INTO B00_05_TT_SALE_IN_OUT_APPEND_TEMP
FROM B00_02_IT_SALE_OUT
GROUP BY SPWOC, ZZSV_CMPTR, MATNR
UNION
-- Sale in data.
SELECT 
	SPWOC, 
	ZZSV_CMPTR, 
	MATNR,
	SUM(FKIMG) ,
	'Sale in' AS ZF_SALE_IN_OUT_REPORT_VALUE
FROM B00_01_IT_SALE_IN
GROUP BY SPWOC, ZZSV_CMPTR, MATNR
UNION
-- Reported on hand stock
SELECT 
	SPWOC, 
	ZZSV_CMPTR, 
	MATNR,
	SUM(ZZSV_CHINV),
	'Reported on hand stock' AS ZF_SALE_IN_OUT_FLAG
FROM B00_02_IT_SALE_OUT
GROUP BY SPWOC, ZZSV_CMPTR, MATNR


-- 1780945

-- Step 6 / Add material text + customer txt.

EXEC SP_REMOVE_TABLES 'B00_06_IT_SALE_IN_OUT_APPEND'
-- 1780945
SELECT 

	A.*,
	B.MATKL,
	B.WGBEZ,
	C.LAND1,
	C.NAME1,
	D.ZF_NUMBERICAL_ORDER,
	D.ZF_SPWOC_WEEK,
	D.ZF_SPWOC_YEAR
	--CAST('No' AS NVARCHAR(3)) AS ZF_ONLY_SALE_IN,
	--CAST('No' AS NVARCHAR(3)) AS ZF_ONLY_SALE_OUT,
	--CAST('No' AS NVARCHAR(3)) AS ZF_QUANTITY_EQUAL_0,
	--IIF( A.SPWOC = E.ZF_SPWOC, 'Yes','No') AS ZF_MAX_SPWOC_EACH_MATNR_CMPTR
INTO B00_06_IT_SALE_IN_OUT_APPEND
FROM B00_05_TT_SALE_IN_OUT_APPEND_TEMP A 
LEFT JOIN B00_03_IT_MATERIAL_GROUP B ON A.MATNR = B.MATNR
LEFT JOIN B00_04_IT_CUSTOMER C ON A.ZZSV_CMPTR = C.KUNNR
LEFT JOIN 
(

	SELECT 
	*,
	ROW_NUMBER () OVER( ORDER BY ZF_SPWOC_YEAR, ZF_SPWOC_WEEK) AS ZF_NUMBERICAL_ORDER
	FROM (
	SELECT 
		DISTINCT 
			RIGHT(SPWOC,4) AS ZF_SPWOC_YEAR,
			LEFT(SPWOC,2 ) AS ZF_SPWOC_WEEK,
			SPWOC
	FROM B00_05_TT_SALE_IN_OUT_APPEND_TEMP
	) AS A
) AS D ON D.SPWOC = A.SPWOC
LEFT JOIN 
(
	SELECT 
		A.MATNR, A.ZZSV_CMPTR,  MAX(ZF_SPWOC_WEEK)+'.'+A.ZF_SPWOC_YEAR AS ZF_SPWOC
	FROM  (
	SELECT 
		DISTINCT 
				RIGHT(SPWOC,4) AS ZF_SPWOC_YEAR,
				LEFT(SPWOC,2 ) AS ZF_SPWOC_WEEK,
				MATNR,
				ZZSV_CMPTR
	FROM B00_05_TT_SALE_IN_OUT_APPEND_TEMP
	WHERE ZF_SALE_IN_OUT_FLAG = 'Reported on hand stock'
	) AS A
	GROUP BY A.MATNR, A.ZZSV_CMPTR, A.ZF_SPWOC_YEAR
) AS E ON A.MATNR = E.MATNR AND A.ZZSV_CMPTR = E.ZZSV_CMPTR AND A.SPWOC = E.ZF_SPWOC
--------------------------------------------------Option 2 -----------------------------------------


EXEC SP_REMOVE_TABLES 'B00_05_TT_SALE_IN_OUT_TEMP'

SELECT 
	SPWOC,
	ZF_ROW_NUMBER_SPWOC,
	MATNR,
	ZZSV_CMPTR,
	ZF_SALE_IN as 'Sale in',
	ZF_SALE_OUT as 'Sale out',
	ZF_ROH as 'Reported on hand stock',
	SUM (ZF_CALCULATED_ON_HANDLE) OVER (PARTITION BY MATNR,ZZSV_CMPTR  ORDER BY ZF_ROW_NUMBER_SPWOC) as 'Calculated on hand stock'
INTO B00_05_TT_SALE_IN_OUT_TEMP
FROM 
	(

	SELECT *,
		CASE WHEN SPWOC = '01.2019' AND ZF_ROW_NUMBER_SPWOC = 1 THEN ZF_ROH
		
			 ELSE  ZF_SALE_IN - ZF_SALE_OUT
		END AS ZF_CALCULATED_ON_HANDLE
	FROM (

		SELECT 
			*,
			ROW_NUMBER () OVER( PARTITION BY A.MATNR, A.ZZSV_CMPTR ORDER BY RIGHT( A.SPWOC,4), LEFT(A.SPWOC,2) ASC) AS ZF_ROW_NUMBER_SPWOC
		FROM
		(
		SELECT 
			ISNULL(	A.SPWOC, B.SPWOC) AS SPWOC,
			ISNULL(	A.MATNR, B.MATNR)  AS MATNR,
			ISNULL(	A.ZZSV_CMPTR, B.ZZSV_CMPTR)  AS ZZSV_CMPTR,
			ISNULL(A.FKIMG,0) AS ZF_SALE_IN,
			ISNULL(B.ZZSV_QTYTC,0) AS ZF_SALE_OUT  ,
			ISNULL(B.ZZSV_CHINV,0) AS ZF_ROH

		FROM B00_01_IT_SALE_IN A
		FULL  JOIN B00_02_IT_SALE_OUT B ON A.SPWOC = B.SPWOC AND A.MATNR = B.MATNR AND A.ZZSV_CMPTR = B.ZZSV_CMPTR
		)AS A
	) AS A
) AS A

-- 



-- Unpivot the table.  
DROP TABLE B00_06_IT_SALE_IN_OUT_APPEND
SELECT  MATNR,ZZSV_CMPTR, SPWOC, ZF_ROW_NUMBER_SPWOC, ZF_SALE_IN_OUT_FLAG, ZF_SALE_IN_OUT_REPORT_VALUE
INTO B00_06_IT_SALE_IN_OUT_APPEND
FROM   
   (SELECT MATNR,ZZSV_CMPTR, SPWOC, ZF_ROW_NUMBER_SPWOC, [Sale in], [Sale out], [Reported on hand stock], [Calculated on hand stock]
   FROM B00_05_TT_SALE_IN_OUT_TEMP) p  
UNPIVOT  
   (ZF_SALE_IN_OUT_REPORT_VALUE FOR ZF_SALE_IN_OUT_FLAG IN   
      ( [Sale in], [Sale out], [Reported on hand stock], [Calculated on hand stock])  
)AS unpvt;  








-- B00_06_IT_SALE_IN_OUT_APPEND


SELECT COUNT(*)
FROM B00_06_IT_SALE_IN_OUT_APPEND_BK

-- 9327812
-- 3942261
DROP TABLE TEMP1
SELECT *
INTO TEMP1
FROM B00_06_IT_SALE_IN_OUT_APPEND
WHERE ZZSV_CMPTR = '1004386'
AND MATNR = 'KD43X720E'
AND RIGHT(SPWOC,4) = 2019
ORDER BY SPWOC



WITH TABLE1 AS 
(
SELECT 
	DISTINCT 
		MATNR,
		ZZSV_CMPTR,
		SPWOC,
		ZF_ROW_NUMBER_SPWOC,
		ZF_SALE_IN_OUT_REPORT_VALUE AS 'Sale out'
FROM TEMP1
WHERE ZF_SALE_IN_OUT_FLAG = 'Sale out'
), TABLE2 AS 
(
	SELECT 
		DISTINCT 
			MATNR,
			ZZSV_CMPTR,
			SPWOC,
			ZF_ROW_NUMBER_SPWOC,			
			ZF_SALE_IN_OUT_REPORT_VALUE AS 'Reported on hand stock'
	FROM TEMP1
	WHERE ZF_SALE_IN_OUT_FLAG = 'Reported on hand stock'

)
SELECT 
	TABLE1.*, TABLE2.[Reported on hand stock]
	INTO TEMP2
FROM TABLE1 INNER JOIN TABLE2
	ON TABLE1.MATNR = TABLE2.MATNR
	AND TABLE1.SPWOC = TABLE2.SPWOC
	AND TABLE1.ZZSV_CMPTR = TABLE2.ZZSV_CMPTR

DROP TABLE TEMP2

SELECT *
FROM TEMP2
-- ZF_ROW_NUMBER_SPWOC
--[Sale out]
-- [Reported on hand stock]

SELECT 
	*,
	--CASE
	--	WHEN count_valid_months = 0 OR (sale_out_next1 IS NULL OR sale_out_next2 IS NULL) THEN 0
	--	ELSE 
	--		ROUND( [Reported on hand stock] / (([Sale out] +sale_out_next1 +sale_out_next2 ) / 3),2)
	--END ,
	
	CASE
		WHEN count_valid_months = 0 OR (sale_out_next1 IS NULL OR sale_out_next2 IS NULL) THEN 0
		ELSE 
			ROUND( (([Sale out] +sale_out_next1 +sale_out_next2 ) / 3),2)
	END


FROM (

SELECT *,
    -- Ð?m s? tháng sale_out khác 0
    (CASE WHEN [Sale out] != 0 THEN 1 ELSE 0 END) +
    (CASE WHEN LEAD([Sale out], 1) OVER (ORDER BY ZF_ROW_NUMBER_SPWOC) != 0 THEN 1 ELSE 0 END) +
    (CASE WHEN LEAD([Sale out], 2) OVER (ORDER BY ZF_ROW_NUMBER_SPWOC) != 0 THEN 1 ELSE 0 END) AS count_valid_months

FROM (

SELECT 
    MATNR,
	ZZSV_CMPTR,
	SPWOC,
	ZF_ROW_NUMBER_SPWOC,
    [Reported on hand stock],
    IIF( [Sale out] < 0 , 0 ,[Sale out]) [Sale out],
    IIF( LEAD([Sale out], 1) OVER (ORDER BY ZF_ROW_NUMBER_SPWOC) < 0 , 0,LEAD([Sale out], 1) OVER (ORDER BY ZF_ROW_NUMBER_SPWOC) )
		AS sale_out_next1,
	IIF( LEAD([Sale out], 2) OVER (ORDER BY ZF_ROW_NUMBER_SPWOC) < 0 , 0,LEAD([Sale out], 1) OVER (ORDER BY ZF_ROW_NUMBER_SPWOC) )
		AS sale_out_next2

FROM TEMP2
) B


) B 

drop table B00_07_IT_ROH_SALES_OUT

SELECT *,
	CASE
		WHEN (sale_out_next1 IS NULL OR sale_out_next2 IS NULL) THEN NULL
		WHEN count_valid_months = 0  THEN 0
		ELSE 
		ROUND(
		
		(
			(
				IIF ( [Sale out] > 0, [Sale out], 0)
				+
				IIF ( sale_out_next1 > 0, sale_out_next1, 0)
				+
				IIF ( sale_out_next2 > 0, sale_out_next2, 0)
			) / 3
		),2)
	END avg_sale_out,

	CASE
		WHEN (sale_out_next1 IS NULL OR sale_out_next2 IS NULL) THEN NULL
		WHEN count_valid_months = 0  THEN 0
		ELSE 
		ROUND(
		[Reported on hand stock] / 
		(
			(
				IIF ( [Sale out] > 0, [Sale out], 0)
				+
				IIF ( sale_out_next1 > 0, sale_out_next1, 0)
				+
				IIF ( sale_out_next2 > 0, sale_out_next2, 0)
			) / 3
		),2)
	END as ROH_Saleout
	INTO B00_07_IT_ROH_SALES_OUT
FROM (
SELECT 
    MATNR,
	ZZSV_CMPTR,
	SPWOC,
	ZF_ROW_NUMBER_SPWOC,
    [Reported on hand stock],
    [Sale out],
    LEAD([Sale out], 1) OVER (PARTITION BY MATNR,ZZSV_CMPTR  ORDER BY ZF_ROW_NUMBER_SPWOC)	AS sale_out_next1,
	LEAD([Sale out], 2) OVER (PARTITION BY MATNR,ZZSV_CMPTR ORDER BY ZF_ROW_NUMBER_SPWOC)	AS sale_out_next2,
	    -- Ð?m s? tháng sale_out khác 0
    (CASE WHEN [Sale out] > 0 THEN 1 ELSE 0 END) +
    (CASE WHEN LEAD([Sale out], 1) OVER (PARTITION BY MATNR,ZZSV_CMPTR ORDER BY ZF_ROW_NUMBER_SPWOC) >0 THEN 1 ELSE 0 END) +
    (CASE WHEN LEAD([Sale out], 2) OVER (PARTITION BY MATNR,ZZSV_CMPTR ORDER BY ZF_ROW_NUMBER_SPWOC) > 0 THEN 1 ELSE 0 END) AS count_valid_months

FROM TEMP2
) B



-- B00_06_IT_SALE_IN_OUT_APPEND 
-- 
DROP TABLE TEMP3

SELECT 
	DISTINCT 
	B00_06_MATNR,	B00_06_ZZSV_CMPTR,	B00_06_SPWOC,

	B00_06_NAME1,	B00_06_MATKL,	B00_06_WGBEZ

INTO TEMP3
FROM B00_06_IT_SALE_IN_OUT_APPEND_BK

ALTER TABLE B00_06_IT_SALE_IN_OUT_APPEND DROP COLUMN  NAME1 NVARCHAR(1000);
ALTER TABLE B00_06_IT_SALE_IN_OUT_APPEND DROP MATKL NVARCHAR(1000);
ALTER TABLE B00_06_IT_SALE_IN_OUT_APPEND DROP WGBEZ NVARCHAR(1000);


ALTER TABLE B00_06_IT_SALE_IN_OUT_APPEND DROP COLUMN  NAME1, MATKL, WGBEZ

UPDATE A
SET NAME1 = B00_06_NAME1,
	MATKL = B00_06_MATKL,
	WGBEZ = B00_06_WGBEZ
FROM B00_06_IT_SALE_IN_OUT_APPEND A 
	INNER JOIN TEMP3 B  
		ON A.MATNR = B.B00_06_MATNR
		AND A.SPWOC = B.B00_06_SPWOC
		AND A.ZZSV_CMPTR = B.B00_06_ZZSV_CMPTR



-- Rename field before load into Qliksense

EXEC SP_UNNAME_FIELD 'B00_01' , 'B00_01_IT_SALE_IN'

EXEC SP_UNNAME_FIELD 'B00_02' , 'B00_02_IT_SALE_OUT'

EXEC SP_UNNAME_FIELD 'B00_02' , 'B00_06_IT_SALE_IN_OUT_APPEND'

EXEC SP_UNNAME_FIELD 'B00_07__' , 'B00_07_IT_ROH_SALES_OUT'



EXEC sp_RENAME_FIELD 'B00_01_', 'B00_01_IT_SALE_IN'

EXEC sp_RENAME_FIELD 'B00_02_', 'B00_02_IT_SALE_OUT'

EXEC sp_RENAME_FIELD 'B00_06_', 'B00_06_IT_SALE_IN_OUT_APPEND'

EXEC sp_RENAME_FIELD 'B00_07_', 'B00_07_IT_ROH_SALES_OUT' 


ALTER TABLE B00_07_IT_ROH_SALES_OUT ADD ZF_FLAG_0_NULL NVARCHAR(3)

UPDATE B00_07_IT_ROH_SALES_OUT
SET ZF_FLAG_0_NULL = 'No'

UPDATE B00_07_IT_ROH_SALES_OUT
SET ZF_FLAG_0_NULL = 'Yes'
WHERE B00_07_ROH_Saleout > 0


B00_06_ZZSV_CMPTR&' - '&B00_06_NAME1 AS ZF_ZZSV_CMPTR_NAME1
B00_06_MATKL&' - '&B00_06_WGBEZ AS ZF_MATKL_WGBEZ


B00_07_ROH_Saleout
5.29



B00_07_Sale out	B00_07_sale_out_next1	B00_07_sale_out_next2


B00_07_count_valid_months	B00_07_avg_sale_out	B00_07_ROH_Saleout
0	0	0
0	0	0

 

SELECT 
    MATNR,
	ZZSV_CMPTR,
	SPWOC,
	ZF_ROW_NUMBER_SPWOC,
    [Reported on hand stock],
    [Sale out],
    LEAD([Sale out], 1) OVER (PARTITION BY MATNR,ZZSV_CMPTR  ORDER BY ZF_ROW_NUMBER_SPWOC)	AS sale_out_next1,
	LEAD([Sale out], 2) OVER (PARTITION BY MATNR,ZZSV_CMPTR ORDER BY ZF_ROW_NUMBER_SPWOC)	AS sale_out_next2,
	    -- Ð?m s? tháng sale_out khác 0
    (CASE WHEN [Sale out] > 0 THEN 1 ELSE 0 END) +
    (CASE WHEN LEAD([Sale out], 1) OVER (PARTITION BY MATNR,ZZSV_CMPTR,SPWOC ORDER BY ZF_ROW_NUMBER_SPWOC) >0 THEN 1 ELSE 0 END) +
    (CASE WHEN LEAD([Sale out], 2) OVER (PARTITION BY MATNR,ZZSV_CMPTR,SPWOC ORDER BY ZF_ROW_NUMBER_SPWOC) > 0 THEN 1 ELSE 0 END) AS count_valid_months

FROM TEMP2
WHERE ZZSV_CMPTR = '1004386'
AND MATNR = 'KD43X720E'
ORDER BY ZF_ROW_NUMBER_SPWOC

select *
FROM TEMP2 
WHERE ZZSV_CMPTR = '1004386'
AND MATNR = 'KD43X720E'
ORDER BY ZF_ROW_NUMBER_SPWOC

SELECT *
FROM B00_06_IT_SALE_IN_OUT_APPEND_BK
WHERE B00_06_ZZSV_CMPTR = '1004386'
AND B00_06_MATNR = 'KD43X720E'
AND RIGHT(B00_06_SPWOC,4) = 2019
AND B00_06_SPWOC = '01.2019'
ORDER BY B00_06_SPWOC


-- SALE IN
SELECT FKIMG, SPWOC SPWOC_, *
FROM [19 20 sell in data]
WHERE ZZSV_CMPTR = '1004386'
AND MATNR = 'KD43X720E'
AND RIGHT(SPWOC,4) = 2019
ORDER BY SPWOC

SELECT 
	ZZSV_QTYTC, 
	ZZSV_CHINV,
	SPWOC SPWOC_,
	*
FROM [19 sell out data]
WHERE ZZSV_CMPTR = '1004386'
AND MATNR = 'KD43X720E'
AND  RIGHT(SPWOC,4) = 2019
ORDER BY SPWOC











UPDATE B00_06_IT_SALE_IN_OUT_APPEND
SET ZF_ONLY_SALE_IN = 'Yes'
FROM B00_06_IT_SALE_IN_OUT_APPEND A
WHERE ZF_SALE_IN_OUT_FLAG = 'Sale in'
AND ZF_SALE_IN_OUT_REPORT_VALUE <> 0
AND NOT EXISTS 
(
	SELECT DISTINCT ZZSV_CMPTR+ZZSV_CMPTR
	FROM B00_06_IT_SALE_IN_OUT_APPEND B 
	WHERE ZF_SALE_IN_OUT_FLAG <> 'Sale in' 
	AND ZF_SALE_IN_OUT_REPORT_VALUE <> 0
	AND A.ZZSV_CMPTR = B.ZZSV_CMPTR
	AND A.MATNR = B.MATNR
)


UPDATE B00_06_IT_SALE_IN_OUT_APPEND
SET ZF_ONLY_SALE_OUT = 'Yes'
FROM B00_06_IT_SALE_IN_OUT_APPEND A
WHERE ZF_SALE_IN_OUT_FLAG = 'Sale out'
AND ZF_SALE_IN_OUT_REPORT_VALUE <> 0
AND NOT EXISTS 
(
	SELECT DISTINCT ZZSV_CMPTR+ZZSV_CMPTR
	FROM B00_06_IT_SALE_IN_OUT_APPEND B 
	WHERE ZF_SALE_IN_OUT_FLAG = 'Sale in' 
	AND A.ZZSV_CMPTR = B.ZZSV_CMPTR
	AND A.MATNR = B.MATNR
	AND ZF_SALE_IN_OUT_REPORT_VALUE <> 0
)
AND NOT EXISTS
(
	SELECT DISTINCT ZZSV_CMPTR+ZZSV_CMPTR
	FROM B00_06_IT_SALE_IN_OUT_APPEND B 
	WHERE ZF_SALE_IN_OUT_FLAG = 'Reported on hand stock' 
	AND A.ZZSV_CMPTR = B.ZZSV_CMPTR
	AND A.MATNR = B.MATNR	
	AND ZF_SALE_IN_OUT_REPORT_VALUE <> 0
)


UPDATE B00_06_IT_SALE_IN_OUT_APPEND
SET ZF_QUANTITY_EQUAL_0 = 'Yes'
WHERE ZF_SALE_IN_OUT_REPORT_VALUE = 0



select 
*
FROM B00_06_IT_SALE_IN_OUT_APPEND
WHERE ZF_ONLY_SALE_OUT = 'Yes'

-- Rename field before load into Qliksense

EXEC SP_UNNAME_FIELD 'B00_01' , 'B00_01_IT_SALE_IN'

EXEC SP_UNNAME_FIELD 'B00_02' , 'B00_02_IT_SALE_OUT'

EXEC SP_UNNAME_FIELD 'B00_02' , 'B00_06_IT_SALE_IN_OUT_APPEND'


EXEC sp_RENAME_FIELD 'B00_01_', 'B00_01_IT_SALE_IN'

EXEC sp_RENAME_FIELD 'B00_02_', 'B00_02_IT_SALE_OUT'

EXEC sp_RENAME_FIELD 'B00_06_', 'B00_06_IT_SALE_IN_OUT_APPEND'








-- 1815095
-- 2091283
-- 2091283

-- 1815095
-- 408969 : 22 sell out data
--  434219      [21 sell out]
--     471907    [20 sell out]
--  500,000       [19 sell out data]


SELECT COUNT(*)
FROM B00_02_IT_SALE_OUT


SELECT 408969 + 434219 + 500000 + 500000


SELECT B00_02_SPWOC, B00_02_ZZSV_CMPTR, B00_02_MATNR
FROM B00_02_IT_SALE_OUT_BK
GROUP BY B00_02_SPWOC, B00_02_ZZSV_CMPTR, B00_02_MATNR
HAVING COUNT(*) > 1


SELECT 
	COUNT(*)
FROM B00_02_IT_SALE_OUT_BK




-- 2091283
-- 1815095

SELECT 
	DISTINCT B00_02_SPWOC, RIGHT(B00_02_SPWOC,4), LEFT(B00_02_SPWOC,2)
FROM B00_02_IT_SALE_OUT_BK
ORDER BY RIGHT(B00_02_SPWOC,4), LEFT(B00_02_SPWOC,2)

-- 01.2023
-- sale in 2023
-- Sale out 2023






SELECT *
FROM B00_06_IT_SALE_IN_in_APPEND
WHERE B00_06_MATNR LIKE 'KD%'
AND B00_06_ZF_SALE_IN_in_FLAG = 'SALE IN'
ORDER BY B00_06_ZF_SALE_IN_in_REPORT_VALUE DESC


SELECT *
FROM B00_06_IT_SALE_IN_in_APPEND
WHERE B00_06_MATNR = 'KD65X85J'
AND B00_06_ZZSV_CMPTR = '1004386'
AND B00_06_ZF_SALE_IN_in_FLAG = 'SALE IN'
ORDER BY B00_06_ZF_SALE_IN_in_REPORT_VALUE ASC





----------------------------------------------------- SALE IN --------------------------------------------------------------------

-- 9327812
-- 3942261
DROP TABLE TEMP1
SELECT *
INTO TEMP1
FROM B00_06_IT_SALE_IN_in_APPEND

EXEC SP_UNNAME_FIELD 'B00_06_' , 'TEMP1'

-- 

SELECT *
FROM TEMP1


WITH TABLE1 AS 
(
SELECT 
	DISTINCT 
		MATNR,
		ZZSV_CMPTR,
		SPWOC,
		ZF_ROW_NUMBER_SPWOC,
		ZF_SALE_IN_OUT_REPORT_VALUE AS 'Sale in'
FROM TEMP1
WHERE ZF_SALE_IN_out_FLAG = 'Sale in'
), TABLE2 AS 
(
	SELECT 
		DISTINCT 
			MATNR,
			ZZSV_CMPTR,
			SPWOC,
			ZF_ROW_NUMBER_SPWOC,			
			ZF_SALE_IN_OUT_REPORT_VALUE AS 'Sale out'
	FROM TEMP1
	WHERE ZF_SALE_IN_out_FLAG = 'Sale out'

)
SELECT 
	TABLE1.*, TABLE2.[Sale out]
	INTO TEMP2
FROM TABLE1 INNER JOIN TABLE2
	ON TABLE1.MATNR = TABLE2.MATNR
	AND TABLE1.SPWOC = TABLE2.SPWOC
	AND TABLE1.ZZSV_CMPTR = TABLE2.ZZSV_CMPTR

DROP TABLE TEMP2




DROP TABLE B00_08_IT_SALES_IN_SALES_OUT

SELECT *,
	CASE
		WHEN (sale_out_next1 IS NULL OR sale_out_next2 IS NULL) THEN NULL
		WHEN count_valid_months = 0  THEN 0
		ELSE 
		ROUND(
		
		(
			(
				IIF ( [Sale out] > 0, [Sale out], 0)
				+
				IIF ( sale_out_next1 > 0, sale_out_next1, 0)
				+
				IIF ( sale_out_next2 > 0, sale_out_next2, 0)
			) / 3
		),2)
	END avg_sale_out,

	CASE
		WHEN (sale_out_next1 IS NULL OR sale_out_next2 IS NULL) THEN NULL
		WHEN count_valid_months = 0  THEN 0
		ELSE 
		ROUND(
		[Sale in] / 
		(
			(
				IIF ( [Sale out] > 0, [Sale out], 0)
				+
				IIF ( sale_out_next1 > 0, sale_out_next1, 0)
				+
				IIF ( sale_out_next2 > 0, sale_out_next2, 0)
			) / 3
		),2)
	END as Salein_Saleout
INTO B00_08_IT_SALES_IN_SALES_OUT
FROM (
SELECT 
    MATNR,
	ZZSV_CMPTR,
	SPWOC,
	ZF_ROW_NUMBER_SPWOC,
    [Sale in],
    [Sale out],
    LEAD([Sale out], 1) OVER (PARTITION BY MATNR,ZZSV_CMPTR  ORDER BY ZF_ROW_NUMBER_SPWOC)	AS sale_out_next1,
	LEAD([Sale out], 2) OVER (PARTITION BY MATNR,ZZSV_CMPTR ORDER BY ZF_ROW_NUMBER_SPWOC)	AS sale_out_next2,
	    -- Ð?m s? tháng sale_out khác 0
    (CASE WHEN [Sale out] > 0 THEN 1 ELSE 0 END) +
    (CASE WHEN LEAD([Sale out], 1) OVER (PARTITION BY MATNR,ZZSV_CMPTR ORDER BY ZF_ROW_NUMBER_SPWOC) >0 THEN 1 ELSE 0 END) +
    (CASE WHEN LEAD([Sale out], 2) OVER (PARTITION BY MATNR,ZZSV_CMPTR ORDER BY ZF_ROW_NUMBER_SPWOC) > 0 THEN 1 ELSE 0 END) AS count_valid_months

FROM TEMP2
) B



SELECT *
FROM B00_08_IT_SALES_IN_SALES_OUT
WHERE 


SELECT *
FROM B00_06_IT_SALE_IN_OUT_APPEND
WHERE B00_06_MATNR LIKE 'KD%'
AND B00_06_ZF_SALE_IN_OUT_FLAG = 'SALE IN'
ORDER BY B00_06_ZF_ROW_NUMBER_SPWOC asc


SELECT *
FROM B00_06_IT_SALE_IN_OUT_APPEND
WHERE B00_06_MATNR = 'KD65X85J'
AND B00_06_ZZSV_CMPTR = '1004386'
AND B00_06_ZF_SALE_IN_OUT_FLAG = 'SALE IN'
ORDER BY B00_06_ZF_ROW_NUMBER_SPWOC ASC

SELECT *
FROM B00_08_IT_SALES_IN_SALES_OUT
WHERE MATNR = 'KD65X85J'
AND ZZSV_CMPTR = '1004386'

SELECT -4/1378

UPDATE B00_08_IT_SALES_IN_SALES_OUT
SET Salein_Saleout =  ABS(Salein_Saleout)

EXEC sp_RENAME_FIELD 'B00_08_', 'B00_08_IT_SALES_IN_SALES_OUT' 





*/
GO
