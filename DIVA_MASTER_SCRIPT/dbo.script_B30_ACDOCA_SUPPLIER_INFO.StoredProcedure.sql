USE [DIVA_MASTER_SCRIPT]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--ALTER PROCEDURE [dbo].[B09_PTP_POS] 
CREATE     PROCEDURE [dbo].[script_B30_ACDOCA_SUPPLIER_INFO]
WITH EXECUTE AS CALLER
AS
--DYNAMIC_SCRIPT_START

INSERT INTO DIVA_MASTER_SCRIPT..B30_01_IT_BSAK_BSIK_AP_ACC_SCH
	SELECT 
		B12_02_IT_PTP_AP.B11_T001_BUTXT,
		B12_02_IT_PTP_AP.B11_ACDOCA_RCLNT AS [B11_BSAIK_MANDT],
		B12_02_IT_PTP_AP.B11_ACDOCA_RBUKRS AS [B11_BSAIK_BUKRS],
		B12_02_IT_PTP_AP.B11_ACDOCA_GJAHR AS [B11_BSAIK_GJAHR],
		B12_02_IT_PTP_AP.B11_ACDOCA_BELNR AS [B11_BSAIK_BELNR],
		B12_02_IT_PTP_AP.B11_ACDOCA_BUZEI AS [B11_BSAIK_BUZEI],
		B12_02_IT_PTP_AP.B11_ACDOCA_BSCHL AS [B11_BSAIK_BSCHL],
		B12_02_IT_PTP_AP.B11_ACDOCA_DRCRK AS [B11_BSAIK_SHKZG],
		B12_02_IT_PTP_AP.B11_ACDOCA_BLART AS [B11_BSAIK_BLART],
		B12_02_IT_PTP_AP.B11_ACDOCA_LIFNR AS [B11_BSAIK_LIFNR],
		B12_02_IT_PTP_AP.B11_ACDOCA_RWCUR AS [B11_BSAIK_WAERS],
		B12_02_IT_PTP_AP.B11_ACDOCA_HSL AS [B11_BSAIK_DMBTR],
		'' AS [B11_BSAIK_UMSKS],
		B12_02_IT_PTP_AP.B11_ACDOCA_UMSKZ AS [B11_BSAIK_UMSKZ],
		B12_02_IT_PTP_AP.B11_ACDOCA_AUGDT AS [B11_BSAIK_AUGDT],
		B12_02_IT_PTP_AP.B11_ACDOCA_AUGBL AS [B11_BSAIK_AUGBL],
		B12_02_IT_PTP_AP.B11_ACDOCA_ZUONR AS [B11_BSAIK_ZUONR],
		B12_02_IT_PTP_AP.B11_ACDOCA_BUDAT AS [B11_BSAIK_BUDAT],
		B12_02_IT_PTP_AP.B11_ACDOCA_BLDAT AS [B11_BSAIK_BLDAT],
		B12_02_IT_PTP_AP.B11_ACDOCA_CPUDT AS [B11_BSAIK_CPUDT],
		'' AS  [B11_BSAIK_XBLNR],
		B12_02_IT_PTP_AP.B11_ACDOCA_MONAT AS [B11_BSAIK_MONAT],
		B12_02_IT_PTP_AP.B11_ACDOCA_RBUSA AS [B11_BSAIK_GSBER],
		'' AS [B11_BSAIK_WRBTR],
		B12_02_IT_PTP_AP.B11_ACDOCA_MWSKZ AS [B11_BSAIK_MWSKZ],
		'' AS [B11_BSAIK_MWSTS],
		'' AS [B11_BSAIK_WMWST],
		B12_02_IT_PTP_AP.B11_ACDOCA_SGTXT AS [B11_BSAIK_SGTXT],
		B12_02_IT_PTP_AP.B11_ACDOCA_AUFNR AS [B11_BSAIK_AUFNR],
		B12_02_IT_PTP_AP.B11_ACDOCA_EBELN AS [B11_BSAIK_EBELN],
		B12_02_IT_PTP_AP.B11_ACDOCA_EBELP AS [B11_BSAIK_EBELP],
		B12_02_IT_PTP_AP.B11_ACDOCA_RACCT AS [B11_BSAIK_HKONT],
		B12_02_IT_PTP_AP.B11_ACDOCA_ZFBDT AS [B11_BSAIK_ZFBDT],
		B12_02_IT_PTP_AP.B11_ACDOCA_ZTERM AS [B11_BSAIK_ZTERM],
		B12_02_IT_PTP_AP.B11_ACDOCA_ZBD1T AS [B11_BSAIK_ZBD1T],
		B12_02_IT_PTP_AP.B11_ACDOCA_ZBD2T AS [B11_BSAIK_ZBD2T],
		B12_02_IT_PTP_AP.B11_ACDOCA_ZBD3T AS [B11_BSAIK_ZBD3T],
		B12_02_IT_PTP_AP.B11_ACDOCA_ZBD1P AS [B11_BSAIK_ZBD1P],
		B12_02_IT_PTP_AP.B11_ACDOCA_ZBD2P AS [B11_BSAIK_ZBD2P],
		B12_02_IT_PTP_AP.B11_ACDOCA_SKFBT AS [B11_BSAIK_SKFBT],
		B12_02_IT_PTP_AP.B11_ACDOCA_WSKTO AS [B11_BSAIK_WSKTO],
		'' AS [B11_BSAIK_ZLSCH],
		'' AS [B11_BSAIK_ZLSPR],
		B12_02_IT_PTP_AP.B11_ACDOCA_BSTAT AS [B11_BSAIK_BSTAT],
		B12_02_IT_PTP_AP.B11_ACDOCA_RCNTR  AS [B11_BSAIK_KOSTL],
		B12_02_IT_PTP_AP.B11_ACDOCA_AUGGJ AS [B11_BSAIK_AUGGJ],
		B12_02_IT_PTP_AP.B11_T003T_LTEXT AS B11_T003T_LTEXT,
		B12_02_IT_PTP_AP.B11_TBSLT_LTEXT AS B11_TBSLT_LTEXT,
		B12_02_IT_PTP_AP.B11_GLOBALS_CURRENCY AS B11_GLOBALS_CURRENCY,
		B12_02_IT_PTP_AP.B11_ZF_ACDOCA_CPUDT_AGE_DAYS AS [B11_ZF_BSAIK_CPUDT_AGE_DAYS],
		B12_02_IT_PTP_AP.B11_ZF_ACDOCA_OPEN_CLOSED AS [B11_ZF_BSAIK_OPEN_CLOSED],
		B12_02_IT_PTP_AP.B11_ZF_ACDOCA_DRCRK_DESC AS [B11_ZF_BSAIK_SHKZG_DESC],
		B12_02_IT_PTP_AP.B11_ZF_ACDOCA_DRCRK_INTEGER AS [B11_ZF_BSAIK_SHKZG_INTEGER],
		B12_02_IT_PTP_AP.B11_ZF_ACDOCA_AUGDT_YEAR_MNTH AS [B11_ZF_BSAK_AUGDT_YEAR_MNTH],
		B12_02_IT_PTP_AP.B11_ZF_ACDOCA_WSKTO_SKBFT AS [B11_ZF_BSAIK_WSKTO_SKBFT],
		B12_02_IT_PTP_AP.B11_ZF_ACDOCA_HSL_S AS [B11_ZF_BSAIK_DMBTR_S],
		B12_02_IT_PTP_AP.B11_ZF_ACDOCA_HSL_CUC AS [B11_ZF_BSAIK_DMBTR_S_CUC],
		B12_02_IT_PTP_AP.B11_ZF_FLAG_SUMMARY AS [B11_ZF_FLAG_SUMMARY],
		B12_02_IT_PTP_AP.SPCAT_SPEND_CAT_LEVEL_1 AS [SPCAT_SPEND_CAT_LEVEL_1],
		B12_02_IT_PTP_AP.SPCAT_SPEND_CAT_LEVEL_2 AS [SPCAT_SPEND_CAT_LEVEL_2],
		B12_02_IT_PTP_AP.SPCAT_SPEND_CAT_LEVEL_3 AS [SPCAT_SPEND_CAT_LEVEL_3],
		B12_02_IT_PTP_AP.SPCAT_SPEND_CAT_LEVEL_4 AS [SPCAT_SPEND_CAT_LEVEL_4],
		'' AS [BKPF_AWTYP],
		A_T001.T001_WAERS AS [T001_WAERS],
		A_T001.T001_KTOPL AS [T001_KTOPL],
		A_LFA1.LFA1_KTOKK AS [LFA1_KTOKK],
		A_LFA1.LFA1_NAME1 AS [LFA1_NAME1],
		A_LFA1.LFA1_LAND1 AS [LFA1_LAND1],
		A_LFA1.LFA1_KUNNR AS [LFA1_KUNNR],
		B00_T077Y.T077Y_TXT30 AS [T077Y_TXT30],
		B00_SKAT.SKAT_TXT20 AS [SKAT_TXT20],
		B00_SKAT.SKAT_TXT50 AS [SKAT_TXT50],
		DB_NAME() AS ZF_DATABASE_FLAG,
		'' AS ZF_COMMENT_LOG
FROM  B12_02_IT_PTP_AP
LEFT JOIN DIVA_MASTER_SCRIPT..B30_01_IT_BSAK_BSIK_AP_ACC_SCH B ON B12_02_IT_PTP_AP.B11_ACDOCA_RBUKRS = B.B11_BSAIK_BUKRS
                                                                                        AND B12_02_IT_PTP_AP.B11_ACDOCA_GJAHR = B.B11_BSAIK_GJAHR 
																						AND B12_02_IT_PTP_AP.B11_ACDOCA_BELNR = B.B11_BSAIK_BELNR
                                                                                        AND B12_02_IT_PTP_AP.B11_ACDOCA_BUZEI = B.B11_BSAIK_BUZEI
LEFT JOIN A_LFA1
		ON B12_02_IT_PTP_AP.B11_ACDOCA_LIFNR = A_LFA1.LFA1_LIFNR
-- Add supplier account group text
LEFT JOIN B00_T077Y
		ON A_LFA1.LFA1_KTOKK = B00_T077Y.T077Y_KTOKK
-- Obtain company description and house currency
LEFT JOIN A_T001
		ON  B12_02_IT_PTP_AP.B11_ACDOCA_RBUKRS = A_T001.T001_BUKRS
-- Add exchange rates for conversion to custom currency   
-- Add G/L Account Text
LEFT JOIN B00_SKAT                                             
ON	   SKAT_KTOPL = A_T001.T001_KTOPL AND
		SKAT_SAKNR = B12_02_IT_PTP_AP.B11_ACDOCA_RACCT 

WHERE B.B11_BSAIK_BUZEI IS NULL
AND  EXISTS (
				   (
									SELECT *
										FROM DIVA_MASTER_SCRIPT..AM_LIST_SUPPLIER
										WHERE RIGHT(CONCAT('0000000000', LIFNR), 10) = RIGHT(CONCAT('0000000000', B12_02_IT_PTP_AP.B11_ACDOCA_LIFNR), 10) 
										AND DB_NAME() LIKE '%' + AM_LIST_SUPPLIER.[Database] + '%'
					)     
			)
GO
