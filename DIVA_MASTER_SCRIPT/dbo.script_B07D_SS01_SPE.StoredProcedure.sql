USE [DIVA_MASTER_SCRIPT]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


--ALTER PROCEDURE [dbo].[B07D_FIN_AR_DOC_TYPES_FILL_BUCKET] 
CREATE     PROCEDURE [dbo].[script_B07D_SS01_SPE]
WITH EXECUTE AS CALLER
AS
BEGIN


/* Initiate the log */  
--Create database log table if it does not exist
IF OBJECT_ID('LOG_SP_EXECUTION', 'U') IS NULL BEGIN CREATE TABLE [DBO].[LOG_SP_EXECUTION] ([DATABASE] NVARCHAR(MAX) NULL,[OBJECT] NVARCHAR(MAX) NULL,[OBJECT_TYPE] NVARCHAR(MAX) NULL,[USER] NVARCHAR(MAX) NULL,[DATE] DATE NULL,[TIME] TIME NULL,[DESCRIPTION] NVARCHAR(MAX) NULL,[TABLE] NVARCHAR(MAX),[ROWS] INT) END

--Log start of procedure
INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(DATE,GETDATE()),CONVERT(TIME,GETDATE()),'Procedure started',NULL,NULL

/* Initialize parameters from globals table */

     DECLARE 	 
			 @CURRENCY NVARCHAR(MAX)			= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'currency')
			,@DATE1 NVARCHAR(MAX)				= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'date1')
			,@DATE2 NVARCHAR(MAX)				= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'date2')
			,@DOWNLOADDATE NVARCHAR(MAX)		= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'downloaddate')
			,@DATEFORMAT VARCHAR(3)             = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'dateformat')
			,@EXCHANGERATETYPE NVARCHAR(MAX)	= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'exchangeratetype')
			,@LANGUAGE1 NVARCHAR(MAX)			= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'language1')
			,@LANGUAGE2 NVARCHAR(MAX)			= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'language2')
			,@YEAR NVARCHAR(MAX)				= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'year')
			,@ID NVARCHAR(MAX)					= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'id')
			,@LIMIT_RECORDS INT		            = CAST((SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'LIMIT_RECORDS') AS INT)


/*Change history comments*/

/*
	Title			: [B07D_FIN_AR_DOC_TYPES_FILL_BUCKET]
	Description	    : Table updated by this script: B07_03_RT_FIN_AR_INV_PAY_FLAGS
					  - DV08 should be reloaded after running this script
					  Table produced by this script: B07_04_IT
	                  Table is used to create the O2C cube
    
	--------------------------------------------------------------
	Update history
	--------------------------------------------------------------
	Date			    |	Who			|	Description
	DD-MM-YYYY				Initials		Initial version
	30-07-2017				CW				Creation
	03-01-2018              CW              Update to include all fields such as accounting schemes
	                                        Update to include company code
											Update to include renaming of AM_B07_03_RT
*/



/*Test mode*/

SET ROWCOUNT @LIMIT_RECORDS
	   
/*     -- Step 1
	Use manual mapping table that contains the flags that have been filled.
	*/
	EXEC SP_DROPTABLE 'B07_03_RT_FIN_AR_INV_PAY_FLAGS'
	--EXEC A_005P_CREATE_B07_03_RT 'AM_B07_03_RT'
	SELECT DISTINCT
		ZF_AR_LIFE_CYCLE_BUCKET_TYPE,
		ZF_AR_LIFE_CYCLE_MAPPING_LABEL,
		ZF_AR_DOC_TYPE_BUCKET,
		ZF_CUST_INV,
		ZF_CUST_INV_CANC,
		ZF_UNALLOCATED_CASH,
		ZF_OTHERS,
		ZF_CUST_PAY,
		ZF_CUST_PAY_CANC,
		ZF_INTERCO_INV,
		ZF_INTERCO_CANC,
		ZF_INTERCO_PAY,
		ZF_INTERCO_PAY_CANC,
		ZF_EMP_INV,
		ZF_EMP_INV_CANC,
		ZF_EMP_PAY,
		ZF_EMP_PAY_CANC,
		BSAID_BUKRS,
		BSAID_SHKZG,
		--	Adding 0 before number from 1 to 10
		DBO.ADD_LEADING_ZEROES(BSAID_BSCHL) BSAID_BSCHL,
		DBO.ADD_LEADING_ZEROES(BSAID_BLART) BSAID_BLART,

		T003T_LTEXT,
		BKPF_TCODE,
		TSTCT_TTEXT,
		ZF_DEBIT_ACCOUNTS,
		ZF_CREDIT_ACCOUNTS,
		ZF_DEBIT_ACCOUNT_TEXTS,
		ZF_CREDIT_ACCOUNT_TEXTS,
		ZF_BANK_DEBIT_ACCOUNTS,
		ZF_BANK_CREDIT_ACCOUNTS,
		ZF_BS_DEBIT_ACCOUNTS,
		ZF_BS_CREDIT_ACCOUNTS,
		ZF_PL_DEBIT_ACCOUNTS,
		ZF_PL_CREDIT_ACCOUNTS,
		ZF_SU_DEBIT_ACCOUNTS,
		ZF_SU_CREDIT_ACCOUNTS,
		ZF_CU_DEBIT_ACCOUNTS,
		ZF_CU_CREDIT_ACCOUNTS,
		ZF_LIST_CSKT_KOSTL,
		ZF_LIST_CSKT_KTEXT,
		ZF_BSAID_DMBTR_S,
		ZF_BSAID_DMBTR_S_CUC
	INTO B07_03_RT_FIN_AR_INV_PAY_FLAGS FROM AM_B07_03_RT
	
/*     -- Step 2
	Add the flags to the detail list of AP line items
	*/
	
	EXEC SP_DROPTABLE 'B07_04_IT_FIN_AR_INV_PAY_FLAGS'

	SELECT
		B04B_BSAID_BUKRS, 
		B04B_BSAID_GJAHR, 
		B04B_BSAID_BELNR, 
		B04B_BSAID_BUZEI,
		ZF_AR_DOC_TYPE_BUCKET
	INTO B07_04_IT_FIN_AR_INV_PAY_FLAGS
	FROM B04_12_IT_BSAD_BSID_AR_ACC_SCH
	OUTER APPLY(SELECT TOP 1 * FROM B07_03_RT_FIN_AR_INV_PAY_FLAGS WHERE
			
		ISNULL(B04_12_IT_BSAD_BSID_AR_ACC_SCH.B04B_BSAID_BUKRS, '') = B07_03_RT_FIN_AR_INV_PAY_FLAGS.BSAID_BUKRS 
		AND ISNULL(B04_12_IT_BSAD_BSID_AR_ACC_SCH.B04B_BSAID_SHKZG, '') = B07_03_RT_FIN_AR_INV_PAY_FLAGS.BSAID_SHKZG 
		AND ISNULL(B04_12_IT_BSAD_BSID_AR_ACC_SCH.B04B_BSAID_BSCHL, '') = B07_03_RT_FIN_AR_INV_PAY_FLAGS.BSAID_BSCHL
		AND ISNULL(B04_12_IT_BSAD_BSID_AR_ACC_SCH.B04B_BSAID_BLART, '') = B07_03_RT_FIN_AR_INV_PAY_FLAGS.BSAID_BLART
		AND ISNULL(B04_12_IT_BSAD_BSID_AR_ACC_SCH.B04B_BSAID_UMSKZ, '') = B07_03_RT_FIN_AR_INV_PAY_FLAGS.BSAID_UMSKZ
		AND ISNULL(B04_12_IT_BSAD_BSID_AR_ACC_SCH.B04B_T003T_LTEXT,'') = B07_03_RT_FIN_AR_INV_PAY_FLAGS.T003T_LTEXT 
      	AND ISNULL(B04_12_IT_BSAD_BSID_AR_ACC_SCH.B04B_BKPF_TCODE, '') = B07_03_RT_FIN_AR_INV_PAY_FLAGS.BKPF_TCODE
		AND ISNULL(B04_12_IT_BSAD_BSID_AR_ACC_SCH.B04B_TSTCT_TTEXT, '') = B07_03_RT_FIN_AR_INV_PAY_FLAGS.TSTCT_TTEXT 
		AND ISNULL(B04_12_IT_BSAD_BSID_AR_ACC_SCH.B04B_ZF_DEBIT_ACCOUNTS, '') = B07_03_RT_FIN_AR_INV_PAY_FLAGS.ZF_DEBIT_ACCOUNTS
		AND ISNULL(B04_12_IT_BSAD_BSID_AR_ACC_SCH.B04B_ZF_CREDIT_ACCOUNTS, '') = B07_03_RT_FIN_AR_INV_PAY_FLAGS.ZF_CREDIT_ACCOUNTS
		AND ISNULL(B04_12_IT_BSAD_BSID_AR_ACC_SCH.B04B_ZF_BANK_DEBIT_ACCOUNTS, '') = B07_03_RT_FIN_AR_INV_PAY_FLAGS.ZF_BANK_DEBIT_ACCOUNTS
		AND ISNULL(B04_12_IT_BSAD_BSID_AR_ACC_SCH.B04B_ZF_BANK_CREDIT_ACCOUNTS, '') = B07_03_RT_FIN_AR_INV_PAY_FLAGS.ZF_BANK_CREDIT_ACCOUNTS
		AND ISNULL(B04_12_IT_BSAD_BSID_AR_ACC_SCH.B04B_ZF_BS_DEBIT_ACCOUNTS,'') = B07_03_RT_FIN_AR_INV_PAY_FLAGS.ZF_BS_DEBIT_ACCOUNTS 
		AND ISNULL(B04_12_IT_BSAD_BSID_AR_ACC_SCH.B04B_ZF_BS_CREDIT_ACCOUNTS,'') = B07_03_RT_FIN_AR_INV_PAY_FLAGS.ZF_BS_CREDIT_ACCOUNTS
		AND ISNULL(B04_12_IT_BSAD_BSID_AR_ACC_SCH.B04B_ZF_PL_DEBIT_ACCOUNTS,'') = B07_03_RT_FIN_AR_INV_PAY_FLAGS.ZF_PL_DEBIT_ACCOUNTS
		AND ISNULL(B04_12_IT_BSAD_BSID_AR_ACC_SCH.B04B_ZF_PL_CREDIT_ACCOUNTS,'') = B07_03_RT_FIN_AR_INV_PAY_FLAGS.ZF_PL_CREDIT_ACCOUNTS
		AND ISNULL(B04_12_IT_BSAD_BSID_AR_ACC_SCH.B04B_ZF_SU_DEBIT_ACCOUNTS,'') = B07_03_RT_FIN_AR_INV_PAY_FLAGS.ZF_SU_DEBIT_ACCOUNTS
		AND ISNULL(B04_12_IT_BSAD_BSID_AR_ACC_SCH.B04B_ZF_SU_CREDIT_ACCOUNTS,'') = B07_03_RT_FIN_AR_INV_PAY_FLAGS.ZF_SU_CREDIT_ACCOUNTS
		AND ISNULL(B04_12_IT_BSAD_BSID_AR_ACC_SCH.B04B_ZF_CU_DEBIT_ACCOUNTS,'') = B07_03_RT_FIN_AR_INV_PAY_FLAGS.ZF_CU_DEBIT_ACCOUNTS
		AND ISNULL(B04_12_IT_BSAD_BSID_AR_ACC_SCH.B04B_ZF_CU_CREDIT_ACCOUNTS,'') =B07_03_RT_FIN_AR_INV_PAY_FLAGS.ZF_CU_CREDIT_ACCOUNTS
		AND ISNULL(B04_12_IT_BSAD_BSID_AR_ACC_SCH.B04B_ZF_DEBIT_ACCOUNT_TEXTS,'') =B07_03_RT_FIN_AR_INV_PAY_FLAGS.ZF_DEBIT_ACCOUNT_TEXTS
		AND ISNULL(B04_12_IT_BSAD_BSID_AR_ACC_SCH.B04B_ZF_CREDIT_ACCOUNT_TEXTS,'') =B07_03_RT_FIN_AR_INV_PAY_FLAGS.ZF_CREDIT_ACCOUNT_TEXTS) B07_03_RT_FIN_AR_INV_PAY_FLAGS
			

--Step 3: Create document type summary table
EXEC SP_DROPTABLE 'B07_05_IT_FIN_AR_INV_PAY_FLAGS'
SELECT DISTINCT
	BSAID_BUKRS,
	ZF_AR_DOC_TYPE_BUCKET,
	BSAID_BSCHL,
	BSAID_BLART,
	BSAID_UMSKZ
INTO B07_05_IT_FIN_AR_INV_PAY_FLAGS
FROM B07_03_RT_FIN_AR_INV_PAY_FLAGS

/*/ Drop the temporary table*/

-- None 


/*Rename fields for Qlik*/
EXEC SP_UNNAME_FIELD 'B04B_', 'B07_04_IT_FIN_AR_INV_PAY_FLAGS'
EXEC SP_RENAME_FIELD 'B07D_', 'B07_04_IT_FIN_AR_INV_PAY_FLAGS'
EXEC SP_RENAME_FIELD 'B07C_', 'B07_05_IT_FIN_AR_INV_PAY_FLAGS'

/* log cube creation*/

INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(DATE,GETDATE()),CONVERT(TIME,GETDATE()),'Cube completed','B07_03_RT_FIN_AR_INV_PAY_FLAGS',(SELECT COUNT(*) FROM B07_03_RT_FIN_AR_INV_PAY_FLAGS) 
--INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
--SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(DATE,GETDATE()),CONVERT(TIME,GETDATE()),'Cube completed','B07_04_IT_FIN_AR_INV_PAY_FLAGS',(SELECT COUNT(*) FROM B07_04_IT_FIN_AR_INV_PAY_FLAGS) 


/* log end of procedure*/


INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(date,GETDATE()),CONVERT(time,GETDATE()),'Procedure finished',NULL,NULL

END

GO
