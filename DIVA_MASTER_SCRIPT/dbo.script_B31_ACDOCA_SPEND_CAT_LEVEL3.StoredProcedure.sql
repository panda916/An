USE [DIVA_MASTER_SCRIPT]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--ALTER PROCEDURE [dbo].[B09_PTP_POS] 
CREATE       PROCEDURE [dbo].[script_B31_ACDOCA_SPEND_CAT_LEVEL3]
WITH EXECUTE AS CALLER
AS
--DYNAMIC_SCRIPT_START

-- Step 1 : Insert value to AP table.
INSERT INTO DIVA_MASTER_SCRIPT..B31_01_IT_AP_SPEND_LEVEL3
	SELECT 
		A.B11_ACDOCA_BELNR+A.B11_ACDOCA_RBUKRS+A.B11_ACDOCA_GJAHR+A.B11_ACDOCA_BUZEI+A.B11_ACDOCA_DOCLN as ZF_REMOVE_DUP_AP_SIDE,
		A.B11_T001_BUTXT,
		A.B11_ACDOCA_RCLNT AS [B11_BSAIK_MANDT],
		A.B11_ACDOCA_RBUKRS AS [B11_BSAIK_BUKRS],
		A.B11_ACDOCA_GJAHR AS [B11_BSAIK_GJAHR],
		A.B11_ACDOCA_BELNR AS [B11_BSAIK_BELNR],
		CONCAT(A.B11_ACDOCA_BUZEI,'_',A.B11_ACDOCA_DOCLN) AS [B11_BSAIK_BUZEI],
		A.B11_ACDOCA_BSCHL AS [B11_BSAIK_BSCHL],
		A.B11_ACDOCA_DRCRK AS [B11_BSAIK_SHKZG],
		A.B11_ACDOCA_BLART AS [B11_BSAIK_BLART],
		A.B11_ACDOCA_LIFNR AS [B11_BSAIK_LIFNR],
		A.B11_ACDOCA_RWCUR AS [B11_BSAIK_WAERS],
		A.B11_ACDOCA_HSL AS [B11_BSAIK_DMBTR],
		'' AS [B11_BSAIK_UMSKS],
		A.B11_ACDOCA_UMSKZ AS [B11_BSAIK_UMSKZ],
		A.B11_ACDOCA_AUGDT AS [B11_BSAIK_AUGDT],
		A.B11_ACDOCA_AUGBL AS [B11_BSAIK_AUGBL],
		A.B11_ACDOCA_ZUONR AS [B11_BSAIK_ZUONR],
		A.B11_ACDOCA_BUDAT AS [B11_BSAIK_BUDAT],
		A.B11_ACDOCA_BLDAT AS [B11_BSAIK_BLDAT],
		A.B11_ACDOCA_CPUDT AS [B11_BSAIK_CPUDT],
		'' AS  [B11_BSAIK_XBLNR],
		A.B11_ACDOCA_MONAT AS [B11_BSAIK_MONAT],
		A.B11_ACDOCA_RBUSA AS [B11_BSAIK_GSBER],
		'' AS [B11_BSAIK_WRBTR],
		A.B11_ACDOCA_MWSKZ AS [B11_BSAIK_MWSKZ],
		'' AS [B11_BSAIK_MWSTS],
		'' AS [B11_BSAIK_WMWST],
		A.B11_ACDOCA_SGTXT AS [B11_BSAIK_SGTXT],
		A.B11_ACDOCA_AUFNR AS [B11_BSAIK_AUFNR],
		A.B11_ACDOCA_EBELN AS [B11_BSAIK_EBELN],
		A.B11_ACDOCA_EBELP AS [B11_BSAIK_EBELP],
		A.B11_ACDOCA_RACCT AS [B11_BSAIK_HKONT],
		A.B11_ACDOCA_ZFBDT AS [B11_BSAIK_ZFBDT],
		A.B11_ACDOCA_ZTERM AS [B11_BSAIK_ZTERM],
		A.B11_ACDOCA_ZBD1T AS [B11_BSAIK_ZBD1T],
		A.B11_ACDOCA_ZBD2T AS [B11_BSAIK_ZBD2T],
		A.B11_ACDOCA_ZBD3T AS [B11_BSAIK_ZBD3T],
		A.B11_ACDOCA_ZBD1P AS [B11_BSAIK_ZBD1P],
		A.B11_ACDOCA_ZBD2P AS [B11_BSAIK_ZBD2P],
		A.B11_ACDOCA_SKFBT AS [B11_BSAIK_SKFBT],
		A.B11_ACDOCA_WSKTO AS [B11_BSAIK_WSKTO],
		'' AS [B11_BSAIK_ZLSCH],
		'' AS [B11_BSAIK_ZLSPR],
		A.B11_ACDOCA_BSTAT AS [B11_BSAIK_BSTAT],
		A.B11_ACDOCA_RCNTR  AS [B11_BSAIK_KOSTL],
		A.B11_ACDOCA_AUGGJ AS [B11_BSAIK_AUGGJ],
		A.B11_T003T_LTEXT AS B11_T003T_LTEXT,
		A.B11_TBSLT_LTEXT AS B11_TBSLT_LTEXT,
		A.B11_GLOBALS_CURRENCY AS B11_GLOBALS_CURRENCY,
		A.B11_ZF_ACDOCA_CPUDT_AGE_DAYS AS [B11_ZF_BSAIK_CPUDT_AGE_DAYS],
		A.B11_ZF_ACDOCA_OPEN_CLOSED AS [B11_ZF_BSAIK_OPEN_CLOSED],
		A.B11_ZF_ACDOCA_DRCRK_DESC AS [B11_ZF_BSAIK_SHKZG_DESC],
		A.B11_ZF_ACDOCA_DRCRK_INTEGER AS [B11_ZF_BSAIK_SHKZG_INTEGER],
		A.B11_ZF_ACDOCA_AUGDT_YEAR_MNTH AS [B11_ZF_BSAK_AUGDT_YEAR_MNTH],
		A.B11_ZF_ACDOCA_WSKTO_SKBFT AS [B11_ZF_BSAIK_WSKTO_SKBFT],
		A.B11_ZF_ACDOCA_HSL_S AS [B11_ZF_BSAIK_DMBTR_S],
		A.B11_ZF_ACDOCA_HSL_CUC AS [B11_ZF_BSAIK_DMBTR_S_CUC],
		A.B11_ZF_FLAG_SUMMARY AS [B11_ZF_FLAG_SUMMARY],
		'' AS [BKPF_AWTYP],
		A_T001.T001_WAERS AS [T001_WAERS],
		A_T001.T001_KTOPL AS [T001_KTOPL],
		A_LFA1.LFA1_KTOKK AS [LFA1_KTOKK],
		A_LFA1.LFA1_NAME1 AS [LFA1_NAME1],
		A_LFA1.LFA1_LAND1 AS [LFA1_LAND1],
		A_LFA1.LFA1_KUNNR AS [LFA1_KUNNR],
		B00_T077Y.T077Y_TXT30 AS [T077Y_TXT30],
		B00_SKAT.SKAT_TXT20 AS [SKAT_TXT20],
		B00_SKAT.SKAT_TXT50 AS [SKAT_TXT50],
		DB_NAME() AS ZF_DATABASE_FLAG,
		'' AS ZF_COMMENT_LOG
		,B11_ZF_ACDOCA_KSL_S
		,B11_ACDOCA_RKCUR
FROM  B12_02_IT_PTP_AP A
-- Filter BELNR in AP side base on
-- BELNR in GL table have SPEND LEVEL 3 found in AM_SPEND_LEVEL3_SUPPLIER
INNER JOIN 
(
-- List of BELNR from GL table have SPEND LEVEL 3 found in AM_SPEND_LEVEL3_SUPPLIER
	SELECT 
		DISTINCT B12_ACDOCA_BELNR, B12_ACDOCA_GJAHR, B12_ACDOCA_RBUKRS
	FROM B12_01_IT_PTP_GL
	INNER JOIN AM_SPEND_CATEGORY AS B ON dbo.REMOVE_LEADING_ZEROES(B12_ACDOCA_RACCT) = dbo.REMOVE_LEADING_ZEROES(B.SPCAT_GL_ACCNT)
	WHERE  EXISTS   
	(
		(
			SELECT TOP 1 1
			FROM DIVA_MASTER_SCRIPT..AM_SPEND_LEVEL3_SUPPLIER
			WHERE 
			dbo.REMOVE_LEADING_ZEROES(B.SPCAT_SPEND_CAT_LEVEL_3)  =  AM_SPEND_LEVEL3_SUPPLIER.SPCAT_SPEND_CAT_LEVEL_3 
			AND DB_NAME() LIKE '%' + AM_SPEND_LEVEL3_SUPPLIER.ZF_DATABASE_NAME + '%'
								
		)     
	)
) AS B
	ON A.B11_ACDOCA_RBUKRS = B.B12_ACDOCA_RBUKRS
	AND A.B11_ACDOCA_GJAHR = B.B12_ACDOCA_GJAHR
	AND A.B11_ACDOCA_BELNR = B.B12_ACDOCA_BELNR
LEFT JOIN A_LFA1
		ON A.B11_ACDOCA_LIFNR = A_LFA1.LFA1_LIFNR
-- Add supplier account group text
LEFT JOIN B00_T077Y
		ON A_LFA1.LFA1_KTOKK = B00_T077Y.T077Y_KTOKK
-- Obtain company description and house currency
LEFT JOIN A_T001
		ON  A.B11_ACDOCA_RBUKRS = A_T001.T001_BUKRS
-- Add exchange rates for conversion to custom currency   
-- Add G/L Account Text
LEFT JOIN B00_SKAT                                             
ON	   SKAT_KTOPL = A_T001.T001_KTOPL AND
		SKAT_SAKNR = A.B11_ACDOCA_RACCT 

-- Remove duplication same region.
WHERE A.B11_ACDOCA_BELNR+A.B11_ACDOCA_RBUKRS+A.B11_ACDOCA_GJAHR+A.B11_ACDOCA_BUZEI+A.B11_ACDOCA_DOCLN NOT IN 
( 
	SELECT DISTINCT ZF_REMOVE_DUP_AP_SIDE
	FROM DIVA_MASTER_SCRIPT..B31_01_IT_AP_SPEND_LEVEL3
	-- Region inserted (same region).
	INNER JOIN DIVA_MASTER_SCRIPT..AM_SPEND_LEVEL3_SUPPLIER
	ON B31_01_IT_AP_SPEND_LEVEL3.ZF_DATABASE_FLAG = AM_SPEND_LEVEL3_SUPPLIER.ZF_DATABASE_NAME	
)



-- Step 2 :  Insert value to GL  table.

INSERT INTO DIVA_MASTER_SCRIPT..B31_02_IT_GL_SPEND_LEVEL3

SELECT 
	A.B12_ACDOCA_BELNR+A.B12_ACDOCA_RBUKRS+A.B12_ACDOCA_GJAHR+A.B12_ACDOCA_BUZEI+A.B12_ACDOCA_DOCLN as ZF_REMOVE_DUP_GL_SIDE,
	A.B12_ACDOCA_RBUKRS ,
	A.B12_ACDOCA_GJAHR ,
	A.B12_ACDOCA_BELNR ,
	CONCAT(A.B12_ACDOCA_BUZEI,'_',A.B12_ACDOCA_DOCLN) AS B12_ACDOCA_BUZEI,
	A.B12_ACDOCA_KOART ,
	A. B12_ZF_ACDOCA_HSL_S  ,
	A.B12_ZF_ACDOCA_KSL_S  ,
	A.B12_ZF_ACDOCA_OSL_S  ,
	A.B12_ZF_ACDOCA_HSL_S_CUC ,
	C.SPCAT_SPEND_CAT_LEVEL_1 ,
	C.SPCAT_SPEND_CAT_LEVEL_2 ,
	C.SPCAT_SPEND_CAT_LEVEL_3 ,
	C.SPCAT_SPEND_CAT_LEVEL_4 ,
	A.B12_ACDOCA_DRCRK,
	A.B12_ACDOCA_RACCT  ,
	A.B12_SKAT_TXT50 ,
	A.B12_AM_GLOBALS_CURRENCY,
	DB_NAME()
FROM B12_01_IT_PTP_GL A
INNER JOIN AM_SPEND_CATEGORY AS C ON dbo.REMOVE_LEADING_ZEROES(A.B12_ACDOCA_RACCT) = dbo.REMOVE_LEADING_ZEROES(C.SPCAT_GL_ACCNT)
--INNER JOIN  DIVA_MASTER_SCRIPT..AM_SPEND_LEVEL3_SUPPLIER AS C
--	ON dbo.REMOVE_LEADING_ZEROES(A.B12_ACDOCA_RACCT) = dbo.REMOVE_LEADING_ZEROES(C.SPCAT_GL_ACCNT) AND
--	 DB_NAME() LIKE '%' + C.ZF_DATABASE_NAME + '%'
INNER JOIN
(
-- List of BELNR from GL table have SPEND LEVEL 3 found in AM_SPEND_LEVEL3_SUPPLIER
	SELECT 
		DISTINCT B12_ACDOCA_BELNR, B12_ACDOCA_GJAHR, B12_ACDOCA_RBUKRS, B12_ACDOCA_BUZEI
	FROM B12_01_IT_PTP_GL
	INNER JOIN AM_SPEND_CATEGORY AS B ON dbo.REMOVE_LEADING_ZEROES(B12_ACDOCA_RACCT) = dbo.REMOVE_LEADING_ZEROES(B.SPCAT_GL_ACCNT)
	
	WHERE  EXISTS   
	(
		(
			SELECT TOP 1 1
			FROM DIVA_MASTER_SCRIPT..AM_SPEND_LEVEL3_SUPPLIER
			WHERE 
			dbo.REMOVE_LEADING_ZEROES(B.SPCAT_SPEND_CAT_LEVEL_3)  =  AM_SPEND_LEVEL3_SUPPLIER.SPCAT_SPEND_CAT_LEVEL_3 
			AND DB_NAME() LIKE '%' + AM_SPEND_LEVEL3_SUPPLIER.ZF_DATABASE_NAME + '%'
								
		)     
	)
) AS B ON A.B12_ACDOCA_BELNR = B.B12_ACDOCA_BELNR 
		 AND A.B12_ACDOCA_GJAHR = B.B12_ACDOCA_GJAHR 
		 AND A.B12_ACDOCA_RBUKRS = B.B12_ACDOCA_RBUKRS
		 AND A.B12_ACDOCA_BUZEI = B.B12_ACDOCA_BUZEI
 --Remove duplication same region.
WHERE A.B12_ACDOCA_BELNR+A.B12_ACDOCA_RBUKRS+A.B12_ACDOCA_GJAHR+A.B12_ACDOCA_BUZEI+A.B12_ACDOCA_DOCLN NOT IN 
( 
	SELECT DISTINCT ZF_REMOVE_DUP_GL_SIDE
	FROM DIVA_MASTER_SCRIPT..B31_02_IT_GL_SPEND_LEVEL3
		-- Region inserted (same region).
	INNER JOIN DIVA_MASTER_SCRIPT..AM_SPEND_LEVEL3_SUPPLIER
	ON B31_02_IT_GL_SPEND_LEVEL3.GL_ZF_DATABASE_FLAG = AM_SPEND_LEVEL3_SUPPLIER.ZF_DATABASE_NAME	
)
GO
