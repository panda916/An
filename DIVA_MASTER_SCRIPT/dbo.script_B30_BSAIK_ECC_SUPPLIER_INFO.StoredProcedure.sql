USE [DIVA_MASTER_SCRIPT]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE     PROCEDURE [dbo].[script_B30_BSAIK_ECC_SUPPLIER_INFO]
WITH EXECUTE AS CALLER
AS
--DYNAMIC_SCRIPT_START
/*  Change history comments
	Update history 
	-------------------------------------------------------
	Date            | Who   |  Description 
	--  23-03-2022	| Thuan	| Remove MANDT field in join
*/

INSERT INTO DIVA_MASTER_SCRIPT..B30_01_IT_BSAK_BSIK_AP_ACC_SCH
SELECT  	
		B12_02_IT_PTP_AP.B11_T001_BUTXT,
		B12_02_IT_PTP_AP.B11_BSAIK_MANDT,
		B12_02_IT_PTP_AP.B11_BSAIK_BUKRS,
		B12_02_IT_PTP_AP.B11_BSAIK_GJAHR,
		B12_02_IT_PTP_AP.B11_BSAIK_BELNR,
		B12_02_IT_PTP_AP.B11_BSAIK_BUZEI,
		B12_02_IT_PTP_AP.B11_BSAIK_BSCHL,
		B12_02_IT_PTP_AP.B11_BSAIK_SHKZG,
		B12_02_IT_PTP_AP.B11_BSAIK_BLART,
		B12_02_IT_PTP_AP.B11_BSAIK_LIFNR,
		B12_02_IT_PTP_AP.B11_BSAIK_WAERS,
		B12_02_IT_PTP_AP.B11_BSAIK_DMBTR,
		B12_02_IT_PTP_AP.B11_BSAIK_UMSKS,
		B12_02_IT_PTP_AP.B11_BSAIK_UMSKZ,
		B12_02_IT_PTP_AP.B11_BSAIK_AUGDT,
		B12_02_IT_PTP_AP.B11_BSAIK_AUGBL,
		B12_02_IT_PTP_AP.B11_BSAIK_ZUONR,
		B12_02_IT_PTP_AP.B11_BSAIK_BUDAT,
		B12_02_IT_PTP_AP.B11_BSAIK_BLDAT,
		B12_02_IT_PTP_AP.B11_BSAIK_CPUDT,
		B12_02_IT_PTP_AP.B11_BSAIK_XBLNR,
		B12_02_IT_PTP_AP.B11_BSAIK_MONAT,
		B12_02_IT_PTP_AP.B11_BSAIK_GSBER,
		B12_02_IT_PTP_AP.B11_BSAIK_WRBTR,
		B12_02_IT_PTP_AP.B11_BSAIK_MWSKZ,
		B12_02_IT_PTP_AP.B11_BSAIK_MWSTS,
		B12_02_IT_PTP_AP.B11_BSAIK_WMWST,
		B12_02_IT_PTP_AP.B11_BSAIK_SGTXT,
		B12_02_IT_PTP_AP.B11_BSAIK_AUFNR,
		B12_02_IT_PTP_AP.B11_BSAIK_EBELN,
		B12_02_IT_PTP_AP.B11_BSAIK_EBELP,
		B12_02_IT_PTP_AP.B11_BSAIK_HKONT,
		B12_02_IT_PTP_AP.B11_BSAIK_ZFBDT,
		B12_02_IT_PTP_AP.B11_BSAIK_ZTERM,
		B12_02_IT_PTP_AP.B11_BSAIK_ZBD1T,
		B12_02_IT_PTP_AP.B11_BSAIK_ZBD2T,
		B12_02_IT_PTP_AP.B11_BSAIK_ZBD3T,
		B12_02_IT_PTP_AP.B11_BSAIK_ZBD1P,
		B12_02_IT_PTP_AP.B11_BSAIK_ZBD2P,
		B12_02_IT_PTP_AP.B11_BSAIK_SKFBT,
		B12_02_IT_PTP_AP.B11_BSAIK_WSKTO,
		B12_02_IT_PTP_AP.B11_BSAIK_ZLSCH,
		B12_02_IT_PTP_AP.B11_BSAIK_ZLSPR,
		B12_02_IT_PTP_AP.B11_BSAIK_BSTAT,
		B12_02_IT_PTP_AP.B11_BSAIK_KOSTL,
		B12_02_IT_PTP_AP.B11_BSAIK_AUGGJ,
		B12_02_IT_PTP_AP.B11_T003T_LTEXT,
		B12_02_IT_PTP_AP.B11_TBSLT_LTEXT,
		B12_02_IT_PTP_AP.B11_GLOBALS_CURRENCY,
		B12_02_IT_PTP_AP.B11_ZF_BSAIK_CPUDT_AGE_DAYS,
		B12_02_IT_PTP_AP.B11_ZF_BSAIK_OPEN_CLOSED ,
		B12_02_IT_PTP_AP.B11_ZF_BSAIK_SHKZG_DESC ,
		B12_02_IT_PTP_AP.B11_ZF_BSAIK_SHKZG_INTEGER,
		B12_02_IT_PTP_AP.B11_ZF_BSAK_AUGDT_YEAR_MNTH,
		B12_02_IT_PTP_AP.B11_ZF_BSAIK_WSKTO_SKBFT,
		B12_02_IT_PTP_AP.B11_ZF_BSAIK_DMBTR_S,
		B12_02_IT_PTP_AP.B11_ZF_BSAIK_DMBTR_S_CUC,
		B12_02_IT_PTP_AP.B11_ZF_FLAG_SUMMARY,
		B12_02_IT_PTP_AP.SPCAT_SPEND_CAT_LEVEL_1 AS [SPCAT_SPEND_CAT_LEVEL_1],
		B12_02_IT_PTP_AP.SPCAT_SPEND_CAT_LEVEL_2 AS [SPCAT_SPEND_CAT_LEVEL_2],
		B12_02_IT_PTP_AP.SPCAT_SPEND_CAT_LEVEL_3 AS [SPCAT_SPEND_CAT_LEVEL_3],
		B12_02_IT_PTP_AP.SPCAT_SPEND_CAT_LEVEL_4 AS [SPCAT_SPEND_CAT_LEVEL_4],
		-- Header information
		A_BKPF.BKPF_AWTYP
		-- Local currency code
		,A_T001.T001_WAERS
        ,A_T001.T001_KTOPL
		--Supplier account group
		,A_LFA1.LFA1_KTOKK
		,A_LFA1.LFA1_NAME1
		,A_LFA1.LFA1_LAND1
		,A_LFA1.LFA1_KUNNR
		--Supplier account group description
		,B00_T077Y.T077Y_TXT30
		-- Add G/L Account Text
		,B00_SKAT.SKAT_TXT20
		,B00_SKAT.SKAT_TXT50
		,DB_NAME()
		,''
FROM B12_02_IT_PTP_AP
-- Add some header information from BKPF tables
-- Remove dup same region (AP value)
LEFT JOIN DIVA_MASTER_SCRIPT..B30_01_IT_BSAK_BSIK_AP_ACC_SCH B ON B12_02_IT_PTP_AP.B11_BSAIK_BUKRS = B.B11_BSAIK_BUKRS
                                                                                        AND B12_02_IT_PTP_AP.B11_BSAIK_GJAHR = B.B11_BSAIK_GJAHR 
																						AND B12_02_IT_PTP_AP.B11_BSAIK_BELNR = B.B11_BSAIK_BELNR
                                                                                        AND B12_02_IT_PTP_AP.B11_BSAIK_BUZEI = B.B11_BSAIK_BUZEI
LEFT JOIN A_BKPF
	ON B12_02_IT_PTP_AP.B11_BSAIK_BUKRS = A_BKPF.BKPF_BUKRS AND
		B12_02_IT_PTP_AP.B11_BSAIK_GJAHR = A_BKPF.BKPF_GJAHR AND
		B12_02_IT_PTP_AP.B11_BSAIK_BELNR = A_BKPF.BKPF_BELNR 

-- Add supplier information
LEFT JOIN A_LFA1
		ON B12_02_IT_PTP_AP.B11_BSAIK_LIFNR = A_LFA1.LFA1_LIFNR
-- Add supplier account group text
LEFT JOIN B00_T077Y
		ON A_LFA1.LFA1_KTOKK = B00_T077Y.T077Y_KTOKK
-- Obtain company description and house currency
LEFT JOIN A_T001
		ON  B12_02_IT_PTP_AP.B11_BSAIK_BUKRS = A_T001.T001_BUKRS
    
-- Add G/L Account Text
LEFT JOIN B00_SKAT                                             
			ON  B00_SKAT.SKAT_KTOPL = A_T001.T001_KTOPL AND               
		B00_SKAT.SKAT_SAKNR = B12_02_IT_PTP_AP.B11_BSAIK_HKONT
WHERE B.B11_BSAIK_BUZEI IS NULL
AND  EXISTS ((
							SELECT *
								FROM DIVA_MASTER_SCRIPT..AM_LIST_SUPPLIER
								WHERE RIGHT(CONCAT('0000000000', LIFNR), 10) = RIGHT(CONCAT('0000000000', B12_02_IT_PTP_AP.B11_BSAIK_LIFNR), 10)
								AND DB_NAME() LIKE '%' + AM_LIST_SUPPLIER.[Database] + '%'
				)     
			)
GO
