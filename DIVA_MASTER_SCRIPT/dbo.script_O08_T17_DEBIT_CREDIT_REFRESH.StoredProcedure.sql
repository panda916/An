USE [DIVA_MASTER_SCRIPT]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--ALTER PROCEDURE [dbo].[O08_T17_Debit-credit refresh]
CREATE     PROCEDURE [dbo].[script_O08_T17_DEBIT_CREDIT_REFRESH]
WITH EXECUTE AS CALLER
AS
-- -- --DYNAMIC_SCRIPT_START

BEGIN


/* Initiate the log */  
--Create database log table if it does not exist
IF OBJECT_ID('LOG_SP_EXECUTION', 'U') IS NULL BEGIN CREATE TABLE [DBO].[LOG_SP_EXECUTION] ([DATABASE] NVARCHAR(MAX) NULL,[OBJECT] NVARCHAR(MAX) NULL,[OBJECT_TYPE] NVARCHAR(MAX) NULL,[USER] NVARCHAR(MAX) NULL,[DATE] DATE NULL,[TIME] TIME NULL,[DESCRIPTION] NVARCHAR(MAX) NULL,[TABLE] NVARCHAR(MAX),[ROWS] INT) END

--Log start of procedure
INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(DATE,GETDATE()),CONVERT(TIME,GETDATE()),'Procedure started',NULL,NULL

/* Initialize parameters from globals table */

    

/*Test mode*/

--SET ROWCOUNT @LIMIT_RECORDS

 
/*Change history comments*/

/*
    Title			:	O08_T17: Debit-credit refreshN  update
      
    --------------------------------------------------------------
    Update history
    --------------------------------------------------------------
    Date		    | Who |	Description
	20/03/2019		  THUAN    Test creation
	23-03-2022		  Thuan	   Remove MANDT field in join
*/
-- Step 1/ List all the invoices in B14_06_IT_ARE table.
EXEC SP_REMOVE_TABLES 'O08_T17_%'
EXEC SP_DROPTABLE 'O08_T17_01_TT_INV'
SELECT 
	DISTINCT
	B14_BSAID_BELNR,
    B14_BSAID_BUZEI,
    B14_SKAT_TXT50,
    B14_BSAID_WAERS,
    B14_T001_WAERS,
    B14_GLOBALS_CURRENCY,
	B14_BSAID_BUDAT,
	B14_BSAID_BLDAT,
	B14_BSAID_GJAHR,
	B14_BSAID_BLART,
	B14_ZF_AR_DOC_TYPE_BUCKET,
	B14_ZF_BSAID_WRBTR_DOC,
    B14_ZF_BSAID_DMBTR_COC,
    B14_ZF_BSAID_DMBTR_CUC,
	B14_BSAID_AUGBL,
    B14_BSAID_AUGGJ,
    B14_BSAID_XBLNR,
	B14_BSAID_AUGDT,
	B14_BSAID_KUNNR,
	B14_BSAID_HKONT,
	B14_KNA1_NAME1,
	B14_BSAID_BUKRS,
	B14_BSAID_BSCHL,
    B14_TBSLT_LTEXT,
	B14_BSAID_SGTXT
INTO O08_T17_01_TT_INV
FROM B14_06_IT_ARE
WHERE 
	B14_ZF_AR_DOC_TYPE_BUCKET ='Customer invoice'
	
-- Step 2/ Caculate amount in document currency base on company code, matching key, clearing date, g/l account, customer number.

EXEC SP_DROPTABLE 'O08_T17_02_TT_TOTAL_INV'
SELECT
	B14_BSAID_BUKRS, 
	B14_BSAID_AUGBL,
	B14_BSAID_AUGDT,
	B14_BSAID_KUNNR,
	B14_BSAID_HKONT,
	SUM(B14_ZF_BSAID_WRBTR_DOC) AS BSAID_WRBTR_TOT_AUGBL,
    SUM(B14_ZF_BSAID_DMBTR_COC) AS BSAID_DMBTR_COC_TOT_AUGBL,
    SUM(B14_ZF_BSAID_DMBTR_CUC) AS BSAID_DMBTR_CUC_TOT_AUGBL
INTO O08_T17_02_TT_TOTAL_INV
FROM O08_T17_01_TT_INV
WHERE B14_ZF_BSAID_WRBTR_DOC >= 0 OR B14_ZF_BSAID_DMBTR_COC >= 0
GROUP BY 
	B14_BSAID_BUKRS,
	B14_BSAID_AUGBL,
	B14_BSAID_AUGDT,
	B14_BSAID_KUNNR,
	B14_BSAID_HKONT

-- Step 3/ List all the invoices join with DA and NEW DA table.

EXEC SP_DROPTABLE 'O08_T17_03_IT_INV'
SELECT 
	IDENTITY (INT, 100, 5) AS REF_KEY_JOIN,
	INV.B14_BSAID_BUKRS,
	INV.B14_BSAID_AUGDT,
	INV.B14_BSAID_KUNNR,
	INV.B14_BSAID_HKONT,
	INV.BSAID_WRBTR_TOT_AUGBL,
	INV.B14_BSAID_AUGBL
INTO O08_T17_03_IT_INV
FROM O08_T17_02_TT_TOTAL_INV AS INV 
INNER JOIN B14_06_IT_ARE AS DA ON 
	INV.B14_BSAID_KUNNR = DA.B14_BSAID_KUNNR 
	AND INV.B14_BSAID_HKONT = DA.B14_BSAID_HKONT
	AND INV.B14_BSAID_AUGBL = DA.B14_BSAID_AUGBL
	AND INV.B14_BSAID_AUGBL = DA.B14_BSAID_BELNR
	AND (INV.BSAID_WRBTR_TOT_AUGBL + DA.B14_ZF_BSAID_WRBTR_DOC) = 0
INNER JOIN B14_06_IT_ARE AS NEW_DA ON
	DA.B14_BSAID_KUNNR = NEW_DA.B14_BSAID_KUNNR 
	AND DA.B14_BSAID_HKONT = NEW_DA.B14_BSAID_HKONT
	AND DA.B14_BSAID_AUGBL != NEW_DA.B14_BSAID_AUGBL
	AND DA.B14_BSAID_BELNR = NEW_DA.B14_BSAID_BELNR
	AND DA.B14_BSAID_AUGBL = NEW_DA.B14_BSAID_BELNR
	AND (NEW_DA.B14_ZF_BSAID_WRBTR_DOC + DA.B14_ZF_BSAID_WRBTR_DOC) = 0
	
--Step 4/ Add more necessary fields from step 3. 

EXEC SP_DROPTABLE 'O08_T17_04_IT_INV_DETAIL'
SELECT 
	NEW_INV.REF_KEY_JOIN,
	ORI_INV.B14_BSAID_BELNR,
    ORI_INV.B14_BSAID_BUZEI,
    ORI_INV.B14_SKAT_TXT50,
    ORI_INV.B14_BSAID_WAERS,
    ORI_INV.B14_T001_WAERS,
    ORI_INV.B14_GLOBALS_CURRENCY,
	ORI_INV.B14_BSAID_BUDAT,
	ORI_INV.B14_BSAID_BLDAT,
	ORI_INV.B14_BSAID_GJAHR,
	ORI_INV.B14_BSAID_BLART,
	ORI_INV.B14_ZF_AR_DOC_TYPE_BUCKET,
	ORI_INV.B14_ZF_BSAID_WRBTR_DOC,
    ORI_INV.B14_ZF_BSAID_DMBTR_COC,
    ORI_INV.B14_ZF_BSAID_DMBTR_CUC,
	NEW_INV.B14_BSAID_AUGBL,
    ORI_INV.B14_BSAID_AUGGJ,
    ORI_INV.B14_BSAID_XBLNR,
	NEW_INV.B14_BSAID_AUGDT,
	NEW_INV.B14_BSAID_KUNNR,
	NEW_INV.B14_BSAID_HKONT,
	ORI_INV.B14_KNA1_NAME1,
	NEW_INV.B14_BSAID_BUKRS,
	ORI_INV.B14_BSAID_BSCHL,
    ORI_INV.B14_TBSLT_LTEXT,
	ORI_INV.B14_BSAID_SGTXT
INTO O08_T17_04_IT_INV_DETAIL
FROM O08_T17_01_TT_INV AS ORI_INV 
INNER JOIN O08_T17_03_IT_INV AS NEW_INV ON
	ORI_INV.B14_BSAID_KUNNR = NEW_INV.B14_BSAID_KUNNR
	AND ORI_INV.B14_BSAID_HKONT = NEW_INV.B14_BSAID_HKONT
	AND ORI_INV.B14_BSAID_BUKRS = NEW_INV.B14_BSAID_BUKRS
	AND ORI_INV.B14_BSAID_AUGBL = NEW_INV.B14_BSAID_AUGBL
	AND ORI_INV.B14_BSAID_AUGDT = NEW_INV.B14_BSAID_AUGDT

--Step 5/ List all the fields for DA table.

EXEC SP_DROPTABLE 'O08_T17_05_IT_DA'
SELECT 
	INV.REF_KEY_JOIN,
	DA.B14_BSAID_BELNR,
    DA.B14_BSAID_BUZEI,
    DA.B14_SKAT_TXT50,
    DA.B14_BSAID_WAERS,
    DA.B14_T001_WAERS,
    DA.B14_GLOBALS_CURRENCY,
	DA.B14_BSAID_BUDAT,
	DA.B14_BSAID_BLDAT,
	DA.B14_BSAID_GJAHR,
	DA.B14_BSAID_BLART,
	DA.B14_ZF_AR_DOC_TYPE_BUCKET,
	DA.B14_ZF_BSAID_WRBTR_DOC,
    DA.B14_ZF_BSAID_DMBTR_COC,
    DA.B14_ZF_BSAID_DMBTR_CUC,
	DA.B14_BSAID_AUGBL,
    DA.B14_BSAID_AUGGJ,
    DA.B14_BSAID_XBLNR,
	DA.B14_BSAID_AUGDT,
	DA.B14_BSAID_KUNNR,
	DA.B14_BSAID_HKONT,
	DA.B14_KNA1_NAME1,
	DA.B14_BSAID_BUKRS,
	DA.B14_BSAID_BSCHL,
    DA.B14_TBSLT_LTEXT,
	DA.B14_BSAID_SGTXT
INTO O08_T17_05_IT_DA
FROM 
	O08_T17_03_IT_INV AS INV INNER JOIN B14_06_IT_ARE AS DA ON 
	INV.B14_BSAID_KUNNR = DA.B14_BSAID_KUNNR 
	AND INV.B14_BSAID_HKONT = DA.B14_BSAID_HKONT
	AND INV.B14_BSAID_AUGBL = DA.B14_BSAID_AUGBL
	AND INV.B14_BSAID_AUGBL = DA.B14_BSAID_BELNR
	AND (INV.BSAID_WRBTR_TOT_AUGBL + DA.B14_ZF_BSAID_WRBTR_DOC) = 0

--Step 6/ List all the fields for NEW DA table

EXEC SP_DROPTABLE 'O08_T17_06_IT_NEW_DA'
 SELECT 
	DA.REF_KEY_JOIN,
	NEW_DA.B14_BSAID_BELNR,
    NEW_DA.B14_BSAID_BUZEI,
    NEW_DA.B14_SKAT_TXT50,
    NEW_DA.B14_BSAID_WAERS,
    NEW_DA.B14_T001_WAERS,
    NEW_DA.B14_GLOBALS_CURRENCY,
	NEW_DA.B14_BSAID_BUDAT,
	NEW_DA.B14_BSAID_BLDAT,
	NEW_DA.B14_BSAID_GJAHR,
	NEW_DA.B14_BSAID_BLART,
	NEW_DA.B14_ZF_AR_DOC_TYPE_BUCKET,
	NEW_DA.B14_ZF_BSAID_WRBTR_DOC,
    NEW_DA.B14_ZF_BSAID_DMBTR_COC,
    NEW_DA.B14_ZF_BSAID_DMBTR_CUC,
	NEW_DA.B14_BSAID_AUGBL,
    NEW_DA.B14_BSAID_AUGGJ,
    NEW_DA.B14_BSAID_XBLNR,
	NEW_DA.B14_BSAID_AUGDT,
	NEW_DA.B14_BSAID_KUNNR,
	NEW_DA.B14_BSAID_HKONT,
	NEW_DA.B14_KNA1_NAME1,
	NEW_DA.B14_BSAID_BUKRS,
	NEW_DA.B14_BSAID_BSCHL,
    NEW_DA.B14_TBSLT_LTEXT,
	NEW_DA.B14_BSAID_SGTXT,
	CASE
			WHEN DATEDIFF(day,DA.B14_BSAID_AUGDT, NEW_DA.B14_BSAID_AUGDT) >0 OR (NEW_DA.B14_BSAID_AUGDT IS NULL)
			 THEN  'Yes'
			ELSE ' '
	END ZF_CLEARING_DIFF
INTO O08_T17_06_IT_NEW_DA
FROM 
	O08_T17_05_IT_DA AS DA INNER JOIN B14_06_IT_ARE AS NEW_DA ON 
	DA.B14_BSAID_KUNNR = NEW_DA.B14_BSAID_KUNNR 
	AND DA.B14_BSAID_HKONT = NEW_DA.B14_BSAID_HKONT
	AND DA.B14_BSAID_AUGBL != NEW_DA.B14_BSAID_AUGBL
	AND DA.B14_BSAID_BELNR = NEW_DA.B14_BSAID_BELNR
	AND DA.B14_BSAID_AUGBL = NEW_DA.B14_BSAID_BELNR
	AND (NEW_DA.B14_ZF_BSAID_WRBTR_DOC + DA.B14_ZF_BSAID_WRBTR_DOC) = 0

-- Step 7/  Combine DA and NEW DA table into 1 table.

EXEC SP_DROPTABLE 'O08_T17_07_IT_DA_NEW_DA'
SELECT 
	DA.REF_KEY_JOIN,
	DA.B14_BSAID_BELNR AS BSAID_BELNR_DA,
    DA.B14_BSAID_BUZEI AS BSAID_BUZEI_DA,
    DA.B14_SKAT_TXT50 AS SKAT_TXT50_DA,
    DA.B14_BSAID_WAERS AS BSAID_WAERS_DA,
    DA.B14_T001_WAERS AS T001_WAERS_DA,
    DA.B14_GLOBALS_CURRENCY AS GLOBALS_CURRENCY_DA,
	DA.B14_BSAID_BUDAT AS BSAID_BUDAT_DA,
	DA.B14_BSAID_BLDAT AS BSAID_BLDAT_DA,
	DA.B14_BSAID_GJAHR AS BSAID_GJAHR_DA,
	DA.B14_BSAID_BLART AS BSAID_BLART_DA,
	DA.B14_ZF_AR_DOC_TYPE_BUCKET AS B14_ZF_AR_DOC_TYPE_BUCKET_DA,
	DA.B14_ZF_BSAID_WRBTR_DOC AS ZF_BSAID_WRBTR_DOC_DA,
    DA.B14_ZF_BSAID_DMBTR_COC AS ZF_BSAID_DMBTR_COC_DA,
    DA.B14_ZF_BSAID_DMBTR_CUC AS ZF_BSAID_DMBTR_CUC_DA,
	DA.B14_BSAID_AUGBL AS BSAID_AUGBL_DA,
    DA.B14_BSAID_AUGGJ AS BSAID_AUGGJ_DA,
    DA.B14_BSAID_XBLNR AS BSAID_XBLNR_DA,
	DA.B14_BSAID_AUGDT AS BSAID_AUGDT_DA,
	DA.B14_BSAID_KUNNR AS BSAID_KUNNR_DA,
	DA.B14_BSAID_HKONT AS BSAID_HKONT_DA,
	DA.B14_KNA1_NAME1 AS KNA1_NAME1_DA,
	DA.B14_BSAID_BUKRS AS BSAID_BUKRS_DA,
	DA.B14_BSAID_BSCHL AS BSAID_BSCHL_DA,
    DA.B14_TBSLT_LTEXT AS TBSLT_LTEXT_DA,
	DA.B14_BSAID_SGTXT AS BSAID_SGTXT_DA,
	NEW_DA.B14_BSAID_BELNR AS BSAID_BELNR_NEW_DA,
    NEW_DA.B14_BSAID_BUZEI AS BSAID_BUZEI_NEW_DA,
    NEW_DA.B14_SKAT_TXT50 AS SKAT_TXT50_NEW_DA,
    NEW_DA.B14_BSAID_WAERS AS BSAID_WAERS_NEW_DA,
    NEW_DA.B14_T001_WAERS AS T001_WAERS_NEW_DA,
    NEW_DA.B14_GLOBALS_CURRENCY AS GLOBAL_CURRENCY_NEW_DA,
	NEW_DA.B14_BSAID_BUDAT AS  BSAID_BUDAT_NEW_DA,
	NEW_DA.B14_BSAID_BLDAT AS BSAID_BLDAT_NEW_DA,
	NEW_DA.B14_BSAID_GJAHR AS BSAID_GJAHR_NEW_DA,
	NEW_DA.B14_BSAID_BLART AS BSAID_BLART_NEW_DA,
	NEW_DA.B14_ZF_AR_DOC_TYPE_BUCKET AS ZF_AR_DOC_TYPE_BUCKET_NEW_DA,
	NEW_DA.B14_ZF_BSAID_WRBTR_DOC AS ZF_BSAID_WRBTR_DOC_NEW_DA,
    NEW_DA.B14_ZF_BSAID_DMBTR_COC AS ZF_BSAID_DMBTR_COC_NEW_DA,
    NEW_DA.B14_ZF_BSAID_DMBTR_CUC AS ZF_BSAID_DMBTR_CUC_NEW_DA,
	NEW_DA.B14_BSAID_AUGBL AS BSAID_AUGBL_NEW_DA,
	NEW_DA.B14_BSAID_AUGDT AS BSAID_AUGDT_NEW_DA,
	NEW_DA.B14_BSAID_AUGGJ AS BSAID_AUGGJ_NEW_DA,
    NEW_DA.B14_BSAID_XBLNR AS BSAID_XBLNR_NEW_DA,
	NEW_DA.B14_BSAID_KUNNR AS BSAID_KUNNR_NEW_DA,
	NEW_DA.B14_BSAID_HKONT AS BSAID_HKONT_NEW_DA,
	NEW_DA.B14_KNA1_NAME1 AS KNA1_NAME1_NEW_DA,
	NEW_DA.B14_BSAID_BUKRS AS BSAID_BUKRS_NEW_DA,
	NEW_DA.B14_BSAID_BSCHL AS BSAID_BSCHL_NEW_DA,
    NEW_DA.B14_TBSLT_LTEXT AS TBSLT_LTEXT_NEW_DA,
	NEW_DA.B14_BSAID_SGTXT AS BSAID_SGTXT_NEW_DA,
	NEW_DA.ZF_CLEARING_DIFF
INTO O08_T17_07_IT_DA_NEW_DA
FROM O08_T17_05_IT_DA  AS DA INNER JOIN O08_T17_06_IT_NEW_DA AS NEW_DA 
ON  DA.REF_KEY_JOIN = NEW_DA.REF_KEY_JOIN

-- Change name for column
EXEC SP_UNNAME_FIELD 'B14_', 'O08_T17_04_IT_INV_DETAIL'
EXEC SP_RENAME_SUFFIX_FIELD '_INV','O08_T17_04_IT_INV_DETAIL'
EXEC SP_UNNAME_FIELD 'B14_', 'O08_T17_07_IT_DA_NEW_DA'
/* log cube creation*/

INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(DATE,GETDATE()),CONVERT(TIME,GETDATE()),'Cube completed','O08_T17_04_IT_INV_DETAIL',(SELECT COUNT(*) FROM O08_T17_04_IT_INV_DETAIL) 
INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(DATE,GETDATE()),CONVERT(TIME,GETDATE()),'Cube completed','O08_T17_07_IT_DA_NEW_DA',(SELECT COUNT(*) FROM O08_T17_07_IT_DA_NEW_DA) 

/* log end of procedure*/


INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(date,GETDATE()),CONVERT(time,GETDATE()),'Procedure finished',NULL,NULL


END
GO
