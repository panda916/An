USE [DIVA_MASTER_SCRIPT]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[script_B37_OTC_GLOBAL_TABLE]
AS
--DYNAMIC_SCRIPT_START
/*  Change history comments
	Update history 
	-------------------------------------------------------
	Date            | Who   |  Description 
	--  23-03-2022	| Thuan	| Remove MANDT field in join
*/

	--Step 1
	--Create a flow table by joining all necessary cubes

	--Step 1.1 Join Sale order, delivery, material cube together
	EXEC SP_REMOVE_TABLES 'B37_01_TT_CENTER_FACT_TABLE'
	SELECT	DISTINCT 
	--Add sale order keys
	B33_01_IT_SALE_DOCUMENTS.B33_ZF_SALE_ORDER_KEY,
	B33_01_IT_SALE_DOCUMENTS.B33_VBAP_ERDAT,
	B33_01_IT_SALE_DOCUMENTS.B33_VBAP_ERZET,
	B33_01_IT_SALE_DOCUMENTS.B33_VBAK_MANDT,
	B33_01_IT_SALE_DOCUMENTS.B33_VBAK_ERNAM ,
	B33_01_IT_SALE_DOCUMENTS.B33_ZF_VBAK_ERNAM_TEXT,
	B33_01_IT_SALE_DOCUMENTS.B33_VBAK_VBELN,
	B33_01_IT_SALE_DOCUMENTS.B33_VBAP_POSNR,
	B33_01_IT_SALE_DOCUMENTS.B33_VBAK_KUNNR,
	B33_01_IT_SALE_DOCUMENTS.B33_ZF_VBAP_NETWR_S_COC,
	B33_01_IT_SALE_DOCUMENTS.B33_ZF_VBAP_NETWR_S_CUC,
	B33_01_IT_SALE_DOCUMENTS.B33_TVKO_BUKRS,
	B33_ZF_DD07T_DDTEXT_VBTYP,
	B33_01_IT_SALE_DOCUMENTS.B33_VBAK_AUART,
	B33_VBAK_WAERK,B33_T001_WAERS,
	--Add delivery keys
	B34_ZF_SALE_DELIVERY_DOC_KEY ,
	B34_01_IT_DELIVERY_DOCS.B34_LIKP_ERDAT ,
	B34_01_IT_DELIVERY_DOCS.B34_LIPS_ERZET ,
	B34_01_IT_DELIVERY_DOCS.B34_LIKP_ERNAM,
	B34_01_IT_DELIVERY_DOCS.B34_ZF_LIKP_ERNAM_TEXT,
	B34_01_IT_DELIVERY_DOCS.B34_LIKP_VBELN,
	B34_01_IT_DELIVERY_DOCS.B34_LIPS_MATNR,
	B34_01_IT_DELIVERY_DOCS.B34_LIKP_MANDT,
	B34_01_IT_DELIVERY_DOCS.B34_LIPS_POSNR ,
	B34_01_IT_DELIVERY_DOCS.B34_LIKP_KUNAG,
	B34_01_IT_DELIVERY_DOCS.B34_ZF_LIPS_NETWR_COC ,
	B34_01_IT_DELIVERY_DOCS.B34_ZF_LIPS_NETWR_CUC ,
	B34_01_IT_DELIVERY_DOCS.B34_TVKO_BUKRS,
	B34_01_IT_DELIVERY_DOCS.B34_LIKP_LFART,
	B34_LIKP_WAERK,B34_T001_WAERS,
	--Add material document keys
	CONCAT(DBO.TRIM(B24_03_MSEG_MBLNR),'-',
	DBO.TRIM(B24_03_MSEG_MJAHR),'-',
	DBO.TRIM(B24_03_MSEG_ZEILE)) AS B24_03_ZF_SALE_MATERIAL_DOC_KEY ,
	B24_03_IT_MATERIAL_DOC.B24_03_MKPF_CPUDT,
	B24_03_IT_MATERIAL_DOC.B24_03_MKPF_CPUTM,
	B24_03_IT_MATERIAL_DOC.B24_03_MKPF_USNAM ,
	B24_03_IT_MATERIAL_DOC.B24_03_V_USERNAME_NAME_TEXT,
	B24_03_IT_MATERIAL_DOC.B24_03_MSEG_KUNNR,
	B24_03_IT_MATERIAL_DOC.B24_03_ZF_MSEG_DMBTR_SIGNED_CUC,
	B24_03_IT_MATERIAL_DOC.B24_03_ZF_MSEG_DMBTR_SIGNED,
	B24_03_IT_MATERIAL_DOC.B24_03_MSEG_BUKRS,
	B24_03_IT_MATERIAL_DOC.B24_03_MKPF_BLART,
	B24_03_MSEG_WAERS
	INTO B37_01_TT_CENTER_FACT_TABLE
	FROM B33_01_IT_SALE_DOCUMENTS 
	--Get delivery key for sale order key
	FULL OUTER JOIN B34_01_IT_DELIVERY_DOCS
	ON B34_01_IT_DELIVERY_DOCS.B34_LIPS_VGBEL = B33_01_IT_SALE_DOCUMENTS.B33_VBAK_VBELN
	AND CAST(B34_01_IT_DELIVERY_DOCS.B34_LIPS_VGPOS AS INT) = CAST(B33_01_IT_SALE_DOCUMENTS.B33_VBAP_POSNR AS INT)

	--Get good issue (Material) document for delivery document

		FULL OUTER JOIN B24_03_IT_MATERIAL_DOC 
			ON B24_03_IT_MATERIAL_DOC.B24_03_MKPF_LE_VBELN =  B34_01_IT_DELIVERY_DOCS.B34_LIKP_VBELN
		AND B24_03_IT_MATERIAL_DOC.B24_03_MSEG_MATNR=B34_01_IT_DELIVERY_DOCS.B34_LIPS_MATNR

	--STep 1.2	Add billing document keys to the flow table
	--One from SO, one from Delivery(which don't have SO)
	--Union 2 to 1 table

	--Step 1.2.1 get the billing from SO
		EXEC SP_DROPTABLE B37_02_TT_CENTER_FACT_TABLE_ADD_SO
	SELECT DISTINCT B37_01_TT_CENTER_FACT_TABLE.*,
	B36_ZF_SALE_INVOICE_DOC_KEY,
	B36_VBRP_ERDAT,
	B36_VBRK_ERZET,
	B36_VBRK_ERNAM,
	B36_VBRK_ERNAM_NAME_TEXT,
	B36_VBRK_VBELN,
	B36_VBRK_KUNAG,
	B36_ZF_VBRP_NETWR_S_COC,
	B36_ZF_VBRP_NETWR_S_CUC,
	B36_VBRP_VBELN,
	B36_ZF_DD07T_DDTEXT_FKTYP,
	B36_TVKO_BUKRS,
	B36_VBRK_FKART,
	B36_VBRK_WAERK,B36_T001_WAERS
	INTO B37_02_TT_CENTER_FACT_TABLE_ADD_SO
	FROM B37_01_TT_CENTER_FACT_TABLE
			LEFT JOIN B36_01_IT_INVOICE_DOCS
			ON B36_01_IT_INVOICE_DOCS.B36_VBRP_VGBEL = B33_VBAK_VBELN  
			AND CAST(B36_01_IT_INVOICE_DOCS.B36_VBRP_VGPOS AS INT)=CAST(B33_VBAP_POSNR AS INT) 
	--Step 1.2.2 get the billing from delivery ,Which don't have in SO
	--Get the list of Inv no SO and SO no Inv

	--SO no Inv
	EXEC SP_DROPTABLE B37_03A_TT_SO_NO_INV
	SELECT DISTINCT  
		B37_01_TT_CENTER_FACT_TABLE.*
	INTO B37_03A_TT_SO_NO_INV
	FROM B37_01_TT_CENTER_FACT_TABLE
		LEFT JOIN B36_01_IT_INVOICE_DOCS
			ON B33_VBAK_VBELN=B36_01_IT_INVOICE_DOCS.B36_VBRP_VGBEL
			AND CAST(B33_VBAP_POSNR AS INT)  =CAST(B36_01_IT_INVOICE_DOCS.B36_VBRP_VGPOS AS INT)
	WHERE B36_VBRK_MANDT IS NULL AND B36_VBRP_VGBEL IS NULL AND B36_VBRP_VGPOS IS NULL

	--Inv no SO
	EXEC SP_DROPTABLE B37_03B_TT_INV_NO_SO
		SELECT DISTINCT  
	B36_01_IT_INVOICE_DOCS.*
	INTO B37_03B_TT_INV_NO_SO
	FROM B37_01_TT_CENTER_FACT_TABLE
		RIGHT JOIN B36_01_IT_INVOICE_DOCS
			ON B33_VBAK_VBELN=B36_01_IT_INVOICE_DOCS.B36_VBRP_VGBEL
			AND CAST(B33_VBAP_POSNR AS INT)  =CAST(B36_01_IT_INVOICE_DOCS.B36_VBRP_VGPOS AS INT)
	WHERE B33_VBAK_MANDT IS NULL AND B33_VBAK_VBELN IS NULL AND B33_VBAP_POSNR IS NULL

	--Join Inv no SO and SO no Inv
	EXEC SP_DROPTABLE B37_03_TT_CENTER_FACT_TABLE_ADD_DELI
	SELECT DISTINCT B37_03A_TT_SO_NO_INV.*,
	B36_ZF_SALE_INVOICE_DOC_KEY,
	B36_VBRP_ERDAT,
	B36_VBRK_ERZET,
	B36_VBRK_ERNAM,
	B36_VBRK_ERNAM_NAME_TEXT,
	B36_VBRK_VBELN,
	B36_VBRK_KUNAG,
	B36_ZF_VBRP_NETWR_S_COC,
	B36_ZF_VBRP_NETWR_S_CUC,
	B36_VBRP_VBELN,
	B36_ZF_DD07T_DDTEXT_FKTYP,
	B36_TVKO_BUKRS,
	B36_VBRK_FKART,
	B36_VBRK_WAERK,B36_T001_WAERS
	INTO B37_03_TT_CENTER_FACT_TABLE_ADD_DELI
	FROM B37_03A_TT_SO_NO_INV 
			FULL OUTER JOIN 
				B37_03B_TT_INV_NO_SO  AS A
			ON A.B36_VBRP_VGBEL = B34_LIKP_VBELN
			AND CAST(A.B36_VBRP_VGPOS AS INT)=CAST(B34_LIPS_POSNR AS INT) 

	--Step 1.2.3 Append 2 table 
	EXEC SP_DROPTABLE B37_04_TT_CENTER_FACT_TABLE_UNION
	SELECT DISTINCT * INTO B37_04_TT_CENTER_FACT_TABLE_UNION
	FROM B37_02_TT_CENTER_FACT_TABLE_ADD_SO
	UNION
	SELECT DISTINCT * FROM B37_03_TT_CENTER_FACT_TABLE_ADD_DELI

	--Step 1.4 Add FI invoie , Inv cancellation,payment ,payment cancellation
	EXEC SP_DROPTABLE B37_05_IT_CENTER_FACT_TABLE_ADD_INV_PAY
	SELECT DISTINCT 
	IDENTITY(INT,1,1) AS ZF_DOCUMENT_FLOW_KEY,
	B37_04_TT_CENTER_FACT_TABLE_UNION.*,
	B14_01_ZF_CUSTOMER_INVOICE_KEY,
	B14_01_BSAID_CPUDT,
	B14_01_BKPF_CPUTM,
	B14_01_BKPF_USNAM,
	B14_01_V_USERNAME_NAME_TEXT,
	 B14_01_BSAID_KUNNR,
	B14_01_BSAID_BUKRS,
	B14_01_BSAID_BLART,
	B14_01_T003T_LTEXT,
	 B14_01_T001_WAERS,
	B14_01_ZF_BSAID_DMBTR_COC,
	B14_01_ZF_BSAID_DMBTR_CUC,

	CONCAT(B14_02_BSAID_BUKRS,'|',B14_02_BSAID_AUGBL,'|',B14_02_BSAID_AUGDT) AS B14_02_ZF_CUSTOMER_CREDIT_NOTE, 
	B14_02_BKPF_USNAM,
	B14_02_V_USERNAME_NAME_TEXT,
--	B14_02_BSAID_KUNNR,
	B14_02_BSAID_BUKRS,
	B14_02_BSAID_BLART,
	B14_02_T003T_LTEXT,
	 B14_02_T001_WAERS,
	B14_02_BSAID_AUGBL,
	B14_02_BSAID_AUGDT,
	B14_02_ZF_BSAID_DMBTR_COC,
	B14_02_ZF_BSAID_DMBTR_CUC,

	CONCAT(B14_05_BSAID_BUKRS,'|',B14_05_BSAID_AUGBL,'|',B14_05_BSAID_AUGDT) AS B14_05_ZF_OTHERS, 

	B14_05_BKPF_USNAM,
	B14_05_V_USERNAME_NAME_TEXT,
	B14_05_BSAID_BUKRS,
	B14_05_BSAID_BLART,
	B14_05_T003T_LTEXT,
	 B14_05_T001_WAERS,
	 B14_05_ZF_BSAID_DMBTR_COC,
	B14_05_ZF_BSAID_DMBTR_CUC,
	B14_05_BSAID_AUGBL,
	B14_05_BSAID_AUGDT,


	CONCAT(B14_03_BSAID_BUKRS,'|',B14_03_BSAID_AUGBL,'|',B14_03_BSAID_AUGDT)  AS B14_03_ZF_CUSTOMER_PAYMENT_KEY, 
	B14_03_BKPF_USNAM,
	B14_03_V_USERNAME_NAME_TEXT,
	B14_03_BSAID_BUKRS,
	B14_03_BSAID_BLART,
	B14_03_T003T_LTEXT,
	 B14_03_T001_WAERS,
	B14_03_BSAID_AUGBL,
	B14_03_BSAID_AUGDT,
	B14_03_ZF_BSAID_DMBTR_COC,
	B14_03_ZF_BSAID_DMBTR_CUC,

	 CONCAT(B14_04_BSAID_BUKRS,'|',B14_04_BSAID_AUGBL,'|',B14_04_BSAID_AUGDT)  AS  B14_04_ZF_CUSTOMER_PAYMENT_CANCELLATION,
	 B14_04_BKPF_USNAM,
	B14_04_V_USERNAME_NAME_TEXT,
	 B14_04_BSAID_BUKRS,
	B14_04_BSAID_BLART,
	 B14_04_T003T_LTEXT,
	 B14_04_T001_WAERS,
	B14_04_ZF_BSAID_DMBTR_COC,
	B14_04_ZF_BSAID_DMBTR_CUC,
	B14_04_BSAID_AUGBL,
	B14_04_BSAID_AUGDT

	INTO B37_05_IT_CENTER_FACT_TABLE_ADD_INV_PAY
	FROM B37_04_TT_CENTER_FACT_TABLE_UNION
		--Get the Customer invoice 
		FULL OUTER JOIN B14_SS01_06_IT_CUSTOMER_INVOICE_SUMMARY  
		ON B14_01_BKPF_AWKEY=B36_VBRP_VBELN
		AND B14_01_BSAID_BUKRS=B36_TVKO_BUKRS

		--Get the credit note
		FULL OUTER JOIN B14_SS01_07_IT_CUSTOMER_CREDIT_NOTE
		ON B14_02_BSAID_AUGBL=B14_01_BSAID_AUGBL
		AND B14_02_BSAID_AUGDT=B14_01_BSAID_AUGDT
		AND B14_02_BSAID_BUKRS=B14_01_BSAID_BUKRS
	AND (B14_02_BSAID_AUGBL<>'' AND B14_01_BSAID_AUGBL<>'' AND B14_02_BSAID_AUGBL<>'ALE-extern')
	--Get the Customer payment
		FULL OUTER JOIN B14_SS01_08_IT_CUSTOMER_PAYMENT_SUMMARY
		ON B14_01_BSAID_AUGBL=B14_03_BSAID_AUGBL
		AND B14_01_BSAID_AUGDT=B14_03_BSAID_AUGDT
		AND B14_01_BSAID_BUKRS=B14_03_BSAID_BUKRS
	AND (B14_01_BSAID_AUGBL<>'' AND B14_03_BSAID_AUGBL<>'' AND B14_03_BSAID_AUGBL<>'ALE-extern')

		--Get the Customer payment cancellation
		FULL OUTER JOIN B14_SS01_09_IT_CUSTOMER_PAYMENT_CANCEL_SUMMARY
		ON  B14_03_BSAID_AUGBL=B14_04_BSAID_AUGBL
		AND B14_03_BSAID_AUGDT=B14_04_BSAID_AUGDT
		AND B14_03_BSAID_BUKRS=B14_04_BSAID_BUKRS
	AND (B14_03_BSAID_AUGBL<>'' AND B14_04_BSAID_AUGBL<>'' AND B14_04_BSAID_AUGBL<>'ALE-extern')

-- get the other
		FULL OUTER JOIN B14_SS01_10_IT_CUSTOMER_OTHERS_SUMMARY
		ON B14_05_BSAID_AUGBL=B14_01_BSAID_AUGBL
		AND B14_05_BSAID_AUGDT=B14_01_BSAID_AUGDT
		AND B14_05_BSAID_BUKRS=B14_01_BSAID_BUKRS
	AND (B14_05_BSAID_AUGBL<>'' AND B14_01_BSAID_AUGBL<>'' AND B14_05_BSAID_AUGBL<>'ALE-extern')


 
--Drop all TT table
EXEC SP_REMOVE_TABLES 'TEMP%'
--EXEC SP_REMOVE_TABLES '%_TT_%'
GO
