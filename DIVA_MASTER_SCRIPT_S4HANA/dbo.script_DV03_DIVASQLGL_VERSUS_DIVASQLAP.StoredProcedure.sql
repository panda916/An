USE [DIVA_MASTER_SCRIPT_S4HANA]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE       PROCEDURE [dbo].[script_DV03_DIVASQLGL_VERSUS_DIVASQLAP]

WITH EXECUTE AS CALLER
AS
--DYNAMIC_SCRIPT_START
BEGIN
 
 /*
    Title            :  DV03: Data Validation dashboard 
    Description      :  Compares the GL cube to the AP cube
       --------------------------------------------------------------
    Update history
    --------------------------------------------------------------
    Date             |      Who |  Description
	15-06-2018          HuyTran        Creation
	                                  
*/
--Create database log table if it does not exist
IF OBJECT_ID('LOG_SP_EXECUTION', 'U') IS NULL BEGIN CREATE TABLE [DBO].[LOG_SP_EXECUTION] ([DATABASE] NVARCHAR(MAX) NULL,[OBJECT] NVARCHAR(MAX) NULL,[OBJECT_TYPE] NVARCHAR(MAX) NULL,[USER] NVARCHAR(MAX) NULL,[DATE] DATE NULL,[TIME] TIME NULL,[DESCRIPTION] NVARCHAR(MAX) NULL,[TABLE] NVARCHAR(MAX),[ROWS] INT) END

--Log start of procedure
INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(DATE,GETDATE()),CONVERT(TIME,GETDATE()),'Procedure started',NULL,NULL

-- Step 1/ Get amount per month on GL table per GL account which contain only Vendor
EXEC SP_DROPTABLE 'DV03_01_TT_GL_CUBE'
	SELECT
		B04_GL_ACDOCA_RCLNT AS B04_ACDOCA_RCLNT,
		B04_GL_ACDOCA_RBUKRS AS B04_ACDOCA_RBUKRS,
		B04_GL_ACDOCA_GJAHR AS B04_ACDOCA_GJAHR,
		RIGHT(B04_GL_ZF_ACDOCA_GJAHR_MONAT,2) AS B04_ZF_ACDOCA_MONAT,
		B04_GL_ACDOCA_RACCT AS B04_ACDOCA_RACCT,
		B04_GL_ACDOCA_BELNR AS B04_ACDOCA_BELNR,
		B04_GL_ACDOCA_BUZEI AS B04_ACDOCA_BUZEI,
		SUM(IIF(B04_GL_ACDOCA_DRCRK = 'S', B04_GL_ZF_ACDOCA_HSL_S, 0)) AS B04_ZF_ACDOCA_HSL_DB,
		SUM(IIF(B04_GL_ACDOCA_DRCRK = 'H', B04_GL_ZF_ACDOCA_HSL_S, 0)) AS B04_ZF_ACDOCA_HSL_CB,
		SUM(B04_GL_ZF_ACDOCA_HSL_S) AS B04_ZF_ACDOCA_HSL_S
	INTO DV03_01_TT_GL_CUBE
    FROM B04_08_IT_FIN_GL
    WHERE B04_GL_ACDOCA_KOART = 'K'
    GROUP BY
            B04_GL_ACDOCA_RCLNT,
            B04_GL_ACDOCA_RBUKRS,
			B04_GL_ACDOCA_GJAHR,
            B04_GL_ZF_ACDOCA_GJAHR_MONAT,
            B04_GL_ACDOCA_RACCT,
            B04_GL_ACDOCA_BELNR,
            B04_GL_ACDOCA_BUZEI             
 
--Step 3/ Get amount per month on PTP table per GL account
-- Update 28/05/2019 by thuan  SUM(IIF(B11B_BSAIK_SHKZG = 'S', B11B_ZF_BSAIK_DMBTR_S, 0)) AS B11B_ZF_BSAIK_DMBTR_DEBIT, -> 
EXEC SP_DROPTABLE 'DV03_02_TT_AP_CUBE'
	SELECT
            B11B_ACDOCA_RCLNT AS B11_ACDOCA_RCLNT,
			B11B_ACDOCA_RBUKRS AS B11_ACDOCA_RBUKRS,
            B11B_ACDOCA_GJAHR AS B11_ACDOCA_GJAHR,
            B11B_ACDOCA_MONAT AS B11_ACDOCA_MONAT,
            B11B_ACDOCA_RACCT AS B11_ACDOCA_RACCT,
            B11B_ACDOCA_BELNR AS B11_ACDOCA_BELNR,
            B11B_ACDOCA_BUZEI AS B11_ACDOCA_BUZEI,
            SUM(IIF(B11B_ACDOCA_DRCRK = 'S', B11B_ZF_ACDOCA_HSL_S, 0)) AS B11B_ZF_ACDOCA_HSL_DB,
            SUM(IIF(B11B_ACDOCA_DRCRK = 'H', B11B_ZF_ACDOCA_HSL_S, 0)) AS B11B_ZF_ACDOCA_HSL_CB
    INTO DV03_02_TT_AP_CUBE
    FROM B11_04_IT_PTP_APA
    GROUP BY
			B11B_ACDOCA_RCLNT,
			B11B_ACDOCA_RBUKRS,
			B11B_ACDOCA_GJAHR,
			B11B_ACDOCA_MONAT,
			B11B_ACDOCA_RACCT,
			B11B_ACDOCA_BELNR,
			B11B_ACDOCA_BUZEI

--Step 4/ Comparing GL and AP so that we have all data which stored in GL or AP or in both
	EXECUTE SP_DROPTABLE 'DV03_03_RT_COMP_GL_AP_CUBE'
    SELECT
			 B04_ACDOCA_RCLNT
			,B11_ACDOCA_RCLNT
			,B04_ACDOCA_RBUKRS
			,B11_ACDOCA_RBUKRS
			,B04_ACDOCA_GJAHR
			,B11_ACDOCA_GJAHR
			,B04_ZF_ACDOCA_MONAT
			,B11_ACDOCA_MONAT
			,B04_ACDOCA_RACCT
			,B11_ACDOCA_RACCT
			,B04_ACDOCA_BELNR
			,B11_ACDOCA_BELNR
			,B04_ACDOCA_BUZEI
			,B11_ACDOCA_BUZEI
			-- check field			
			,CASE 
				WHEN ISNULL(B04_ACDOCA_BELNR,'') <> '' AND 
					ISNULL(B11_ACDOCA_BELNR,'') = '' 
				THEN 'DOC IN GL NOT IN AP'
				WHEN ISNULL(B04_ACDOCA_BELNR,'') = '' AND 
					ISNULL(B11_ACDOCA_BELNR,'') <> '' 
				THEN 'DOC IN AP NOT IN GL'
				WHEN ISNULL(B04_ACDOCA_BELNR,'') <> '' AND 
				ISNULL(B11_ACDOCA_BELNR,'') <> ''
				THEN 'DOC IN GL AND AP'
				ELSE 'CASE NOT IDENTIFIED'
			END AS   ZF_CHECK_BELNR_IN_GL_AND_AP_CUBE
			--numeric check
			,B04_ZF_ACDOCA_HSL_DB
			,B11B_ZF_ACDOCA_HSL_DB
			,ISNULL(B04_ZF_ACDOCA_HSL_DB, 0) - ISNULL(B11B_ZF_ACDOCA_HSL_DB, 0) AS ZF_GL_DB_MINUS_AP_DB
			,B04_ZF_ACDOCA_HSL_CB
			,B11B_ZF_ACDOCA_HSL_CB
			,ISNULL(B04_ZF_ACDOCA_HSL_CB, 0) - ISNULL(B11B_ZF_ACDOCA_HSL_CB, 0) AS ZF_GL_CB_MINUS_AP_CB
    INTO   DV03_03_RT_COMP_GL_AP_CUBE
    FROM DV03_01_TT_GL_CUBE
    FULL OUTER JOIN DV03_02_TT_AP_CUBE ON
		DV03_01_TT_GL_CUBE.B04_ACDOCA_RCLNT			= DV03_02_TT_AP_CUBE.B11_ACDOCA_RCLNT AND
		DV03_01_TT_GL_CUBE.B04_ACDOCA_RBUKRS		= DV03_02_TT_AP_CUBE.B11_ACDOCA_RBUKRS AND
		DV03_01_TT_GL_CUBE.B04_ACDOCA_GJAHR			= DV03_02_TT_AP_CUBE.B11_ACDOCA_GJAHR AND
		DV03_01_TT_GL_CUBE.B04_ZF_ACDOCA_MONAT		= DV03_02_TT_AP_CUBE.B11_ACDOCA_MONAT AND
		DV03_01_TT_GL_CUBE.B04_ACDOCA_RACCT			= DV03_02_TT_AP_CUBE.B11_ACDOCA_RACCT AND
		DV03_01_TT_GL_CUBE.B04_ACDOCA_BELNR			= DV03_02_TT_AP_CUBE.B11_ACDOCA_BELNR AND
		DV03_01_TT_GL_CUBE.B04_ACDOCA_BUZEI			= DV03_02_TT_AP_CUBE.B11_ACDOCA_BUZEI
 
  
--Step 5/ Split the comparison into two tables so that we can be able to filter them separately
	--5.1 DIVA SQL GL full table
	EXEC SP_DROPTABLE 'DV03_04_RT_FULL_GL_CUBE'
	SELECT
		*
		,B04_ACDOCA_RCLNT + '|' + B04_ACDOCA_RBUKRS + '|' + B04_ACDOCA_GJAHR +  '|' +  B04_ACDOCA_BELNR  + '|' + B04_ACDOCA_BUZEI  AS ZF_KEY_JOIN_GL
	INTO DV03_04_RT_FULL_GL_CUBE
	FROM DV03_03_RT_COMP_GL_AP_CUBE
	WHERE B04_ACDOCA_RACCT IS NOT NULL
	
	---- 
	EXEC SP_DROPTABLE 'DV03_05_RT_FULL_AP_CUBE'
	--5.2  DIVA SQL AP full tablle
	SELECT 
		*                 
		,B11_ACDOCA_RCLNT + '|' + B11_ACDOCA_RBUKRS + '|' + B11_ACDOCA_GJAHR +  '|' +  B11_ACDOCA_BELNR  + '|' + B11_ACDOCA_BUZEI  AS ZF_KEY_JOIN_APA
	INTO DV03_05_RT_FULL_AP_CUBE
	FROM DV03_03_RT_COMP_GL_AP_CUBE
	WHERE B11_ACDOCA_RACCT IS NOT NULL
 
-- Step 6/ Split the comparison into two discrepancy tables so that we can be able to filter them separately
 	
	--Step 6.1  DIVASQLGL discrepancy table
	EXEC SP_DROPTABLE 'DV03_06_RT_DISC_GL_CUBE'
	SELECT
		*
		,B04_ACDOCA_RCLNT + '|' + B04_ACDOCA_RBUKRS + '|' + B04_ACDOCA_GJAHR +  '|' +  B04_ACDOCA_BELNR  + '|' + B04_ACDOCA_BUZEI  AS ZF_KEY_JOIN_GL
	INTO DV03_06_RT_DISC_GL_CUBE
	FROM DV03_03_RT_COMP_GL_AP_CUBE
	WHERE 
		ABS(ZF_GL_DB_MINUS_AP_DB)>10 AND ZF_CHECK_BELNR_IN_GL_AND_AP_CUBE = 'DOC IN GL NOT IN AP' 

	----Step 6.2  DIVASQLAP discrepancy table
	EXEC SP_DROPTABLE 'DV03_07_RT_DISC_AP_CUBE'
	SELECT
		*
		,B11_ACDOCA_RCLNT + '|' + B11_ACDOCA_RBUKRS + '|' + B11_ACDOCA_GJAHR +  '|' +  B11_ACDOCA_BELNR  + '|' + B11_ACDOCA_BUZEI  AS ZF_KEY_JOIN_APA
	INTO DV03_07_RT_DISC_AP_CUBE
	FROM DV03_03_RT_COMP_GL_AP_CUBE
	WHERE
		ABS(ZF_GL_DB_MINUS_AP_DB)>10 AND
		ZF_CHECK_BELNR_IN_GL_AND_AP_CUBE = 'DOC IN AP NOT IN GL' 
		OR ZF_CHECK_BELNR_IN_GL_AND_AP_CUBE = 'Case not identified'
	

--step 7 Send Finish Message for the tool
	INSERT INTO DV00_RT_USER_FEEDBACK_MESSAGE VALUES('', '', 'DV03_DIVASQLGL_VERSUS_DIVASQLAP')

--Step 8/
--Delete temporary tables
	EXEC SP_REMOVE_TABLES '%_TT_%'

-- Step 9/
-- Rename fields 
EXEC SP_RENAME_FIELD 'DV03A_', 'DV03_03_RT_COMP_GL_AP_CUBE'
EXEC SP_RENAME_FIELD 'DV03B_', 'DV03_04_RT_FULL_GL_CUBE'
EXEC SP_RENAME_FIELD 'DV03C_', 'DV03_05_RT_FULL_AP_CUBE'
EXEC SP_RENAME_FIELD 'DV03D_', 'DV03_06_RT_DISC_GL_CUBE'
EXEC SP_RENAME_FIELD 'DV03E_', 'DV03_07_RT_DISC_AP_CUBE'


INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(DATE,GETDATE()),CONVERT(TIME,GETDATE()),'Cube completed','DV03_03_RT_COMP_GL_AP_CUBE',(SELECT COUNT(*) FROM DV03_03_RT_COMP_GL_AP_CUBE) 
INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(DATE,GETDATE()),CONVERT(TIME,GETDATE()),'Cube completed','DV03_04_RT_FULL_GL_CUBE',(SELECT COUNT(*) FROM DV03_04_RT_FULL_GL_CUBE) 
INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(DATE,GETDATE()),CONVERT(TIME,GETDATE()),'Cube completed','DV03_05_RT_FULL_AP_CUBE',(SELECT COUNT(*) FROM DV03_05_RT_FULL_AP_CUBE)      
INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(DATE,GETDATE()),CONVERT(TIME,GETDATE()),'Cube completed','DV03_06_RT_DISC_GL_CUBE',(SELECT COUNT(*) FROM DV03_06_RT_DISC_GL_CUBE)  
INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(DATE,GETDATE()),CONVERT(TIME,GETDATE()),'Cube completed','DV03_07_RT_DISC_AP_CUBE',(SELECT COUNT(*) FROM DV03_07_RT_DISC_AP_CUBE)  

/* log end of procedure*/
INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(DATE,GETDATE()),CONVERT(TIME,GETDATE()),'Procedure finished',NULL,NULL

END
GO
