USE [DIVA_MASTER_SCRIPT_S4HANA]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[script_B31_OTC_GLOBAL_TABLE_V1]
AS
/****** Object:  StoredProcedure [dbo].[script_B31_OTC_GLOBAL_TABLE]    Script Date: 7/24/2023 3:52:10 PM ******/
--SET ANSI_NULLS ON
--GO
--SET QUOTED_IDENTIFIER ON
--GO
--ALTER PROCEDURE [dbo].[script_B31_OTC_GLOBAL_TABLE] 
--AS
--DYNAMIC_SCRIPT_START

/*  Change history comments
	Update history 
	-------------------------------------------------------
	Date            | Who   |  Description 
	24-03-2022	| T/huan	| Remove MANDT field in join
*/

	--Step 1
	--Create a flow table by joining all necessary cubes

	--Step 1.1 Join Sale order, delivery, material cube together
	EXEC SP_REMOVE_TABLES 'B31_01_TT_CENTER_FACT_TABLE'
	SELECT	DISTINCT 
	--Add sale order keys
	B28_01_IT_SALE_DOCUMENTS.B28_ZF_SALE_ORDER_KEY,
	B28_01_IT_SALE_DOCUMENTS.B28_VBAP_ERDAT,
	B28_01_IT_SALE_DOCUMENTS.B28_VBAK_MANDT,
	B28_01_IT_SALE_DOCUMENTS.B28_VBAK_ERNAM ,
	B28_01_IT_SALE_DOCUMENTS.B28_ZF_VBAK_ERNAM_TEXT,
	B28_01_IT_SALE_DOCUMENTS.B28_VBAK_VBELN,
	B28_01_IT_SALE_DOCUMENTS.B28_VBAP_POSNR,
	B28_01_IT_SALE_DOCUMENTS.B28_VBAK_KUNNR,
	B28_01_IT_SALE_DOCUMENTS.B28_ZF_VBAP_NETWR_S,
	B28_01_IT_SALE_DOCUMENTS.B28_ZF_VBAP_NETWR_S_CUC,
	B28_01_IT_SALE_DOCUMENTS.B28_TVKO_BUKRS,
	B28_ZF_DD07T_DDTEXT_VBTYP,
	B28_01_IT_SALE_DOCUMENTS.B28_VBAK_AUART,
	B28_VBAK_WAERK,
	--Add delivery keys
	B29_ZF_SALE_DELIVERY_DOC_KEY ,
	B29_01_IT_DELIVERY_DOCS.B29_LIKP_ERDAT ,
	B29_01_IT_DELIVERY_DOCS.B29_LIKP_ERNAM,
	B29_01_IT_DELIVERY_DOCS.B29_ZF_LIKP_ERNAM_TEXT,
	B29_01_IT_DELIVERY_DOCS.B29_LIKP_VBELN,
	B29_01_IT_DELIVERY_DOCS.B29_LIPS_MATNR,
	B29_01_IT_DELIVERY_DOCS.B29_LIKP_MANDT,
	B29_01_IT_DELIVERY_DOCS.B29_LIPS_POSNR ,
	B29_01_IT_DELIVERY_DOCS.B29_LIKP_KUNAG,
	B29_01_IT_DELIVERY_DOCS.B29_ZF_LIPS_NETWR ,
	B29_01_IT_DELIVERY_DOCS.B29_ZF_LIPS_NETWR_CUC ,
	B29_01_IT_DELIVERY_DOCS.B29_TVKO_BUKRS,
	B29_01_IT_DELIVERY_DOCS.B29_LIKP_LFART,
	B29_LIKP_WAERK,
	--Add material document keys
	CONCAT(DBO.TRIM(B26_03_MSEG_MBLNR),'-',
	DBO.TRIM(B26_03_MSEG_MJAHR),'-',
	DBO.TRIM(B26_03_MSEG_ZEILE)) AS B26_03_ZF_SALE_MATERIAL_DOC_KEY ,
	B26_03_IT_MATERIAL_DOC.B26_03_MKPF_CPUDT,
	B26_03_IT_MATERIAL_DOC.B26_03_MKPF_USNAM ,
	B26_03_IT_MATERIAL_DOC.B26_03_V_USERNAME_NAME_TEXT,
	B26_03_IT_MATERIAL_DOC.B26_03_MSEG_KUNNR,
	B26_03_IT_MATERIAL_DOC.B26_03_ZF_MSEG_DMBTR_SIGNED_CUC,
	B26_03_IT_MATERIAL_DOC.B26_03_ZF_MSEG_DMBTR_SIGNED,
	B26_03_IT_MATERIAL_DOC.B26_03_MSEG_BUKRS,
	B26_03_IT_MATERIAL_DOC.B26_03_MKPF_BLART,
	B26_03_MSEG_WAERS
	INTO B31_01_TT_CENTER_FACT_TABLE
	FROM B28_01_IT_SALE_DOCUMENTS 
	--Get delivery key for sale order key
	FULL OUTER JOIN B29_01_IT_DELIVERY_DOCS
	ON  B29_01_IT_DELIVERY_DOCS.B29_LIPS_VGBEL = B28_01_IT_SALE_DOCUMENTS.B28_VBAK_VBELN
	AND CAST(B29_01_IT_DELIVERY_DOCS.B29_LIPS_VGPOS AS INT) = CAST(B28_01_IT_SALE_DOCUMENTS.B28_VBAP_POSNR AS INT)

	--Get good issue (Material) document for delivery document

		FULL OUTER JOIN B26_03_IT_MATERIAL_DOC 
			ON  B26_03_IT_MATERIAL_DOC.B26_03_MKPF_LE_VBELN =  B29_01_IT_DELIVERY_DOCS.B29_LIKP_VBELN
		AND B26_03_IT_MATERIAL_DOC.B26_03_MSEG_MATNR=B29_01_IT_DELIVERY_DOCS.B29_LIPS_MATNR

	--STep 1.2	Add billing document keys to the flow table
	--One from SO, one from Delivery(which don't have SO)
	--Union 2 to 1 table

	--Step 1.2.1 get the billing from SO
		EXEC SP_DROPTABLE B31_02_TT_CENTER_FACT_TABLE_ADD_SO
	SELECT DISTINCT B31_01_TT_CENTER_FACT_TABLE.*,
	B30_ZF_SALE_INVOICE_DOC_KEY,
	B30_VBRP_ERDAT,
	B30_VBRK_ERNAM,
	B30_VBRK_ERNAM_NAME_TEXT,
	B30_VBRK_VBELN,
	B30_VBRK_KUNAG,
	B30_ZF_VBRP_NETWR_S,
	B30_ZF_VBRP_NETWR_S_CUC,
	B30_VBRP_VBELN,
	B30_ZF_DD07T_DDTEXT_FKTYP,
	B30_TVKO_BUKRS,
	B30_VBRK_FKART,
	B30_VBRK_WAERK,B30_TVKO_BUKRS_MAPPING
	INTO B31_02_TT_CENTER_FACT_TABLE_ADD_SO
	FROM B31_01_TT_CENTER_FACT_TABLE
			 JOIN B30_01_IT_INVOICE_DOCS
			ON  B30_01_IT_INVOICE_DOCS.B30_VBRP_VGBEL = B28_VBAK_VBELN  
			AND CAST(B30_01_IT_INVOICE_DOCS.B30_VBRP_VGPOS AS INT)=CAST(B28_VBAP_POSNR AS INT) 
	--Step 1.2.2 get the billing from delivery ,Which don't have in SO
	--Get the list of Inv no SO and SO no Inv

	--SO no Inv
	EXEC SP_DROPTABLE B31_03A_TT_SO_NO_INV
	SELECT DISTINCT  
		B31_01_TT_CENTER_FACT_TABLE.*
	INTO B31_03A_TT_SO_NO_INV
	FROM B31_01_TT_CENTER_FACT_TABLE
		LEFT JOIN B30_01_IT_INVOICE_DOCS
			ON  B28_VBAK_VBELN=B30_01_IT_INVOICE_DOCS.B30_VBRP_VGBEL
			AND CAST(B28_VBAP_POSNR AS INT)  =CAST(B30_01_IT_INVOICE_DOCS.B30_VBRP_VGPOS AS INT)
	WHERE B30_VBRK_MANDT IS NULL AND B30_VBRP_VGBEL IS NULL AND B30_VBRP_VGPOS IS NULL

	--Inv no SO
	EXEC SP_DROPTABLE B31_03B_TT_INV_NO_SO
		SELECT DISTINCT  
	B30_01_IT_INVOICE_DOCS.*
	INTO B31_03B_TT_INV_NO_SO
	FROM B31_01_TT_CENTER_FACT_TABLE
		RIGHT JOIN B30_01_IT_INVOICE_DOCS
			ON  B28_VBAK_VBELN=B30_01_IT_INVOICE_DOCS.B30_VBRP_VGBEL
			AND CAST(B28_VBAP_POSNR AS INT)  =CAST(B30_01_IT_INVOICE_DOCS.B30_VBRP_VGPOS AS INT)
	WHERE B28_VBAK_MANDT IS NULL AND B28_VBAK_VBELN IS NULL AND B28_VBAP_POSNR IS NULL

	--Join Inv no SO and SO no Inv
	EXEC SP_DROPTABLE B31_03_TT_CENTER_FACT_TABLE_ADD_DELI
	SELECT DISTINCT B31_03A_TT_SO_NO_INV.*,
	B30_ZF_SALE_INVOICE_DOC_KEY,
	B30_VBRP_ERDAT,
	B30_VBRK_ERNAM,
	B30_VBRK_ERNAM_NAME_TEXT,
	B30_VBRK_VBELN,
	B30_VBRK_KUNAG,
	B30_ZF_VBRP_NETWR_S,
	B30_ZF_VBRP_NETWR_S_CUC,
	B30_VBRP_VBELN,
	B30_ZF_DD07T_DDTEXT_FKTYP,
	B30_TVKO_BUKRS,
	B30_VBRK_FKART,
	B30_VBRK_WAERK,B30_TVKO_BUKRS_MAPPING
	INTO B31_03_TT_CENTER_FACT_TABLE_ADD_DELI
	FROM B31_03A_TT_SO_NO_INV 
			FULL OUTER JOIN 
				B31_03B_TT_INV_NO_SO  AS A
			ON  A.B30_VBRP_VGBEL = B29_LIKP_VBELN
			AND CAST(A.B30_VBRP_VGPOS AS INT)=CAST(B29_LIPS_POSNR AS INT) 

	--Step 1.2.3 Append 2 table 
	EXEC SP_DROPTABLE B31_04_TT_CENTER_FACT_TABLE_UNION
	SELECT DISTINCT * INTO B31_04_TT_CENTER_FACT_TABLE_UNION
	FROM B31_02_TT_CENTER_FACT_TABLE_ADD_SO
	UNION
	SELECT DISTINCT * FROM B31_03_TT_CENTER_FACT_TABLE_ADD_DELI

	--Step 1.4 Add FI invoie to the cube
	EXEC SP_DROPTABLE B31_05_01_TT_ADD_INV
	SELECT  
	DISTINCT 
	B31_04_TT_CENTER_FACT_TABLE_UNION.*,
	B14_01_ZF_CUSTOMER_INVOICE_KEY,
	B14_01_ACDOCA_BLDAT,
	B14_01_ACDOCA_USNAM,
	B14_01_V_USERNAME_NAME_TEXT,
	 B14_01_ACDOCA_KUNNR,
	B14_01_ACDOCA_RBUKRS,
	B14_01_ACDOCA_BLART,
	B14_01_T003T_LTEXT,
	 B14_01_T001_WAERS,
	  B14_01_ZF_ACDOCA_KSL_S,
	  B14_01_ZF_ACDOCA_OSL_S,
	 B14_01_ZF_ACDOCA_HSL_S,
	 B14_01_ZF_ACDOCA_HSL_S_CUC,
	 B14_01_ACDOCA_AUGBL,
	 B14_01_ACDOCA_AUGDT,
	 B14_01_ACDOCA_BUKRS_MAPPING
	INTO B31_05_01_TT_ADD_INV
	FROM B31_04_TT_CENTER_FACT_TABLE_UNION
		--Get the Customer invoice 
		FULL OUTER JOIN B14_SS01_09_TT_JE_INV_CLEARING_ALL_LINES_ADD_FLAG  
		ON B14_01_ACDOCA_AWREF=B30_VBRP_VBELN
	--	AND B14_01_ACDOCA_RBUKRS=B30_TVKO_BUKRS
	AND B30_TVKO_BUKRS_MAPPING=B14_01_ACDOCA_BUKRS_MAPPING

--Step 1.5 Add the payment to the cube
--Base on the method
--Add directly to the payment by using AUGBL+AUGDT+BUKRS
EXEC SP_DROPTABLE B31_05_02_TT_INV_PAY

SELECT  B31_05_01_TT_ADD_INV.*,
	B14_03_ZF_CUSTOMER_PAYMENT_KEY, 
	B14_03_ACDOCA_BLDAT,
	B14_03_ZF_ACDOCA_HSL_S,
	B14_03_ZF_ACDOCA_HSL_S_CUC,
	B14_03_ACDOCA_USNAM,
	B14_03_V_USERNAME_NAME_TEXT,
	B14_03_ACDOCA_KUNNR,
	B14_03_ACDOCA_RBUKRS,
	B14_03_ACDOCA_BLART,
	B14_03_T003T_LTEXT,
	 B14_03_T001_WAERS,
	B14_03_ZF_ACDOCA_KSL_S,
	B14_03_ZF_ACDOCA_OSL_S,
	B14_03_ACDOCA_AUGBL,
	 B14_03_ACDOCA_AUGDT,
	 B14_03_ACDOCA_BUKRS_MAPPING
	INTO B31_05_02_TT_INV_PAY
FROM B31_05_01_TT_ADD_INV
FULL OUTER JOIN 
B14_10_IT_CUSTOMER_PAYMENT_SUMMARY
ON B14_01_ACDOCA_AUGBL=B14_03_ACDOCA_AUGBL
		AND B14_01_ACDOCA_AUGDT=B14_03_ACDOCA_AUGDT
	--	AND B14_01_ACDOCA_RBUKRS=B14_03_ACDOCA_RBUKRS
	AND B14_01_ACDOCA_BUKRS_MAPPING=B14_03_ACDOCA_BUKRS_MAPPING
	AND (B14_01_ACDOCA_AUGBL<>'' AND B14_03_ACDOCA_AUGBL<>'')

--Step 1.6 using the clearing AR ( AUGBL_CLEARING, AUGDT_CLEARING,RBUKRS_CLEARING)
EXEC SP_DROPTABLE B31_05_03_TT_INV_PAY_AR_CLEAR

SELECT DISTINCT B31_05_01_TT_ADD_INV.*,
	B14_03_ZF_CUSTOMER_PAYMENT_KEY, 
	B14_03_ACDOCA_BLDAT,
	B14_03_ZF_ACDOCA_HSL_S,
	B14_03_ZF_ACDOCA_HSL_S_CUC,
	B14_03_ACDOCA_USNAM,
	B14_03_V_USERNAME_NAME_TEXT,
	B14_03_ACDOCA_KUNNR,
	B14_03_ACDOCA_RBUKRS,
	B14_03_ACDOCA_BLART,
	B14_03_T003T_LTEXT,
	 B14_03_T001_WAERS,
	B14_03_ZF_ACDOCA_KSL_S,
	B14_03_ZF_ACDOCA_OSL_S,
	B14_03_ACDOCA_AUGBL,
	 B14_03_ACDOCA_AUGDT,
	 B14_03_ACDOCA_BUKRS_MAPPING
	INTO B31_05_03_TT_INV_PAY_AR_CLEAR
FROM B31_05_01_TT_ADD_INV 
LEFT JOIN B14_SS01_09_TT_JE_INV_CLEARING_ALL_LINES_ADD_FLAG
ON B31_05_01_TT_ADD_INV.B14_01_ZF_CUSTOMER_INVOICE_KEY=B14_SS01_09_TT_JE_INV_CLEARING_ALL_LINES_ADD_FLAG.B14_01_ZF_CUSTOMER_INVOICE_KEY
FULL OUTER JOIN 
B14_10_IT_CUSTOMER_PAYMENT_SUMMARY
ON B14_SS01_09_TT_JE_INV_CLEARING_ALL_LINES_ADD_FLAG.B14_01_ACDOCA_AUGBL_CLEAR=B14_03_ACDOCA_AUGBL
		AND B14_SS01_09_TT_JE_INV_CLEARING_ALL_LINES_ADD_FLAG.B14_01_ACDOCA_AUGDT_CLEAR=B14_03_ACDOCA_AUGDT
	    AND B14_SS01_09_TT_JE_INV_CLEARING_ALL_LINES_ADD_FLAG.B14_01_ACDOCA_RBUKRS_CLEAR=B14_03_ACDOCA_BUKRS_MAPPING
        AND (B14_01_ACDOCA_AUGBL_CLEAR IS NOT NULL AND B14_03_ACDOCA_AUGBL IS NOT NULL)

--Step 1.7 Append together 2 inv-pay cube

	EXEC SP_DROPTABLE B31_05_04_TT_INV_PAY_APPEND

	SELECT DISTINCT A.*
	INTO B31_05_04_TT_INV_PAY_APPEND
	FROM 
	(
		SELECT *
		FROM B31_05_02_TT_INV_PAY
		UNION 
		SELECT *
		FROM B31_05_03_TT_INV_PAY_AR_CLEAR
	) AS A

--Step 1.8 Since invoice link to payment by 2 method
-- Method 1: link directly to payment
-- Method 2: link by AR clearing
-- Since using full outer join, then appends
-- The will be case that can link by method 1, not method 2/ method 2, not method 1
-- For the same invoice number:
--If it can link be method 1, remove the lines that can not link method 2
--  If it can link be method 1, remove the lines that can not link method 1 

-- Method to remove :
-- Get the invoice that have more than 1 payment ( which 1 invoice might have payments and blank lines)
--Get the payment have more than 1 invoice ( which 1 payments might have invoice and blank lines)

--Step 1.8.1  Get the invoice number have more 1 difference payments

	EXEC SP_DROPTABLE TEMP1
	SELECT 
		B14_01_ZF_CUSTOMER_INVOICE_KEY
	INTO 
		TEMP1
	FROM 
		B31_05_04_TT_INV_PAY_APPEND
	WHERE 
		B14_01_ZF_CUSTOMER_INVOICE_KEY IS NOT NULL
	GROUP BY 
		B14_01_ZF_CUSTOMER_INVOICE_KEY
	HAVING COUNT(DISTINCT ISNULL(B14_03_ZF_CUSTOMER_PAYMENT_KEY,'_'))>1

--Step 1.8.2 Get the payment that have more than 1 difference invoices
	EXEC SP_DROPTABLE TEMP2
	SELECT 
		B14_03_ZF_CUSTOMER_PAYMENT_KEY
	INTO TEMP2
	FROM
		B31_05_04_TT_INV_PAY_APPEND
	WHERE 
		B14_03_ZF_CUSTOMER_PAYMENT_KEY IS NOT NULL
	GROUP BY 
		B14_03_ZF_CUSTOMER_PAYMENT_KEY
	HAVING COUNT(DISTINCT ISNULL(B14_01_ZF_CUSTOMER_INVOICE_KEY,'_'))>1

--Step 1.8.3 Remove the lines that found in invoice have many payments list, and contains null payments
	DELETE FROM 
	 B31_05_04_TT_INV_PAY_APPEND
	WHERE 
		B14_01_ZF_CUSTOMER_INVOICE_KEY IN
			(
				SELECT B14_01_ZF_CUSTOMER_INVOICE_KEY
				FROM TEMP1 
			)
	AND B14_03_ZF_CUSTOMER_PAYMENT_KEY IS NULL
--Step 1.8.4 Remove the lines that found in payment have many invoice list, and contains null invoice
		DELETE FROM 
			B31_05_04_TT_INV_PAY_APPEND
		WHERE 
			B14_03_ZF_CUSTOMER_PAYMENT_KEY IN
				(
					SELECT
						B14_03_ZF_CUSTOMER_PAYMENT_KEY
					FROM 
						TEMP2 
				)
		AND B14_01_ZF_CUSTOMER_INVOICE_KEY IS NULL
--Remove temporary tables
	EXEC SP_DROPTABLE 'TEMP1'
	EXEC SP_DROPTABLE 'TEMP2'

--Step 1.9 Add the payment cancellaion, and credit notes
EXEC SP_DROPTABLE B31_05_IT_CENTER_FACT_TABLE_ADD_INV_PAY

	SELECT DISTINCT 
			IDENTITY(INT,1,1) AS ZF_DOCUMENT_FLOW_KEY,
			B31_05_04_TT_INV_PAY_APPEND.*,
			 B14_02_ZF_CREDIT_NOTE_KEY,
			 B14_02_ACDOCA_BLDAT,
			B14_02_ZF_ACDOCA_HSL_S,
			B14_02_ZF_ACDOCA_HSL_S_CUC,
			 B14_02_ACDOCA_USNAM,
			B14_02_V_USERNAME_NAME_TEXT,
			 B14_02_ACDOCA_KUNNR,
			 B14_02_ACDOCA_RBUKRS,
			B14_02_ACDOCA_BLART,
			 B14_02_T003T_LTEXT,
			 B14_02_T001_WAERS,
			B14_02_ZF_ACDOCA_KSL_S,
			B14_02_ZF_ACDOCA_OSL_S,
			 B14_04_ZF_CUSTOMER_PAYMENT_CANCELLATION,
			 B14_04_ACDOCA_BLDAT,
			B14_04_ZF_ACDOCA_HSL_S,
			B14_04_ZF_ACDOCA_HSL_S_CUC,
			 B14_04_ACDOCA_USNAM,
			B14_04_V_USERNAME_NAME_TEXT,
			 B14_04_ACDOCA_KUNNR,
			 B14_04_ACDOCA_RBUKRS,
			B14_04_ACDOCA_BLART,
			 B14_04_T003T_LTEXT,
			 B14_04_T001_WAERS,
			B14_04_ZF_ACDOCA_KSL_S,
			B14_04_ZF_ACDOCA_OSL_S
INTO B31_05_IT_CENTER_FACT_TABLE_ADD_INV_PAY
FROM B31_05_04_TT_INV_PAY_APPEND
		--Get the Customer payment cancellation
		FULL OUTER JOIN B14_11_IT_CUSTOMER_PAYMENT_CANCEL_SUMMARY
		ON B14_03_ACDOCA_AUGBL=B14_04_ACDOCA_AUGBL
		AND B14_03_ACDOCA_AUGDT=B14_04_ACDOCA_AUGDT
	--	AND B14_03_ACDOCA_RBUKRS=B14_04_ACDOCA_RBUKRS
	AND B14_03_ACDOCA_BUKRS_MAPPING=B14_04_ACDOCA_BUKRS_MAPPING
	AND (B14_03_ACDOCA_AUGBL<>'' AND B14_04_ACDOCA_AUGBL<>'')
		FULL OUTER JOIN B14_13_IT_CUSTOMER_CREDIT_NOTE
		ON B14_01_ACDOCA_AUGBL=B14_02_ACDOCA_AUGBL
		AND B14_01_ACDOCA_AUGDT=B14_02_ACDOCA_AUGDT
	AND B14_01_ACDOCA_BUKRS_MAPPING=B14_02_ACDOCA_BUKRS_MAPPING
	AND (LEN(ISNULL(B14_01_ACDOCA_AUGBL,''))>0 AND LEN(ISNULL(B14_01_ACDOCA_AUGBL,''))>0)

--Drop all TT table
EXEC SP_REMOVE_TABLES '%TEMP%'
EXEC SP_REMOVE_TABLES '%_TT_%'
EXEC SP_REMOVE_TABLES 'TT_%'

--159762
--119743

--SELECT COUNT(DISTINCT B14_01_ZF_CUSTOMER_INVOICE_KEY)
--FROM 
--B31_05_IT_CENTER_FACT_TABLE_ADD_INV_PAY
--WHERE LEN(REPLACE(B14_01_ZF_CUSTOMER_INVOICE_KEY,'|',''))>0
--AND B14_03_ZF_CUSTOMER_PAYMENT_KEY IS NULL

--SELECT DISTINCT B14_03_ZF_CUSTOMER_PAYMENT_KEY,B14_01_ZF_CUSTOMER_INVOICE_KEY
--FROM B31_05_IT_CENTER_FACT_TABLE_ADD_INV_PAY


--VN00|2022|0015167605|001

--FROM B31_05_IT_CENTER_FACT_TABLE_ADD_INV_PAY
GO
