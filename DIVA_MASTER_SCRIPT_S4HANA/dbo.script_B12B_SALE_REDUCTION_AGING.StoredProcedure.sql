USE [DIVA_MASTER_SCRIPT_S4HANA]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[script_B12B_SALE_REDUCTION_AGING]
AS
/* 
	Title        :  B12B_SALE_REDUCTION_AGING 
    Description  :  Sale reduction aging
       
*/ 
/* Initiate the log */  
--DYNAMIC_SCRIPT_START
/*  Change history comments
	Update history 
	-------------------------------------------------------
	Date            | Who   |  Description 
	24-03-2022	| Thuan	| Remove MANDT field in join
*/

--Create database log table if it does not exist
IF OBJECT_ID('LOG_SP_EXECUTION', 'U') IS NULL BEGIN CREATE TABLE [DBO].[LOG_SP_EXECUTION] ([DATABASE] NVARCHAR(MAX) NULL,[OBJECT] NVARCHAR(MAX) NULL,[OBJECT_TYPE] NVARCHAR(MAX) NULL,[USER] NVARCHAR(MAX) NULL,[DATE] DATE NULL,[TIME] TIME NULL,[DESCRIPTION] NVARCHAR(MAX) NULL,[TABLE] NVARCHAR(MAX),[ROWS] INT) END

--Log start of procedure
INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(DATE,GETDATE()),CONVERT(TIME,GETDATE()),'Procedure started',NULL,NULL
	/*Step 0: prepare GL GRIR account table */
	/* Initialize parameters from globals table */
    DECLARE  
				@CURRENCY NVARCHAR(3)                 = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'currency')
				,@DATE1 NVARCHAR(MAX)                           = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'date1')
				,@DATE2 NVARCHAR(MAX)                           = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'date2')
				,@DOWNLOADDATE NVARCHAR(MAX)             = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'downloaddate')
				,@DATEFORMAT VARCHAR(3)             = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'dateformat')
				,@EXCHANGERATETYPE NVARCHAR(MAX)  = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'exchangeratetype')
				,@LANGUAGE1 NVARCHAR(3)                = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'language1')
				,@LANGUAGE2 NVARCHAR(3)                = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'language2')
				,@LIMIT_RECORDS INT                    = CAST((SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'LIMIT_RECORDS') AS INT)
				,@FISCAL_YEAR_FROM NVARCHAR(MAX)					= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'FISCAL_YEAR_FROM')
				,@FISCAL_YEAR_TO NVARCHAR(MAX)					= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'FISCAL_YEAR_TO')
                 SET DATEFORMAT @DATEFORMAT;

	SET ROWCOUNT @LIMIT_RECORDS
	----------------------------------------------------------------------------------------------------------------------------
	/*
		Step 1: Loop every snapshot date begin date1 to date2 and select and insert the documents that still open in this snapshot
	*/

EXEC SP_REMOVE_TABLES 'B12_07_IT_SR_SNAPSHOT'
	SELECT TOP 0 ACDOCA_RCLNT, ACDOCA_RBUKRS, ACDOCA_GJAHR, ACDOCA_BELNR, ACDOCA_BUZEI, ACDOCA_DOCLN, ACDOCA_BUDAT, ACDOCA_BLDAT, ACDOCA_AUGDT, ACDOCA_AUGDT AS ACDOCA_CPUDT
	INTO B12_07_IT_SR_SNAPSHOT
	FROM B00_ACDOCA;

	--ALTER TABLE B12_07_IT_SR_SNAPSHOT ADD SR_OR_GINI_OR_ARDR NVARCHAR(4);
	ALTER TABLE B12_07_IT_SR_SNAPSHOT ADD SR_FLAG NVARCHAR(30);
	ALTER TABLE B12_07_IT_SR_SNAPSHOT ADD SNAPSHOT_DATE DATE;
	ALTER TABLE B12_07_IT_SR_SNAPSHOT ADD ZF_BUDAT_MINUS_SNAPSHOT_DATE BIGINT;
	ALTER TABLE B12_07_IT_SR_SNAPSHOT ADD ZF_BUDAT_MINUS_SNAPSHOT_DATE_BUCKET NVARCHAR(50);
	ALTER TABLE B12_07_IT_SR_SNAPSHOT ADD ZF_BLDAT_MINUS_SNAPSHOT_DATE BIGINT;
	ALTER TABLE B12_07_IT_SR_SNAPSHOT ADD ZF_BLDAT_MINUS_SNAPSHOT_DATE_BUCKET NVARCHAR(50);
	ALTER TABLE B12_07_IT_SR_SNAPSHOT ADD ZF_AUGDT_MINUS_SNAPSHOT_DATE BIGINT;
	ALTER TABLE B12_07_IT_SR_SNAPSHOT ADD ZF_AUGDT_MINUS_SNAPSHOT_DATE_BUCKET NVARCHAR(50);
	ALTER TABLE B12_07_IT_SR_SNAPSHOT ADD ZF_CPUDT_MINUS_SNAPSHOT_DATE BIGINT;
	ALTER TABLE B12_07_IT_SR_SNAPSHOT ADD ZF_CPUDT_MINUS_SNAPSHOT_DATE_BUCKET NVARCHAR(50);
	WHILE EOMONTH(@DATE1) <= EOMONTH(@DATE2)
	BEGIN
		PRINT CONCAT('Process for snapshot date: ',@DATE1);
		INSERT INTO B12_07_IT_SR_SNAPSHOT
		SELECT 
				B04_GL_ACDOCA_RCLNT,
				B04_GL_ACDOCA_RBUKRS,
				B04_GL_ACDOCA_GJAHR,
				B04_GL_ACDOCA_BELNR,
				B04_GL_ACDOCA_BUZEI,
				B04_GL_ACDOCA_DOCLN,
				B04_GL_ACDOCA_BUDAT,
				B04_GL_ACDOCA_BLDAT,
				B04_GL_ACDOCA_AUGDT,
				B04_GL_ACDOCA_CPUDT,
				SR_FLAG,
				@DATE1,
				DATEDIFF(DAY, B04_GL_ACDOCA_BUDAT, @DATE1),
				CASE
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_BUDAT, @DATE1) >=0 AND DATEDIFF(DAY, B04_GL_ACDOCA_BUDAT, @DATE1) <= 10 THEN '0-10 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_BUDAT, @DATE1) >= 11 AND DATEDIFF(DAY, B04_GL_ACDOCA_BUDAT, @DATE1) <= 20 THEN '11-20 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_BUDAT, @DATE1) >= 21 AND DATEDIFF(DAY, B04_GL_ACDOCA_BUDAT, @DATE1) <= 30 THEN '21-30 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_BUDAT, @DATE1) >= 31 AND DATEDIFF(DAY, B04_GL_ACDOCA_BUDAT, @DATE1) <= 60 THEN '31-60 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_BUDAT, @DATE1) >= 61 AND DATEDIFF(DAY, B04_GL_ACDOCA_BUDAT, @DATE1) <= 180 THEN '61-180 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_BUDAT, @DATE1) >= 181 AND DATEDIFF(DAY, B04_GL_ACDOCA_BUDAT, @DATE1) <= 360 THEN '181-360 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_BUDAT, @DATE1) > 360 THEN '360+ days'
					ELSE '<0 days'
				END,
				DATEDIFF(DAY, B04_GL_ACDOCA_BLDAT, @DATE1),
				CASE
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_BLDAT, @DATE1) >=0 AND DATEDIFF(DAY, B04_GL_ACDOCA_BLDAT, @DATE1) <= 10 THEN '0-10 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_BLDAT, @DATE1) >= 11 AND DATEDIFF(DAY, B04_GL_ACDOCA_BLDAT, @DATE1) <= 20 THEN '11-20 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_BLDAT, @DATE1) >= 21 AND DATEDIFF(DAY, B04_GL_ACDOCA_BLDAT, @DATE1) <= 30 THEN '21-30 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_BLDAT, @DATE1) >= 31 AND DATEDIFF(DAY, B04_GL_ACDOCA_BLDAT, @DATE1) <= 60 THEN '31-60 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_BLDAT, @DATE1) >= 61 AND DATEDIFF(DAY, B04_GL_ACDOCA_BLDAT, @DATE1) <= 180 THEN '61-180 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_BLDAT, @DATE1) >= 181 AND DATEDIFF(DAY, B04_GL_ACDOCA_BLDAT, @DATE1) <= 360 THEN '181-360 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_BLDAT, @DATE1) > 360 THEN '360+ days'
					ELSE '<0 days'
				END,
				DATEDIFF(DAY, B04_GL_ACDOCA_AUGDT, @DATE1),
				CASE
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_AUGDT, @DATE1) >=0 AND DATEDIFF(DAY, B04_GL_ACDOCA_AUGDT, @DATE1) <= 10 THEN '0-10 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_AUGDT, @DATE1) >= 11 AND DATEDIFF(DAY, B04_GL_ACDOCA_AUGDT, @DATE1) <= 20 THEN '11-20 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_AUGDT, @DATE1) >= 21 AND DATEDIFF(DAY, B04_GL_ACDOCA_AUGDT, @DATE1) <= 30 THEN '21-30 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_AUGDT, @DATE1) >= 31 AND DATEDIFF(DAY, B04_GL_ACDOCA_AUGDT, @DATE1) <= 60 THEN '31-60 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_AUGDT, @DATE1) >= 61 AND DATEDIFF(DAY, B04_GL_ACDOCA_AUGDT, @DATE1) <= 180 THEN '61-180 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_AUGDT, @DATE1) >= 181 AND DATEDIFF(DAY, B04_GL_ACDOCA_AUGDT, @DATE1) <= 360 THEN '181-360 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_AUGDT, @DATE1) > 360 THEN '360+ days'
					ELSE '<0 days'
				END,
				DATEDIFF(DAY, B04_GL_ACDOCA_CPUDT, @DATE1),
				CASE
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_CPUDT, @DATE1) >=0 AND DATEDIFF(DAY, B04_GL_ACDOCA_CPUDT, @DATE1) <= 10 THEN '0-10 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_CPUDT, @DATE1) >= 11 AND DATEDIFF(DAY, B04_GL_ACDOCA_CPUDT, @DATE1) <= 20 THEN '11-20 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_CPUDT, @DATE1) >= 21 AND DATEDIFF(DAY, B04_GL_ACDOCA_CPUDT, @DATE1) <= 30 THEN '21-30 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_CPUDT, @DATE1) >= 31 AND DATEDIFF(DAY, B04_GL_ACDOCA_CPUDT, @DATE1) <= 60 THEN '31-60 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_CPUDT, @DATE1) >= 61 AND DATEDIFF(DAY, B04_GL_ACDOCA_CPUDT, @DATE1) <= 180 THEN '61-180 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_CPUDT, @DATE1) >= 181 AND DATEDIFF(DAY, B04_GL_ACDOCA_CPUDT, @DATE1) <= 360 THEN '181-360 days'
					WHEN DATEDIFF(DAY, B04_GL_ACDOCA_CPUDT, @DATE1) > 360 THEN '360+ days'
					ELSE '<0 days'
				END
		FROM B04_08_IT_FIN_GL
		INNER JOIN AM_SALE_REDUCTION_AGING
		ON B04_GL_ACDOCA_RACCT = SR_GL_ACCT AND SR_FLAG<>''
		WHERE B04_GL_ACDOCA_BUDAT <= @DATE1 AND (B04_GL_ACDOCA_AUGDT IS NULL OR B04_GL_ACDOCA_AUGBL = '' OR B04_GL_ACDOCA_AUGDT > @DATE1)
		SET @DATE1 = EOMONTH(DATEADD(MM,1,@DATE1))
	END

	/*
		Step 2: Create a cube from full GL cube only include the documents have been in the IR/GR account
	*/
	EXEC SP_REMOVE_TABLES 'B12_08_IT_SR_DOCUMENTS'
	SELECT B04_08_IT_FIN_GL.*,
		A_T001.T001_BUTXT,
		A_SKAT.SKAT_TXT50,
		A_T003T.T003T_LTEXT,
		A_TBSLT.TBSLT_LTEXT,
		A_LFA1.LFA1_NAME1,
		A_LFA1.LFA1_KTOKK,
		A_KNA1.KNA1_NAME1,
		A_KNA1.KNA1_KTOKD,
		A_V_USERNAME.*,
		AM_SCOPE.SCOPE_BUSINESS_DMN_L1,
		AM_SCOPE.SCOPE_BUSINESS_DMN_L2,
		AM_T077Y.T077Y_TXT30,
		AM_T077Y.INTERCO_TXT AS T077Y_INTERCO_TXT,
		AM_T077X.T077X_TXT30,
		AM_T077X.INTERCO_TXT AS T077X_INTERCO_TXT,
		AM_SALE_REDUCTION_AGING.*

	INTO B12_08_IT_SR_DOCUMENTS
	FROM B04_08_IT_FIN_GL
	INNER JOIN AM_SALE_REDUCTION_AGING
	ON B04_GL_ACDOCA_RACCT = SR_GL_ACCT

	--Get company information from T001 tables
	LEFT JOIN A_T001
	ON A_T001.T001_BUKRS = B04_08_IT_FIN_GL.B04_GL_ACDOCA_RBUKRS

	--Get g/l account information from SKAT
	LEFT JOIN A_SKAT
	ON A_SKAT.SKAT_KTOPL = B04_08_IT_FIN_GL.B04_GL_T001_KTOPL AND
	   A_SKAT.SKAT_SAKNR = B04_08_IT_FIN_GL.B04_GL_ACDOCA_RACCT AND
	   A_SKAT.SKAT_SPRAS IN ('E', 'EN')

	--Get document type text description
	LEFT JOIN A_T003T
	ON A_T003T.T003T_SPRAS IN ('E', 'EN') AND
	   A_T003T.T003T_BLART = B04_08_IT_FIN_GL.B04_GL_ACDOCA_BLART

	--Get posting key desctiption from TBSLT
	LEFT JOIN A_TBSLT
	ON A_TBSLT.TBSLT_SPRAS IN ('E', 'EN') AND
	   A_TBSLT.TBSLT_BSCHL = B04_08_IT_FIN_GL.B04_GL_ACDOCA_BSCHL AND
	   A_TBSLT.TBSLT_UMSKZ = B04_08_IT_FIN_GL.B04_GL_ACDOCA_UMSKZ

	--Get vendor name from LFA1
	LEFT JOIN A_LFA1
	ON A_LFA1.LFA1_LIFNR = B04_08_IT_FIN_GL.B04_GL_ACDOCA_LIFNR

	--Get customer name from KNA1
	LEFT JOIN A_KNA1
	ON  A_KNA1.KNA1_KUNNR = B04_08_IT_FIN_GL.B04_GL_ACDOCA_KUNNR

	--Get user name for V_USNAM
	LEFT JOIN A_V_USERNAME
	ON A_V_USERNAME.V_USERNAME_BNAME = B04_08_IT_FIN_GL.B04_GL_ACDOCA_USNAM

	--Get information from AM_SCOPE
	LEFT JOIN AM_SCOPE
	ON AM_SCOPE.SCOPE_CMPNY_CODE = B04_08_IT_FIN_GL.B04_GL_ACDOCA_RBUKRS

	LEFT JOIN AM_T077Y
	ON AM_T077Y.T077Y_KTOKK = A_LFA1.LFA1_KTOKK AND
	   AM_T077Y.T077Y_SPRAS IN ('E', 'EN')

	LEFT JOIN AM_T077X
	ON AM_T077X.T077X_KTOKD = A_KNA1.KNA1_KTOKD AND
	   AM_T077X.T077X_SPRAS IN ('E', 'EN')

	EXEC SP_RENAME_FIELD 'B12_07_', 'B12_07_IT_SR_SNAPSHOT'
	EXEC SP_UNNAME_FIELD 'B04_GL_', 'B12_08_IT_SR_DOCUMENTS'
	EXEC SP_RENAME_FIELD 'B12_08_', 'B12_08_IT_SR_DOCUMENTS'
GO
