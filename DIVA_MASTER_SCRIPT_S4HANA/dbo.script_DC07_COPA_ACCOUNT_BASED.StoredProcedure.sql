USE [DIVA_MASTER_SCRIPT_S4HANA]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[script_DC07_COPA_ACCOUNT_BASED]

WITH EXECUTE AS CALLER
AS

--DYNAMIC_SCRIPT_START
/* Initiate the log */ 
----Create database log table if it does not exist
IF OBJECT_ID('LOG_SP_EXECUTION', 'U') IS NULL BEGIN CREATE TABLE [DBO].[LOG_SP_EXECUTION] ([DATABASE] NVARCHAR(MAX) NULL,[OBJECT] NVARCHAR(MAX) NULL,[OBJECT_TYPE] NVARCHAR(MAX) NULL,[USER] NVARCHAR(MAX) NULL,[DATE] DATE NULL,[TIME] TIME NULL,[DESCRIPTION] NVARCHAR(MAX) NULL,[TABLE] NVARCHAR(MAX),[ROWS] INT) END
 
--Log start of procedure
INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(DATE,GETDATE()),CONVERT(TIME,GETDATE()),'Procedure started',NULL,NULL

/* Initialize parameters from globals table */
    DECLARE  
				@CURRENCY NVARCHAR(3)                 = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'currency')
				,@DATE1 NVARCHAR(MAX)                           = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'date1')
				,@DATE2 NVARCHAR(MAX)                           = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'date2')
				,@DOWNLOADDATE NVARCHAR(MAX)             = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'downloaddate')
				,@DATEFORMAT VARCHAR(3)             = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'dateformat')
				,@EXCHANGERATETYPE NVARCHAR(MAX)  = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'exchangeratetype')
				,@LANGUAGE1 NVARCHAR(3)                = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'language1')
				,@LANGUAGE2 NVARCHAR(3)                = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'language2')
				,@LIMIT_RECORDS INT                    = CAST((SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'LIMIT_RECORDS') AS INT)
				,@FISCAL_YEAR_FROM NVARCHAR(MAX)					= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'FISCAL_YEAR_FROM')
				,@FISCAL_YEAR_TO NVARCHAR(MAX)					= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'FISCAL_YEAR_TO')


--Step 1/ Compare values (USD) between table B18_04_IT_COPA_ACCOUNT_BASED_NEW (use TCURR and TCURF) and table B18_04_IT_COPA_ACCOUNT_BASED (use AM_EXCHNG)

EXEC SP_DROPTABLE 'DC07_01_IT_COPA_ACCOUNT_BASED'

SELECT 
    A.B18_ACDOCA_RBUKRS, A.B18_ACDOCA_RYEAR, A.B18_ACDOCA_BELNR,
    MAX(A.B18_ACDOCA_RHCUR) AS B18_ACDOCA_RHCUR,
    MAX(A.B18_ACDOCA_BUDAT) AS B18_ACDOCA_BUDAT,
	MAX(ISNULL(AM_EXCHNG.EXCHNG_RATIO, 1)) AS EXCHNG_RATE_OLD,
	MAX(COALESCE(CAST(TCURR_CUC.TCURR_UKURS AS FLOAT),1) * COALESCE(TCURF_CUC.TCURF_TFACT,1) / COALESCE(TCURF_CUC.TCURF_FFACT,1)) AS EXCHNG_RATE_NEW,
    SUM(A.B18_ZF_ACDOCA_HSL_S) AS B18_ZF_ACDOCA_HSL_S,
    SUM(A.B18_ZF_ACDOCA_HSL_S_CUC) AS B18_ZF_ACDOCA_HSL_S_CUC_NEW,
    SUM(B.B18_ZF_ACDOCA_HSL_S_CUC) AS B18_ZF_ACDOCA_HSL_S_CUC_OLD
INTO DC07_01_IT_COPA_ACCOUNT_BASED

FROM
(
    SELECT B18_ACDOCA_RBUKRS, B18_ACDOCA_RYEAR, B18_ACDOCA_BELNR,
    MAX(B18_ACDOCA_RHCUR) AS B18_ACDOCA_RHCUR,
    MAX(B18_ACDOCA_BUDAT) AS B18_ACDOCA_BUDAT,
    SUM(B18_ZF_ACDOCA_HSL_S) AS B18_ZF_ACDOCA_HSL_S,
    SUM(B18_ZF_ACDOCA_HSL_S_CUC) AS B18_ZF_ACDOCA_HSL_S_CUC
    FROM B18_04_IT_COPA_ACCOUNT_BASED_NEW
    GROUP BY B18_ACDOCA_RBUKRS, B18_ACDOCA_RYEAR, B18_ACDOCA_BELNR
) A
INNER JOIN 
(
    SELECT B18_ACDOCA_RBUKRS, B18_ACDOCA_RYEAR, B18_ACDOCA_BELNR,
    MAX(B18_ACDOCA_RHCUR) AS B18_ACDOCA_RHCUR,
    MAX(B18_ACDOCA_BUDAT) AS B18_ACDOCA_BUDAT,
    SUM(B18_ZF_ACDOCA_HSL_S) AS B18_ZF_ACDOCA_HSL_S,
    SUM(B18_ZF_ACDOCA_HSL_S_CUC) AS B18_ZF_ACDOCA_HSL_S_CUC
    FROM B18_04_IT_COPA_ACCOUNT_BASED
    GROUP BY B18_ACDOCA_RBUKRS, B18_ACDOCA_RYEAR, B18_ACDOCA_BELNR
) B
ON A.B18_ACDOCA_BELNR = B.B18_ACDOCA_BELNR
AND A.B18_ACDOCA_RBUKRS = B.B18_ACDOCA_RBUKRS
AND A.B18_ACDOCA_RYEAR = B.B18_ACDOCA_RYEAR

--Get company currency
LEFT JOIN A_T001
ON	A.B18_ACDOCA_RBUKRS = A_T001.T001_BUKRS

--Get exchange rate from Local to Custom Currency
LEFT JOIN AM_EXCHNG
ON	AM_EXCHNG.EXCHNG_FROM = A_T001.T001_WAERS AND
AM_EXCHNG.EXCHNG_TO = @currency

-- Add exchange rate from company currency to USD
LEFT JOIN B00_IT_TCURR TCURR_CUC
	ON A_T001.T001_WAERS = TCURR_CUC.TCURR_FCURR
	AND TCURR_CUC.TCURR_TCURR  = @currency  
	AND TCURR_CUC.TCURR_GDATU = (
		SELECT TOP 1 B00_IT_TCURR.TCURR_GDATU
		FROM B00_IT_TCURR
		WHERE A_T001.T001_WAERS = B00_IT_TCURR.TCURR_FCURR AND 
				B00_IT_TCURR.TCURR_TCURR  = @currency  AND
				B00_IT_TCURR.TCURR_GDATU <= A.B18_ACDOCA_BUDAT
		ORDER BY B00_IT_TCURR.TCURR_GDATU DESC
		) 

-- Add currency factor from company currency to USD

LEFT JOIN B00_IT_TCURF TCURF_CUC
ON A_T001.T001_WAERS = TCURF_CUC.TCURF_FCURR
AND TCURF_CUC.TCURF_TCURR  = @currency  
AND TCURF_CUC.TCURF_GDATU = (
	SELECT TOP 1 B00_IT_TCURF.TCURF_GDATU
	FROM B00_IT_TCURF
	WHERE A_T001.T001_WAERS = B00_IT_TCURF.TCURF_FCURR AND 
			B00_IT_TCURF.TCURF_TCURR  = @currency  AND
			B00_IT_TCURF.TCURF_GDATU <= A.B18_ACDOCA_BUDAT
	ORDER BY B00_IT_TCURF.TCURF_GDATU DESC
	)
GROUP BY A.B18_ACDOCA_RBUKRS, A.B18_ACDOCA_RYEAR, A.B18_ACDOCA_BELNR



EXEC SP_UNNAME_FIELD 'B18_',DC07_01_IT_COPA_ACCOUNT_BASED

EXEC SP_RENAME_FIELD 'DC07_01_',DC07_01_IT_COPA_ACCOUNT_BASED

--Step 2/ Compare values (USD) between table B18_06_IT_COPA_BILLING_NEW (use TCURR and TCURF) and table B18_06_IT_COPA_BILLING (use AM_EXCHNG)
   

SELECT		A.B18_06_VBRK_BUKRS,
			A.B18_06_VBRK_VBELN,
			A.B18_06_VBRP_POSNR,
			MAX(A.B18_06_VBRK_WAERK) AS B18_11_VBRK_WAERK,
			MAX(A.B18_06_T001_WAERS) AS B18_06_T001_WAERS,
			MAX(A.B18_06_VBRK_FKDAT) AS B18_11_VBRK_FKDAT,
			SUM(A.B18_06_ZF_VBRP_NETWR_S) AS B18_11_ZF_VBRP_NETWR_S,
			SUM(B.B18_06_ZF_VBRP_NETWR_S_CUC) AS B18_11_ZF_VBRP_NETWR_S_CUC_OLD,
			SUM(A.B18_06_ZF_VBRP_NETWR_S_CUC) AS B18_11_ZF_VBRP_NETWR_S_CUC_NEW,
			MAX(ISNULL(EXCHNG_RATIO,1)) AS EXCHNG_RATE_OLD,
			MAX(VBRP_KURSK * COALESCE(TCURF_COC.TCURF_TFACT,1)/COALESCE(TCURF_COC.TCURF_FFACT,1) 
			* COALESCE(CAST(TCURR_CUC.TCURR_UKURS AS FLOAT),1) * COALESCE(TCURF_CUC.TCURF_TFACT,1) / COALESCE(TCURF_CUC.TCURF_FFACT,1)) AS EXCHNG_RATE_NEW
INTO DC07_02_COPA_BILLING
FROM
(
SELECT DISTINCT 
			B18_06_VBRK_BUKRS,
			B18_06_VBRK_VBELN,
			B18_06_VBRP_POSNR,
			MAX(B18_06_VBRK_WAERK) AS B18_06_VBRK_WAERK,
			MAX(B18_06_T001_WAERS) AS B18_06_T001_WAERS,
			MAX(B18_06_VBRK_FKDAT) AS B18_06_VBRK_FKDAT,
			SUM(B18_06_ZF_VBRP_NETWR_S) AS B18_06_ZF_VBRP_NETWR_S,
			SUM(B18_06_ZF_VBRP_NETWR_S_CUC) AS B18_06_ZF_VBRP_NETWR_S_CUC
		FROM B18_06_IT_COPA_BILLING_NEW
		GROUP BY 
			B18_06_VBRK_BUKRS,
			B18_06_VBRK_VBELN,
			B18_06_VBRP_POSNR
)A
INNER JOIN
(
SELECT DISTINCT 
			B18_06_VBRK_BUKRS,
			B18_06_VBRK_VBELN,
			B18_06_VBRP_POSNR,
			MAX(B18_06_VBRK_WAERK) AS B18_06_VBRK_WAERK,
			MAX(B18_06_T001_WAERS) AS B18_06_T001_WAERS,
			MAX(B18_06_VBRK_FKDAT) AS B18_06_VBRK_FKDAT,
			SUM(B18_06_ZF_VBRP_NETWR_S) AS B18_06_ZF_VBRP_NETWR_S,
			SUM(B18_06_ZF_VBRP_NETWR_S_CUC) AS B18_06_ZF_VBRP_NETWR_S_CUC
		FROM B18_06_IT_COPA_BILLING
		GROUP BY 
			B18_06_VBRK_BUKRS,
			B18_06_VBRK_VBELN,
			B18_06_VBRP_POSNR
) B
ON A.B18_06_VBRK_BUKRS = B.B18_06_VBRK_BUKRS
		AND A.B18_06_VBRK_VBELN= B.B18_06_VBRK_VBELN
		AND A.B18_06_VBRP_POSNR = B.B18_06_VBRP_POSNR

-- Add document currency exchange rate
INNER JOIN A_VBRP
		ON A.B18_06_VBRK_VBELN = VBRP_VBELN
-- Get company inforamtion
LEFT JOIN A_T001
	ON T001_BUKRS = A.B18_06_VBRK_BUKRS

-- Custome currency exchange rate
LEFT JOIN AM_EXCHNG
	ON EXCHNG_FROM = A.B18_06_VBRK_WAERK AND
	EXCHNG_TO = @CURRENCY

-- Add currency factor from company currency to USD

LEFT JOIN B00_IT_TCURF TCURF_CUC
	ON A_T001.T001_WAERS = TCURF_CUC.TCURF_FCURR
	AND TCURF_CUC.TCURF_TCURR  = @currency  
	AND TCURF_CUC.TCURF_GDATU = (
		SELECT TOP 1 B00_IT_TCURF.TCURF_GDATU
		FROM B00_IT_TCURF
		WHERE A_T001.T001_WAERS = B00_IT_TCURF.TCURF_FCURR AND 
				B00_IT_TCURF.TCURF_TCURR  = @currency  AND
				B00_IT_TCURF.TCURF_GDATU <= A.B18_06_VBRK_FKDAT
		ORDER BY B00_IT_TCURF.TCURF_GDATU DESC
		)
-- Add exchange rate from company currency to USD
LEFT JOIN B00_IT_TCURR TCURR_CUC
	ON A_T001.T001_WAERS = TCURR_CUC.TCURR_FCURR
	AND TCURR_CUC.TCURR_TCURR  = @currency  
	AND TCURR_CUC.TCURR_GDATU = (
		SELECT TOP 1 B00_IT_TCURR.TCURR_GDATU
		FROM B00_IT_TCURR
		WHERE A_T001.T001_WAERS = B00_IT_TCURR.TCURR_FCURR AND 
				B00_IT_TCURR.TCURR_TCURR  = @currency  AND
				B00_IT_TCURR.TCURR_GDATU <= A.B18_06_VBRK_FKDAT
		ORDER BY B00_IT_TCURR.TCURR_GDATU DESC
		) 

-- Add currency factor from document currency to local currency

LEFT JOIN B00_IT_TCURF TCURF_COC
	ON A.B18_06_VBRK_WAERK = TCURF_COC.TCURF_FCURR
	AND TCURF_COC.TCURF_TCURR  = T001_WAERS  
	AND TCURF_COC.TCURF_GDATU = (
		SELECT TOP 1 B00_IT_TCURF.TCURF_GDATU
		FROM B00_IT_TCURF
		WHERE A.B18_06_VBRK_WAERK = B00_IT_TCURF.TCURF_FCURR AND 
				B00_IT_TCURF.TCURF_TCURR  = T001_WAERS  AND
				B00_IT_TCURF.TCURF_GDATU <= A.B18_06_VBRK_FKDAT
		ORDER BY B00_IT_TCURF.TCURF_GDATU DESC
		)
GROUP BY 
			A.B18_06_VBRK_BUKRS,
			A.B18_06_VBRK_VBELN,
			A.B18_06_VBRP_POSNR

EXEC SP_UNNAME_FIELD 'B18_06_', DC07_02_COPA_BILLING
EXEC SP_RENAME_FIELD 'DC07_02_', DC07_02_COPA_BILLING
GO
