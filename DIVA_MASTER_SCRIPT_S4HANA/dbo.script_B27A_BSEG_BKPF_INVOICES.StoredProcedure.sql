USE [DIVA_MASTER_SCRIPT_S4HANA]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[script_B27A_BSEG_BKPF_INVOICES]
AS


--DYNAMIC_SCRIPT_START
BEGIN

--Step 1. Get the invoice values from ACDOCA, by joining back to AP mapping
--Join base on main keys
EXEC  SP_DROPTABLE 'B27A_01_TT_GET_ACDOCA_INV'

SELECT DISTINCT
B04_08_IT_FIN_GL.*, BUKRS_MAPPING AS B04_GL_ACDOCA_BUKRS_MAPPING
INTO B27A_01_TT_GET_ACDOCA_INV
FROM B04_08_IT_FIN_GL
JOIN B07_03_IT_FIN_AP_INV_PAY_FLAGS
ON  B07B_ACDOCA_RBUKRS=B04_GL_ACDOCA_RBUKRS
AND B07B_ACDOCA_GJAHR=B04_GL_ACDOCA_GJAHR
AND B07B_ACDOCA_BELNR=B04_GL_ACDOCA_BELNR
INNER JOIN AM_COMPANY_CODE ON 
B04_GL_ACDOCA_RBUKRS=COMPANY_CODE
WHERE B07B_ZF_SUPP_INV='X'




/*
AND B04_GL_ACDOCA_RBUKRS IN
(
	SELECT * FROM AM_COMPANY_CODE
)*/
--Step 1.1. Adding information for the cube
EXEC SP_DROPTABLE B27A_02_IT_GET_ACDOCA_INV
SELECT B27A_01_TT_GET_ACDOCA_INV.*,
V_USERNAME_NAME_TEXT AS ACDOCA_V_USERNAME_NAME_TEXT,LFA1_ERNAM AS ACDOCA_LFA1_ERNAM,
T003T_LTEXT AS ACDOCA_T003T_LTEXT,
LFA1_NAME1 AS ACDOCA_LFA1_NAME1,
T001_BUTXT AS ACDOCA_T001_BUTXT,
T001_WAERS AS B04_GL_T001_WAERS,
SKAT_TXT20 AS ACDOCA_SKAT_TXT20,
TBSLT_LTEXT AS ACDOCA_TBSTL_LTEXT,
                    CASE
                        WHEN B04_GL_ACDOCA_KOART = 'A' THEN 'Assets'
                        WHEN B04_GL_ACDOCA_KOART = 'D' THEN 'Customers'
                        WHEN B04_GL_ACDOCA_KOART = 'K' THEN 'Vendors'
                        WHEN B04_GL_ACDOCA_KOART = 'M' THEN 'Material'
                        WHEN B04_GL_ACDOCA_KOART = 'S' THEN 'G/L accounts'
                        ELSE ''
                    END                                                                  AS ZF_ACDOCA_KOART_DESC,
		B04_09_ZF_CREDIT_ACCOUNTS_DESC_COMBINE AS ZF_CREDIT_ACCOUNTS_DESC_COMBINE,
		B04_09_ZF_DEBIT_ACCOUNTS_DESC_COMBINE AS ZF_DEBIT_ACCOUNTS_DESC_COMBINE,
		B04_09_ZF_DEBIT_ACDOCA_RCNTR_AND_DESC AS ZF_DEBIT_ACDOCA_RCNTR_AND_DESC,
		B04_09_ZF_CREDIT_ACDOCA_RCNTR_AND_DESC AS ZF_CREDIT_ACDOCA_RCNTR_AND_DESC,
		B04_09_ZF_DEBIT_ACDOCA_PRCTR_AND_DESC AS ZF_DEBIT_ACDOCA_PRCTR_AND_DESC,
		B04_09_ZF_CREDIT_ACDOCA_PRCTR_AND_DESC AS ZF_CREDIT_ACDOCA_PRCTR_AND_DESC,
		T134T_MTBEZ,
		MARA_MTART,
		MAKT_MAKTX,
CONCAT( DBO.TRIM(B04_GL_ACDOCA_RBUKRS),'-',
		DBO.TRIM(B04_GL_ACDOCA_BELNR),'-',
		DBO.TRIM(B04_GL_ACDOCA_GJAHR))  AS ZF_ACDOCA_DOCUMENT_KEY
INTO B27A_02_IT_GET_ACDOCA_INV
FROM B27A_01_TT_GET_ACDOCA_INV
LEFT JOIN A_T001
	ON T001_BUKRS=B04_GL_ACDOCA_RBUKRS
LEFT JOIN A_V_USERNAME
		ON B04_GL_ACDOCA_USNAM=V_USERNAME_BNAME 
LEFT JOIN A_LFA1
		ON LFA1_LIFNR=B04_GL_ACDOCA_LIFNR
LEFT JOIN B00_T003T
		ON T003T_BLART=B04_GL_ACDOCA_BLART
LEFT JOIN B00_SKAT                                             
       ON     B00_SKAT.SKAT_KTOPL = A_T001.T001_KTOPL AND               
              B00_SKAT.SKAT_SAKNR = B04_GL_ACDOCA_RACCT
LEFT JOIN A_MARA
	ON MARA_MATNR=B04_GL_ACDOCA_MATNR
LEFT JOIN B00_T134T
	ON MARA_MTART=T134T_MTART
LEFT JOIN B04_09_IT_ACDOCA_BKPF_ACC_SCH
	ON B04_GL_ACDOCA_RBUKRS=B04_09_ACDOCA_RBUKRS
	AND B04_GL_ACDOCA_GJAHR=B04_09_ACDOCA_GJAHR
	AND B04_GL_ACDOCA_BELNR=B04_09_ACDOCA_BELNR
LEFT JOIN B00_MAKT
	ON MAKT_MATNR=B04_GL_ACDOCA_MATNR
-- Get posting key description
		LEFT JOIN B00_TBSLT
		ON B00_TBSLT.TBSLT_BSCHL = B04_GL_ACDOCA_BSCHL AND
		   B00_TBSLT.TBSLT_UMSKZ = B04_GL_ACDOCA_UMSKZ
WHERE B04_GL_ACDOCA_KOART='K' OR B04_GL_ACDOCA_KOART='S'




--Step 2 The line with K (Which will be in BSAK-BSIK )will don't have EBELN,EBELP,
--The line with S has,
--Come bine line K to one line get the EBELN and EBELP


EXEC SP_DROPTABLE B27A_03_TT_ACDOCA_INVOICE_ADD_PO_NUM
SELECT DISTINCT 
A.B04_GL_ACDOCA_RBUKRS,
A.B04_GL_ACDOCA_GJAHR,
A.B04_GL_ACDOCA_BELNR ,
A.B04_GL_ACDOCA_BUZEI,
A.B04_GL_ACDOCA_USNAM ,
A.B04_GL_T001_WAERS,
A.ACDOCA_V_USERNAME_NAME_TEXT,
A.B04_GL_ACDOCA_BLDAT ,
A.B04_GL_ACDOCA_CPUDT,
A.B04_GL_ACDOCA_CPUTM,
A.B04_GL_ACDOCA_LIFNR ,
A.ACDOCA_LFA1_ERNAM ,
A.ACDOCA_T003T_LTEXT ,
A.B04_GL_ZF_ACDOCA_HSL_S,
A.B04_GL_ZF_ACDOCA_HSL_S_CUC,
A.B04_GL_ZF_ACDOCA_KSL_S,
A.B04_GL_ZF_ACDOCA_OSL_S,
B04_GL_ZF_ACDOCA_AWKEY_DOC_NUM,
B04_GL_ZF_ACDOCA_AWKEY_YEAR,
B.B04_GL_ACDOCA_EBELN,
B.B04_GL_ACDOCA_EBELP ,
	B04_GL_ACDOCA_AUGBL,
	B04_GL_ACDOCA_AUGDT,
	B04_GL_ACDOCA_BUKRS_MAPPING
INTO B27A_03_TT_ACDOCA_INVOICE_ADD_PO_NUM
FROM
(SELECT DISTINCT
	B04_GL_ACDOCA_RBUKRS,
	B04_GL_ACDOCA_GJAHR,
	B04_GL_ACDOCA_BELNR ,
	B04_GL_ACDOCA_BUZEI,
	B04_GL_ACDOCA_USNAM ,
	B04_GL_ZF_ACDOCA_AWKEY_DOC_NUM,
	B04_GL_ZF_ACDOCA_AWKEY_YEAR,
	ACDOCA_V_USERNAME_NAME_TEXT,
	B04_GL_ACDOCA_BLDAT ,
	B04_GL_ACDOCA_CPUDT,
	B04_GL_ACDOCA_CPUTM,
	B04_GL_ACDOCA_LIFNR ,
	ACDOCA_LFA1_ERNAM ,
	ACDOCA_T003T_LTEXT ,
	SUM(B04_GL_ZF_ACDOCA_HSL_S)AS B04_GL_ZF_ACDOCA_HSL_S,
	SUM(B04_GL_ZF_ACDOCA_HSL_S_CUC)AS B04_GL_ZF_ACDOCA_HSL_S_CUC,
	SUM(B04_GL_ZF_ACDOCA_KSL_S)AS B04_GL_ZF_ACDOCA_KSL_S,
	SUM(B04_GL_ZF_ACDOCA_OSL_S) AS B04_GL_ZF_ACDOCA_OSL_S,
	B04_GL_ACDOCA_AUGBL,
	B04_GL_ACDOCA_AUGDT,
	B04_GL_ACDOCA_BUKRS_MAPPING,B04_GL_T001_WAERS
FROM B27A_02_IT_GET_ACDOCA_INV WHERE B04_GL_ACDOCA_KOART='K'
	GROUP BY 
	B04_GL_ACDOCA_RBUKRS,
	B04_GL_ACDOCA_GJAHR,
	B04_GL_ACDOCA_BELNR ,
	B04_GL_ACDOCA_BUZEI,
	B04_GL_ACDOCA_USNAM ,
	B04_GL_ZF_ACDOCA_AWKEY_DOC_NUM,
	B04_GL_ZF_ACDOCA_AWKEY_YEAR,
	ACDOCA_V_USERNAME_NAME_TEXT,
	B04_GL_ACDOCA_BLDAT ,
	B04_GL_ACDOCA_CPUDT,
	B04_GL_ACDOCA_CPUTM,
	B04_GL_ACDOCA_LIFNR ,
	ACDOCA_LFA1_ERNAM ,
	ACDOCA_T003T_LTEXT ,
	B04_GL_ACDOCA_AUGBL,
	B04_GL_ACDOCA_AUGDT,
	B04_GL_ACDOCA_BUKRS_MAPPING,B04_GL_T001_WAERS
	) AS A
LEFT JOIN
(SELECT DISTINCT B04_GL_ACDOCA_BELNR,B04_GL_ACDOCA_RBUKRS,B04_GL_ACDOCA_GJAHR,B04_GL_ACDOCA_EBELN,B04_GL_ACDOCA_EBELP  
FROM B27A_02_IT_GET_ACDOCA_INV WHERE B04_GL_ACDOCA_KOART='S') AS B
ON A.B04_GL_ACDOCA_BELNR=B.B04_GL_ACDOCA_BELNR AND 
A.B04_GL_ACDOCA_RBUKRS=B.B04_GL_ACDOCA_RBUKRS AND 
A.B04_GL_ACDOCA_GJAHR=B.B04_GL_ACDOCA_GJAHR

-- Drop all temporary table
--EXEC SP_REMOVE_TABLES'%_TT_%'

END


GO
