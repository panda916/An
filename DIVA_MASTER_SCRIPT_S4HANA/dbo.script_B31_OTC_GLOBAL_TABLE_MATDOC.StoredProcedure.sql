USE [DIVA_MASTER_SCRIPT_S4HANA]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE       PROCEDURE [dbo].[script_B31_OTC_GLOBAL_TABLE_MATDOC] 
AS
--DYNAMIC_SCRIPT_START

/*  Change history comments
	Update history 
	-------------------------------------------------------
	Date            | Who   |  Description 
	24-03-2022	| Thuan	| Remove MANDT field in join
*/

	--Step 1
	--Create a flow table by joining all necessary cubes

	--Step 1.1 Join Sale order, delivery, material cube together
	EXEC SP_REMOVE_TABLES 'B31_01_TT_CENTER_FACT_TABLE'
	SELECT	DISTINCT 
	--Add sale order keys
	B28_01_IT_SALE_DOCUMENTS.B28_ZF_SALE_ORDER_KEY,
	B28_01_IT_SALE_DOCUMENTS.B28_VBAP_ERDAT,
	B28_01_IT_SALE_DOCUMENTS.B28_VBAP_ERZET,
	B28_01_IT_SALE_DOCUMENTS.B28_VBAK_MANDT,
	B28_01_IT_SALE_DOCUMENTS.B28_VBAK_ERNAM ,
	B28_01_IT_SALE_DOCUMENTS.B28_ZF_VBAK_ERNAM_TEXT,
	B28_01_IT_SALE_DOCUMENTS.B28_VBAK_VBELN,
	B28_01_IT_SALE_DOCUMENTS.B28_VBAP_POSNR,
	B28_01_IT_SALE_DOCUMENTS.B28_VBAK_KUNNR,
	B28_01_IT_SALE_DOCUMENTS.B28_ZF_VBAP_NETWR_S,
	B28_01_IT_SALE_DOCUMENTS.B28_ZF_VBAP_NETWR_S_CUC,
	B28_01_IT_SALE_DOCUMENTS.B28_TVKO_BUKRS,
	B28_ZF_DD07T_DDTEXT_VBTYP,
	B28_01_IT_SALE_DOCUMENTS.B28_VBAK_AUART,
	B28_VBAK_WAERK,B28_T001_WAERS,
	--Add delivery keys
	B29_ZF_SALE_DELIVERY_DOC_KEY ,
	B29_01_IT_DELIVERY_DOCS.B29_LIKP_ERDAT ,
	B29_01_IT_DELIVERY_DOCS.B29_LIPS_ERZET ,
	B29_01_IT_DELIVERY_DOCS.B29_LIKP_ERNAM,
	B29_01_IT_DELIVERY_DOCS.B29_ZF_LIKP_ERNAM_TEXT,
	B29_01_IT_DELIVERY_DOCS.B29_LIKP_VBELN,
	B29_01_IT_DELIVERY_DOCS.B29_LIPS_MATNR,
	B29_01_IT_DELIVERY_DOCS.B29_LIKP_MANDT,
	B29_01_IT_DELIVERY_DOCS.B29_LIPS_POSNR ,
	B29_01_IT_DELIVERY_DOCS.B29_LIKP_KUNAG,
	B29_01_IT_DELIVERY_DOCS.B29_ZF_LIPS_NETWR ,
	B29_01_IT_DELIVERY_DOCS.B29_ZF_LIPS_NETWR_CUC ,
	B29_01_IT_DELIVERY_DOCS.B29_TVKO_BUKRS,
	B29_01_IT_DELIVERY_DOCS.B29_LIKP_LFART,
	B29_LIKP_WAERK,B29_T001_WAERS,
	--Add material document keys
	CONCAT(DBO.TRIM(B26_03_MATDOC_MBLNR),'-',
	DBO.TRIM(B26_03_MATDOC_MJAHR),'-',
	DBO.TRIM(B26_03_MATDOC_ZEILE)) AS B26_03_ZF_SALE_MATERIAL_DOC_KEY ,
	B26_03_IT_MATERIAL_DOC.B26_03_MATDOC_CPUDT,
	B26_03_IT_MATERIAL_DOC.B26_03_MATDOC_CPUTM,
	B26_03_IT_MATERIAL_DOC.B26_03_MATDOC_USNAM ,
	B26_03_IT_MATERIAL_DOC.B26_03_V_USERNAME_NAME_TEXT,
	B26_03_IT_MATERIAL_DOC.B26_03_MATDOC_KUNNR,
	B26_03_IT_MATERIAL_DOC.B26_03_ZF_MATDOC_DMBTR_SIGNED_CUC,
	B26_03_IT_MATERIAL_DOC.B26_03_ZF_MATDOC_DMBTR_SIGNED,
	B26_03_IT_MATERIAL_DOC.B26_03_MATDOC_BUKRS,
	B26_03_IT_MATERIAL_DOC.B26_03_MATDOC_BLART,
	B26_03_MATDOC_WAERS
	INTO B31_01_TT_CENTER_FACT_TABLE
	FROM B28_01_IT_SALE_DOCUMENTS 
	--Get delivery key for sale order key
	FULL OUTER JOIN B29_01_IT_DELIVERY_DOCS
	ON  B29_01_IT_DELIVERY_DOCS.B29_LIPS_VGBEL = B28_01_IT_SALE_DOCUMENTS.B28_VBAK_VBELN
	AND CAST(B29_01_IT_DELIVERY_DOCS.B29_LIPS_VGPOS AS INT) = CAST(B28_01_IT_SALE_DOCUMENTS.B28_VBAP_POSNR AS INT)

	--Get good issue (Material) document for delivery document

		FULL OUTER JOIN B26_03_IT_MATERIAL_DOC 
			ON  B26_03_IT_MATERIAL_DOC.B26_03_MATDOC_LE_VBELN =  B29_01_IT_DELIVERY_DOCS.B29_LIKP_VBELN
		AND B26_03_IT_MATERIAL_DOC.B26_03_MATDOC_MATNR=B29_01_IT_DELIVERY_DOCS.B29_LIPS_MATNR


	--STep 1.2	Add billing document keys to the flow table
	--One from SO, one from Delivery(which don't have SO)
	--Union 2 to 1 table

	--Step 1.2.1 get the billing from SO
		EXEC SP_DROPTABLE B31_02_TT_CENTER_FACT_TABLE_ADD_SO
	SELECT DISTINCT B31_01_TT_CENTER_FACT_TABLE.*,
	B30_ZF_SALE_INVOICE_DOC_KEY,
	B30_VBRP_ERDAT,
	B30_VBRK_ERZET,
	B30_VBRK_ERNAM,
	B30_VBRK_ERNAM_NAME_TEXT,
	B30_VBRK_VBELN,
	B30_VBRK_KUNAG,
	B30_ZF_VBRP_NETWR_S,
	B30_ZF_VBRP_NETWR_S_CUC,
	B30_VBRP_VBELN,
	B30_ZF_DD07T_DDTEXT_FKTYP,
	B30_TVKO_BUKRS,
	B30_VBRK_FKART,B30_T001_WAERS,
	B30_VBRK_WAERK,B30_TVKO_BUKRS_MAPPING
	INTO B31_02_TT_CENTER_FACT_TABLE_ADD_SO
	FROM B31_01_TT_CENTER_FACT_TABLE
			 JOIN B30_01_IT_INVOICE_DOCS
			ON  B30_01_IT_INVOICE_DOCS.B30_VBRP_VGBEL = B28_VBAK_VBELN  
			AND CAST(B30_01_IT_INVOICE_DOCS.B30_VBRP_VGPOS AS INT)=CAST(B28_VBAP_POSNR AS INT) 
	--Step 1.2.2 get the billing from delivery ,Which don't have in SO
	--Get the list of Inv no SO and SO no Inv

	--SO no Inv
	EXEC SP_DROPTABLE B31_03A_TT_SO_NO_INV
	SELECT DISTINCT  
		B31_01_TT_CENTER_FACT_TABLE.*
	INTO B31_03A_TT_SO_NO_INV
	FROM B31_01_TT_CENTER_FACT_TABLE
		LEFT JOIN B30_01_IT_INVOICE_DOCS
			ON  B28_VBAK_VBELN=B30_01_IT_INVOICE_DOCS.B30_VBRP_VGBEL
			AND CAST(B28_VBAP_POSNR AS INT)  =CAST(B30_01_IT_INVOICE_DOCS.B30_VBRP_VGPOS AS INT)
	WHERE B30_VBRK_MANDT IS NULL AND B30_VBRP_VGBEL IS NULL AND B30_VBRP_VGPOS IS NULL

	--Inv no SO
	EXEC SP_DROPTABLE B31_03B_TT_INV_NO_SO
		SELECT DISTINCT  
	B30_01_IT_INVOICE_DOCS.*
	INTO B31_03B_TT_INV_NO_SO
	FROM B31_01_TT_CENTER_FACT_TABLE
		RIGHT JOIN B30_01_IT_INVOICE_DOCS
			ON  B28_VBAK_VBELN=B30_01_IT_INVOICE_DOCS.B30_VBRP_VGBEL
			AND CAST(B28_VBAP_POSNR AS INT)  =CAST(B30_01_IT_INVOICE_DOCS.B30_VBRP_VGPOS AS INT)
	WHERE B28_VBAK_MANDT IS NULL AND B28_VBAK_VBELN IS NULL AND B28_VBAP_POSNR IS NULL

	--Join Inv no SO and SO no Inv
	EXEC SP_DROPTABLE B31_03_TT_CENTER_FACT_TABLE_ADD_DELI
	SELECT DISTINCT B31_03A_TT_SO_NO_INV.*,
	B30_ZF_SALE_INVOICE_DOC_KEY,
	B30_VBRP_ERDAT,
	B30_VBRK_ERZET,
	B30_VBRK_ERNAM,
	B30_VBRK_ERNAM_NAME_TEXT,
	B30_VBRK_VBELN,
	B30_VBRK_KUNAG,
	B30_ZF_VBRP_NETWR_S,
	B30_ZF_VBRP_NETWR_S_CUC,
	B30_VBRP_VBELN,
	B30_ZF_DD07T_DDTEXT_FKTYP,
	B30_TVKO_BUKRS,
	B30_VBRK_FKART,B30_T001_WAERS,
	B30_VBRK_WAERK,B30_TVKO_BUKRS_MAPPING
	INTO B31_03_TT_CENTER_FACT_TABLE_ADD_DELI
	FROM B31_03A_TT_SO_NO_INV 
			FULL OUTER JOIN 
				B31_03B_TT_INV_NO_SO  AS A
			ON  A.B30_VBRP_VGBEL = B29_LIKP_VBELN
			AND CAST(A.B30_VBRP_VGPOS AS INT)=CAST(B29_LIPS_POSNR AS INT) 

	--Step 1.2.3 Append 2 table 
	EXEC SP_DROPTABLE B31_04_TT_CENTER_FACT_TABLE_UNION
	SELECT DISTINCT * INTO B31_04_TT_CENTER_FACT_TABLE_UNION
	FROM B31_02_TT_CENTER_FACT_TABLE_ADD_SO
	UNION
	SELECT DISTINCT * FROM B31_03_TT_CENTER_FACT_TABLE_ADD_DELI


	--Step 1.4 Add FI invoie , Inv cancellation,payment ,payment cancellation
	EXEC SP_DROPTABLE B31_05_IT_CENTER_FACT_TABLE_ADD_INV_PAY
	SELECT  
	IDENTITY(INT,1,1) AS ZF_DOCUMENT_FLOW_KEY,
	B31_04_TT_CENTER_FACT_TABLE_UNION.*,
	B14_01_ZF_CUSTOMER_INVOICE_KEY,
	B14_01_ACDOCA_CPUDT,
	B14_01_ACDOCA_CPUTM,
	B14_01_ACDOCA_USNAM,
	B14_01_V_USERNAME_NAME_TEXT,
	 B14_01_ACDOCA_KUNNR,
	B14_01_ACDOCA_RBUKRS,
	B14_01_ACDOCA_BLART,
	B14_01_T003T_LTEXT,
	 B14_01_T001_WAERS,
	  B14_01_ZF_ACDOCA_KSL_S,
	  B14_01_ZF_ACDOCA_OSL_S,
	 B14_01_ZF_ACDOCA_HSL_S,
	 B14_01_ZF_ACDOCA_HSL_S_CUC,

	CONCAT(B14_02_ACDOCA_RBUKRS,'|',B14_02_ACDOCA_AUGBL,'|',B14_02_ACDOCA_AUGDT) AS B14_02_ZF_CUSTOMER_CREDIT_NOTE, 
	B14_02_ZF_ACDOCA_HSL_S,
	B14_02_ZF_ACDOCA_HSL_S_CUC,
	B14_02_ACDOCA_USNAM,
	B14_02_V_USERNAME_NAME_TEXT,
 
	B14_02_ACDOCA_RBUKRS,
	B14_02_ACDOCA_BLART,
	B14_02_T003T_LTEXT,
	 B14_02_T001_WAERS,
	B14_02_ZF_ACDOCA_KSL_S,
	B14_02_ZF_ACDOCA_OSL_S,
	B14_02_ACDOCA_AUGBL,
	B14_02_ACDOCA_AUGDT,

	CONCAT(B14_05_ACDOCA_RBUKRS,'|',B14_05_ACDOCA_AUGBL,'|',B14_05_ACDOCA_AUGDT) AS B14_05_ZF_OTHERS, 
	B14_05_ZF_ACDOCA_HSL_S,
	B14_05_ZF_ACDOCA_HSL_S_CUC,
	B14_05_ACDOCA_USNAM,
	B14_05_V_USERNAME_NAME_TEXT,
 
	B14_05_ACDOCA_RBUKRS,
	B14_05_ACDOCA_BLART,
	B14_05_T003T_LTEXT,
	 B14_05_T001_WAERS,
	B14_05_ZF_ACDOCA_KSL_S,
	B14_05_ZF_ACDOCA_OSL_S,
	B14_05_ACDOCA_AUGBL,
	B14_05_ACDOCA_AUGDT,


	CONCAT(B14_03_ACDOCA_RBUKRS,'|',B14_03_ACDOCA_AUGBL,'|',B14_03_ACDOCA_AUGDT)  AS B14_03_ZF_CUSTOMER_PAYMENT_KEY, 
	B14_03_ZF_ACDOCA_HSL_S,
	B14_03_ZF_ACDOCA_HSL_S_CUC,
	B14_03_ACDOCA_USNAM,
	B14_03_V_USERNAME_NAME_TEXT,
 
	B14_03_ACDOCA_RBUKRS,
	B14_03_ACDOCA_BLART,
	B14_03_T003T_LTEXT,
	 B14_03_T001_WAERS,
	B14_03_ZF_ACDOCA_KSL_S,
	B14_03_ZF_ACDOCA_OSL_S,
	B14_03_ACDOCA_AUGBL,
	B14_03_ACDOCA_AUGDT,

	 CONCAT(B14_04_ACDOCA_RBUKRS,'|',B14_04_ACDOCA_AUGBL,'|',B14_04_ACDOCA_AUGDT)  AS  B14_04_ZF_CUSTOMER_PAYMENT_CANCELLATION,
	B14_04_ZF_ACDOCA_HSL_S,
	B14_04_ZF_ACDOCA_HSL_S_CUC,
	 B14_04_ACDOCA_USNAM,
	B14_04_V_USERNAME_NAME_TEXT,
 
	 B14_04_ACDOCA_RBUKRS,
	B14_04_ACDOCA_BLART,
	 B14_04_T003T_LTEXT,
	 B14_04_T001_WAERS,
	B14_04_ZF_ACDOCA_KSL_S,
	B14_04_ZF_ACDOCA_OSL_S,
	B14_04_ACDOCA_AUGBL,
	B14_04_ACDOCA_AUGDT

	INTO B31_05_IT_CENTER_FACT_TABLE_ADD_INV_PAY
	FROM B31_04_TT_CENTER_FACT_TABLE_UNION
		--Get the Customer invoice 
		FULL OUTER JOIN B14_SS01_06_IT_CUSTOMER_INVOICE_SUMMARY  
		ON B14_01_ACDOCA_AWREF=B30_VBRP_VBELN
	--	AND B14_01_ACDOCA_RBUKRS=B30_TVKO_BUKRS
	AND B30_TVKO_BUKRS_MAPPING=B14_01_ACDOCA_BUKRS_MAPPING

		--Get the credit note
		FULL OUTER JOIN B14_SS01_07_IT_CUSTOMER_CREDIT_NOTE
		ON B14_02_ACDOCA_AUGBL=B14_01_ACDOCA_AUGBL
		AND B14_02_ACDOCA_AUGDT=B14_01_ACDOCA_AUGDT
	--	AND B14_03_ACDOCA_RBUKRS=B14_04_ACDOCA_RBUKRS
	AND B14_02_ACDOCA_BUKRS_MAPPING=B14_01_ACDOCA_BUKRS_MAPPING
	AND (B14_02_ACDOCA_AUGBL<>'' AND B14_01_ACDOCA_AUGBL<>'')

-- get the other
		FULL OUTER JOIN B14_SS01_10_IT_CUSTOMER_OTHERS_SUMMARY
		ON B14_05_ACDOCA_AUGBL=B14_01_ACDOCA_AUGBL
		AND B14_05_ACDOCA_AUGDT=B14_01_ACDOCA_AUGDT
	--	AND B14_03_ACDOCA_RBUKRS=B14_04_ACDOCA_RBUKRS
	AND B14_05_ACDOCA_BUKRS_MAPPING=B14_01_ACDOCA_BUKRS_MAPPING
	AND (B14_05_ACDOCA_AUGBL<>'' AND B14_01_ACDOCA_AUGBL<>'')

	--Get the Customer payment
		FULL OUTER JOIN B14_SS01_08_IT_CUSTOMER_PAYMENT_SUMMARY
		ON B14_01_ACDOCA_AUGBL=B14_03_ACDOCA_AUGBL
		AND B14_01_ACDOCA_AUGDT=B14_03_ACDOCA_AUGDT
	--	AND B14_01_ACDOCA_RBUKRS=B14_03_ACDOCA_RBUKRS
	AND B14_01_ACDOCA_BUKRS_MAPPING=B14_03_ACDOCA_BUKRS_MAPPING
	AND (B14_01_ACDOCA_AUGBL<>'' AND B14_03_ACDOCA_AUGBL<>'')
		--Get the Customer payment cancellation
		FULL OUTER JOIN B14_SS01_09_IT_CUSTOMER_PAYMENT_CANCEL_SUMMARY
		ON B14_03_ACDOCA_AUGBL=B14_04_ACDOCA_AUGBL
		AND B14_03_ACDOCA_AUGDT=B14_04_ACDOCA_AUGDT
	--	AND B14_03_ACDOCA_RBUKRS=B14_04_ACDOCA_RBUKRS
	AND B14_03_ACDOCA_BUKRS_MAPPING=B14_04_ACDOCA_BUKRS_MAPPING
	AND (B14_03_ACDOCA_AUGBL<>'' AND B14_04_ACDOCA_AUGBL<>'')


--Drop all TT table
EXEC SP_REMOVE_TABLES '%TEMP%'
EXEC SP_REMOVE_TABLES '%_TT_%'
EXEC SP_REMOVE_TABLES 'TT_%'

GO
