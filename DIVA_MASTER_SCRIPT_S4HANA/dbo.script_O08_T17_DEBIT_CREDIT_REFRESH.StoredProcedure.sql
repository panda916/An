USE [DIVA_MASTER_SCRIPT_S4HANA]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--ALTER PROCEDURE [dbo].[O08_T17_Debit-credit refresh]
CREATE     PROCEDURE [dbo].[script_O08_T17_DEBIT_CREDIT_REFRESH]
WITH EXECUTE AS CALLER
AS
--DYNAMIC_SCRIPT_START
BEGIN


/* Initiate the log */  
--Create database log table if it does not exist
IF OBJECT_ID('LOG_SP_EXECUTION', 'U') IS NULL BEGIN CREATE TABLE [DBO].[LOG_SP_EXECUTION] ([DATABASE] NVARCHAR(MAX) NULL,[OBJECT] NVARCHAR(MAX) NULL,[OBJECT_TYPE] NVARCHAR(MAX) NULL,[USER] NVARCHAR(MAX) NULL,[DATE] DATE NULL,[TIME] TIME NULL,[DESCRIPTION] NVARCHAR(MAX) NULL,[TABLE] NVARCHAR(MAX),[ROWS] INT) END

--Log start of procedure
INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(DATE,GETDATE()),CONVERT(TIME,GETDATE()),'Procedure started',NULL,NULL

	/* Initialize parameters from globals table */
    DECLARE  
				@CURRENCY NVARCHAR(3)                 = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'currency')
				,@DATE1 NVARCHAR(MAX)                           = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'date1')
				,@DATE2 NVARCHAR(MAX)                           = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'date2')
				,@DOWNLOADDATE NVARCHAR(MAX)             = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'downloaddate')
				,@DATEFORMAT VARCHAR(3)             = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'dateformat')
				,@EXCHANGERATETYPE NVARCHAR(MAX)  = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'exchangeratetype')
				,@LANGUAGE1 NVARCHAR(3)                = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'language1')
				,@LANGUAGE2 NVARCHAR(3)                = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'language2')
				,@LIMIT_RECORDS INT                    = CAST((SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'LIMIT_RECORDS') AS INT)
				,@FISCAL_YEAR_FROM NVARCHAR(MAX)					= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'FISCAL_YEAR_FROM')
				,@FISCAL_YEAR_TO NVARCHAR(MAX)					= (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'FISCAL_YEAR_TO')
                 SET DATEFORMAT @DATEFORMAT;


/*Test mode*/

SET ROWCOUNT @LIMIT_RECORDS


/*Change history comments*/

/*
    Title			:	O08_T17: Debit-credit refreshN  update
      
    --------------------------------------------------------------
    Update history
    --------------------------------------------------------------
    Date		    | Who |	Description
	20/03/2019		  THUAN    Test creation
	05-08-2019			VL		Update with S4HANA logic
*/


-- Step 1/ List all the invoices in B14_06_IT_ARE table.

EXEC SP_DROPTABLE 'O08_T17_01_TT_INV'
SELECT 
	DISTINCT
	B14_ACDOCA_BELNR,
	B14_ACDOCA_BUDAT,
	B14_ACDOCA_BLDAT,
	B14_ACDOCA_GJAHR,
	B14_ACDOCA_BLART,
	B14_ZF_AR_DOC_TYPE_BUCKET,
	B14_ACDOCA_RWCUR,
	B14_ZF_ACDOCA_WSL_DOC,
	B14_ACDOCA_RHCUR,
	B14_ZF_ACDOCA_HSL_S,
	B14_ACDOCA_RKCUR,
	B14_ZF_ACDOCA_KSL_S,
	B14_GLOBALS_CURRENCY,
	B14_ZF_ACDOCA_HSL_S_CUC,
	B14_ACDOCA_AUGBL,
	B14_ACDOCA_AUGDT,
	B14_ACDOCA_KUNNR,
	B14_ACDOCA_RACCT,
	B14_KNA1_NAME1,
	B14_ACDOCA_RBUKRS,
	B14_ACDOCA_BSCHL
INTO O08_T17_01_TT_INV
FROM B14_06_IT_ARE
-- WHERE 
-- 	B14_ZF_AR_DOC_TYPE_BUCKET ='Invoice'
	
-- Step 2/ Caculate amount in document currency base on company code, matching key, clearing date, g/l account, customer number.

EXEC SP_DROPTABLE 'O08_T17_02_TT_TOTAL_INV'
SELECT
	B14_ACDOCA_RBUKRS, 
	B14_ACDOCA_AUGBL,
	B14_ACDOCA_AUGDT,
	B14_ACDOCA_KUNNR,
	B14_ACDOCA_RACCT,
	B14_ACDOCA_RWCUR,
	SUM(B14_ZF_ACDOCA_WSL_DOC) AS ZF_ACDOCA_WSL_TOT_AUGBL,
	B14_ACDOCA_RHCUR,
	SUM(B14_ZF_ACDOCA_HSL_S) AS ZF_ACDOCA_HSL,
	B14_ACDOCA_RKCUR,
	SUM(B14_ZF_ACDOCA_KSL_S) AS ZF_ACDOCA_KSL,
	B14_GLOBALS_CURRENCY,
	SUM(B14_ZF_ACDOCA_HSL_S_CUC) AS ZF_ACDOCA_HSL_CUC
INTO O08_T17_02_TT_TOTAL_INV
FROM O08_T17_01_TT_INV
WHERE B14_ZF_ACDOCA_WSL_DOC >= 0 OR B14_ZF_ACDOCA_HSL_S >= 0 OR B14_ZF_ACDOCA_KSL_S >= 0
GROUP BY 
	B14_ACDOCA_RBUKRS,
	B14_ACDOCA_AUGBL,
	B14_ACDOCA_AUGDT,
	B14_ACDOCA_KUNNR,
	B14_ACDOCA_RACCT,
	B14_ACDOCA_RWCUR,
	B14_ACDOCA_RHCUR,
	B14_ACDOCA_RKCUR,
	B14_GLOBALS_CURRENCY

-- Step 3/ List all the invoices join with DA and NEW DA table.

EXEC SP_DROPTABLE 'O08_T17_03_IT_INV'
SELECT 
	IDENTITY (INT, 100, 5) AS REF_KEY_JOIN,
	INV.B14_ACDOCA_RBUKRS,
	INV.B14_ACDOCA_AUGDT,
	INV.B14_ACDOCA_KUNNR,
	INV.B14_ACDOCA_RACCT,
	INV.B14_ACDOCA_RWCUR,
	INV.ZF_ACDOCA_WSL_TOT_AUGBL,
	INV.B14_ACDOCA_RHCUR,
	INV.ZF_ACDOCA_HSL,
	INV.B14_ACDOCA_RKCUR,
	INV.ZF_ACDOCA_KSL,
	INV.B14_GLOBALS_CURRENCY,
	INV.ZF_ACDOCA_HSL_CUC,
	INV.B14_ACDOCA_AUGBL
INTO O08_T17_03_IT_INV
FROM O08_T17_02_TT_TOTAL_INV AS INV INNER JOIN B14_06_IT_ARE AS DA ON 
	INV.B14_ACDOCA_KUNNR = DA.B14_ACDOCA_KUNNR 
	AND INV.B14_ACDOCA_RACCT = DA.B14_ACDOCA_RACCT
	AND INV.B14_ACDOCA_AUGBL = DA.B14_ACDOCA_AUGBL
	AND INV.B14_ACDOCA_AUGBL = DA.B14_ACDOCA_BELNR
	AND (INV.ZF_ACDOCA_WSL_TOT_AUGBL + DA.B14_ZF_ACDOCA_WSL_DOC) = 0
INNER JOIN B14_06_IT_ARE AS NEW_DA ON
	DA.B14_ACDOCA_KUNNR = NEW_DA.B14_ACDOCA_KUNNR 
	AND DA.B14_ACDOCA_RACCT = NEW_DA.B14_ACDOCA_RACCT
	AND DA.B14_ACDOCA_AUGBL != NEW_DA.B14_ACDOCA_AUGBL
	AND DA.B14_ACDOCA_BELNR = NEW_DA.B14_ACDOCA_BELNR
	AND DA.B14_ACDOCA_AUGBL = NEW_DA.B14_ACDOCA_BELNR
	AND (NEW_DA.B14_ZF_ACDOCA_WSL_DOC + DA.B14_ZF_ACDOCA_WSL_DOC) = 0
	
--Step 4/ Add more necessary fields from step 3. 

EXEC SP_DROPTABLE 'O08_T17_04_IT_INV_DETAIL'
SELECT 
	NEW_INV.REF_KEY_JOIN,
	ORI_INV.B14_ACDOCA_BELNR,
	ORI_INV.B14_ACDOCA_BUDAT,
	ORI_INV.B14_ACDOCA_BLDAT,
	ORI_INV.B14_ACDOCA_GJAHR,
	ORI_INV.B14_ACDOCA_BLART,
	ORI_INV.B14_ZF_AR_DOC_TYPE_BUCKET,
	ORI_INV.B14_ACDOCA_RWCUR,
	ORI_INV.B14_ZF_ACDOCA_WSL_DOC,
	ORI_INV.B14_ACDOCA_RHCUR,
	ORI_INV.B14_ZF_ACDOCA_HSL_S,
	ORI_INV.B14_ACDOCA_RKCUR,
	ORI_INV.B14_ZF_ACDOCA_KSL_S,
	ORI_INV.B14_GLOBALS_CURRENCY,
	ORI_INV.B14_ZF_ACDOCA_HSL_S_CUC,
	NEW_INV.B14_ACDOCA_AUGBL,
	NEW_INV.B14_ACDOCA_AUGDT,
	NEW_INV.B14_ACDOCA_KUNNR,
	NEW_INV.B14_ACDOCA_RACCT,
	ORI_INV.B14_KNA1_NAME1,
	NEW_INV.B14_ACDOCA_RBUKRS,
	ORI_INV.B14_ACDOCA_BSCHL
INTO O08_T17_04_IT_INV_DETAIL
FROM O08_T17_01_TT_INV AS ORI_INV INNER JOIN O08_T17_03_IT_INV AS NEW_INV ON
	ORI_INV.B14_ACDOCA_KUNNR = NEW_INV.B14_ACDOCA_KUNNR
	AND ORI_INV.B14_ACDOCA_RACCT = NEW_INV.B14_ACDOCA_RACCT
	AND ORI_INV.B14_ACDOCA_RBUKRS = NEW_INV.B14_ACDOCA_RBUKRS
	AND ORI_INV.B14_ACDOCA_AUGBL = NEW_INV.B14_ACDOCA_AUGBL
	AND ORI_INV.B14_ACDOCA_AUGDT = NEW_INV.B14_ACDOCA_AUGDT
WHERE ORI_INV.B14_ZF_ACDOCA_WSL_DOC >= 0
--Step 5/ List all the fields for DA table.
EXEC SP_DROPTABLE 'O08_T17_05_IT_DA'
SELECT 
	INV.REF_KEY_JOIN,
	DA.B14_ACDOCA_BELNR,
	DA.B14_ACDOCA_BUDAT,
	DA.B14_ACDOCA_BLDAT,
	DA.B14_ACDOCA_GJAHR,
	DA.B14_ACDOCA_BLART,
	DA.B14_ZF_AR_DOC_TYPE_BUCKET,
	DA.B14_ACDOCA_RWCUR,
	DA.B14_ZF_ACDOCA_WSL_DOC,
	DA.B14_ACDOCA_RHCUR,
	DA.B14_ZF_ACDOCA_HSL_S,
	DA.B14_ACDOCA_RKCUR,
	DA.B14_ZF_ACDOCA_KSL_S,
	DA.B14_GLOBALS_CURRENCY,
	DA.B14_ZF_ACDOCA_HSL_S_CUC,	
	DA.B14_ACDOCA_AUGBL,
	DA.B14_ACDOCA_AUGDT,
	DA.B14_ACDOCA_KUNNR,
	DA.B14_ACDOCA_RACCT,
	DA.B14_KNA1_NAME1,
	DA.B14_ACDOCA_RBUKRS,
	DA.B14_ACDOCA_BSCHL
INTO O08_T17_05_IT_DA
FROM 
	O08_T17_03_IT_INV AS INV INNER JOIN B14_06_IT_ARE AS DA ON 
	INV.B14_ACDOCA_KUNNR = DA.B14_ACDOCA_KUNNR 
	AND INV.B14_ACDOCA_RACCT = DA.B14_ACDOCA_RACCT
	AND INV.B14_ACDOCA_AUGBL = DA.B14_ACDOCA_AUGBL
	AND INV.B14_ACDOCA_AUGBL = DA.B14_ACDOCA_BELNR
	AND (INV.ZF_ACDOCA_WSL_TOT_AUGBL + DA.B14_ZF_ACDOCA_WSL_DOC) = 0

--Step 6/ List all the fields for NEW DA table
EXEC SP_DROPTABLE 'O08_T17_06_IT_NEW_DA'
 SELECT 
	DA.REF_KEY_JOIN,
	NEW_DA.B14_ACDOCA_BELNR,
	NEW_DA.B14_ACDOCA_BUDAT,
	NEW_DA.B14_ACDOCA_BLDAT,
	NEW_DA.B14_ACDOCA_GJAHR,
	NEW_DA.B14_ACDOCA_BLART,
	NEW_DA.B14_ZF_AR_DOC_TYPE_BUCKET,
	NEW_DA.B14_ACDOCA_RWCUR,
	NEW_DA.B14_ZF_ACDOCA_WSL_DOC,
	NEW_DA.B14_ACDOCA_RHCUR,
	NEW_DA.B14_ZF_ACDOCA_HSL_S,
	NEW_DA.B14_ACDOCA_RKCUR,
	NEW_DA.B14_ZF_ACDOCA_KSL_S,
	NEW_DA.B14_GLOBALS_CURRENCY,
	NEW_DA.B14_ZF_ACDOCA_HSL_S_CUC,	
	NEW_DA.B14_ACDOCA_AUGBL,
	NEW_DA.B14_ACDOCA_AUGDT,
	NEW_DA.B14_ACDOCA_KUNNR,
	NEW_DA.B14_ACDOCA_RACCT,
	NEW_DA.B14_KNA1_NAME1,
	NEW_DA.B14_ACDOCA_RBUKRS,
	NEW_DA.B14_ACDOCA_BSCHL,
	CASE
			WHEN DATEDIFF(day,DA.B14_ACDOCA_AUGDT, NEW_DA.B14_ACDOCA_AUGDT) >0 OR (NEW_DA.B14_ACDOCA_AUGDT IS NULL)
			 THEN  'Yes'
			ELSE ' '
	END ZF_CLEARING_DIFF
INTO O08_T17_06_IT_NEW_DA
FROM 
	O08_T17_05_IT_DA AS DA INNER JOIN B14_06_IT_ARE AS NEW_DA ON 
	DA.B14_ACDOCA_KUNNR = NEW_DA.B14_ACDOCA_KUNNR 
	AND DA.B14_ACDOCA_RACCT = NEW_DA.B14_ACDOCA_RACCT
	AND DA.B14_ACDOCA_AUGBL != NEW_DA.B14_ACDOCA_AUGBL
	AND DA.B14_ACDOCA_BELNR = NEW_DA.B14_ACDOCA_BELNR
	AND DA.B14_ACDOCA_AUGBL = NEW_DA.B14_ACDOCA_BELNR
	AND (NEW_DA.B14_ZF_ACDOCA_WSL_DOC + DA.B14_ZF_ACDOCA_WSL_DOC) = 0

-- Step 7/  Combine DA and NEW DA table into 1 table.

EXEC SP_DROPTABLE 'O08_T17_07_IT_DA_NEW_DA'
SELECT 
	DA.REF_KEY_JOIN,
	DA.B14_ACDOCA_BELNR AS ACDOCA_BELNR_DA,
	DA.B14_ACDOCA_BUDAT AS ACDOCA_BUDAT_DA,
	DA.B14_ACDOCA_BLDAT AS ACDOCA_BLDAT_DA,
	DA.B14_ACDOCA_GJAHR AS ACDOCA_GJAHR_DA,
	DA.B14_ACDOCA_BLART AS ACDOCA_BLART_DA,
	DA.B14_ZF_AR_DOC_TYPE_BUCKET AS B14_ZF_AR_DOC_TYPE_BUCKET_DA,
	DA.B14_ACDOCA_RWCUR AS ACDOCA_RWCUR_DA,
	DA.B14_ZF_ACDOCA_WSL_DOC AS ZF_ACDOCA_WSL_DOC_DA,
	DA.B14_ACDOCA_RHCUR AS ACDOCA_RHCUR_DA,
	DA.B14_ZF_ACDOCA_HSL_S AS ACDOCA_HSL_DA,
	DA.B14_ACDOCA_RKCUR AS ACDOCA_RKCUR_DA,
	DA.B14_ZF_ACDOCA_KSL_S AS ACDOCA_KSL_DA,
	DA.B14_GLOBALS_CURRENCY AS GLOBALS_CURRENCY_DA,
	DA.B14_ZF_ACDOCA_HSL_S_CUC AS ZF_ACDOCA_HSL_CUC_DA,
	DA.B14_ACDOCA_AUGBL AS ACDOCA_AUGBL_DA,
	DA.B14_ACDOCA_AUGDT AS ACDOCA_AUGDT_DA,
	DA.B14_ACDOCA_KUNNR AS ACDOCA_KUNNR_DA,
	DA.B14_ACDOCA_RACCT AS ACDOCA_RACCT_DA,
	DA.B14_KNA1_NAME1 AS KNA1_NAME1_DA,
	DA.B14_ACDOCA_RBUKRS AS ACDOCA_RBUKRS_DA,
	DA.B14_ACDOCA_BSCHL AS ACDOCA_BSCHL_DA,
	NEW_DA.B14_ACDOCA_BELNR AS ACDOCA_BELNR_NEW_DA,
	NEW_DA.B14_ACDOCA_BUDAT AS  ACDOCA_BUDAT_NEW_DA,
	NEW_DA.B14_ACDOCA_BLDAT AS ACDOCA_BLDAT_NEW_DA,
	NEW_DA.B14_ACDOCA_GJAHR AS ACDOCA_GJAHR_NEW_DA,
	NEW_DA.B14_ACDOCA_BLART AS ACDOCA_BLART_NEW_DA,
	NEW_DA.B14_ZF_AR_DOC_TYPE_BUCKET AS ZF_AR_DOC_TYPE_BUCKET_NEW_DA,
	NEW_DA.B14_ACDOCA_RWCUR AS ACDOCA_RWCUR_NEW_DA,
	NEW_DA.B14_ZF_ACDOCA_WSL_DOC AS ZF_ACDOCA_WSL_DOC_NEW_DA,
	NEW_DA.B14_ACDOCA_RHCUR AS ACDOCA_RHCUR_NEW_DA,
	NEW_DA.B14_ZF_ACDOCA_HSL_S AS ACDOCA_HSL_NEW_DA,
	NEW_DA.B14_ACDOCA_RKCUR AS ACDOCA_RKCUR_NEW_DA,
	NEW_DA.B14_ZF_ACDOCA_KSL_S AS ACDOCA_KSL_NEW_DA,
	NEW_DA.B14_GLOBALS_CURRENCY AS GLOBALS_CURRENCY_NEW_DA,
	NEW_DA.B14_ZF_ACDOCA_HSL_S_CUC AS ZF_ACDOCA_HSL_CUC,
	NEW_DA.B14_ACDOCA_AUGBL AS ACDOCA_AUGBL_NEW_DA,
	NEW_DA.B14_ACDOCA_AUGDT AS ACDOCA_AUGDT_NEW_DA,
	NEW_DA.B14_ACDOCA_KUNNR AS ACDOCA_KUNNR_NEW_DA,
	NEW_DA.B14_ACDOCA_RACCT AS ACDOCA_RACCT_NEW_DA,
	NEW_DA.B14_KNA1_NAME1 AS KNA1_NAME1_NEW_DA,
	NEW_DA.B14_ACDOCA_RBUKRS AS ACDOCA_RBUKRS_NEW_DA,
	NEW_DA.B14_ACDOCA_BSCHL AS ACDOCA_BSCHL_NEW_DA,
	NEW_DA.ZF_CLEARING_DIFF
INTO O08_T17_07_IT_DA_NEW_DA
FROM O08_T17_05_IT_DA  AS DA INNER JOIN O08_T17_06_IT_NEW_DA AS NEW_DA 
ON  DA.REF_KEY_JOIN = NEW_DA.REF_KEY_JOIN

-- Change name for column
EXEC SP_UNNAME_FIELD 'B14_', 'O08_T17_04_IT_INV_DETAIL'
EXEC SP_RENAME_SUFFIX_FIELD '_INV','O08_T17_04_IT_INV_DETAIL'
EXEC SP_UNNAME_FIELD 'B14_', 'O08_T17_07_IT_DA_NEW_DA'

/* Delete all temparory table*/
--EXEC SP_REMOVE_TABLES '%_TT_%'
EXEC SP_DROPTABLE 'O08_T17_01_TT_INV'

EXEC SP_DROPTABLE 'O08_T17_02_TT_TOTAL_INV'
/* log cube creation*/

INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(DATE,GETDATE()),CONVERT(TIME,GETDATE()),'Cube completed','O08_T17_04_IT_INV_DETAIL',(SELECT COUNT(*) FROM O08_T17_04_IT_INV_DETAIL) 
INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(DATE,GETDATE()),CONVERT(TIME,GETDATE()),'Cube completed','O08_T17_07_IT_DA_NEW_DA',(SELECT COUNT(*) FROM O08_T17_07_IT_DA_NEW_DA) 

/* log end of procedure*/


INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(date,GETDATE()),CONVERT(time,GETDATE()),'Procedure finished',NULL,NULL


END
GO
