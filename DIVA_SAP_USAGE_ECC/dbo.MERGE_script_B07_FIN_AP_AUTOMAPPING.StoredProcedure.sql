USE [DIVA_SAP_USAGE_ECC]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE     PROC [dbo].[MERGE_script_B07_FIN_AP_AUTOMAPPING]
WITH EXECUTE AS CALLER
AS
--DYNAMIC_SCRIPT_START

/* Initiate the log */  
--Create database log table if it does not exist
IF OBJECT_ID('LOG_SP_EXECUTION', 'U') IS NULL BEGIN CREATE TABLE [DBO].[LOG_SP_EXECUTION] ([DATABASE] NVARCHAR(MAX) NULL,[OBJECT] NVARCHAR(MAX) NULL,[OBJECT_TYPE] NVARCHAR(MAX) NULL,[USER] NVARCHAR(MAX) NULL,[DATE] DATE NULL,[TIME] TIME NULL,[DESCRIPTION] NVARCHAR(MAX) NULL,[TABLE] NVARCHAR(MAX),[ROWS] INT) END

--Log start of procedure
INSERT INTO [DBO].[LOG_SP_EXECUTION] ([DATABASE],[OBJECT],[OBJECT_TYPE],[USER],[DATE],[TIME],[DESCRIPTION],[TABLE],[ROWS])
SELECT DB_NAME(),OBJECT_NAME(@@PROCID),'P',SYSTEM_USER,CONVERT(DATE,GETDATE()),CONVERT(TIME,GETDATE()),'Procedure started',NULL,NULL

/* Initialize parameters from globals table */

     DECLARE   
       @CURRENCY NVARCHAR(MAX)      = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'currency')
      ,@DATE1 NVARCHAR(MAX)       = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'date1')
      ,@DATE2 NVARCHAR(MAX)       = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'date2')
      ,@DOWNLOADDATE NVARCHAR(MAX)    = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'downloaddate')
      ,@DATEFORMAT VARCHAR(3)             = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'dateformat')
      ,@EXCHANGERATETYPE NVARCHAR(MAX)  = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'exchangeratetype')
      ,@LANGUAGE1 NVARCHAR(MAX)     = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'language1')
      ,@LANGUAGE2 NVARCHAR(MAX)     = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'language2')
      ,@YEAR NVARCHAR(MAX)        = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'year')
      ,@ID NVARCHAR(MAX)          = (SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'id')
      ,@LIMIT_RECORDS INT               = CAST((SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'LIMIT_RECORDS') AS INT)
      ,@ZV_LFA1_KTOKK_PERS INT                = CAST((SELECT GLOBALS_VALUE FROM [AM_GLOBALS] WHERE GLOBALS_PARAMETER = 'ZV_LFA1_KTOKK_PERS') AS INT)


  /*Change history comments*/

  /*
    Title     : [B07B_FIN_AP_DOC_TYPES_FILL_BUCKET]
    Description     : Table updated by this script: B07_02_RT_FIN_AP_INV_PAY_FLAGS
              - DV06 should be reloaded after running this script
              Table produced by this script: B07_02_IT
              Table is used to create the P2P cube
    
    --------------------------------------------------------------
    Update history
    --------------------------------------------------------------
    Date          | Who     | Description
    DD-MM-YYYY        Initials    Initial version
    27-11-2020        Vinh Le     Create first version of AP mapping automatically
  */



 



	  /*Test mode*/

	  SET ROWCOUNT @LIMIT_RECORDS

	  /*
		  Step 1: Create a summary table before we flag the AP document with categories to we can check the mapping easier because it have less record than full AP documents tables.
	  */

	  EXEC SP_REMOVE_TABLES 'B07_01_TT_FIN_AP_INV_PAY_FLAGS'
	  SELECT DISTINCT
		  BSAIK_BUKRS,
		  BSAIK_BLART,
		  ZF_DOC_CLEARING_FLAG,
		  BSAIK_UMSKZ,
		  BSAIK_BSCHL,
		  BKPF_TCODE,
		  BKPF_AWTYP,
		  LFA1_KTOKK,
		  BSAIK_XANET,
		  BSAIK_LIFNR,
		  BSAIK_SHKZG,
		  ZF_DEBIT_ACCOUNT_TYPES,
		  ZF_CREDIT_ACCOUNT_TYPES,
		  ZF_DEBIT_T012K_FEBKO_SKB1_HBKID_XGKON_FLAG_LIST,
		  ZF_CREDIT_T012K_FEBKO_SKB1_HBKID_XGKON_FLAG_LIST,
		  ZF_DEBIT_SKA1_GVTYP_FLAG_LIST,
		  ZF_CREDIT_SKA1_GVTYP_FLAG_LIST,
		  ZF_LIFNR_KUNNR_IS_SAME_FLAG,
		  ZF_REGUH_PAYMENT_FLAG,
		  ZF_REGUP_INVOICE_FLAG,
		  'Y' AS UNCLASSIFIED_FLAG
	  INTO B07_01_TT_FIN_AP_INV_PAY_FLAGS
	  FROM B04_10_IT_BSAK_BSIK_AP_ACC_SCH
	  


	  /*
		Step 2: Add AP document type columns with default value is "Other". It will be update later
	  */

	  ALTER TABLE B07_01_TT_FIN_AP_INV_PAY_FLAGS ADD ZF_FLAG_SUMMARY NVARCHAR(100) DEFAULT 'Others' WITH VALUES;
	  ALTER TABLE B07_01_TT_FIN_AP_INV_PAY_FLAGS ADD ZF_SUPP_INV NVARCHAR(1) DEFAULT '' WITH VALUES;
	  ALTER TABLE B07_01_TT_FIN_AP_INV_PAY_FLAGS ADD ZF_SUPP_INV_CANC NVARCHAR(1) DEFAULT '' WITH VALUES;
	  ALTER TABLE B07_01_TT_FIN_AP_INV_PAY_FLAGS ADD ZF_SUPP_PAY NVARCHAR(1) DEFAULT '' WITH VALUES;
	  ALTER TABLE B07_01_TT_FIN_AP_INV_PAY_FLAGS ADD ZF_SUPP_PAY_CANC NVARCHAR(1) DEFAULT '' WITH VALUES;
	  ALTER TABLE B07_01_TT_FIN_AP_INV_PAY_FLAGS ADD ZF_PERSONAL_EXPENSE NVARCHAR(1) DEFAULT '' WITH VALUES;
	  ALTER TABLE B07_01_TT_FIN_AP_INV_PAY_FLAGS ADD ZF_PERSONAL_EXPENSE_CANCELLATION NVARCHAR(1) DEFAULT '' WITH VALUES;
	  ALTER TABLE B07_01_TT_FIN_AP_INV_PAY_FLAGS ADD ZF_PERSONAL_EXPENSE_PAYMENT NVARCHAR(1) DEFAULT '' WITH VALUES;
	  ALTER TABLE B07_01_TT_FIN_AP_INV_PAY_FLAGS ADD ZF_PERSONAL_EXPENSE_PAYMENT_CANCELLATION NVARCHAR(1) DEFAULT '' WITH VALUES;
	  ALTER TABLE B07_01_TT_FIN_AP_INV_PAY_FLAGS ADD ZF_OTHERS NVARCHAR(1) DEFAULT '' WITH VALUES;


	  /*
		Step 3: Update the AP document type base on ACL logic from Claire and meeting with Sony team on March 25, 2021
				Vinh updated the AP mapping sql scripts and Thuan finished testing on April 2, 2021
				
	  */

		  /*
				Step 3.1: Flag all documents which have BLART in ('PA', 'TR') to "Others" bucket. (Only apply for SPE now)
		  */
		  IF DB_NAME() LIKE '%SPE%' 
		  BEGIN
			  UPDATE B07_01_TT_FIN_AP_INV_PAY_FLAGS
			  SET ZF_FLAG_SUMMARY = 'Others', ZF_OTHERS = 'X', 
				  UNCLASSIFIED_FLAG = ''
			  WHERE UNCLASSIFIED_FLAG = 'Y' AND BSAIK_BLART IN ('PA', 'TR')
		  END


	  
		  /*
				Step 3.2: Flag all documents have
							Debit on account type 'K'
							Credit on (SKA1_GVTYP_BSEG<> "" OR  BSEG_KOART = S) AND NOT(ZF_BSEG_HKONT_PAYFLAG) AND BSAK_XANET ="" 
							BELNR = AUGBL
							AWTYP <> 'RMRP'
						 to "Others" bucket 
		  */
		  UPDATE B07_01_TT_FIN_AP_INV_PAY_FLAGS
		  SET ZF_FLAG_SUMMARY = 'Others', ZF_OTHERS = 'X', 
			  UNCLASSIFIED_FLAG = ''
		  WHERE UNCLASSIFIED_FLAG = 'Y' AND 

				LEFT(ZF_DEBIT_ACCOUNT_TYPES, 1) = 'K'
				AND (
					LEFT(ZF_CREDIT_SKA1_GVTYP_FLAG_LIST, 1) <> '_' OR
					LEFT(ZF_CREDIT_ACCOUNT_TYPES, 1) = 'S'
					)
				AND LEFT(ZF_CREDIT_T012K_FEBKO_SKB1_HBKID_XGKON_FLAG_LIST, 1) <> 'Y'
				AND ISNULL(BSAIK_XANET, '') = ''
				AND ZF_DOC_CLEARING_FLAG = 1
				AND BKPF_AWTYP <> 'RMRP' 

		  /*
				Step 3.2.1: Flag all documents have
							Discuss with Claire if we should not get the customer equal to vendor number rule reinstated for KOART D/K postings
						 to "Others" bucket 
				Meeting with Jesper on 26-03-2021
							Add a new rule from Sony's daily meeting on Monday, 29 March 2021. We should flag all documents credit on 'K' and vendor number is blank to "Others"
		  */
		  UPDATE B07_01_TT_FIN_AP_INV_PAY_FLAGS
		  SET ZF_FLAG_SUMMARY = 'Others', ZF_OTHERS = 'X', 
			  UNCLASSIFIED_FLAG = ''
		  WHERE UNCLASSIFIED_FLAG = 'Y' AND 
		  LEFT(ZF_CREDIT_ACCOUNT_TYPES, 1) = 'K' 
		  AND (
				  ( 
					  LEFT(ZF_DEBIT_ACCOUNT_TYPES, 1) = 'D'
					  AND ZF_LIFNR_KUNNR_IS_SAME_FLAG = 'Y'
				  )
				  OR 
				  ISNULL(BSAIK_LIFNR, '') = ''
			  )





			/*
				Step 3.3: Flag all documents have
							Debit on (SKA1_GVTYP_BSEG <> "" OR  BSEG_KOART = S) AND NOT(ZF_BSEG_HKONT_PAYFLAG) AND BSAK_XANET ="" 
							Credit on account type 'K'
							BELNR <> AUGBL
							AWTYP = 'RMRP'
						  to Supplier invoice
			*/
			UPDATE B07_01_TT_FIN_AP_INV_PAY_FLAGS
			SET ZF_FLAG_SUMMARY = 'Supplier invoice', ZF_SUPP_INV = 'X', 
			    UNCLASSIFIED_FLAG = ''
			WHERE UNCLASSIFIED_FLAG = 'Y' AND
				  
				  (
					LEFT(ZF_DEBIT_SKA1_GVTYP_FLAG_LIST,1) <> '_' OR
					LEFT(ZF_DEBIT_ACCOUNT_TYPES, 1) = 'S'
				  )
				  AND LEFT(ZF_DEBIT_T012K_FEBKO_SKB1_HBKID_XGKON_FLAG_LIST, 1) <> 'Y'
				  AND ISNULL(BSAIK_XANET, '') = ''
				  AND LEFT(ZF_CREDIT_ACCOUNT_TYPES, 1) = 'K'
				  AND ZF_DOC_CLEARING_FLAG = 0
				  AND BKPF_AWTYP = 'RMRP'



			/*
				Step 3.4: Flag all documents have
							Debit on account type 'K'
							Credit on (SKA1_GVTYP_BSEG<> "" OR  BSEG_KOART = S) AND NOT(ZF_BSEG_HKONT_PAYFLAG) AND BSAK_XANET ="" 
							AUGBL <> BELNR
							AWTYP= RMRP
						  to Supplier invoice cancellation
			*/
			UPDATE B07_01_TT_FIN_AP_INV_PAY_FLAGS
			SET ZF_FLAG_SUMMARY = 'Supplier invoice cancellation', ZF_SUPP_INV_CANC = 'X', 
			    UNCLASSIFIED_FLAG = ''
			WHERE UNCLASSIFIED_FLAG = 'Y' AND
			LEFT(ZF_DEBIT_ACCOUNT_TYPES, 1) = 'K' AND
			(
				LEFT(ZF_CREDIT_SKA1_GVTYP_FLAG_LIST, 1) <> '_' OR
				LEFT(ZF_CREDIT_ACCOUNT_TYPES, 1) = 'S'
			)
			AND LEFT(ZF_CREDIT_T012K_FEBKO_SKB1_HBKID_XGKON_FLAG_LIST, 1) <> 'Y'
			AND ISNULL(BSAIK_XANET, '') = ''
			AND ZF_DOC_CLEARING_FLAG = 0
			AND BKPF_AWTYP = 'RMRP' 



			/*
				Step 3.5: Flag all documents have
							Debit on BSEG_KOART = K
							Credit on ZF_BSEG_HKONT_PAYFLAG OR BSAK_XANET <> "" 
							BSAK_BELNR found in REGUH_VBLNR
							AWTYP <> 'RMRP'
						  to Supplier payment
			*/
			UPDATE B07_01_TT_FIN_AP_INV_PAY_FLAGS
			SET ZF_FLAG_SUMMARY = 'Supplier payment', ZF_SUPP_PAY = 'X', 
			    UNCLASSIFIED_FLAG = ''
			WHERE UNCLASSIFIED_FLAG = 'Y' AND
				  LEFT(ZF_DEBIT_ACCOUNT_TYPES, 1) = 'K'
				  AND (
						LEFT(ZF_CREDIT_T012K_FEBKO_SKB1_HBKID_XGKON_FLAG_LIST, 1) = 'Y' OR
						ISNULL(BSAIK_XANET, '') <> ''
					  )
				  AND ZF_REGUH_PAYMENT_FLAG = 'X'
				  AND BKPF_AWTYP <> 'RMRP'


			/*
				Step 3.6: Flag all documents have
							Debit on ZF_BSEG_HKONT_PAYFLAG OR BSAK_XANET <> "" 
							Credit on BSEG_KOART = K
							BSAK_BELNR found in REGUH_VBLNR
							AWTYP <> 'RMRP'
						  to Supplier payment cancellation
			*/
			UPDATE B07_01_TT_FIN_AP_INV_PAY_FLAGS
			SET ZF_FLAG_SUMMARY = 'Supplier payment cancellation', ZF_SUPP_PAY_CANC = 'X', 
			    UNCLASSIFIED_FLAG = ''
			WHERE UNCLASSIFIED_FLAG = 'Y' AND
				  (
					LEFT(ZF_DEBIT_T012K_FEBKO_SKB1_HBKID_XGKON_FLAG_LIST, 1) = 'Y' OR
					ISNULL(BSAIK_XANET, '') <> ''
				  )
				  AND LEFT(ZF_CREDIT_ACCOUNT_TYPES, 1) = 'K'
				  AND ZF_REGUH_PAYMENT_FLAG = 'X'
				  AND BKPF_AWTYP <> 'RMRP'


			/*
				Step 3.7: Flag all documents have
							Debit on (SKA1_GVTYP_BSEG<> "" OR  BSEG_KOART = S) AND NOT(ZF_BSEG_HKONT_PAYFLAG) AND BSAK_XANET ="" 
							Credit on BSEG_KOART = K
							AUGBL <> BELNR
						  to Supplier invoice
			*/
			UPDATE B07_01_TT_FIN_AP_INV_PAY_FLAGS
			SET ZF_FLAG_SUMMARY = 'Supplier invoice', ZF_SUPP_INV = 'X', 
			    UNCLASSIFIED_FLAG = ''
			WHERE UNCLASSIFIED_FLAG = 'Y' AND
				  (
					LEFT(ZF_DEBIT_SKA1_GVTYP_FLAG_LIST,1) <> '_' OR
					LEFT(ZF_DEBIT_ACCOUNT_TYPES, 1) = 'S'
				  )
				  AND LEFT(ZF_DEBIT_T012K_FEBKO_SKB1_HBKID_XGKON_FLAG_LIST, 1) <> 'Y'
				  AND ISNULL(BSAIK_XANET, '') = ''
				  AND LEFT(ZF_CREDIT_ACCOUNT_TYPES, 1) = 'K'
				  AND ZF_DOC_CLEARING_FLAG = 0



			/*
				Step 3.8: Flag all documents have
							Debit on account type 'K'
							Credit on (SKA1_GVTYP_BSEG<> "" OR  BSEG_KOART = S) AND NOT(ZF_BSEG_HKONT_PAYFLAG) AND BSAK_XANET ="" 
							AUGBL <> BELNR
						  to Supplier invoice cancellation
			*/
			UPDATE B07_01_TT_FIN_AP_INV_PAY_FLAGS
			SET ZF_FLAG_SUMMARY = 'Supplier invoice cancellation', ZF_SUPP_INV_CANC = 'X', 
			    UNCLASSIFIED_FLAG = ''
			WHERE UNCLASSIFIED_FLAG = 'Y' AND
			LEFT(ZF_DEBIT_ACCOUNT_TYPES, 1) = 'K' AND
			(
				LEFT(ZF_CREDIT_SKA1_GVTYP_FLAG_LIST, 1) <> '_' OR
				LEFT(ZF_CREDIT_ACCOUNT_TYPES, 1) = 'S'
			)
			AND LEFT(ZF_CREDIT_T012K_FEBKO_SKB1_HBKID_XGKON_FLAG_LIST, 1) <> 'Y'
			AND ISNULL(BSAIK_XANET, '') = ''
			AND ZF_DOC_CLEARING_FLAG = 0



			/*
				Step 3.9: Flag all documents have
							Debit on BSEG_KOART = K
							Credit on ZF_BSEG_HKONT_PAYFLAG OR BSAK_XANET <> "" 
							AWTYP <> 'RMRP'
						  to Supplier payment
			*/
			UPDATE B07_01_TT_FIN_AP_INV_PAY_FLAGS
			SET ZF_FLAG_SUMMARY = 'Supplier payment', ZF_SUPP_PAY = 'X', 
			    UNCLASSIFIED_FLAG = ''
			WHERE UNCLASSIFIED_FLAG = 'Y' AND
				  LEFT(ZF_DEBIT_ACCOUNT_TYPES, 1) = 'K'
				  AND (
						LEFT(ZF_CREDIT_T012K_FEBKO_SKB1_HBKID_XGKON_FLAG_LIST, 1) = 'Y' OR
						ISNULL(BSAIK_XANET, '') <> ''
					  )
				  AND BKPF_AWTYP <> 'RMRP'

			
			/*
				Step 3.10: Flag all documents have
							Debit on ZF_BSEG_HKONT_PAYFLAG OR BSAK_XANET <> "" 
							Credit on BSEG_KOART = K
							AWTYP <> 'RMRP'
						  to Supplier payment cancellation
			*/
			UPDATE B07_01_TT_FIN_AP_INV_PAY_FLAGS
			SET ZF_FLAG_SUMMARY = 'Supplier payment cancellation', ZF_SUPP_PAY_CANC = 'X', 
			    UNCLASSIFIED_FLAG = ''
			WHERE UNCLASSIFIED_FLAG = 'Y' AND
				  (
					LEFT(ZF_DEBIT_T012K_FEBKO_SKB1_HBKID_XGKON_FLAG_LIST, 1) = 'Y' OR
					ISNULL(BSAIK_XANET, '') <> ''
				  )
				  AND LEFT(ZF_CREDIT_ACCOUNT_TYPES, 1) = 'K'
				  AND BKPF_AWTYP <> 'RMRP'


			/*
				Step 3.11: Flag all documents have
							Debit on (SKA1_GVTYP_BSEG<> "" OR  BSEG_KOART = S) AND NOT(ZF_BSEG_HKONT_PAYFLAG) AND BSAK_XANET ="" 
							Credit on BSEG_KOART = K
						  to Supplier invoice
			*/
			UPDATE B07_01_TT_FIN_AP_INV_PAY_FLAGS
			SET ZF_FLAG_SUMMARY = 'Supplier invoice', ZF_SUPP_INV = 'X', 
			    UNCLASSIFIED_FLAG = ''
			WHERE UNCLASSIFIED_FLAG = 'Y' AND
				  (
					LEFT(ZF_DEBIT_SKA1_GVTYP_FLAG_LIST,1) <> '_' OR
					LEFT(ZF_DEBIT_ACCOUNT_TYPES, 1) = 'S'
				  )
				  AND LEFT(ZF_DEBIT_T012K_FEBKO_SKB1_HBKID_XGKON_FLAG_LIST, 1) <> 'Y'
				  AND ISNULL(BSAIK_XANET, '') = ''
				  AND LEFT(ZF_CREDIT_ACCOUNT_TYPES, 1) = 'K'



			/*
				Step 3.12: Flag all documents have
							Debit on account type 'K'
							Credit on (SKA1_GVTYP_BSEG<> "" OR  BSEG_KOART = S) AND NOT(ZF_BSEG_HKONT_PAYFLAG) AND BSAK_XANET ="" 
						  to Supplier invoice cancellation
			*/
			UPDATE B07_01_TT_FIN_AP_INV_PAY_FLAGS
			SET ZF_FLAG_SUMMARY = 'Supplier invoice cancellation', ZF_SUPP_INV_CANC = 'X', 
			    UNCLASSIFIED_FLAG = ''
			WHERE UNCLASSIFIED_FLAG = 'Y' AND
			LEFT(ZF_DEBIT_ACCOUNT_TYPES, 1) = 'K' AND
			(
				LEFT(ZF_CREDIT_SKA1_GVTYP_FLAG_LIST, 1) <> '_' OR
				LEFT(ZF_CREDIT_ACCOUNT_TYPES, 1) = 'S'
			)
			AND LEFT(ZF_CREDIT_T012K_FEBKO_SKB1_HBKID_XGKON_FLAG_LIST, 1) <> 'Y'
			AND ISNULL(BSAIK_XANET, '') = ''


			/*
				Step 3.13: Flag the rest documents to others
			*/
			UPDATE B07_01_TT_FIN_AP_INV_PAY_FLAGS
			SET ZF_FLAG_SUMMARY = 'Others', ZF_OTHERS = 'X', 
			    UNCLASSIFIED_FLAG = ''
			WHERE UNCLASSIFIED_FLAG = 'Y'



	  /*
			Step 4: Join the summary table after flaged all AP docuement to categories back to full AP document cube.
	  */
		EXEC SP_REMOVE_TABLES 'B07_03_IT_FIN_AP_INV_PAY_FLAGS'
		SELECT 
			B04_10_IT_BSAK_BSIK_AP_ACC_SCH.*,
			B07_01_TT_FIN_AP_INV_PAY_FLAGS.ZF_FLAG_SUMMARY,
			B07_01_TT_FIN_AP_INV_PAY_FLAGS.ZF_SUPP_INV,
			B07_01_TT_FIN_AP_INV_PAY_FLAGS.ZF_SUPP_INV_CANC,
			B07_01_TT_FIN_AP_INV_PAY_FLAGS.ZF_SUPP_PAY,
			B07_01_TT_FIN_AP_INV_PAY_FLAGS.ZF_SUPP_PAY_CANC,
			B07_01_TT_FIN_AP_INV_PAY_FLAGS.ZF_PERSONAL_EXPENSE,
			B07_01_TT_FIN_AP_INV_PAY_FLAGS.ZF_PERSONAL_EXPENSE_CANCELLATION,
			B07_01_TT_FIN_AP_INV_PAY_FLAGS.ZF_PERSONAL_EXPENSE_PAYMENT,
			B07_01_TT_FIN_AP_INV_PAY_FLAGS.ZF_PERSONAL_EXPENSE_PAYMENT_CANCELLATION,
			B07_01_TT_FIN_AP_INV_PAY_FLAGS.ZF_OTHERS
		INTO B07_03_IT_FIN_AP_INV_PAY_FLAGS
		FROM B04_10_IT_BSAK_BSIK_AP_ACC_SCH
		LEFT JOIN B07_01_TT_FIN_AP_INV_PAY_FLAGS
		ON 
		 ISNULL(B04_10_IT_BSAK_BSIK_AP_ACC_SCH.BSAIK_BUKRS, '') = ISNULL(B07_01_TT_FIN_AP_INV_PAY_FLAGS.BSAIK_BUKRS, '') AND
		 ISNULL(B04_10_IT_BSAK_BSIK_AP_ACC_SCH.BSAIK_BLART, '') = ISNULL(B07_01_TT_FIN_AP_INV_PAY_FLAGS.BSAIK_BLART, '') AND
		 ISNULL(B04_10_IT_BSAK_BSIK_AP_ACC_SCH.ZF_DOC_CLEARING_FLAG, '') = ISNULL(B07_01_TT_FIN_AP_INV_PAY_FLAGS.ZF_DOC_CLEARING_FLAG, '') AND
		 ISNULL(B04_10_IT_BSAK_BSIK_AP_ACC_SCH.BSAIK_UMSKZ, '') = ISNULL(B07_01_TT_FIN_AP_INV_PAY_FLAGS.BSAIK_UMSKZ, '') AND
		 ISNULL(B04_10_IT_BSAK_BSIK_AP_ACC_SCH.BSAIK_BSCHL, '') = ISNULL(B07_01_TT_FIN_AP_INV_PAY_FLAGS.BSAIK_BSCHL, '') AND
		 ISNULL(B04_10_IT_BSAK_BSIK_AP_ACC_SCH.BKPF_TCODE, '') = ISNULL(B07_01_TT_FIN_AP_INV_PAY_FLAGS.BKPF_TCODE, '') AND
		 ISNULL(B04_10_IT_BSAK_BSIK_AP_ACC_SCH.BKPF_AWTYP, '') = ISNULL(B07_01_TT_FIN_AP_INV_PAY_FLAGS.BKPF_AWTYP, '') AND
		 ISNULL(B04_10_IT_BSAK_BSIK_AP_ACC_SCH.LFA1_KTOKK, '') = ISNULL(B07_01_TT_FIN_AP_INV_PAY_FLAGS.LFA1_KTOKK, '') AND
		 ISNULL(B04_10_IT_BSAK_BSIK_AP_ACC_SCH.BSAIK_XANET, '') = ISNULL(B07_01_TT_FIN_AP_INV_PAY_FLAGS.BSAIK_XANET, '') AND
		 ISNULL(B04_10_IT_BSAK_BSIK_AP_ACC_SCH.BSAIK_LIFNR, '') = ISNULL(B07_01_TT_FIN_AP_INV_PAY_FLAGS.BSAIK_LIFNR, '') AND
		 ISNULL(B04_10_IT_BSAK_BSIK_AP_ACC_SCH.BSAIK_SHKZG, '') = ISNULL(B07_01_TT_FIN_AP_INV_PAY_FLAGS.BSAIK_SHKZG, '') AND
		 ISNULL(B04_10_IT_BSAK_BSIK_AP_ACC_SCH.ZF_DEBIT_ACCOUNT_TYPES, '') = ISNULL(B07_01_TT_FIN_AP_INV_PAY_FLAGS.ZF_DEBIT_ACCOUNT_TYPES, '') AND
		 ISNULL(B04_10_IT_BSAK_BSIK_AP_ACC_SCH.ZF_CREDIT_ACCOUNT_TYPES, '') = ISNULL(B07_01_TT_FIN_AP_INV_PAY_FLAGS.ZF_CREDIT_ACCOUNT_TYPES, '') AND
		 ISNULL(B04_10_IT_BSAK_BSIK_AP_ACC_SCH.ZF_DEBIT_T012K_FEBKO_SKB1_HBKID_XGKON_FLAG_LIST, '') = ISNULL(B07_01_TT_FIN_AP_INV_PAY_FLAGS.ZF_DEBIT_T012K_FEBKO_SKB1_HBKID_XGKON_FLAG_LIST , '')AND 
		 ISNULL(B04_10_IT_BSAK_BSIK_AP_ACC_SCH.ZF_CREDIT_T012K_FEBKO_SKB1_HBKID_XGKON_FLAG_LIST, '') = ISNULL(B07_01_TT_FIN_AP_INV_PAY_FLAGS.ZF_CREDIT_T012K_FEBKO_SKB1_HBKID_XGKON_FLAG_LIST, '') AND
		 ISNULL(B04_10_IT_BSAK_BSIK_AP_ACC_SCH.ZF_DEBIT_SKA1_GVTYP_FLAG_LIST, '') = ISNULL(B07_01_TT_FIN_AP_INV_PAY_FLAGS.ZF_DEBIT_SKA1_GVTYP_FLAG_LIST, '') AND
		 ISNULL(B04_10_IT_BSAK_BSIK_AP_ACC_SCH.ZF_CREDIT_SKA1_GVTYP_FLAG_LIST, '') = ISNULL(B07_01_TT_FIN_AP_INV_PAY_FLAGS.ZF_CREDIT_SKA1_GVTYP_FLAG_LIST, '') AND
		 ISNULL(B04_10_IT_BSAK_BSIK_AP_ACC_SCH.ZF_LIFNR_KUNNR_IS_SAME_FLAG, '') = ISNULL(B07_01_TT_FIN_AP_INV_PAY_FLAGS.ZF_LIFNR_KUNNR_IS_SAME_FLAG, '') AND
		 ISNULL(B04_10_IT_BSAK_BSIK_AP_ACC_SCH.ZF_REGUH_PAYMENT_FLAG, '') = ISNULL(B07_01_TT_FIN_AP_INV_PAY_FLAGS.ZF_REGUH_PAYMENT_FLAG, '') AND
		 ISNULL(B04_10_IT_BSAK_BSIK_AP_ACC_SCH.ZF_REGUP_INVOICE_FLAG, '') = ISNULL(B07_01_TT_FIN_AP_INV_PAY_FLAGS.ZF_REGUP_INVOICE_FLAG, '')


	EXEC SP_RENAME_FIELD 'B07B_', 'B07_03_IT_FIN_AP_INV_PAY_FLAGS'
	EXEC SP_REMOVE_TABLES '%_TT_%'
GO
