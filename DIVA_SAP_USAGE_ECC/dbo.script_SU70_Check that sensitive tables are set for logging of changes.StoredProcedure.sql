USE [DIVA_SAP_USAGE_ECC]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[script_SU70_Check that sensitive tables are set for logging of changes]
AS 
--DYNAMIC_SCRIPT_START

--Script objective : 
--Check if the table is set to log data changes or not

--STep 1 Get the list of table 
--Flag if it is allow to log data changes or not
--Set the description is not not found if it is null
EXEC SP_DROPTABLE SU70_01_RT_LOG_DATA_CHANGE
SELECT
	BC15_01_DD09L_TABNAME,	
	BC15_01_DD09L_AS4LOCAL,	
	BC15_01_DD09L_AS4VERS,	
	BC15_01_DD09L_TABKAT,	
	BC15_01_DD09L_TABART,	
	BC15_01_DD09L_PUFFERUNG,
	BC15_01_DD09L_SCHFELDANZ,	
	BC15_01_DD09L_PROTOKOLL,
	BC15_01_DD09L_SPEICHPUFF,	
	BC15_01_DD09L_AS4USER,
	BC15_01_DD09L_AS4DATE,
	BC15_01_DD09L_AS4TIME,	
	BC15_01_DD09L_TRANSPFLAG,
	BC15_01_DD09L_RESERVE,
	BC15_01_DD09L_UEBERSETZ,
	BC15_01_DD09L_ACTFLAG,
	BC15_01_DD09L_BUFALLOW,
	BC15_01_DD09L_JAVAONLY,
	BC15_01_USER_ADDR_NAME_TEXTC,
	BC15_01_ZF_DD09L_AS4LOCAL_DESC,
	BC15_01_ZF_DD09L_TABKAT_DESC,
	IIF(BC15_01_DD02T_DDTEXT IS NULL,'Not found',BC15_01_DD02T_DDTEXT) AS BC15_01_DD02T_DDTEXT,
	IIF(BC15_01_DD09L_PROTOKOLL='X','Yes','') AS ZF_DD09L_PROTOKOLL_FLAG
INTO SU70_01_RT_LOG_DATA_CHANGE
FROM BC15_01_IT_DD09L_DD02T
--Get the max line only
INNER JOIN 
(
	SELECT BC15_01_DD09L_TABNAME AS BC15_01_DD09L_TABNAME_MAX,
			BC15_01_DD09L_AS4LOCAL AS BC15_01_DD09L_AS4LOCAL_MAX,
			BC15_01_DD09L_AS4VERS AS BC15_01_DD09L_AS4VERS_MAX,
			MAX(BC15_01_DD09L_AS4DATE) AS BC15_01_DD09L_AS4DATE_MAX
			FROM BC15_01_IT_DD09L_DD02T
			GROUP BY
			BC15_01_DD09L_TABNAME,
			BC15_01_DD09L_AS4LOCAL,
			BC15_01_DD09L_AS4VERS
) AS B
ON BC15_01_DD09L_TABNAME=BC15_01_DD09L_TABNAME_MAX AND
	BC15_01_DD09L_AS4LOCAL=BC15_01_DD09L_AS4LOCAL_MAX AND
	BC15_01_DD09L_AS4VERS=BC15_01_DD09L_AS4VERS_MAX AND
	 BC15_01_DD09L_AS4DATE=BC15_01_DD09L_AS4DATE_MAX


--STep 2 Get the detail of DD02L

EXEC SP_DROPTABLE 'SU70_02_RT_DD02L'

SELECT 	DISTINCT 
	   DD02L_TABNAME
      ,DD02L_AS4LOCAL
      ,DD02L_AS4VERS
      ,DD02L_TABCLASS
      ,DD02L_SQLTAB
      ,DD02L_DATMIN
      ,DD02L_DATMAX
      ,DD02L_DATAVG
      ,DD02L_CLIDEP
      ,DD02L_BUFFERED
      ,DD02L_COMPRFLAG
      ,DD02L_LANGDEP
      ,DD02L_ACTFLAG
      ,DD02L_APPLCLASS
      ,DD02L_AUTHCLASS
      ,DD02L_AS4USER
      ,DD02L_AS4TIME
      ,DD02L_MASTERLANG
      ,DD02L_MAINFLAG
      ,DD02L_CONTFLAG
      ,DD02L_RESERVETAB
      ,DD02L_GLOBALFLAG
      ,DD02L_PROZPUFF
      ,DD02L_VIEWCLASS
      ,DD02L_VIEWGRANT
      ,DD02L_MULTIPLEX
      ,DD02L_SHLPEXI
      ,DD02L_PROXYTYPE
      ,DD02L_EXCLASS
      ,DD02L_WRONGCL
      ,DD02L_AS4DATE
      ,
	  CASE 
		WHEN	DD02L_AS4LOCAL= 'A' THEN 'Entry activated or generated in this form'
		WHEN	DD02L_AS4LOCAL= 'L'	THEN 'Lock entry (first N version)'
		WHEN	DD02L_AS4LOCAL= 'N' THEN 'Entry edited, but not activated'	
		WHEN	DD02L_AS4LOCAL= 'S'	THEN 'Previously active entry, backup copy'
		WHEN	DD02L_AS4LOCAL= 'T'	THEN 'Temporary version when editing'
		ELSE 'Not found' END ZF_DD02L_AS4LOCAL_DESC
      ,ZF_DD09L_PROTOKOLL_FLAG AS ZF_DD02L_DD09L_PROTOKOL_FLAG
      ,
		IIF(
				LEN(TRIM(BC15_01_DD09L_TABNAME))>0,'X',''
			) 
			AS ZF_DD02L_IN_DD09L_FLAG
	, DD02T_DDTEXT
      ,	CASE
		WHEN DD02L_TABCLASS='TRANSP' THEN 'Transparent table'
		WHEN DD02L_TABCLASS='INTTAB' THEN 'Structure'
		WHEN DD02L_TABCLASS='CLUSTER' THEN 'Cluster table'
		WHEN DD02L_TABCLASS='POOL' THEN 'Pooled table'
		WHEN DD02L_TABCLASS='VIEW' THEN 'General view structure'
		WHEN DD02L_TABCLASS='APPEND' THEN 'Append structure'
		END AS ZF_DD02L_TABCLASS_DESC
INTO SU70_02_RT_DD02L
FROM A_DD02L

--Add table name
--Add the name of the table
LEFT JOIN A_DD02T
ON
	DD02L_TABNAME=DD02T_TABNAME AND
	DD02L_AS4LOCAL=DD02T_AS4LOCAL AND 
	DD02L_AS4VERS=DD02T_AS4VERS 
--Left join to with DD09L to check if DD02L found in DD09L or not
LEFT JOIN SU70_01_RT_LOG_DATA_CHANGE
	ON 	   DD02L_TABNAME=BC15_01_DD09L_TABNAME
      AND DD02L_AS4LOCAL=BC15_01_DD09L_AS4LOCAL
      AND DD02L_AS4VERS=BC15_01_DD09L_AS4VERS

--Rename the fields
EXEC SP_UNNAME_FIELD 'BC15_01_','SU70_01_RT_LOG_DATA_CHANGE'
EXEC SP_RENAME_FIELD 'SU70_01_','SU70_01_RT_LOG_DATA_CHANGE'
EXEC SP_RENAME_FIELD 'SU70_02_','SU70_02_RT_DD02L'
GO
