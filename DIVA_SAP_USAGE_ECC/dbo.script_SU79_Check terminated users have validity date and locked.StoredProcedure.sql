USE [DIVA_SAP_USAGE_ECC]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[script_SU79_Check terminated users have validity date and locked]
WITH EXECUTE AS CALLER
AS
--DYNAMIC_SCRIPT_START

-- Script object: Check terminated users have validity date and locked
-- Step 1: select user data from BC16_01_IT_USERS (user cube)

EXEC SP_REMOVE_TABLES 'SU79_01_RT_TERMINATED_USERS'

SELECT USR02_BNAME,
	USR02_GLTGV,
	USR02_USTYP,
	USR02_GLTGB,
	USR02_CLASS,
	USR02_UFLAG,
	USR02_TRDAT,
	ZF_USR02_USTYP_SHORT_DESC,
	ZF_USR02_UFLAG_DESC,
	USR02_CODVN,
	ZF_USR02_CODVN_DESCRIPTION,
	-- Calculate month diff between last login date and extract date
	DATEDIFF(MONTH ,USR02_TRDAT,(SELECT GLOBALS_VALUE FROM AM_GLOBALS
	WHERE GLOBALS_PARAMETER = 'downloaddate')) AS ZF_DATE_DIFF_USR02_TRDAT_EXTRACT_DATE_FLAG,
	-- Check extract date > valid date or not
	IIF((SELECT GLOBALS_VALUE FROM AM_GLOBALS
	WHERE GLOBALS_PARAMETER = 'downloaddate')> USR02_GLTGB, 'Yes', 'No') AS ZF_EXTRACT_DATE_BIGGER_VALID_DATE_FLAG,
	-- Check last login date > valid date or not
	IIF(USR02_TRDAT> USR02_GLTGB, 'Yes', 'No') AS ZF_USR02_TRDAT_BIGGER_USR02_GLTGB,
	-- Add some information of user
	USER_ADDR_NAME_TEXTC,
	USER_ADDR_DEPARTMENT,
	A_USER_ADDR.USER_ADDR_CITY1,
	(SELECT GLOBALS_VALUE FROM AM_GLOBALS WHERE GLOBALS_PARAMETER = 'downloaddate') AS ZF_EXTRACT_DATE,
	USGRPT_TEXT
INTO SU79_01_RT_TERMINATED_USERS
FROM BC16_01_IT_USR02_USERS
LEFT JOIN A_USER_ADDR
ON USR02_BNAME = USER_ADDR_BNAME
-- Rename the fields
EXEC SP_RENAME_FIELD 'SU79_01_', 'SU79_01_RT_TERMINATED_USERS'
GO
