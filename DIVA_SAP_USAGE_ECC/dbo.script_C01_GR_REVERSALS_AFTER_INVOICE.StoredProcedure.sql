USE [DIVA_SAP_USAGE_ECC]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE    PROCEDURE [dbo].[script_C01_GR_REVERSALS_AFTER_INVOICE]
WITH EXECUTE AS CALLER
AS
--DYNAMIC_SCRIPT_START
BEGIN

/*Change history comments*/

/*
	Title			:	C01: Good Reciept reversals and Invoice Posting
	  
	--------------------------------------------------------------
	Update history
	--------------------------------------------------------------
	Date		    | Who |	Description
	13/09/2022        DAT   First version for Sony ECC
*/
-- Step 1 / Filter the GR cube on reversals

EXEC SP_REMOVE_TABLES 'C01_%'

EXEC SP_DROPTABLE 'C01_01_TT_GR_REVERSALS'

SELECT 
	BP03_01_IT_GR.*
INTO C01_01_TT_GR_REVERSALS
FROM BP03_01_IT_GR
WHERE BP03_01_MKPF_BLART = 'WE' AND (BP03_01_MSEG_BWART = '102' OR BP03_01_MSEG_BWART = '104' OR BP03_01_MSEG_BWART = '106' OR BP03_01_MSEG_BWART = '108' OR BP03_01_MSEG_BWART = '110'
	OR BP03_01_MSEG_BWART = '122' OR BP03_01_MSEG_BWART = '123' OR BP03_01_MSEG_BWART = '124' OR BP03_01_MSEG_BWART = '125' OR BP03_01_MSEG_BWART = '161')

--Step 2/ Join C01_01_TT_GR_REVERSALS to invoices on EBELN+EBELP where MKPF_BUDAT > RBKP_BUDAT

EXEC SP_DROPTABLE 'C01_02_TT_GR_REVERSALS_INV'

SELECT 
	C01_01_TT_GR_REVERSALS.*,
	BP04A_01_IT_INVOICE.*
INTO C01_02_TT_GR_REVERSALS_INV
FROM C01_01_TT_GR_REVERSALS
INNER JOIN
(
		SELECT 
		A.BP03_01_MSEG_EBELN,
		A.BP03_01_MSEG_EBELP,
		A.BP03_01_MKPF_BUDAT
		FROM C01_01_TT_GR_REVERSALS A
	GROUP BY  A.BP03_01_MSEG_EBELN,
			A.BP03_01_MSEG_EBELP,
			BP03_01_MKPF_BUDAT
	HAVING  SUM(BP03_01_ZF_MSEG_DMBTR_SIGNED_CUC) <> 0
) AS D
	ON C01_01_TT_GR_REVERSALS.BP03_01_MSEG_EBELN=D.BP03_01_MSEG_EBELN
	AND C01_01_TT_GR_REVERSALS.BP03_01_MSEG_EBELP=D.BP03_01_MSEG_EBELP
INNER JOIN
	(
SELECT A.BP04A_01_RSEG_EBELN,A.BP04A_01_RSEG_EBELP,MAX(A.BP04A_01_RBKP_BUDAT) AS BP04A_01_RBKP_BUDAT
FROM BP04A_01_IT_INVOICE AS A
INNER JOIN
(
		SELECT 
			BP04A_01_RSEG_EBELN,
			BP04A_01_RSEG_EBELP,
			MAX(BP04A_01_RBKP_BUDAT) AS  BP04A_01_RBKP_BUDAT
		FROM BP04A_01_IT_INVOICE
		GROUP BY
		BP04A_01_RSEG_EBELN,
		BP04A_01_RSEG_EBELP
	) AS B
		ON A.BP04A_01_RSEG_EBELN=B.BP04A_01_RSEG_EBELN AND 
			A.BP04A_01_RSEG_EBELP=B.BP04A_01_RSEG_EBELP AND
			A.BP04A_01_RBKP_BUDAT=B.BP04A_01_RBKP_BUDAT
		GROUP BY A.BP04A_01_RSEG_EBELN, A.BP04A_01_RSEG_EBELP
		HAVING SUM(BP04A_01_ZF_RSEG_WRBTR_S_CUC) <> 0
	) AS BP04A_01_IT_INVOICE
ON BP04A_01_IT_INVOICE.BP04A_01_RSEG_EBELN = C01_01_TT_GR_REVERSALS.BP03_01_MSEG_EBELN 
AND BP04A_01_IT_INVOICE.BP04A_01_RSEG_EBELP = C01_01_TT_GR_REVERSALS.BP03_01_MSEG_EBELP
WHERE C01_01_TT_GR_REVERSALS.BP03_01_MKPF_BUDAT > BP04A_01_RBKP_BUDAT

--Step 3/ Create summary list of GR numbers from Step 2

EXEC SP_DROPTABLE 'C01_03_TT_GR_SUMM'

SELECT DISTINCT
	BP03_01_MSEG_BUKRS,
	BP03_01_MKPF_MBLNR,
	BP03_01_MKPF_MJAHR,
	BP03_01_MSEG_ZEILE
INTO C01_03_TT_GR_SUMM
FROM C01_02_TT_GR_REVERSALS_INV

--Step 4/ Filter the result of 1/ on result of step 3

EXEC SP_DROPTABLE 'C01_04_XT_GR_REVERSALS'

SELECT 
	C01_01_TT_GR_REVERSALS.*
INTO C01_04_XT_GR_REVERSALS
FROM C01_01_TT_GR_REVERSALS
INNER JOIN C01_03_TT_GR_SUMM
ON C01_03_TT_GR_SUMM.BP03_01_MSEG_BUKRS = C01_01_TT_GR_REVERSALS.BP03_01_MSEG_BUKRS 
AND C01_03_TT_GR_SUMM.BP03_01_MKPF_MBLNR = C01_01_TT_GR_REVERSALS.BP03_01_MKPF_MBLNR
AND C01_03_TT_GR_SUMM.BP03_01_MKPF_MJAHR = C01_01_TT_GR_REVERSALS.BP03_01_MKPF_MJAHR
AND C01_03_TT_GR_SUMM.BP03_01_MSEG_ZEILE = C01_01_TT_GR_REVERSALS.BP03_01_MSEG_ZEILE


--Step 5/ Make a summary list of invoice numbers from step 2

EXEC SP_DROPTABLE 'C01_05_TT_INV_SUMM'

SELECT DISTINCT 
	BP04A_01_RBKP_BUKRS,
	BP04A_01_RBKP_BELNR,
	BP04A_01_RBKP_GJAHR,
	BP04A_01_RSEG_BUZEI
INTO C01_05_TT_INV_SUMM
FROM  BP04A_01_IT_INVOICE AS A
INNER JOIN
	C01_02_TT_GR_REVERSALS_INV AS B
	ON A.BP04A_01_RSEG_EBELN=B.BP04A_01_RSEG_EBELN
	AND A.BP04A_01_RSEG_EBELP=B.BP04A_01_RSEG_EBELP
	AND A.BP04A_01_RBKP_BUDAT=B.BP04A_01_RBKP_BUDAT

--Step 6/ Filter the invoice cube on result of step 5


EXEC SP_DROPTABLE 'C01_06_XT_INV'

SELECT 
	BP04A_01_IT_INVOICE.*
INTO C01_06_XT_INV
FROM BP04A_01_IT_INVOICE
INNER JOIN C01_05_TT_INV_SUMM
ON C01_05_TT_INV_SUMM.BP04A_01_RBKP_BUKRS = BP04A_01_IT_INVOICE.BP04A_01_RBKP_BUKRS AND C01_05_TT_INV_SUMM.BP04A_01_RBKP_BELNR = BP04A_01_IT_INVOICE.BP04A_01_RBKP_BELNR
AND C01_05_TT_INV_SUMM.BP04A_01_RBKP_GJAHR = BP04A_01_IT_INVOICE.BP04A_01_RBKP_GJAHR AND C01_05_TT_INV_SUMM.BP04A_01_RSEG_BUZEI = BP04A_01_IT_INVOICE.BP04A_01_RSEG_BUZEI

--Step 7/ Create summary table of GR number, GR reversal date, invoice date

EXEC SP_DROPTABLE 'C01_07_XT_GR_INV_SUMM'
SELECT DISTINCT
	BP03_01_MSEG_BUKRS,
	BP03_01_MKPF_MBLNR,
	BP03_01_MKPF_MJAHR,
	BP03_01_MSEG_ZEILE,
	BP03_01_MKPF_BUDAT,
	BP04A_01_RBKP_BUDAT
INTO C01_07_XT_GR_INV_SUMM
FROM C01_02_TT_GR_REVERSALS_INV


-- Thuan : After discussing with Jesper. We should add 2 requests as follows : 2023-04-07
-- Request 1 / For the GRs and INVs tables we will add a full detail table, because currently in the dashboard we are showing GRs reversal after INVs.
-- Request 2 / We should add a filter : For each EBELN, EBELP get MAX(Posting date) for GRs > MAX(Posting date) in INVs.

-- Step 8 / Handle request number 1.
-- Step 8.1 Get GRs full detail table with POs exists in C01_04_XT_GR_REVERSALS table.

EXEC SP_DROPTABLE 'C01_08_XT_GR_WITH_REVALSAL_LINE_FULL'
SELECT 
	A.*
INTO C01_08_XT_GR_WITH_REVALSAL_LINE_FULL
FROM BP03_01_IT_GR A
INNER JOIN C01_04_XT_GR_REVERSALS B
	ON A.BP03_01_MSEG_EBELN = B.BP03_01_MSEG_EBELN
	AND A.BP03_01_MSEG_EBELP = B.BP03_01_MSEG_EBELP


-- Step 8.1 Get INVs full detail table with POs exists in C01_04_XT_GR_REVERSALS table.


EXEC SP_DROPTABLE 'C01_09_XT_INV_RELATE_REVESAL_GR_FULL'
SELECT 
	A.*
INTO C01_09_XT_INV_RELATE_REVESAL_GR_FULL
FROM BP04A_01_IT_INVOICE A
INNER JOIN C01_04_XT_GR_REVERSALS B
	ON A.BP04A_01_RSEG_EBELN = B.BP03_01_MSEG_EBELN
	AND A.BP04A_01_RSEG_EBELP = B.BP03_01_MSEG_EBELP

--/*Drop temporary tables*/
EXEC SP_DROPTABLE 'C01_05_TT_INV_SUMM'
EXEC SP_DROPTABLE 'C01_03_TT_GR_SUMM'
EXEC SP_DROPTABLE 'C01_02_TT_GR_REVERSALS_INV'
EXEC SP_DROPTABLE 'C01_01_TT_GR_REVERSALS'


EXEC SP_UNNAME_FIELD 'BP03_01_', 'C01_04_XT_GR_REVERSALS'
EXEC SP_UNNAME_FIELD 'BP04A_01_', 'C01_06_XT_INV'
EXEC SP_UNNAME_FIELD 'BP03_01_', 'C01_07_XT_GR_INV_SUMM'
EXEC SP_UNNAME_FIELD 'BP04A_01_', 'C01_07_XT_GR_INV_SUMM'
EXEC SP_UNNAME_FIELD 'BP03_01_', 'C01_08_XT_GR_WITH_REVALSAL_LINE_FULL'
EXEC SP_UNNAME_FIELD 'BP04A_01_', 'C01_09_XT_INV_RELATE_REVESAL_GR_FULL'


END


GO
