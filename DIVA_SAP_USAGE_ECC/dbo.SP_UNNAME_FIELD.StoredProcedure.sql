USE [DIVA_SAP_USAGE_ECC]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--ALTER PROC [dbo].[sp_UNNAME_FIELD](@ZV_PREFIX AS NVARCHAR(MAX), @TABLE_NAME AS NVARCHAR(MAX))
CREATE   PROCEDURE [dbo].[SP_UNNAME_FIELD](@ZV_PREFIX AS NVARCHAR(MAX), @TABLE_NAME AS NVARCHAR(MAX))
as

-- RENAME OUTPUT TABLE FOR QLIK DASHBOARD CONNECTION
DECLARE @STR_SQL NVARCHAR(MAX)
DECLARE @ZV_FIELD_NAME NVARCHAR(MAX), @ZV_OLD_NAME NVARCHAR(MAX), @ZV_NEW_NAME NVARCHAR(MAX)
DECLARE @CURRENT_DB NVARCHAR(MAX) = (SELECT DB_NAME())
DECLARE FIELDLIST_CURSOR CURSOR SCROLL
	FOR SELECT name FROM sys.columns WHERE object_id = OBJECT_ID('dbo.' + @TABLE_NAME) 

OPEN FIELDLIST_CURSOR
	FETCH NEXT FROM FIELDLIST_CURSOR
		INTO @ZV_FIELD_NAME
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @ZV_OLD_NAME = '[' + @TABLE_NAME + '].[' + @ZV_FIELD_NAME + ']'
		PRINT @ZV_OLD_NAME
		SET @ZV_NEW_NAME = REPLACE(@ZV_FIELD_NAME, @ZV_PREFIX,'')
		PRINT @ZV_FIELD_NAME
		EXEC sp_rename  @ZV_OLD_NAME, @ZV_NEW_NAME, 'COLUMN'
	FETCH NEXT FROM FIELDLIST_CURSOR
			INTO @ZV_FIELD_NAME
	END
CLOSE FIELDLIST_CURSOR
DEALLOCATE FIELDLIST_CURSOR

GO
