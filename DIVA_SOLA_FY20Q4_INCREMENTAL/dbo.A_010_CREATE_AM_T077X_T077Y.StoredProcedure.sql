USE [DIVA_SOLA_FY20Q4_INCREMENTAL]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE   PROCEDURE [dbo].[A_010_CREATE_AM_T077X_T077Y]
AS
BEGIN
	/*
		Step 1: Check and create AM_T077X table if it do not exist
	*/
	IF NOT EXISTS(SELECT TOP 1 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'AM_T077X')
	BEGIN
		SELECT *
		INTO AM_T077X
		FROM A_T077X

		ALTER TABLE AM_T077X ADD INTERCO_TXT NVARCHAR(100) NULL DEFAULT 'Unmapped' WITH VALUES;
		ALTER TABLE AM_T077X ADD INTERCO_CAT NVARCHAR(1) NULL DEFAULT 'N' WITH VALUES;
	END

	/*
		Step 2: Insert new AM_T077X rows base on A_T077X table.
	*/
	INSERT INTO AM_T077X(T077X_MANDT, T077X_SPRAS, T077X_KTOKD, T077X_TXT30, INTERCO_TXT, INTERCO_CAT)
	SELECT DISTINCT A_T077X.T077X_MANDT, A_T077X.T077X_SPRAS, A_T077X.T077X_KTOKD, A_T077X.T077X_TXT30, 'Unmapped', '0'
	FROM A_T077X
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM AM_T077X WHERE A_T077X.T077X_MANDT = AM_T077X.T077X_MANDT AND A_T077X.T077X_SPRAS = AM_T077X.T077X_SPRAS AND A_T077X.T077X_KTOKD = AM_T077X.T077X_KTOKD)

	/*
		Step 3: Try to classify customer group
	*/
	UPDATE AM_T077X
	SET INTERCO_TXT = 'Intercompany', INTERCO_CAT = 'Y'
	WHERE (T077X_TXT30 LIKE '%interco%' OR T077X_TXT30 LIKE '%int.%' OR T077X_TXT30 LIKE '%sony%') 
			AND NOT (T077X_TXT30 LIKE '%wo%' OR T077X_TXT30 LIKE '%w/o%' OR T077X_TXT30 LIKE '%witho%') 
			AND INTERCO_TXT = 'Unmapped'

	UPDATE AM_T077X
	SET INTERCO_TXT = 'Employee', INTERCO_CAT = 'E'
	WHERE (T077X_TXT30 LIKE '%empl%' OR T077X_TXT30 LIKE '%emp.%') AND INTERCO_TXT = 'Unmapped'


	UPDATE AM_T077X
	SET INTERCO_TXT = '3rd party', INTERCO_CAT = 'N'
	WHERE INTERCO_TXT = 'Unmapped'

	/*
		Step 4: Check and create AM_T077Y table if it do not exist
	*/
	IF NOT EXISTS(SELECT TOP 1 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'AM_T077Y')
	BEGIN
		SELECT *
		INTO AM_T077Y
		FROM A_T077Y

		ALTER TABLE AM_T077Y ADD INTERCO_TXT NVARCHAR(100) NULL DEFAULT 'Unmapped' WITH VALUES;
		ALTER TABLE AM_T077Y ADD INTERCO_CAT NVARCHAR(1) NULL DEFAULT 'N' WITH VALUES;
	END

	/*
		Step 5: Insert new AM_T077Y rows base on AM_T077Y table.
	*/

	INSERT INTO AM_T077Y(T077Y_MANDT, T077Y_SPRAS, T077Y_KTOKK, T077Y_TXT30, INTERCO_TXT, INTERCO_CAT)
	SELECT DISTINCT A_T077Y.T077Y_MANDT, A_T077Y.T077Y_SPRAS, A_T077Y.T077Y_KTOKK, A_T077Y.T077Y_TXT30, 'Unmapped', 'N'
	FROM A_T077Y
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM AM_T077Y WHERE A_T077Y.T077Y_MANDT = AM_T077Y.T077Y_MANDT 
	AND A_T077Y.T077Y_SPRAS = AM_T077Y.T077Y_SPRAS AND A_T077Y.T077Y_KTOKK = AM_T077Y.T077Y_KTOKK)

	/*
		Step 6: Try to classify vendor group
	*/
	UPDATE AM_T077Y
	SET INTERCO_TXT = 'Intercompany', INTERCO_CAT = 'Y'
	WHERE (T077Y_TXT30 LIKE '%interco%' OR T077Y_TXT30 LIKE '%int.%' OR T077Y_TXT30 LIKE '%sony%')
	AND NOT (T077Y_TXT30 LIKE '%wo%' OR T077Y_TXT30 LIKE '%w/o%' OR T077Y_TXT30 LIKE '%witho%') 
	AND INTERCO_TXT = 'Unmapped'

	UPDATE AM_T077Y
	SET INTERCO_TXT = 'Employee', INTERCO_CAT = 'E'
	WHERE (T077Y_TXT30 LIKE '%empl%' OR T077Y_TXT30 LIKE '%emp.%') AND INTERCO_TXT = 'Unmapped'


	UPDATE AM_T077Y
	SET INTERCO_TXT = '3rd party', INTERCO_CAT = 'N'
	WHERE INTERCO_TXT = 'Unmapped'

END
GO
